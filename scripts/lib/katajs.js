typeof Kata == "undefined" && (Kata = {});
Kata.closureIncluded = {"katajs/core/Core.js":!0, "katajs/core/Core.js":!0, "externals/GLGE/src/core/glge.js":!0, "externals/GLGE/src/core/glge_math.js":!0, "externals/GLGE/src/core/glge_document.js":!0, "externals/GLGE/src/core/glge_event.js":!0, "externals/GLGE/src/core/glge_animatable.js":!0, "externals/GLGE/src/core/glge_placeable.js":!0, "externals/GLGE/src/core/glge_jsonloader.js":!0, "externals/GLGE/src/core/glge_quicknote.js":!0, "externals/GLGE/src/core/glge_messages.js":!0, "externals/GLGE/src/core/glge_group.js":!0,
"externals/GLGE/src/renderable/glge_object.js":!0, "externals/GLGE/src/physics/glge_physicsabstract.js":!0, "externals/GLGE/src/scene/glge_scene.js":!0, "externals/GLGE/src/scene/glge_light.js":!0, "externals/GLGE/src/scene/glge_camera.js":!0, "externals/GLGE/src/renders/glge_renderer.js":!0, "externals/GLGE/src/renderable/glge_text.js":!0, "externals/GLGE/src/renderable/glge_lod.js":!0, "externals/GLGE/src/physics/glge_physicssphere.js":!0, "externals/GLGE/src/physics/glge_physicsplane.js":!0, "externals/GLGE/src/physics/glge_physicsmesh.js":!0,
"externals/GLGE/src/physics/glge_physicsext.js":!0, "externals/GLGE/src/physics/glge_physicsconstraintpoint.js":!0, "externals/GLGE/src/physics/glge_physicsbox.js":!0, "externals/GLGE/src/material/glge_texturevideo.js":!0, "externals/GLGE/src/material/glge_texture.js":!0, "externals/GLGE/src/material/glge_texturecube.js":!0, "externals/GLGE/src/material/glge_texturecanvas.js":!0, "externals/GLGE/src/material/glge_texturecamera.js":!0, "externals/GLGE/src/material/glge_multimaterial.js":!0, "externals/GLGE/src/material/glge_materiallayer.js":!0,
"externals/GLGE/src/material/glge_material.js":!0, "externals/GLGE/src/geometry/glge_mesh.js":!0, "externals/GLGE/src/animation/glge_animationvector.js":!0, "externals/GLGE/src/animation/glge_animationpoints.js":!0, "externals/GLGE/src/animation/glge_animationcurve.js":!0, "externals/GLGE/src/animation/glge_action.js":!0, "externals/GLGE/src/animation/glge_actionchannel.js":!0, "externals/GLGE/src/extra/glge_xmlparser.js":!0, "externals/GLGE/src/extra/glge_wavefront.js":!0, "externals/GLGE/src/extra/glge_particles.js":!0,
"externals/GLGE/src/extra/glge_input.js":!0, "externals/GLGE/src/extra/glge_filter2d.js":!0, "externals/GLGE/src/extra/glge_collada.js":!0, "externals/GLGE/src/extra/filters/glge_filter_scanlines.js":!0, "externals/GLGE/src/extra/filters/glge_filter_glow.js":!0, "externals/GLGE/src/extra/filters/glge_filter_ao.js":!0, "externals/protojs/protobuf.js":!0, "externals/protojs/pbj.js":!0, "katajs/gfx/WebGLCompat.js":!0, "katajs/gfx/glgegfx.js":!0, "katajs/gfx/TextGraphics.js":!0, "katajs/gfx/layer0.js":!0,
"katajs/gfx/layer1.js":!0, "katajs/gfx/layer2.js":!0, "katajs/gfx/layer2_no_sunbeams.js":!0, "katajs/core/Channel.js":!0, "katajs/core/Deque.js":!0, "katajs/core/FilterChannel.js":!0, "katajs/core/Location.js":!0, "katajs/core/Math.uuid.js":!0, "katajs/core/MessageDispatcher.js":!0, "katajs/core/ObjectID.js":!0, "katajs/core/PresenceID.js":!0, "katajs/core/Quaternion.js":!0, "katajs/core/SimpleChannel.js":!0, "katajs/core/SpaceID.js":!0, "katajs/core/Time.js":!0, "katajs/core/URL.js":!0, "katajs/core/WebWorker.js":!0,
"katajs/network/TCPSST.js":!0, "katajs/oh/behavior/NamedObject.js":!0, "katajs/oh/GraphicsScript.js":!0, "katajs/oh/GraphicsSimulation.js":!0, "katajs/oh/GUISimulation.js":!0, "katajs/oh/HostedObject.js":!0, "katajs/oh/impl/BootstrapScript.js":!0, "katajs/oh/impl/ScriptProtocol.js":!0, "katajs/oh/MainThread.js":!0, "katajs/oh/ObjectHost.js":!0, "katajs/oh/ObjectHostWorker.js":!0, "katajs/oh/odp/Endpoint.js":!0, "katajs/oh/odp/PortID.js":!0, "katajs/oh/odp/Port.js":!0, "katajs/oh/odp/Service.js":!0,
"katajs/oh/plugins/loop/LoopbackSpaceConnection.js":!0, "katajs/oh/plugins/sirikata/Frame.js":!0, "katajs/oh/plugins/sirikata/impl/AggregateBoundingInfo.pbj.js":!0, "katajs/oh/plugins/sirikata/impl/all.pbj.js":!0, "katajs/oh/plugins/sirikata/impl/Empty.pbj.js":!0, "katajs/oh/plugins/sirikata/impl/Frame.pbj.js":!0, "katajs/oh/plugins/sirikata/impl/Loc.pbj.js":!0, "katajs/oh/plugins/sirikata/impl/ObjectMessage.pbj.js":!0, "katajs/oh/plugins/sirikata/impl/Prox.pbj.js":!0, "katajs/oh/plugins/sirikata/impl/Session.pbj.js":!0,
"katajs/oh/plugins/sirikata/impl/SSTHeader.pbj.js":!0, "katajs/oh/plugins/sirikata/impl/TimedMotionQuaternion.pbj.js":!0, "katajs/oh/plugins/sirikata/impl/TimedMotionVector.pbj.js":!0, "katajs/oh/plugins/sirikata/impl/TimeSync.pbj.js":!0, "katajs/oh/plugins/sirikata/SirikataSpaceConnection.js":!0, "katajs/oh/plugins/sirikata/Sync.js":!0, "katajs/oh/Presence.js":!0, "katajs/oh/RemotePresence.js":!0, "katajs/oh/Script.js":!0, "katajs/oh/SessionManager.js":!0, "katajs/oh/Simulation.js":!0, "katajs/oh/SpaceConnection.js":!0,
"katajs/oh/sst/SSTImpl.js":!0, "katajs/space/loop/EveryoneProx.js":!0, "katajs/space/loop/Loc.js":!0, "katajs/space/loop/Space.js":!0, "katajs/space/loop/Subscription.js":!0};
var Kata, network_debug = !1, debug_console;
network_debug && (Kata = function() {
});
typeof Kata == "undefined" && (Kata = {});
typeof console == "undefined" ? (self.console = {}, debug_console = !1) : debug_console = !0;
typeof JSON == "undefined" && (JSON = {});
Kata.urlGetVars = new function(e) {
  function f(e) {
    if(g.test(e)) {
      return null
    }
    if(h.test(e)) {
      return e.toLowerCase() === "true"
    }
    if(isFinite(e)) {
      return parseFloat(e)
    }
    var f = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(e);
    if(f) {
      return new Date(Date.UTC(+f[1], +f[2] - 1, +f[3], +f[4], +f[5], +f[6]))
    }
    return e
  }
  var g = /^\s*$/, h = /^(true|false)$/i;
  if(e.length > 1) {
    for(var j = 0, m = e.substr(1).split("&");j < m.length;j++) {
      e = m[j].split("="), this[unescape(e[0])] = e.length > 1 ? f(unescape(e[1])) : null
    }
  }
}(self.location.search);
if(self.Kata_scriptRoot !== void 0) {
  Kata.scriptRoot = self.Kata_scriptRoot
}else {
  if(!Kata.scriptRoot) {
    Kata.scriptRoot = ""
  }
}
if(!Kata.queryString) {
  Kata.queryString = Kata.urlGetVars.v ? "?" + Kata.urlGetVars.v : ""
}
(function() {
  function e(e, f) {
    Kata._currentScript.push(e);
    try {
      f && f()
    }finally {
      Kata.getCurrentScript() != e && Kata.log("Error11: " + e + " != " + Kata.getCurrentScript(), Kata._currentScript), Kata._currentScript.pop(), e && Kata.setIncluded(e)
    }
  }
  function f(e) {
    function f(g) {
      return function() {
        delete m[e[g]];
        Kata.include(e[g])
      }
    }
    for(var h = 0;h < e.length;h++) {
      for(;g[e[h]];) {
        e.splice(h, 1)
      }
    }
    for(h = 0;h < e.length - 1;h++) {
      j[e[h]] = j[e[h]] || [], j[e[h]].push(f(h + 1)), m[e[h + 1]] = !0
    }
    e.length && (m[e[0]] || Kata.include(e[0]))
  }
  var g = Kata.closureIncluded || {"katajs/core/Core.js":!0}, h = {"katajs/core/Core.js":!0}, j = {}, m = {};
  Kata._currentScript = [];
  Kata.getCurrentScript = function() {
    return Kata._currentScript[Kata._currentScript.length - 1]
  };
  Kata.require = function(g, p, o) {
    function r(f) {
      q[f] && (delete q[f], t--, t == 0 && (o && delete m[o], e(o, p)))
    }
    if(o && o in h) {
      Kata.warn("JS file " + o + " included twice.")
    }else {
      if(!m[o]) {
        var s, q = {}, t = 0;
        for(s = 0;s < g.length;s++) {
          if(g[s].push) {
            for(var u = 0;u < g[s].length;u++) {
              !h[g[s][u]] && !(g[s][u] in q) && (q[g[s][u]] = !0, t++)
            }
          }else {
            !h[g[s]] && !(g[s] in q) && (q[g[s]] = !0, t++)
          }
        }
        if(t) {
          o && (m[o] = !0);
          for(s in q) {
            j[s] = j[s] || [], j[s].push(r)
          }
          for(s = 0;s < g.length;s++) {
            g[s].push ? f(g[s]) : m[g[s]] || Kata.include(g[s])
          }
        }else {
          p(), Kata.setIncluded(o)
        }
      }
    }
  };
  Kata.defer = function(e) {
    e && Kata.require([], e, null)
  };
  Kata.setIncluded = function(e) {
    if(e && !m[e]) {
      if(j[e]) {
        var f = j[e];
        delete j[e];
        for(var g = 0;g < f.length;g++) {
          f[g](e)
        }
      }
      h[e] = !0
    }
  };
  if(typeof importScripts != "undefined") {
    Kata.include = function(f) {
      g[f] || (g[f] = !0, e(f, function() {
        try {
          importScripts(Kata.scriptRoot + f + Kata.queryString)
        }catch(e) {
          throw Kata.log("Error in importScripts(" + Kata.scriptRoot + f + ")"), e;
        }
      }))
    }, Kata.evalInclude = Kata.include
  }else {
    if(typeof document != "undefined" && document.write) {
      for(var p = document.getElementsByTagName("script"), o = document.getElementsByTagName("head")[0], r = 0;r < p.length;r++) {
        var s = p[r].getAttribute("src");
        if(s) {
          var t = s.indexOf("katajs/core/Core.js");
          if(t != -1) {
            s = s.substr(0, t), s.length > 0 && s.slice(-1) != "/" && (s += "/"), Kata.scriptRoot = s
          }
        }
      }
      window.pendingScripts = {};
      Kata.include = function(e) {
        if(!g[e]) {
          g[e] = !0;
          var f;
          f = document.createElement("script");
          f.src = e.search("http") == 0 ? e : Kata.scriptRoot + e + Kata.queryString;
          f.type = "text/javascript";
          f.addEventListener("load", function() {
            Kata.getCurrentScript() && Kata.log("Error: " + e + " != " + Kata.getCurrentScript(), Kata._currentScript);
            Kata.setIncluded(e)
          }, !0);
          o.appendChild(f)
        }
      };
      Kata.evalInclude = Kata.include
    }
  }
  Kata.extend = function(e, f) {
    for(var g in f) {
      e.prototype[g] = f[g]
    }
    e.prototype.constructor = e;
    e.prototype.SUPER = f
  };
  Kata.bind = function(e, f) {
    if(arguments.length == 2) {
      return function() {
        return e.apply(f, arguments)
      }
    }else {
      for(var g = Array(arguments.length - 2), h = 2;h < arguments.length;++h) {
        g[h - 2] = arguments[h]
      }
      return function() {
        for(var h = arguments.length, j = Array(h), m = 0;m < h;++m) {
          j[m] = arguments[m]
        }
        return e.apply(f, g.concat(j))
      }
    }
  };
  Kata.stringify = function(e, f) {
    f || (f = "");
    var g = f + "}";
    f += "    ";
    var h;
    if(typeof e != "object" || e === null) {
      return"" + e
    }
    h = "{\n";
    for(var j in e) {
      h += f + j + ": " + Kata.stringify(e[j], f) + ",\n"
    }
    h += g;
    return h
  };
  Kata.log = console.log && console.log.apply && debug_console ? function() {
    console.log.apply(console, arguments)
  } : typeof document == "undefined" || typeof window == "undefined" ? console.log = function() {
    for(var e = [], f = 0;f < arguments.length;f++) {
      e[f] = arguments[f], typeof e[f] == "object" ? e[f] = Kata.stringify(e[f]) : typeof e[f] != "string" && (e[f] = "" + e[f])
    }
    self.postMessage({msg:q, debug:"log", contents:e})
  } : debug_console ? console.log = function() {
    window.status = "" + arguments[0];
    var e = document.createElement("p");
    e.style.border = "1px solid black";
    for(var f = e.style.margin = "0", g = 0;g < arguments.length;g++) {
      var h = arguments[g], j;
      typeof h != "object" || h.toString != Object.prototype.toString ? j = document.createElement("div") : (h = Kata.stringify(h), j = document.createElement("pre"));
      j.appendChild(document.createTextNode(h));
      j.style.margin = "0";
      j.style.padding = "5px";
      j.style.overflow = "auto";
      j.style.whiteSpace = "pre";
      j.style.border = "1px solid #ccc";
      j.style.marginLeft = f;
      f = "30px";
      e.appendChild(j)
    }
    document.body && document.body.appendChild(e)
  } : console.log = function() {
  };
  Kata.setStatus = function(e) {
    if(typeof window != "undefined") {
      window.status = e
    }
  };
  var q = "__magic_debug_msg_string";
  Kata.error = function(e) {
    if(typeof window == "undefined") {
      throw self.postMessage({msg:q, debug:"error", contents:e}), e;
    }
    console.log(e);
    typeof console.error != "undefined" && (Kata.setStatus(e), console.error && console.error(e), console.trace && console.trace())
  };
  Kata.warn = function(e, f) {
    if(typeof f == "undefined" || !f) {
      f = ""
    }
    if(typeof window == "undefined") {
      self.postMessage({msg:q, debug:"warn", type:f, contents:e})
    }else {
      var g = null;
      f && e ? g = f + ": " + e : f ? g = f : e && (g = e);
      console.log(g);
      Kata.setStatus(g)
    }
    console.trace && console.trace()
  };
  Kata.notImplemented = function(e) {
    Kata.log(e, "notImplemented")
  };
  var u = 1001;
  Kata.debugMessage = function(e, f) {
    if(f === void 0 || f === null || f.msg != q) {
      return!1
    }
    var g = 0;
    if(e) {
      if(!e.__debug_id) {
        e.__debug_id = u++
      }
      g = e.__debug_id
    }
    g = "<" + g + ">";
    switch(f.debug) {
      case "error":
        Kata.log(g + " " + f.contents);
        break;
      case "warn":
        Kata.log(g + f.type + ": " + f.contents);
        break;
      case "log":
        f.contents.splice(0, 0, g);
        Kata.log.apply(self, f.contents);
        break;
      default:
        Kata.error(g + " Unknown debug message type: " + f.debug)
    }
    return!0
  }
})();
typeof GLGE == "undefined" && (GLGE = {});
(function(e) {
  e.augment = function(e, f) {
    for(proto in e.prototype) {
      f.prototype[proto] = e.prototype[proto]
    }
  };
  e.makeGlobal = function() {
    for(var f in e) {
      window[f] = e[f]
    }
  };
  e.New = function(f) {
    return e[f].prototype.className != "" ? new e[f] : !1
  };
  e.TRUE = 1;
  e.FALSE = 0;
  e.GLOBAL = 0;
  e.LOCAL = 1;
  e.DRAW_TRIS = 1;
  e.DRAW_LINES = 2;
  e.DRAW_LINELOOPS = 3;
  e.DRAW_LINESTRIPS = 4;
  e.DRAW_POINTS = 5;
  e.RENDER_DEFAULT = 0;
  e.RENDER_SHADOW = 1;
  e.RENDER_PICK = 2;
  e.RENDER_NORMAL = 3;
  e.RENDER_EMIT = 4;
  e.RENDER_DEPTH = 5;
  e.RENDER_NULL = 6;
  e.TEXT_BOXPICK = 1;
  e.TEXT_TEXTPICK = 2;
  e.P_EULER = 1;
  e.P_QUAT = 2;
  e.P_MATRIX = 3;
  e.NONE = 0;
  e.XAXIS = 1;
  e.YAXIS = 2;
  e.ZAXIS = 3;
  e.POS_XAXIS = 1;
  e.NEG_XAXIS = 2;
  e.POS_YAXIS = 3;
  e.NEG_YAXIS = 4;
  e.POS_ZAXIS = 5;
  e.NEG_ZAXIS = 6;
  e.ZERO = "ZERO";
  e.ONE = "ONE";
  e.SRC_COLOR = "SRC_COLOR";
  e.ONE_MINUS_SRC_COLOR = "ONE_MINUS_SRC_COLOR";
  e.SRC_ALPHA = "SRC_ALPHA";
  e.ONE_MINUS_SRC_ALPHA = "ONE_MINUS_SRC_ALPHA";
  e.DST_ALPHA = "DST_ALPHA";
  e.ONE_MINUS_DST_ALPHA = "ONE_MINUS_DST_ALPHA";
  e.LINEAR_BLEND = function(e) {
    return e
  };
  e.QUAD_BLEND = function(e) {
    return e * e
  };
  e.SPECIAL_BLEND = function(e) {
    e *= 2 - e;
    return e * e
  };
  e.error = function(e) {
    console && console.log && console.log("GLGE error: " + e)
  };
  e.XMLHttpRequest = window.XMLHttpRequest;
  e.loadImage = function(e, f) {
    e.crossOrigin = "";
    e.src = f
  };
  e.Assets = {};
  e.Assets.assets = {};
  e.REGISTER_ASSETS = !1;
  e.Assets.createUUID = function() {
    var e = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "A", "B", "C", "D", "E", "F"], f = ["8", "9", "A", "B"];
    uuid = "";
    for(var j = 0;j < 38;j++) {
      switch(j) {
        case 8:
          uuid += "-";
          break;
        case 13:
          uuid += "-";
          break;
        case 18:
          uuid += "-";
          break;
        case 14:
          uuid += "4";
          break;
        case 19:
          uuid += f[Math.round(Math.random() * 3)];
          break;
        default:
          uuid += e[Math.round(Math.random() * 15)]
      }
    }
    return uuid
  };
  e.Assets.registerAsset = function(f, h) {
    if(e.REGISTER_ASSETS) {
      h || (h = e.Assets.createUUID()), f.uid = h, e.Assets.assets[h] = f
    }
  };
  e.Assets.unregisterAsset = function(f) {
    delete e.Assets.assets[f]
  };
  e.Assets.get = function(f) {
    return(f = e.Assets.assets[f]) ? f : !1
  };
  e.DJBHash = function(e) {
    for(var f = 5381, j = 0;j < e.length;j++) {
      f = (f << 5) + f + e.charCodeAt(j)
    }
    return f
  };
  e.getGLShader = function(f, h, j) {
    var m = e.DJBHash(j);
    if(!f.shaderCache) {
      f.shaderCache = {}
    }
    if(!f.shaderCache[m]) {
      h = f.createShader(h);
      f.shaderSource(h, j);
      f.compileShader(h);
      if(!f.getShaderParameter(h, f.COMPILE_STATUS)) {
        try {
          e.error(f.getShaderInfoLog(h));
          return
        }catch(p) {
        }
      }
      f.shaderCache[m] = h
    }
    return f.shaderCache[m]
  };
  var f = 0;
  e.getGLProgram = function(g, h, j) {
    if(!g.programCache) {
      g.programCache = []
    }
    for(var m = g.programCache, p = 0;p < m.length;p++) {
      if(m[p].fShader == j && m[p].vShader == h) {
        return m[p].program
      }
    }
    var o = g.createProgram();
    o.progIdx = f++;
    g.attachShader(o, h);
    g.attachShader(o, j);
    g.linkProgram(o);
    g.getProgramParameter(o, g.LINK_STATUS) || e.error("Couldn't link shader: " + g.getProgramInfoLog(o));
    m.push({vShader:h, fShader:j, program:o});
    if(!o.uniformDetails) {
      o.uniformDetails = {};
      h = g.getProgramParameter(o, g.ACTIVE_UNIFORMS);
      for(p = 0;p < h;++p) {
        j = g.getActiveUniform(o, p), o.uniformDetails[j.name] = {loc:e.getUniformLocation(g, o, j.name), info:j}
      }
    }
    return o
  };
  e.getUniformLocation = function(e, f, j) {
    if(!f.uniformCache) {
      f.uniformCache = {}
    }
    if(!f.uniformChecked) {
      f.uniformChecked = {}
    }
    f.uniformChecked[j] || (f.uniformCache[j] = e.getUniformLocation(f, j), f.uniformChecked[j] = !0);
    return f.uniformCache[j]
  };
  e.setUniform = function(e, f, j, m) {
    typeof m == "string" && (m = +m);
    if(j != null) {
      e["uniform" + f](j, m)
    }
  };
  e.setUniform3 = function(e, f, j, m, p, o) {
    typeof m == "string" && (m = +m);
    typeof p == "string" && (p = +p);
    typeof o == "string" && (o = +o);
    if(j != null) {
      e["uniform" + f](j, m, p, o)
    }
  };
  e.setUniform2 = function(e, f, j, m, p) {
    typeof m == "string" && (m = +m);
    typeof p == "string" && (p = +p);
    if(j != null) {
      e["uniform" + f](j, m, p)
    }
  };
  e.setUniform4 = function(e, f, j, m, p, o, r) {
    if(j != null) {
      e["uniform" + f](j, m, p, o, r)
    }
  };
  e.setUniformMatrix = function(e, f, j, m, p) {
    if(j != null) {
      e["uniform" + f](j, m, p)
    }
  };
  e.getAttribLocation = function(e, f, j) {
    if(!f.attribCache) {
      f.attribCache = {}
    }
    f.attribCache[j] == void 0 && (f.attribCache[j] = e.getAttribLocation(f, j));
    return f.attribCache[j]
  };
  e.colorParse = function(e) {
    var f, j, m, p, o = {aliceblue:"f0f8ff", antiquewhite:"faebd7", aqua:"00ffff", aquamarine:"7fffd4", azure:"f0ffff", beige:"f5f5dc", bisque:"ffe4c4", black:"000000", blanchedalmond:"ffebcd", blue:"0000ff", blueviolet:"8a2be2", brown:"a52a2a", burlywood:"deb887", cadetblue:"5f9ea0", chartreuse:"7fff00", chocolate:"d2691e", coral:"ff7f50", cornflowerblue:"6495ed", cornsilk:"fff8dc", crimson:"dc143c", cyan:"00ffff", darkblue:"00008b", darkcyan:"008b8b", darkgoldenrod:"b8860b", darkgray:"a9a9a9",
    darkgreen:"006400", darkkhaki:"bdb76b", darkmagenta:"8b008b", darkolivegreen:"556b2f", darkorange:"ff8c00", darkorchid:"9932cc", darkred:"8b0000", darksalmon:"e9967a", darkseagreen:"8fbc8f", darkslateblue:"483d8b", darkslategray:"2f4f4f", darkturquoise:"00ced1", darkviolet:"9400d3", deeppink:"ff1493", deepskyblue:"00bfff", dimgray:"696969", dodgerblue:"1e90ff", feldspar:"d19275", firebrick:"b22222", floralwhite:"fffaf0", forestgreen:"228b22", fuchsia:"ff00ff", gainsboro:"dcdcdc", ghostwhite:"f8f8ff",
    gold:"ffd700", goldenrod:"daa520", gray:"808080", green:"008000", greenyellow:"adff2f", honeydew:"f0fff0", hotpink:"ff69b4", indianred:"cd5c5c", indigo:"4b0082", ivory:"fffff0", khaki:"f0e68c", lavender:"e6e6fa", lavenderblush:"fff0f5", lawngreen:"7cfc00", lemonchiffon:"fffacd", lightblue:"add8e6", lightcoral:"f08080", lightcyan:"e0ffff", lightgoldenrodyellow:"fafad2", lightgrey:"d3d3d3", lightgreen:"90ee90", lightpink:"ffb6c1", lightsalmon:"ffa07a", lightseagreen:"20b2aa", lightskyblue:"87cefa",
    lightslateblue:"8470ff", lightslategray:"778899", lightsteelblue:"b0c4de", lightyellow:"ffffe0", lime:"00ff00", limegreen:"32cd32", linen:"faf0e6", magenta:"ff00ff", maroon:"800000", mediumaquamarine:"66cdaa", mediumblue:"0000cd", mediumorchid:"ba55d3", mediumpurple:"9370d8", mediumseagreen:"3cb371", mediumslateblue:"7b68ee", mediumspringgreen:"00fa9a", mediumturquoise:"48d1cc", mediumvioletred:"c71585", midnightblue:"191970", mintcream:"f5fffa", mistyrose:"ffe4e1", moccasin:"ffe4b5", navajowhite:"ffdead",
    navy:"000080", oldlace:"fdf5e6", olive:"808000", olivedrab:"6b8e23", orange:"ffa500", orangered:"ff4500", orchid:"da70d6", palegoldenrod:"eee8aa", palegreen:"98fb98", paleturquoise:"afeeee", palevioletred:"d87093", papayawhip:"ffefd5", peachpuff:"ffdab9", peru:"cd853f", pink:"ffc0cb", plum:"dda0dd", powderblue:"b0e0e6", purple:"800080", red:"ff0000", rosybrown:"bc8f8f", royalblue:"4169e1", saddlebrown:"8b4513", salmon:"fa8072", sandybrown:"f4a460", seagreen:"2e8b57", seashell:"fff5ee", sienna:"a0522d",
    silver:"c0c0c0", skyblue:"87ceeb", slateblue:"6a5acd", slategray:"708090", snow:"fffafa", springgreen:"00ff7f", steelblue:"4682b4", tan:"d2b48c", teal:"008080", thistle:"d8bfd8", tomato:"ff6347", turquoise:"40e0d0", violet:"ee82ee", violetred:"d02090", wheat:"f5deb3", white:"ffffff", whitesmoke:"f5f5f5", yellow:"ffff00", yellowgreen:"9acd32"};
    o[e] && (e = "#" + o[e]);
    e.substr && e.substr(0, 1) == "#" ? (e = e.substr(1), e.length == 8 ? (f = parseInt("0x" + e.substr(0, 2)) / 255, j = parseInt("0x" + e.substr(2, 2)) / 255, m = parseInt("0x" + e.substr(4, 2)) / 255, p = parseInt("0x" + e.substr(6, 2)) / 255) : e.length == 4 ? (f = parseInt("0x" + e.substr(0, 1)) / 15, j = parseInt("0x" + e.substr(1, 1)) / 15, m = parseInt("0x" + e.substr(2, 1)) / 15, p = parseInt("0x" + e.substr(3, 1)) / 15) : e.length == 6 ? (f = parseInt("0x" + e.substr(0, 2)) / 255, j = parseInt("0x" +
    e.substr(2, 2)) / 255, m = parseInt("0x" + e.substr(4, 2)) / 255, p = 1) : e.length == 3 && (f = parseInt("0x" + e.substr(0, 1)) / 15, j = parseInt("0x" + e.substr(1, 1)) / 15, m = parseInt("0x" + e.substr(2, 1)) / 15, p = 1)) : e.substr && e.substr(0, 4) == "rgb(" ? (e = e.substr(4).split(","), f = parseInt(e[0]) / 255, j = parseInt(e[1]) / 255, m = parseInt(e[2]) / 255, p = 1) : e.substr && e.substr(0, 5) == "rgba(" ? (e = e.substr(4).split(","), f = parseInt(e[0]) / 255, j = parseInt(e[1]) /
    255, m = parseInt(e[2]) / 255, p = parseInt(e[3]) / 255) : p = m = j = f = 0;
    return{r:f, g:j, b:m, a:p}
  }
})(GLGE);
typeof GLGE == "undefined" && (GLGE = {});
(function(e) {
  var f = [];
  e.reuseMatrix4 = function() {
  };
  e.matrix4 = function(e, h, j, m, p, o, r, s, t, q, u, v, w, B, A, D) {
    if(f.length == 0) {
      var C = [e, h, j, m, p, o, r, s, t, q, u, v, w, B, A, D]
    }else {
      C = f.shift(), C[0] = e, C[1] = h, C[2] = j, C[3] = m, C[4] = p, C[5] = o, C[6] = r, C[7] = s, C[8] = t, C[9] = q, C[10] = u, C[11] = v, C[12] = w, C[13] = B, C[14] = A, C[15] = D
    }
    return C
  };
  e.Vec = function(e) {
    return e.slice(0)
  };
  e.Vec3 = function(e, f, j) {
    return[e, f, j]
  };
  e.Vec4 = function(e, f, j, m) {
    return[e, f, j, m]
  };
  e.get1basedVec4 = function(e, f) {
    return e[f - 1]
  };
  e.get1basedVec3 = function(e, f) {
    return e[f - 1]
  };
  e.getVec4 = function(e, f) {
    return e[f]
  };
  e.getVec3 = function(e, f) {
    return e[f]
  };
  e.addVec4 = function(e, f) {
    return[e[0] + f[0], e[1] + f[1], e[2] + f[2], e[3] + f[3]]
  };
  e.addVec3 = function(e, f) {
    return[e[0] + f[0], e[1] + f[1], e[2] + f[2]]
  };
  e.subVec4 = function(e, f) {
    return[e[0] - f[0], e[1] - f[1], e[2] - f[2], e[3] - f[3]]
  };
  e.subVec3 = function(e, f) {
    return[e[0] - f[0], e[1] - f[1], e[2] - f[2]]
  };
  e.dotVec3 = function(e, f) {
    return e[0] * f[0] + e[1] * f[1] + e[2] * f[2]
  };
  e.dotVec4 = function(e, f) {
    return e[0] * f[0] + e[1] * f[1] + e[2] * f[2] + e[3] * f[3]
  };
  e.scaleVec4 = function(e, f) {
    return[e[0] * f, e[1] * f, e[2] * f, e[3] * f]
  };
  e.scaleVec3 = function(e, f) {
    return[e[0] * f, e[1] * f, e[2] * f]
  };
  e.crossVec3 = function(e, f) {
    return[e[1] * f[2] - e[2] * f[1], e[2] * f[0] - e[0] * f[2], e[0] * f[1] - e[1] * f[0]]
  };
  e.toUnitVec3 = function(e) {
    var f = e[0] * e[0] + e[1] * e[1] + e[2] * e[2], j = 1;
    f > 0 && (j = Math.pow(f, 0.5));
    return[e[0] / j, e[1] / j, e[2] / j]
  };
  e.toUnitVec4 = function(e) {
    var f = e[0] * e[0] + e[1] * e[1] + e[2] * e[2] + e[3] * e[3], j = 1;
    f > 0 && (j = Math.pow(f, 0.5));
    return[e[0] / j, e[1] / j, e[2] / j, e[3] / j]
  };
  e.lengthVec3 = function(e) {
    return Math.pow(e[0] * e[0] + e[1] * e[1] + e[2] * e[2], 0.5)
  };
  e.distanceVec3 = function(f, h) {
    return e.lengthVec3(e.subVec3(f, h))
  };
  e.lengthVec4 = function(e) {
    return Math.pow(e[0] * e[0] + e[1] * e[1] + e[2] * e[2] + e[3] * e[3], 0.5)
  };
  e.distanceVec4 = function(f, h) {
    return e.lengthVec4(e.subVec4(f, h))
  };
  e.angleVec3 = function(f, h) {
    f = e.toUnitVec3(f);
    h = e.toUnitVec3(h);
    d = e.dotVec3(f, h);
    d < -1 && (d = -1);
    d > 1 && (d = 1);
    return Math.acos(d)
  };
  e.angleVec4 = function(f, h) {
    f = e.toUnitVec4(f);
    h = e.toUnitVec4(h);
    d = e.dotVec4(f, h);
    d < -1 && (d = -1);
    d > 1 && (d = 1);
    return Math.acos(d)
  };
  GLGE_math_use_webgl_float = !1;
  e.Mat3 = GLGE_math_use_webgl_float ? function(e) {
    if(e.length == 9) {
      return new Float32Array(e)
    }else {
      if(e.length == 16) {
        return new Float32Array([e[0], e[1], e[2], e[4], e[5], e[6], e[8], e[9], e[10]])
      }else {
        throw"invalid matrix length";
      }
    }
  } : function(e) {
    if(e.length == 9) {
      e = e.slice(0)
    }else {
      if(e.length == 16) {
        e = [e[0], e[1], e[2], e[4], e[5], e[6], e[8], e[9], e[10]]
      }else {
        throw"invalid matrix length";
      }
    }
    e.get = function(e) {
      return this[e]
    };
    return e
  };
  e.Mat = GLGE_math_use_webgl_float ? function(e) {
    return new Float32Array(e)
  } : function(e) {
    e = e.slice(0);
    e.get = function(e) {
      return this[e]
    };
    return e
  };
  e.Mat4 = function(e) {
    if(e.length == 9) {
      e = [e[0], e[1], e[2], 0, e[3], e[4], e[5], 0, e[6], e[7], e[8], 0, 0, 0, 0, 1]
    }else {
      if(e.length == 16) {
        e = e.slice ? e.slice(0) : e.subarray(0)
      }else {
        throw"invalid matrix length";
      }
    }
    e.get = function(e) {
      return this[e]
    };
    return e
  };
  e.determinantMat4 = function(e) {
    return e[12] * e[9] * e[6] * e[3] - e[8] * e[13] * e[6] * e[3] - e[12] * e[5] * e[10] * e[3] + e[4] * e[13] * e[10] * e[3] + e[8] * e[5] * e[14] * e[3] - e[4] * e[9] * e[14] * e[3] - e[12] * e[9] * e[2] * e[7] + e[8] * e[13] * e[2] * e[7] + e[12] * e[1] * e[10] * e[7] - e[0] * e[13] * e[10] * e[7] - e[8] * e[1] * e[14] * e[7] + e[0] * e[9] * e[14] * e[7] + e[12] * e[5] * e[2] * e[11] - e[4] * e[13] * e[2] * e[11] - e[12] * e[1] * e[6] * e[11] + e[0] * e[13] * e[6] * e[11] + e[4] * e[1] * e[14] *
    e[11] - e[0] * e[5] * e[14] * e[11] - e[8] * e[5] * e[2] * e[15] + e[4] * e[9] * e[2] * e[15] + e[8] * e[1] * e[6] * e[15] - e[0] * e[9] * e[6] * e[15] - e[4] * e[1] * e[10] * e[15] + e[0] * e[5] * e[10] * e[15]
  };
  e.inverseMat4 = function(f) {
    var h = f[0], j = f[1], m = f[2], p = f[3], o = f[4], r = f[5], s = f[6], t = f[7], q = f[8], u = f[9], v = f[10], w = f[11], B = f[12], A = f[13], D = f[14], f = f[15], C = B * u * s * p - q * A * s * p - B * r * v * p + o * A * v * p + q * r * D * p - o * u * D * p - B * u * m * t + q * A * m * t + B * j * v * t - h * A * v * t - q * j * D * t + h * u * D * t + B * r * m * w - o * A * m * w - B * j * s * w + h * A * s * w + o * j * D * w - h * r * D * w - q * r * m * f + o * u * m * f + q *
    j * s * f - h * u * s * f - o * j * v * f + h * r * v * f;
    return e.matrix4((u * D * t - A * v * t + A * s * w - r * D * w - u * s * f + r * v * f) / C, (A * v * p - u * D * p - A * m * w + j * D * w + u * m * f - j * v * f) / C, (r * D * p - A * s * p + A * m * t - j * D * t - r * m * f + j * s * f) / C, (u * s * p - r * v * p - u * m * t + j * v * t + r * m * w - j * s * w) / C, (B * v * t - q * D * t - B * s * w + o * D * w + q * s * f - o * v * f) / C, (q * D * p - B * v * p + B * m * w - h * D * w - q * m * f + h * v * f) / C, (B * s * p - o * D *
    p - B * m * t + h * D * t + o * m * f - h * s * f) / C, (o * v * p - q * s * p + q * m * t - h * v * t - o * m * w + h * s * w) / C, (q * A * t - B * u * t + B * r * w - o * A * w - q * r * f + o * u * f) / C, (B * u * p - q * A * p - B * j * w + h * A * w + q * j * f - h * u * f) / C, (o * A * p - B * r * p + B * j * t - h * A * t - o * j * f + h * r * f) / C, (q * r * p - o * u * p - q * j * t + h * u * t + o * j * w - h * r * w) / C, (B * u * s - q * A * s - B * r * v + o * A * v + q * r *
    D - o * u * D) / C, (q * A * m - B * u * m + B * j * v - h * A * v - q * j * D + h * u * D) / C, (B * r * m - o * A * m - B * j * s + h * A * s + o * j * D - h * r * D) / C, (o * u * m - q * r * m + q * j * s - h * u * s - o * j * v + h * r * v) / C)
  };
  e.mulMat4Vec3 = function(f, h) {
    return e.Vec3(f[0] * h[0] + f[1] * h[1] + f[2] * h[2] + f[3], f[4] * h[0] + f[5] * h[1] + f[6] * h[2] + f[7], f[8] * h[0] + f[9] * h[1] + f[10] * h[2] + f[11])
  };
  e.mulMat4Vec4 = function(f, h) {
    return e.Vec4(f[0] * h[0] + f[1] * h[1] + f[2] * h[2] + f[3] * h[3], f[4] * h[0] + f[5] * h[1] + f[6] * h[2] + f[7] * h[3], f[8] * h[0] + f[9] * h[1] + f[10] * h[2] + f[11] * h[3], f[12] * h[0] + f[13] * h[1] + f[14] * h[2] + f[15] * h[3])
  };
  e.scaleMat4 = function(f, h) {
    return e.matrix4([f[0] * h, f[1] * h, f[2] * h, f[3] * h, f[4] * h, f[5] * h, f[6] * h, f[7] * h, f[8] * h, f[9] * h, f[10] * h, f[11] * h, f[12] * h, f[13] * h, f[14] * h, f[15] * h])
  };
  e.scaleInPlaceMat4 = function(e, f) {
    e.set(0, e[0] * f);
    e.set(1, e[1] * f);
    e.set(2, e[2] * f);
    e.set(3, e[3] * f);
    e.set(4, e[4] * f);
    e.set(5, e[5] * f);
    e.set(6, e[6] * f);
    e.set(7, e[7] * f);
    e.set(8, e[8] * f);
    e.set(9, e[9] * f);
    e.set(10, e[10] * f);
    e.set(11, e[11] * f);
    e.set(12, e[12] * f);
    e.set(13, e[13] * f);
    e.set(14, e[14] * f);
    e.set(15, e[15] * f);
    return e
  };
  e.addInPlaceMat4 = function(e, f) {
    e.set(0, e[0] + f[0]);
    e.set(1, e[1] + f[1]);
    e.set(2, e[2] + f[2]);
    e.set(3, e[3] + f[3]);
    e.set(4, e[4] + f[4]);
    e.set(5, e[5] + f[5]);
    e.set(6, e[6] + f[6]);
    e.set(7, e[7] + f[7]);
    e.set(8, e[8] + f[8]);
    e.set(9, e[9] + f[9]);
    e.set(10, e[10] + f[10]);
    e.set(11, e[11] + f[11]);
    e.set(12, e[12] + f[12]);
    e.set(13, e[13] + f[13]);
    e.set(14, e[14] + f[14]);
    e.set(15, e[15] + f[15]);
    return e
  };
  e.addMat4 = function(f, h) {
    return e.Mat([f[0] + h[0], f[1] + h[1], f[2] + h[2], f[3] + h[3], f[4] + h[4], f[5] + h[5], f[6] + h[6], f[7] + h[7], f[8] + h[8], f[9] + h[9], f[10] + h[10], f[11] + h[11], f[12] + h[12], f[13] + h[13], f[14] + h[14], f[15] + h[15]])
  };
  e.subInPlaceMat4 = function(e, f) {
    e.set(0, e[0] - f[0]);
    e.set(1, e[1] - f[1]);
    e.set(2, e[2] - f[2]);
    e.set(3, e[3] - f[3]);
    e.set(4, e[4] - f[4]);
    e.set(5, e[5] - f[5]);
    e.set(6, e[6] - f[6]);
    e.set(7, e[7] - f[7]);
    e.set(8, e[8] - f[8]);
    e.set(9, e[9] - f[9]);
    e.set(10, e[10] - f[10]);
    e.set(11, e[11] - f[11]);
    e.set(12, e[12] - f[12]);
    e.set(13, e[13] - f[13]);
    e.set(14, e[14] - f[14]);
    e.set(15, e[15] - f[15]);
    return e
  };
  e.subMat4 = function(f, h) {
    return e.Mat([f[0] - h[0], f[1] - h[1], f[2] - h[2], f[3] - h[3], f[4] - h[4], f[5] - h[5], f[6] - h[6], f[7] - h[7], f[8] - h[8], f[9] - h[9], f[10] - h[10], f[11] - h[11], f[12] - h[12], f[13] - h[13], f[14] - h[14], f[15] - h[15]])
  };
  e.mulMat4 = function(f, h) {
    var j = h[0], m = h[1], p = h[2], o = h[3], r = h[4], s = h[5], t = h[6], q = h[7], u = h[8], v = h[9], w = h[10], B = h[11], A = h[12], D = h[13], C = h[14], G = h[15], E = f[0], J = f[1], F = f[2], H = f[3], I = f[4], K = f[5], L = f[6], M = f[7], N = f[8], O = f[9], P = f[10], Q = f[11], R = f[12], S = f[13], T = f[14], U = f[15];
    return e.matrix4(E * j + J * r + F * u + H * A, E * m + J * s + F * v + H * D, E * p + J * t + F * w + H * C, E * o + J * q + F * B + H * G, I * j + K * r + L * u + M * A, I * m + K * s + L * v + M * D, I * p + K * t + L * w + M * C, I * o + K * q + L * B + M * G, N * j + O * r + P * u + Q * A, N * m + O * s + P * v + Q * D, N * p + O * t + P * w + Q * C, N * o + O * q + P * B + Q * G, R * j + S * r + T * u + U * A, R * m + S * s + T * v + U * D, R * p + S * t + T * w + U * C, R * o + S * q +
    T * B + U * G)
  };
  e.transposeInPlaceMat4 = function(e) {
    var f = e[1];
    e.set(1, e[4]);
    e.set(4, f);
    f = e[8];
    e.set(8, e[2]);
    e.set(2, f);
    f = e[3];
    e.set(3, e[12]);
    e.set(12, f);
    f = e[9];
    e.set(9, e[6]);
    e.set(6, f);
    f = e[13];
    e.set(13, e[7]);
    e.set(7, f);
    f = e[14];
    e.set(14, e[11]);
    e.set(11, f)
  };
  e.transposeMat4 = function(f) {
    return e.matrix4(f[0], f[4], f[8], f[12], f[1], f[5], f[9], f[13], f[2], f[6], f[10], f[14], f[3], f[7], f[11], f[15])
  };
  e.mat4gl = function(e, f) {
    f[0] = e[0];
    f[1] = e[1];
    f[2] = e[2];
    f[3] = e[3];
    f[4] = e[4];
    f[5] = e[5];
    f[6] = e[6];
    f[7] = e[7];
    f[8] = e[8];
    f[9] = e[9];
    f[10] = e[10];
    f[11] = e[11];
    f[12] = e[12];
    f[13] = e[13];
    f[14] = e[14];
    f[15] = e[15]
  };
  e.set1basedMat4 = function(e, f, j, m) {
    e[(f - 1) * 4 + (j - 1)] = m;
    e.glData !== void 0 && delete e.glData
  };
  e.setMat4 = function(e, f, j, m) {
    e[f * 4 + j] = m;
    e.glData !== void 0 && delete e.glData
  };
  e.get1basedMat4 = function(e, f, j) {
    return e.get((f - 1) * 4 + (j - 1))
  };
  e.getMat4 = function(e, f, j) {
    return e[f * 4 + j]
  };
  e.glDataMat4 = function(e) {
    e.glArray = new Float32Array(e);
    return e.glArray
  };
  e.identMatrix = function() {
    return e.matrix4(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1)
  };
  e.translateMatrix = function(f) {
    var h, j, m;
    arguments.length == 3 ? (h = arguments[0], j = arguments[1], m = arguments[2]) : f.data ? (h = f.data[0], j = f.data[1], m = f.data[2]) : f instanceof Array && (h = f[0], j = f[1], m = f[2]);
    return e.matrix4(1, 0, 0, h, 0, 1, 0, j, 0, 0, 1, m, 0, 0, 0, 1)
  };
  e.scaleMatrix = function(f) {
    var h, j, m;
    arguments.length == 3 ? (h = arguments[0], j = arguments[1], m = arguments[2]) : f.data ? (h = f.data[0], j = f.data[1], m = f.data[2]) : f instanceof Array && (h = f[0], j = f[1], m = f[2]);
    return e.matrix4(h, 0, 0, 0, 0, j, 0, 0, 0, 0, m, 0, 0, 0, 0, 1)
  };
  e.ROT_XYZ = 1;
  e.ROT_XZY = 2;
  e.ROT_YXZ = 3;
  e.ROT_YZX = 4;
  e.ROT_ZXY = 5;
  e.ROT_ZYX = 6;
  e.rotateMatrix = function(f, h) {
    var j, m, p;
    arguments.length > 2 ? (j = arguments[0], m = arguments[1], p = arguments[2], h = arguments[3]) : f.data ? (j = f.data[0], m = f.data[1], p = f.data[2]) : f instanceof Array && (j = f[0], m = f[1], p = f[2]);
    if(!h) {
      h = e.ROT_XYZ
    }
    var o = Math.cos(j), r = Math.sin(j);
    j = Math.cos(m);
    var s = Math.sin(m);
    m = Math.cos(p);
    p = Math.sin(p);
    o = e.matrix4(1, 0, 0, 0, 0, o, -r, 0, 0, r, o, 0, 0, 0, 0, 1);
    j = e.matrix4(j, 0, s, 0, 0, 1, 0, 0, -s, 0, j, 0, 0, 0, 0, 1);
    m = e.matrix4(m, -p, 0, 0, p, m, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
    switch(h) {
      case e.ROT_XYZ:
        return e.mulMat4(o, e.mulMat4(j, m));
      case e.ROT_XZY:
        return e.mulMat4(o, e.mulMat4(m, j));
      case e.ROT_YXZ:
        return e.mulMat4(j, e.mulMat4(o, m));
      case e.ROT_YZX:
        return e.mulMat4(j, e.mulMat4(m, o));
      case e.ROT_ZXY:
        return e.mulMat4(m, e.mulMat4(o, j));
      case e.ROT_ZYX:
        return e.mulMat4(m, e.mulMat4(j, o))
    }
  };
  e.angleAxis = function(f, h) {
    var j, m, p, o, r, s, h = [h[0], h[1], h[2], 0], t = h[0], q = h[1], u = h[2], v = Math.cos(f), w = 1 - v;
    m = Math.sin(f);
    j = t * m;
    r = q * m;
    s = u * m;
    m = t * q;
    p = q * u;
    o = u * t;
    j = e.matrix4(w * t * t + v, w * m - s, w * o + r, 0, w * m + s, w * q * q + v, w * p - j, 0, w * o - r, w * p + j, w * u * u + v, 0, 0, 0, 0, 1);
    return e.Mat(j)
  };
  e.quatFromAxisAngle = function(e, f) {
    var j = [], m = f * 0.5, p = Math.sin(m), m = Math.cos(m);
    j[0] = e[0] * p;
    j[1] = e[1] * p;
    j[2] = e[2] * p;
    j[3] = m;
    return j
  };
  e.mulQuat = function(e, f) {
    var j = [], m = e[0], p = e[1], o = e[2], r = e[3], s = f[0], t = f[1], q = f[2], u = f[3];
    j[0] = m * u + s * r + (p * q - o * t);
    j[1] = p * u + t * r + (o * s - m * q);
    j[2] = o * u + q * r + (m * t - p * s);
    j[3] = r * u - (m * s + p * t + o * q);
    return j
  };
  e.mat4FromQuat = function(e) {
    var f = e[0] * e[0], j = e[1] * e[1], m = e[2] * e[2], p = e[0] * e[1], o = e[2] * e[3], r = e[2] * e[0], s = e[1] * e[3], t = e[1] * e[2], e = e[0] * e[3], q = [];
    q[0] = 1 - 2 * (j + m);
    q[1] = 2 * (p + o);
    q[2] = 2 * (r - s);
    q[3] = 0;
    q[4] = 2 * (p - o);
    q[5] = 1 - 2 * (m + f);
    q[6] = 2 * (t + e);
    q[7] = 0;
    q[8] = 2 * (r + s);
    q[9] = 2 * (t - e);
    q[10] = 1 - 2 * (j + f);
    q[11] = 0;
    q[12] = 0;
    q[13] = 0;
    q[14] = 0;
    q[15] = 1;
    return q
  };
  e.quatRotation = function(f, h, j, m) {
    return e.matrix4(1 - 2 * h * h - 2 * j * j, 2 * f * h - 2 * j * m, 2 * f * j + 2 * h * m, 0, 2 * f * h + 2 * j * m, 1 - 2 * f * f - 2 * j * j, 2 * h * j - 2 * f * m, 0, 2 * f * j - 2 * h * m, 2 * h * j + 2 * f * m, 1 - 2 * f * f - 2 * h * h, 0, 0, 0, 0, 1)
  };
  e.makeOrtho = function(f, h, j, m, p, o) {
    return e.matrix4(2 / (h - f), 0, 0, -(h + f) / (h - f), 0, 2 / (m - j), 0, -(m + j) / (m - j), 0, 0, -2 / (o - p), -(o + p) / (o - p), 0, 0, 0, 1)
  };
  e.makeFrustum = function(f, h, j, m, p, o) {
    return e.matrix4(2 * p / (h - f), 0, (h + f) / (h - f), 0, 0, 2 * p / (m - j), (m + j) / (m - j), 0, 0, 0, -(o + p) / (o - p), -2 * o * p / (o - p), 0, 0, -1, 0)
  };
  e.makePerspective = function(f, h, j, m) {
    var f = j * Math.tan(f * 0.00872664625972), p = -f;
    return e.makeFrustum(p * h, f * h, p, f, j, m)
  };
  e.matrix2Scale = function(e) {
    var f = e[0], j = e[1], m = e[2], p = e[4], o = e[5], r = e[6], s = e[8], t = e[9], e = e[10];
    return[Math.sqrt(f * f + j * j + m * m), Math.sqrt(p * p + o * o + r * r), Math.sqrt(s * s + t * t + e * e)]
  };
  e.rotationMatrix2Quat = function(e) {
    var f = e[0] + e[5] + e[10] + 1, j, m, p;
    f > 0 ? (j = 0.5 / Math.sqrt(f), p = 0.25 / j, f = (e[9] - e[6]) * j, m = (e[2] - e[8]) * j, e = (e[4] - e[1]) * j) : e[0] > e[5] && e[0] > e[10] ? (j = Math.sqrt(1 + e[0] - e[5] - e[10]) * 2, p = (e[9] - e[6]) / j, f = 0.25 / j, m = (e[1] + e[4]) / j, e = (e[2] + e[8]) / j) : e[5] > e[10] ? (j = Math.sqrt(1 + e[5] - e[0] - e[10]) * 2, p = (e[2] - e[8]) / j, f = (e[1] + e[4]) / j, m = 0.25 / j, e = (e[6] + e[9]) / j) : (j = Math.sqrt(1 + e[10] - e[0] - e[5]) * 2, p = (e[4] - e[1]) / j, f = (e[2] +
    e[8]) / j, m = (e[6] + e[9]) / j, e = 0.25 / j);
    j = Math.sqrt(f * f + m * m + e * e + p * p);
    return[f / j, m / j, e / j, p / j]
  };
  e.rayToPlane = function(f, h) {
    var j = e.toUnitVec3(h);
    return[j[0], j[1], j[2], e.dotVec3(f, j)]
  };
  e.rayIntersectPlane = function(f, h, j) {
    var m = [j[0], j[1], j[2]], j = j[3], p = e.dotVec3(m, h);
    if(p <= 0) {
      return!1
    }
    m = -(e.dotVec3(m, f) + j) / p;
    if(m <= 0) {
      return!1
    }
    return e.addVec3(f, e.scaleVec3(h, m))
  };
  e.screenToDirection = function(f, h, j, m, p) {
    xcoord = -(2 * f / j - 1) / p[0];
    ycoord = (2 * h / m - 1) / p[5];
    zcoord = 1;
    return e.toUnitVec3([xcoord, ycoord, zcoord])
  };
  e.BoundingVolume = function(e, f, j, m, p, o) {
    this.limits = [e, f, j, m, p, o];
    this.calcProps()
  };
  e.BoundingVolume.prototype.getCornerPoints = function() {
    return this.points
  };
  e.BoundingVolume.prototype.getSphereRadius = function() {
    return this.radius
  };
  e.BoundingVolume.prototype.getCenter = function() {
    return this.center
  };
  e.BoundingVolume.prototype.isNull = function() {
    return this.limits[0] == 0 && this.limits[1] == 0 && this.limits[2] == 0 && this.limits[3] == 0 && this.limits[4] == 0 && this.limits[5] == 0
  };
  e.BoundingVolume.prototype.addBoundingVolume = function(e) {
    this.isNull() ? (this.limits[0] = e.limits[0], this.limits[1] = e.limits[1], this.limits[2] = e.limits[2], this.limits[3] = e.limits[3], this.limits[4] = e.limits[4], this.limits[5] = e.limits[5]) : e.isNull() || (this.limits[0] = Math.min(e.limits[0], this.limits[0]), this.limits[2] = Math.min(e.limits[2], this.limits[2]), this.limits[4] = Math.min(e.limits[4], this.limits[4]), this.limits[1] = Math.max(e.limits[1], this.limits[1]), this.limits[3] = Math.max(e.limits[3], this.limits[3]), this.limits[5] =
    Math.max(e.limits[5], this.limits[5]));
    this.calcProps()
  };
  e.BoundingVolume.prototype.applyMatrix = function(f) {
    var h = e.mulMat4Vec4(f, [this.limits[0], this.limits[2], this.limits[4], 1]), j = e.mulMat4Vec4(f, [this.limits[1], this.limits[2], this.limits[4], 1]), m = e.mulMat4Vec4(f, [this.limits[0], this.limits[3], this.limits[4], 1]), p = e.mulMat4Vec4(f, [this.limits[1], this.limits[3], this.limits[4], 1]), o = e.mulMat4Vec4(f, [this.limits[0], this.limits[2], this.limits[5], 1]), r = e.mulMat4Vec4(f, [this.limits[1], this.limits[2], this.limits[5], 1]), s = e.mulMat4Vec4(f, [this.limits[0], this.limits[3],
    this.limits[5], 1]), f = e.mulMat4Vec4(f, [this.limits[1], this.limits[3], this.limits[5], 1]);
    this.limits[0] = Math.min(h[0], j[0], m[0], p[0], o[0], r[0], s[0], f[0]);
    this.limits[1] = Math.max(h[0], j[0], m[0], p[0], o[0], r[0], s[0], f[0]);
    this.limits[2] = Math.min(h[1], j[1], m[1], p[1], o[1], r[1], s[1], f[1]);
    this.limits[3] = Math.max(h[1], j[1], m[1], p[1], o[1], r[1], s[1], f[1]);
    this.limits[4] = Math.min(h[2], j[2], m[2], p[2], o[2], r[2], s[2], f[2]);
    this.limits[5] = Math.max(h[2], j[2], m[2], p[2], o[2], r[2], s[2], f[2]);
    this.calcProps()
  };
  e.BoundingVolume.prototype.calcProps = function() {
    var e = this.limits[0], f = this.limits[1], j = this.limits[2], m = this.limits[3], p = this.limits[4], o = this.limits[5];
    this.points = [[e, j, p], [f, j, p], [e, m, p], [f, m, p], [e, j, o], [f, j, o], [e, m, o], [f, m, o]];
    this.center = [(this.limits[1] - this.limits[0]) / 2 + this.limits[0], (this.limits[3] - this.limits[2]) / 2 + this.limits[2], (this.limits[5] - this.limits[4]) / 2 + this.limits[4]];
    e = this.limits[0] - this.center[0];
    f = this.limits[2] - this.center[1];
    j = this.limits[4] - this.center[2];
    this.radius = Math.sqrt(e * e + f * f + j * j)
  };
  e.BoundingVolume.prototype.clone = function() {
    return new e.BoundingVolume(this.limits[0], this.limits[1], this.limits[2], this.limits[3], this.limits[4], this.limits[5])
  };
  e.BoundingVolume.prototype.toString = function() {
    return this.limits.toString()
  };
  e.cameraViewProjectionToPlanes = function(f) {
    var h = e.inverseMat4(f), j = e.mulMat4Vec4, m = e.subVec3, p = e.crossVec3, o = e.toUnitVec3, f = e.dotVec3, r = j(h, [-1, -1, -1, 1]), s = j(h, [1, -1, -1, 1]), t = j(h, [-1, -1, 1, 1]), q = j(h, [1, 1, -1, 1]), u = j(h, [1, 1, 1, 1]), v = j(h, [-1, 1, 1, 1]), r = [r[0] / r[3], r[1] / r[3], r[2] / r[3]], s = [s[0] / s[3], s[1] / s[3], s[2] / s[3]], t = [t[0] / t[3], t[1] / t[3], t[2] / t[3]], q = [q[0] / q[3], q[1] / q[3], q[2] / q[3]], u = [u[0] / u[3], u[1] / u[3], u[2] / u[3]], v = [v[0] /
    v[3], v[1] / v[3], v[2] / v[3]], h = o(p(m(q, s), m(r, s))), j = o(p(m(v, t), m(u, t))), w = o(p(m(r, t), m(v, t))), B = o(p(m(u, q), m(q, s))), q = o(p(m(v, q), m(q, u))), m = o(p(m(r, s), m(t, r)));
    h.push(f(h, r));
    j.push(f(j, t));
    w.push(f(w, r));
    B.push(f(B, s));
    q.push(f(q, u));
    m.push(f(m, r));
    return[h, j, w, B, q, m]
  };
  e.sphereInFrustumPlanes = function(e, f) {
    var j = e[0], m = e[1], p = e[2], o = e[3], r = f[0], s = f[1], t = f[2], q = f[3], u = f[4], v = f[5];
    return j * r[0] + m * r[1] + p * r[2] - r[3] - o > 0 || j * s[0] + m * s[1] + p * s[2] - s[3] - o > 0 || j * t[0] + m * t[1] + p * t[2] - t[3] - o > 0 || j * q[0] + m * q[1] + p * q[2] - q[3] - o > 0 || j * u[0] + m * u[1] + p * u[2] - u[3] - o > 0 || j * v[0] + m * v[1] + p * v[2] - v[3] - o > 0 ? !1 : !0
  };
  e.pointsInFrustumPlanes = function(e, f) {
    for(var j = f[0], m = f[1], p = f[2], o = f[3], r = f[4], s = f[5], t, q, u, v = 0;v < e.length;v++) {
      if(t = e[v][0], q = e[v][1], u = e[v][2], t * j[0] + q * j[1] + u * j[2] - j[3] > 0 && t * m[0] + q * m[1] + u * m[2] - m[3] > 0 && t * p[0] + q * p[1] + u * p[2] - o[3] > 0 && t * o[0] + q * o[1] + u * o[2] - r[3] > 0 && t * r[0] + q * r[1] + u * r[2] - r[3] > 0 && t * s[0] + q * s[1] + u * s[2] - s[3] > 0) {
        return!1
      }
    }
    return!0
  };
  e.getDirLightProjection = function(f, h, j, m) {
    var f = e.mulMat4(h, e.inverseMat4(f)), h = [0, 0, 0], p = [0, 0, 0];
    for(x = 0;x < 2;x++) {
      for(y = 0;y < 2;y++) {
        for(z = 0;z < 2;z++) {
          var o = e.mulMat4Vec4(f, [x * 2 - 1, y * 2 - 1, z * j, 1]);
          o[0] /= o[3];
          o[1] /= o[3];
          o[2] /= o[3];
          h[0] = h[0] > o[0] ? o[0] : h[0];
          h[1] = h[1] > o[1] ? o[1] : h[1];
          p[0] = p[0] < o[0] ? o[0] : p[0];
          p[1] = p[1] < o[1] ? o[1] : p[1];
          p[2] = p[2] < o[2] ? o[2] : p[2]
        }
      }
    }
    return e.makeOrtho(h[0], p[0], h[1], p[1], 0.01, +m)
  };
  (function() {
    var f = e.Vec([1, 2, 3, 4]), h = e.Vec4(e.getVec4(f, 3), e.get1basedVec4(f, 3), e.getVec4(f, 1), e.getVec4(f, 0)), f = e.identMatrix(), h = e.mulMat4Vec4(f, h);
    if(e.getVec4(h, 0) != 4 || e.getVec4(h, 1) != 3 || e.getVec4(h, 2) != 2 || e.getVec4(h, 3) != 1) {
      throw"Unit Test 1 failed MatVecMul " + h;
    }
    for(var h = e.Mat4([3, 4, 5, 0, 0.5, 0.75, 0, 0, 0.75, 0.5, 0, 0, 0.25, 0.25, 1, 1]), j = e.Mat4([2, 1, 8, 2, 1, 4, 3, 2, 1, 0.5, 6.5, 2, 8, 3, 1, 0.25]), m = e.mulMat4(h, j), p = e.Mat4([15, 21.5, 68.5, 24, 1.75, 3.5, 6.25, 2.5, 2, 2.75, 7.5, 2.5, 9.75, 4.75, 10.25, 3.25]), j = 0;j < 4;++j) {
      for(var o = 0;o < 4;++o) {
        var r = e.getMat4(m, j, o) - e.getMat4(p, j, o);
        if(!(r < 1.0E-6 && r > -1.0E-6)) {
          throw"Unit Test 1 failed Multiplication " + e.getMat4(m, j, o) + " != " + e.getMat4(p, j, o);
        }
      }
    }
    j = e.inverseMat4(h);
    m = e.mulMat4(h, j);
    e.mulMat4(j, h);
    for(j = 0;j < 4;++j) {
      for(o = 0;o < 4;++o) {
        if(r = e.getMat4(m, j, o) - e.getMat4(f, j, o), !(r < 1.0E-4 && r > -1.0E-4)) {
          throw"Unit Test 1 failed Inverse " + e.getMat4(m, j, o) + " != " + e.getMat4(f, j, o);
        }
      }
    }
  })()
})(GLGE);
(function(e) {
  e.Document = function() {
    this.listeners = [];
    this.documents = []
  };
  e.Document.prototype.listeners = null;
  e.Document.prototype.documents = null;
  e.Document.prototype.rootURL = null;
  e.Document.prototype.loadCount = 0;
  e.Document.prototype.version = 0;
  e.Document.prototype.getElementById = function(e) {
    for(var g = this.getElementsByTagName("*"), h = 0;h < g.length;h++) {
      if(g[h].getAttribute("id") == e) {
        return g[h]
      }
    }
    return null
  };
  e.Document.prototype.getAbsolutePath = function(e, g) {
    if(e.substr(0, 7) == "http://" || e.substr(0, 7) == "file://" || e.substr(0, 8) == "https://") {
      return e
    }else {
      if(!g) {
        g = window.location.href
      }
      for(var h = g.split("/"), j = h[2], m = h[0], p = [], o = 3;o < h.length - 1;o++) {
        p.push(h[o])
      }
      e.substr(0, 1) == "/" && (p = []);
      h = e.split("/");
      for(o = 0;o < h.length;o++) {
        h[o] == ".." ? p.pop() : h[o] != "" && p.push(h[o])
      }
      return m + "//" + j + "/" + p.join("/")
    }
  };
  e.Document.prototype.load = function(e) {
    this.documents = [];
    this.rootURL = e;
    this.loadDocument(e, null)
  };
  e.Document.prototype.loadDocument = function(f, g) {
    this.loadCount++;
    var f = this.getAbsolutePath(f, g), h = new e.XMLHttpRequest;
    if(h) {
      h.docurl = f, h.docObj = this, h.overrideMimeType("text/xml"), h.onreadystatechange = function() {
        if(this.readyState == 4) {
          this.status == 200 || this.status == 0 ? (this.responseXML.getElementById = this.docObj.getElementById, this.docObj.loaded(this.docurl, this.responseXML)) : e.error("Error loading Document: " + this.docurl + " status " + this.status)
        }
      }, h.open("GET", f, !0), h.send("")
    }
  };
  e.Document.prototype.loaded = function(e, g) {
    this.loadCount--;
    this.documents[e] = {xml:g};
    var h = g.getElementsByTagName("glge");
    if(h[0] && h[0].hasAttribute("version")) {
      this.version = parseFloat(h[0].getAttribute("version"))
    }
    for(var h = g.getElementsByTagName("import"), j = 0;j < h.length;j++) {
      this.documents[this.getAbsolutePath(h[j].getAttribute("url"), e)] || (this.documents[this.getAbsolutePath(h[j].getAttribute("url"), e)] = {}, this.loadDocument(h[j].getAttribute("url"), e))
    }
    this.loadCount == 0 && this.finishedLoading()
  };
  e.Document.prototype.finishedLoading = function() {
    for(var e = 0;e < this.listeners.length;e++) {
      this.listeners[e](this.listeners.rootURL)
    }
    this.onLoad()
  };
  e.Document.prototype.onLoad = function() {
  };
  e.Document.prototype.classString = function(e) {
    if(!e) {
      return!1
    }
    for(var e = e.split("_"), g = "", h = 0;h < e.length;h++) {
      g = g + e[h][0].toUpperCase() + e[h].substr(1)
    }
    return g
  };
  e.Document.prototype.setProperties = function(f) {
    for(var g, h, j = 0;j < f.attributes.length;j++) {
      h = !1;
      g = "set" + this.classString(f.attributes[j].nodeName);
      f.attributes[j].value[0] == "#" && (h = this.getElement(f.attributes[j].value.substr(1), !0));
      h || (h = typeof e[f.attributes[j].value] != "undefined" ? e[f.attributes[j].value] : f.attributes[j].value);
      if(f.object[g]) {
        f.object[g](h)
      }
      if(f.attributes[j].nodeName == "uid") {
        e.Assets.unregisterAsset(f.object.uid), f.object.uid = f.attributes[j].value, e.Assets.registerAsset(f.object, f.attributes[j].value)
      }
    }
  };
  e.Document.prototype.addChildren = function(e) {
    for(var g, h = e.firstChild;h;) {
      g = "add" + this.classString(h.tagName);
      if(e.object[g]) {
        e.object[g](this.getElement(h))
      }
      h = h.nextSibling
    }
  };
  e.Document.prototype.getElement = function(f, g) {
    var h, j;
    if(typeof f == "string") {
      for(j in this.documents) {
        if(this.documents[j].xml && (h = this.documents[j].xml.getElementById(f))) {
          f = h;
          break
        }
      }
    }
    return typeof f == "string" ? (g || e.error("Element " + f + " not found in document"), !1) : this["get" + this.classString(f.tagName)] ? this["get" + this.classString(f.tagName)](f) : this.getDefault(f)
  };
  e.Document.prototype.getData = function(f) {
    if(!f.object && (f.object = this.parseArray(f), f.hasAttribute("type"))) {
      switch(f.getAttribute("type")) {
        case "matrix":
          for(var g = 0;g < f.object.length;g++) {
            f.object[g] = e.Mat4(f.object[g].split(" "))
          }
          break;
        case "links":
          for(g = 0;g < f.object.length;g++) {
            f.object[g] = this.getElement(f.object[g].substr(1))
          }
      }
    }
    return f.object
  };
  e.Document.prototype.getDefault = function(f) {
    if(!f.object) {
      e[this.classString(f.tagName)] ? (f.object = new (e[this.classString(f.tagName)]), this.setProperties(f), this.addChildren(f)) : e.error("XML Parse Error: GLGE Object not found")
    }
    return f.object
  };
  e.Document.prototype.getTexture = function(f) {
    if(!f.object) {
      var g = this.getAbsolutePath(this.rootURL, null);
      f.object = new (e[this.classString(f.tagName)]);
      f.object.setSrc(this.getAbsolutePath(f.getAttribute("src"), g));
      f.removeAttribute("src");
      this.setProperties(f)
    }
    return f.object
  };
  e.Document.prototype.getTextureVideo = e.Document.prototype.getTexture;
  e.Document.prototype.parseArray = function(e) {
    for(var e = e.firstChild, g = "", h = [], j, m;e;) {
      j = (g + e.nodeValue).split(",");
      e = e.nextSibling;
      j[0] == "" && j.unshift();
      e && (g = j.pop());
      for(m = 0;m < j.length;m++) {
        h.push(j[m])
      }
    }
    return h
  };
  e.Document.prototype.getMesh = function(f) {
    if(this.version > 0) {
      return this.getDefault(f)
    }
    if(!f.object) {
      f.object = new e.Mesh;
      this.setProperties(f);
      for(var g = f.firstChild;g;) {
        switch(g.tagName) {
          case "positions":
            f.object.setPositions(this.parseArray(g));
            break;
          case "normals":
            f.object.setNormals(this.parseArray(g));
            break;
          case "uv1":
            f.object.setUV(this.parseArray(g));
            break;
          case "uv2":
            f.object.setUV2(this.parseArray(g));
            break;
          case "faces":
            f.object.setFaces(this.parseArray(g));
            break;
          case "joint_names":
            for(var h = this.parseArray(g), j = [], m = 0;m < h.length;m++) {
              h[m].substr(0, 1) == "#" ? j.push(this.getElement(h[m].substr(1))) : j.push(h[m])
            }
            f.object.setJoints(j);
            break;
          case "bind_matrix":
            h = this.parseArray(g);
            j = [];
            for(m = 0;m < h.length;m++) {
              j.push(e.Mat4(h[m].split(" ")))
            }
            f.object.setInvBindMatrix(j);
            break;
          case "joints":
            f.object.setVertexJoints(this.parseArray(g), g.getAttribute("count"));
            break;
          case "weights":
            f.object.setVertexWeights(this.parseArray(g), g.getAttribute("count"))
        }
        g = g.nextSibling
      }
    }
    return f.object
  };
  e.Document.prototype.addLoadListener = function(e) {
    this.listeners.push(e)
  };
  e.Document.prototype.removeLoadListener = function(e) {
    for(var g = 0;g < this.listeners.length;g++) {
      this.listeners[g] === e && this.listeners.splice(g, 1)
    }
  };
  e.Document.prototype.parseScript = function(e) {
    this.rootURL = window.location.toString();
    var g = document.getElementById(e);
    if(!g) {
      return null
    }
    for(var h = "", g = g.firstChild;g;) {
      g.nodeType == 3 && (h += g.textContent), g = g.nextSibling
    }
    h = (new DOMParser).parseFromString(h, "text/xml");
    h.getElementById = this.getElementById;
    this.documents["#" + e] = {xml:h};
    e = h.getElementsByTagName("import");
    for(h = 0;h < e.length;h++) {
      this.documents[this.getAbsolutePath(e[h].getAttribute("url"), url)] || (this.documents[this.getAbsolutePath(e[h].getAttribute("url"), url)] = {}, this.loadDocument(e[h].getAttribute("url")))
    }
    this.loadCount == 0 && this.finishedLoading()
  }
})(GLGE);
(function(e) {
  e.Events = function() {
  };
  e.Events.prototype.fireEvent = function(e, g) {
    if(this.events && this.events[e]) {
      for(var h = this.events[e], j = 0;j < h.length;j++) {
        h[j].call(this, g)
      }
    }
  };
  e.Events.prototype.addEventListener = function(e, g) {
    if(!this.events) {
      this.events = {}
    }
    this.events[e] || (this.events[e] = []);
    this.events[e].push(g)
  };
  e.Events.prototype.removeEventListener = function(e, g) {
    if(this.events[e]) {
      var h = this.events[e].indexOf(g);
      h != -1 && this.events[e].splice(h, 1)
    }
  }
})(GLGE);
(function(e) {
  e.Animatable = function() {
  };
  e.augment(e.Events, e.Animatable);
  e.Animatable.prototype.animationStart = null;
  e.Animatable.prototype.animation = null;
  e.Animatable.prototype.blendStart = 0;
  e.Animatable.prototype.blendTime = 0;
  e.Animatable.prototype.lastFrame = null;
  e.Animatable.prototype.frameRate = 30;
  e.Animatable.prototype.loop = e.TRUE;
  e.Animatable.prototype.paused = e.FALSE;
  e.Animatable.prototype.pausedTime = null;
  e.Animatable.prototype.blendFunction = e.LINEAR_BLEND;
  e.Animatable.prototype.blendTo = function(f, g, h) {
    if(!h) {
      h = e.LINEAR_BLEND
    }
    var j = new e.AnimationVector, m, p;
    for(prop in f) {
      m = new e.AnimationCurve, m.setChannel(prop), p = new e.LinearPoint, p.setX(1), p.setY(f[prop]), m.addPoint(p), j.addAnimationCurve(m)
    }
    this.setBlendFunction(h);
    this.setAnimation(j, g);
    return this
  };
  e.Animatable.prototype.setBlendFunction = function(e) {
    this.blendFunction = e;
    return this
  };
  e.Animatable.prototype.getBlendFunction = function() {
    return this.blendFunction
  };
  e.Animatable.prototype.setName = function(e) {
    this.name = e;
    return this
  };
  e.Animatable.prototype.getName = function() {
    return this.name
  };
  e.Animatable.prototype.getFrameNumber = function(e) {
    if(!this.startFrame) {
      this.startFrame = this.animation.startFrame
    }
    if(!this.animFrames) {
      this.animFrames = this.animation.frames
    }
    e || (e = parseInt((new Date).getTime()));
    if(this.animFrames > 1) {
      if(this.loop) {
        e = (parseFloat(e) - parseFloat(this.animationStart)) / 1E3 * this.frameRate % (this.animFrames - 1) + 1 + this.startFrame
      }else {
        if(e = (parseFloat(e) - parseFloat(this.animationStart)) / 1E3 * this.frameRate + 1 + this.startFrame, e >= this.animFrames + this.startFrame) {
          e = this.animFrames
        }
      }
    }else {
      e = 1
    }
    return Math.round(e)
  };
  e.Animatable.prototype.setStartFrame = function(e, g, h) {
    this.loop = h;
    var j = parseInt((new Date).getTime());
    g || (g = 0);
    if(g > 0 && this.animation) {
      this.blendInitValues = this.getInitialValues(this.animation, j), this.blendTime = g
    }
    this.animationStart = j;
    this.lastFrame = null;
    this.animFinished = !1;
    this.startFrame = e;
    if(this.children) {
      for(j = 0;j < this.children.length;j++) {
        this.children[j].setStartFrame && this.children[j].setStartFrame(e, g, h)
      }
    }
    return this
  };
  e.Animatable.prototype.setFrames = function(e) {
    this.animFrames = e;
    if(this.children) {
      for(var g = 0;g < this.children.length;g++) {
        this.children[g].setFrames && this.children[g].setFrames(e)
      }
    }
    return this
  };
  e.Animatable.prototype.getInitialValues = function(e, g) {
    var h = {};
    if(this.animation) {
      this.lastFrame = null, this.animate(g, !0)
    }
    for(var j in e.curves) {
      this["get" + j] && (h[j] = this["get" + j]())
    }
    return h
  };
  e.Animatable.prototype.animate = function(e, g) {
    if(!this.paused && this.animation) {
      e || (e = parseInt((new Date).getTime()));
      var h = this.getFrameNumber(e);
      if(!this.animation.animationCache) {
        this.animation.animationCache = {}
      }
      if(h != this.lastFrame || this.blendTime != 0) {
        if(this.lastFrame = h, this.blendTime == 0) {
          if(!this.animation.animationCache[h] || g) {
            if(this.animation.animationCache[h] = [], this.animation.curves.LocX && this.animation.curves.LocY && this.animation.curves.LocZ && this.animation.curves.ScaleX && this.animation.curves.ScaleY && this.animation.curves.ScaleZ && this.animation.curves.QuatX && this.animation.curves.QuatY && this.animation.curves.QuatZ && this.animation.curves.QuatW) {
              for(property in this.animation.curves) {
                if(this["set" + property]) {
                  var j = this.animation.curves[property].getValue(parseFloat(h));
                  switch(property) {
                    case "QuatX":
                    ;
                    case "QuatY":
                    ;
                    case "QuatZ":
                    ;
                    case "QuatW":
                    ;
                    case "LocX":
                    ;
                    case "LocY":
                    ;
                    case "LocZ":
                    ;
                    case "ScaleX":
                    ;
                    case "ScaleY":
                    ;
                    case "ScaleZ":
                      break;
                    default:
                      this.animation.animationCache[h].push({property:property, value:j})
                  }
                  this["set" + property](j)
                }
              }
              this.animation.animationCache[h].push({property:"StaticMatrix", value:this.getLocalMatrix()})
            }else {
              for(property in this.animation.curves) {
                if(this["set" + property]) {
                  j = this.animation.curves[property].getValue(parseFloat(h));
                  switch(property) {
                    case "QuatX":
                    ;
                    case "QuatY":
                    ;
                    case "QuatZ":
                    ;
                    case "QuatW":
                    ;
                    case "RotX":
                    ;
                    case "RotY":
                    ;
                    case "RotZ":
                      var m = !0;
                      break;
                    default:
                      this.animation.animationCache[h].push({property:property, value:j})
                  }
                  this["set" + property](j)
                }
              }
              m && (j = this.getRotMatrix(), this.animation.animationCache[h].push({property:"RotMatrix", value:j}))
            }
          }else {
            j = this.animation.animationCache[h];
            for(m = 0;m < j.length;m++) {
              if(this["set" + j[m].property]) {
                this["set" + j[m].property](j[m].value)
              }
            }
          }
        }else {
          if(j = e - this.animationStart, j < this.blendTime) {
            for(property in m = j / this.blendTime, m = this.blendFunction(m), this.animation.curves) {
              this["set" + property] && (j = this.animation.curves[property].getValue(parseFloat(h)), j = j * m + this.blendInitValues[property] * (1 - m), this["set" + property](j))
            }
          }else {
            this.blendTime = 0
          }
        }
      }
    }
    if(this.children) {
      for(m = 0;m < this.children.length;m++) {
        this.children[m].animate && this.children[m].animate(e, g)
      }
    }
    if(this.animation && !this.animFinished && this.blendTime == 0 && this.animation.frames == h && !g) {
      this.animFinished = !0, this.fireEvent("animFinished", {})
    }
  };
  e.Animatable.prototype.setAnimation = function(e, g, h) {
    h == null && (h = parseInt((new Date).getTime()));
    g || (g = 0);
    if(g > 0) {
      this.blendInitValues = this.getInitialValues(e, h), this.blendTime = g
    }
    this.startFrame = this.animFrames = null;
    this.animationStart = h;
    this.lastFrame = null;
    this.animation = e;
    this.animFinished = !1;
    return this
  };
  e.Animatable.prototype.getAnimation = function() {
    return this.animation
  };
  e.Animatable.prototype.setFrameRate = function(e) {
    this.frameRate = e;
    if(this.children) {
      for(var g = 0;g < this.children.length;g++) {
        this.children[g].setFrameRate && this.children[g].setFrameRate(e)
      }
    }
    return this
  };
  e.Animatable.prototype.getFrameRate = function() {
    return this.frameRate
  };
  e.Animatable.prototype.setLoop = function(e) {
    this.loop = e;
    return this
  };
  e.Animatable.prototype.getLoop = function() {
    return this.loop
  };
  e.Animatable.prototype.isLooping = e.Animatable.prototype.getLoop;
  e.Animatable.prototype.setPaused = function(e) {
    e ? this.pauseTime = parseInt((new Date).getTime()) : this.animationStart += parseInt((new Date).getTime()) - this.pauseTime;
    this.paused = e;
    return this
  };
  e.Animatable.prototype.getPaused = function() {
    return this.paused
  };
  e.Animatable.prototype.togglePaused = function() {
    this.setPaused(!this.getPaused());
    return this.paused
  }
})(GLGE);
(function(e) {
  e.ZUP = [0, 0, 1];
  e.YUP = [0, 1, 0];
  e.XUP = [1, 0, 0];
  e.Placeable = function() {
  };
  e.Placeable.prototype.locX = 0;
  e.Placeable.prototype.locY = 0;
  e.Placeable.prototype.locZ = 0;
  e.Placeable.prototype.dLocX = 0;
  e.Placeable.prototype.dLocY = 0;
  e.Placeable.prototype.dLocZ = 0;
  e.Placeable.prototype.quatX = 0;
  e.Placeable.prototype.quatY = 0;
  e.Placeable.prototype.quatZ = 0;
  e.Placeable.prototype.quatW = 0;
  e.Placeable.prototype.rotX = 0;
  e.Placeable.prototype.rotY = 0;
  e.Placeable.prototype.rotZ = 0;
  e.Placeable.prototype.dRotX = 0;
  e.Placeable.prototype.dRotY = 0;
  e.Placeable.prototype.dRotZ = 0;
  e.Placeable.prototype.scaleX = 1;
  e.Placeable.prototype.scaleY = 1;
  e.Placeable.prototype.scaleZ = 1;
  e.Placeable.prototype.dScaleX = 0;
  e.Placeable.prototype.dScaleY = 0;
  e.Placeable.prototype.dScaleZ = 0;
  e.Placeable.prototype.matrix = null;
  e.Placeable.prototype.rotOrder = e.ROT_XYZ;
  e.Placeable.prototype.lookAt = null;
  e.Placeable.prototype.mode = e.P_EULER;
  e.Placeable.prototype.upAxis = e.ZUP;
  e.Placeable.prototype.getRoot = function() {
    if(this.type == e.G_ROOT) {
      return this
    }else {
      if(this.parent) {
        var f = this.parent.getRoot();
        return f ? f : this
      }else {
        return this
      }
    }
  };
  e.Placeable.prototype.getRef = function() {
    return this.id ? this.id : this.parent ? this.parent.getRef() : null
  };
  e.Placeable.prototype.setId = function(e) {
    this.id = e;
    return this
  };
  e.Placeable.prototype.getId = function() {
    return this.id
  };
  e.Placeable.prototype.getLookat = function() {
    return this.lookAt
  };
  e.Placeable.prototype.setLookat = function(e) {
    this.lookAt = e;
    return this
  };
  e.Placeable.prototype.getUpAxis = function() {
    return this.upAxis
  };
  e.Placeable.prototype.setUpAxis = function(e) {
    this.upAxis = e;
    return this
  };
  e.Placeable.prototype.Lookat = function(f) {
    var g = this.getPosition(), f = f.getPosition ? f.getPosition() : {x:f[0], y:f[1], z:f[2]}, g = e.toUnitVec3([g.x - f.x, g.y - f.y, g.z - f.z]), f = e.toUnitVec3(e.crossVec3(this.upAxis, g));
    f[0] == 0 && f[1] == 0 && f[2] == 0 && (f[1] = 1);
    var h = e.toUnitVec3(e.crossVec3(g, f));
    this.setRotMatrix(e.Mat4([f[0], h[0], g[0], 0, f[1], h[1], g[1], 0, f[2], h[2], g[2], 0, 0, 0, 0, 1]))
  };
  e.Placeable.prototype.getRotOrder = function() {
    return this.rotOrder
  };
  e.Placeable.prototype.setRotOrder = function(e) {
    this.rotOrder = e;
    this.rotmatrix = this.matrix = null;
    return this
  };
  e.Placeable.prototype.getRotMatrix = function() {
    if(!this.rotmatrix) {
      var f = this.getRotation();
      if(this.mode == e.P_EULER) {
        this.rotmatrix = e.rotateMatrix(f.x, f.y, f.z, this.rotOrder)
      }
      if(this.mode == e.P_QUAT) {
        this.rotmatrix = e.quatRotation(f.x, f.y, f.z, f.w)
      }
    }
    return this.rotmatrix
  };
  e.Placeable.prototype.setRotMatrix = function(f) {
    this.mode = e.P_MATRIX;
    this.rotmatrix = f;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setLocX = function(e) {
    this.locX = e;
    this.staticMatrix = this.translateMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setLocY = function(e) {
    this.locY = e;
    this.staticMatrix = this.translateMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setLocZ = function(e) {
    this.locZ = e;
    this.staticMatrix = this.translateMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setLoc = function(e, g, h) {
    this.locX = e;
    this.locY = g;
    this.locZ = h;
    this.staticMatrix = this.translateMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setDLocX = function(e) {
    this.dLocX = e;
    this.staticMatrix = this.translateMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setDLocY = function(e) {
    this.dLocY = e;
    this.staticMatrix = this.translateMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setDLocZ = function(e) {
    this.dLocZ = e;
    this.staticMatrix = this.translateMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setDLoc = function(e, g, h) {
    this.dLocX = e;
    this.dLocY = g;
    this.dLocZ = h;
    this.staticMatrix = this.translateMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setQuatX = function(f) {
    this.mode = e.P_QUAT;
    this.quatX = parseFloat(f);
    this.rotmatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setQuatY = function(f) {
    this.mode = e.P_QUAT;
    this.quatY = parseFloat(f);
    this.rotmatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setQuatZ = function(f) {
    this.mode = e.P_QUAT;
    this.quatZ = parseFloat(f);
    this.rotmatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setQuatW = function(f) {
    this.mode = e.P_QUAT;
    this.quatW = parseFloat(f);
    this.rotmatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setQuat = function(f, g, h, j) {
    this.mode = e.P_QUAT;
    this.quatX = f;
    this.quatY = g;
    this.quatZ = h;
    this.quatW = j;
    this.rotmatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setRotX = function(f) {
    this.mode = e.P_EULER;
    this.rotX = f;
    this.rotmatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setRotY = function(f) {
    this.mode = e.P_EULER;
    this.rotY = f;
    this.rotmatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setRotZ = function(f) {
    this.mode = e.P_EULER;
    this.rotZ = f;
    this.rotmatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setRot = function(f, g, h) {
    this.mode = e.P_EULER;
    this.rotX = f;
    this.rotY = g;
    this.rotZ = h;
    this.rotmatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setDRotX = function(f) {
    this.mode = e.P_EULER;
    this.dRotX = f;
    this.rotmatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setDRotY = function(f) {
    this.mode = e.P_EULER;
    this.dRotY = f;
    this.rotmatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setDRotZ = function(f) {
    this.mode = e.P_EULER;
    this.dRotZ = f;
    this.rotmatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setDRot = function(f, g, h) {
    this.mode = e.P_EULER;
    this.dRotX = f;
    this.dRotY = g;
    this.dRotZ = h;
    this.rotmatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setScaleX = function(e) {
    if(this.ScaleX == e) {
      return this
    }
    this.scaleX = e;
    this.scaleMatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setScaleY = function(e) {
    if(this.ScaleY == e) {
      return this
    }
    this.scaleY = e;
    this.scaleMatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setScaleZ = function(e) {
    if(this.ScaleZ == e) {
      return this
    }
    this.scaleZ = e;
    this.scaleMatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setScale = function(e, g, h) {
    g || (h = g = e);
    this.scaleX = e;
    this.scaleY = g;
    this.scaleZ = h;
    this.scaleMatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setDScaleX = function(e) {
    if(this.dScaleX == e) {
      return this
    }
    this.dScaleX = e;
    this.scaleMatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setDScaleY = function(e) {
    if(this.dScaleY == e) {
      return this
    }
    this.dScaleY = e;
    this.scaleMatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setDScaleZ = function(e) {
    if(this.dScaleZ == e) {
      return this
    }
    this.dScaleZ = e;
    this.scaleMatrix = this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.setDScale = function(e, g, h) {
    this.dScaleX = e;
    this.dScaleY = g;
    this.dScaleZ = h;
    this.scaleMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.getLocX = function() {
    return this.locX
  };
  e.Placeable.prototype.getLocY = function() {
    return this.locY
  };
  e.Placeable.prototype.getLocZ = function() {
    return this.locZ
  };
  e.Placeable.prototype.getDLocX = function() {
    return this.dLocX
  };
  e.Placeable.prototype.getDLocY = function() {
    return this.dLocY
  };
  e.Placeable.prototype.getDLocZ = function() {
    return this.dLocZ
  };
  e.Placeable.prototype.getQuatX = function() {
    return this.quatX
  };
  e.Placeable.prototype.getQuatY = function() {
    return this.quatY
  };
  e.Placeable.prototype.getQuatZ = function() {
    return this.quatZ
  };
  e.Placeable.prototype.getQuatW = function() {
    return this.quatW
  };
  e.Placeable.prototype.getRotX = function() {
    return this.rotX
  };
  e.Placeable.prototype.getRotY = function() {
    return this.rotY
  };
  e.Placeable.prototype.getRotZ = function() {
    return this.rotZ
  };
  e.Placeable.prototype.getDRotX = function() {
    return this.dRotX
  };
  e.Placeable.prototype.getDRotY = function() {
    return this.dRotY
  };
  e.Placeable.prototype.getDRotZ = function() {
    return this.dRotZ
  };
  e.Placeable.prototype.getScaleX = function() {
    return this.scaleX
  };
  e.Placeable.prototype.getScaleY = function() {
    return this.scaleY
  };
  e.Placeable.prototype.getScaleZ = function() {
    return this.scaleZ
  };
  e.Placeable.prototype.getDScaleX = function() {
    return this.dScaleX
  };
  e.Placeable.prototype.getDScaleY = function() {
    return this.dScaleY
  };
  e.Placeable.prototype.getDScaleZ = function() {
    return this.dScaleZ
  };
  e.Placeable.prototype.getPosition = function() {
    var e = {};
    e.x = parseFloat(this.locX) + parseFloat(this.dLocX);
    e.y = parseFloat(this.locY) + parseFloat(this.dLocY);
    e.z = parseFloat(this.locZ) + parseFloat(this.dLocZ);
    return e
  };
  e.Placeable.prototype.getRotation = function() {
    var f = {};
    if(this.mode == e.P_EULER) {
      f.x = parseFloat(this.rotX) + parseFloat(this.dRotX), f.y = parseFloat(this.rotY) + parseFloat(this.dRotY), f.z = parseFloat(this.rotZ) + parseFloat(this.dRotZ)
    }
    if(this.mode == e.P_QUAT) {
      f.x = parseFloat(this.quatX), f.y = parseFloat(this.quatY), f.z = parseFloat(this.quatZ), f.w = parseFloat(this.quatW)
    }
    return f
  };
  e.Placeable.prototype.getScale = function() {
    var e = {};
    e.x = parseFloat(this.scaleX) + parseFloat(this.dScaleX);
    e.y = parseFloat(this.scaleY) + parseFloat(this.dScaleY);
    e.z = parseFloat(this.scaleZ) + parseFloat(this.dScaleZ);
    return e
  };
  e.Placeable.prototype.getScaleMatrix = function() {
    if(!this.scaleMatrix) {
      this.scaleMatrix = e.scaleMatrix(parseFloat(this.scaleX) + parseFloat(this.dScaleX), parseFloat(this.scaleY) + parseFloat(this.dScaleY), parseFloat(this.scaleZ) + parseFloat(this.dScaleZ))
    }
    return this.scaleMatrix
  };
  e.Placeable.prototype.getTranslateMatrix = function() {
    if(!this.tmatrix) {
      this.tmatrix = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1]
    }
    if(!this.translateMatrix) {
      this.tmatrix[3] = +this.locX + this.dLocX, this.tmatrix[7] = +this.locY + this.dLocY, this.tmatrix[11] = +this.locZ + this.dLocZ, this.translateMatrix = this.tmatrix
    }
    return this.translateMatrix
  };
  e.Placeable.prototype.getLocalMatrix = function() {
    this.getModelMatrix();
    return this.localMatrix
  };
  e.Placeable.prototype.setStaticMatrix = function(e) {
    this.staticMatrix = e;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.clearStaticMatrix = function() {
    this.staticMatrix = null;
    this.updateMatrix();
    return this
  };
  e.Placeable.prototype.updateMatrix = function() {
    this.matrix = null;
    if(this.children) {
      for(var e = 0;e < this.children.length;e++) {
        this.children[e].updateMatrix()
      }
    }
    e = obj = this;
    obj.fireEvent("matrixUpdate", {obj:e});
    (obj = obj.parent) && obj.fireEvent("childMatrixUpdate", {obj:e})
  };
  e.Placeable.prototype.getModelMatrix = function() {
    if(!this.matrix) {
      e.reuseMatrix4(this.invmatrix);
      e.reuseMatrix4(this.transmatrix);
      e.reuseMatrix4(this.transinvmatrix);
      this.transinvmatrix = this.transmatrix = this.invmatrix = null;
      if(this.staticMatrix) {
        var f = this.staticMatrix;
        this.localMatrix = this.staticMatrix
      }else {
        var f = this.getTranslateMatrix(), g = this.getScaleMatrix(), g = e.mulMat4(this.getRotMatrix(), g);
        this.localMatrix = f = e.mulMat4(f, g)
      }
      this.parent && (f = e.mulMat4(this.parent.getModelMatrix(), f));
      this.matrix = f
    }
    return this.matrix
  };
  e.Placeable.prototype.getInverseModelMatrix = function() {
    this.matrix || this.getModelMatrix();
    if(!this.invmatrix) {
      this.invmatrix = e.transposeMat4(this.matrix)
    }
    return this.invmatrix
  };
  e.Placeable.prototype.getTransposeModelMatrix = function() {
    this.matrix || this.getModelMatrix();
    if(!this.transmatrix) {
      this.transmatrix = e.transposeMat4(this.matrix)
    }
    return this.transmatrix
  };
  e.Placeable.prototype.getTransposeInverseModelMatrix = function() {
    this.matrix || this.getModelMatrix();
    if(!this.transinvmatrix) {
      this.invtransmatrix = e.transposeMat4(this.getInverseModelMatrix())
    }
    return this.transinvmatrix
  };
  e.Placeable.prototype.move = function(f, g) {
    if(!g) {
      g = e.GLOBAL
    }
    switch(g) {
      case e.GLOBAL:
        this.setLocX(+this.locX + f[0]);
        this.setLocY(+this.locY + f[1]);
        this.setLocZ(+this.locZ + f[2]);
        break;
      case e.LOCAL:
        var h = this.getModelMatrix(), j = e.toUnitVec3([h[0], h[1], h[2]]), m = e.toUnitVec3([h[4], h[5], h[6]]), h = e.toUnitVec3([h[8], h[9], h[10]]), m = m[0] * f[0] + m[1] * f[1] + m[2] * f[2], h = h[0] * f[0] + h[1] * f[1] + h[2] * f[2];
        this.setLocX(+this.locX + (j[0] * f[0] + j[1] * f[1] + j[2] * f[2]));
        this.setLocY(+this.locY + m);
        this.setLocZ(+this.locZ + h)
    }
    return this
  }
})(GLGE);
(function(e) {
  e.JSONLoader = function() {
  };
  e.JSONLoader.prototype.downloadPriority = 0;
  e.JSONLoader.prototype.setJSONSrc = function(f) {
    var g = this;
    e.Message.messageLoader(f, function(e) {
      g.setJSONString(e)
    }, this.downloadPriority)
  };
  e.JSONLoader.prototype.setJSONString = function(f) {
    f = JSON.parse(f);
    if(f.type == this.className) {
      f.uid = this.uid, f.command = "update", e.Message.parseMessage(f)
    }
  };
  e.JSONLoader.prototype.setDownloadPriority = function(e) {
    this.downloadPriority = e
  };
  e.JSONLoader.prototype.getDownloadPriority = function() {
    return this.downloadPriority
  }
})(GLGE);
(function(e) {
  e.QuickNotation = function() {
  };
  e.QuickNotation.prototype._ = function() {
    for(var e, g = 0;g < arguments.length;g++) {
      if(e = arguments[g], typeof e == "object") {
        if(e.className && this["add" + e.className]) {
          this["add" + e.className](e)
        }else {
          for(var h in e) {
            if(this["set" + h]) {
              this["set" + h](e[h])
            }
          }
        }
      }
    }
    return this
  }
})(GLGE);
(function(e) {
  e.Message = {};
  e.Message.parseMessage = function(f) {
    switch(f.command) {
      case "create":
        var g = new e[f.type](f.uid);
        this.setAttributes(g, f.attributes);
        f.children && e.Message.addChildren(g, f.children);
        return g;
      case "update":
        return g = e.Assets.get(f.uid), this.setAttributes(g, f.attributes), f.add && e.Message.addChildren(g, f.add), f.remove && e.Message.removeChildren(g, f.remove), g
    }
    return null
  };
  e.Message.setAttributes = function(f, g) {
    if(g) {
      for(var h in g) {
        f["set" + h] && (g[h].command && (g[h] = e.Message.parseMessage(g[h])), f["set" + h](g[h]))
      }
    }
    return this
  };
  e.Message.addChildren = function(f, g) {
    g instanceof Array || (g = [g]);
    for(var h = 0;h < g.length;h++) {
      var j = g[h].command ? e.Message.parseMessage(g[h]) : e.Assets.get(g[h]);
      f["add" + j.className](j)
    }
  };
  e.Message.removeChildren = function(f, g) {
    g instanceof Array || (g = [g]);
    for(var h = 0;h < g.length;h++) {
      var j = e.Assets.get(g[h]);
      f["add" + j.className](j)
    }
  };
  e.Message.toLoad = [];
  e.Message.messageLoader = function(f, g, h) {
    e.Message.toLoad.push([f, g, h]);
    e.Message.toLoad.length == 1 && e.Message.loadMessages()
  };
  e.Message.loadMessages = function() {
    var f = e.Message.toLoad.pop(), g = new e.XMLHttpRequest;
    g.onreadystatechange = function() {
      if(this.readyState == 4) {
        if(this.status == 200 || this.status == 0) {
          f[1](this.responseText)
        }else {
          e.error("Error loading Document: " + f[0] + " status " + this.status)
        }
      }
    };
    g.open("GET", f[0], !0);
    g.send("");
    e.Message.toLoad.length > 0 && e.Message.loadMessages()
  }
})(GLGE);
(function(e) {
  e.G_NODE = 1;
  e.G_ROOT = 2;
  e.Group = function(f) {
    e.Assets.registerAsset(this, f);
    this.children = [];
    var g = this;
    this.downloadComplete = function() {
      g.isComplete() && g.fireEvent("downloadComplete")
    }
  };
  e.augment(e.Placeable, e.Group);
  e.augment(e.Animatable, e.Group);
  e.augment(e.QuickNotation, e.Group);
  e.augment(e.JSONLoader, e.Group);
  e.Group.prototype.children = null;
  e.Group.prototype.className = "Group";
  e.Group.prototype.type = e.G_NODE;
  e.Group.prototype.isComplete = function() {
    for(var e = 0;e < this.children.length;e++) {
      if(this.children[e].isComplete && !this.children[e].isComplete()) {
        return!1
      }
    }
    return!0
  };
  e.Group.prototype.setAction = function(e, g, h) {
    e.start(g, h, this.getNames());
    return this
  };
  e.Group.prototype.getNames = function(e) {
    e || (e = {});
    var g = this.getName();
    g != "" && (e[g] = this);
    for(g = 0;g < this.children.length;g++) {
      this.children[g].getNames && this.children[g].getNames(e)
    }
    return e
  };
  e.Group.prototype.getBoundingVolume = function(f) {
    this.boundingVolume = null;
    for(var g = 0;g < this.children.length;g++) {
      if(this.children[g].getBoundingVolume) {
        this.boundingVolume ? this.boundingVolume.addBoundingVolume(this.children[g].getBoundingVolume(!0)) : this.boundingVolume = this.children[g].getBoundingVolume(!0).clone()
      }
    }
    if(!this.boundingVolume) {
      this.boundingVolume = new e.BoundingVolume(0, 0, 0, 0, 0, 0)
    }
    f ? this.boundingVolume.applyMatrix(this.getLocalMatrix()) : this.boundingVolume.applyMatrix(this.getModelMatrix());
    return this.boundingVolume
  };
  e.Group.prototype.getObjects = function(e) {
    this.lookAt && this.Lookat(this.lookAt);
    this.animation && this.animate();
    e || (e = []);
    for(var g = 0;g < this.children.length;g++) {
      this.children[g].className == "Object" || this.children[g].className == "Text" || this.children[g].toRender ? this.children[g].renderFirst ? e.unshift(this.children[g]) : e.push(this.children[g]) : this.children[g].getObjects && this.children[g].getObjects(e)
    }
    return e
  };
  e.Group.prototype.getLights = function(e) {
    e || (e = []);
    for(var g = 0;g < this.children.length;g++) {
      this.children[g].className == "Light" ? e.push(this.children[g]) : this.children[g].getLights && this.children[g].getLights(e)
    }
    return e
  };
  e.Group.prototype.updateAllPrograms = function() {
    for(var e = this.getObjects(), g = 0;g < e.length;g++) {
      e[g].updateProgram && e[g].updateProgram()
    }
  };
  e.Group.prototype.addChild = function(f) {
    f.parent && f.parent.removeChild(f);
    e.reuseMatrix4(f.matrix);
    f.matrix = null;
    f.parent = this;
    this.children.push(f);
    if(f.getLights && f.getLights().length > 0 || f.className == "Light") {
      for(var g = f;g.parent;) {
        g = g.parent
      }
      g.updateAllPrograms()
    }
    f.addEventListener && (f.addEventListener("shaderupdate", function() {
      for(var e = this;e.parent;) {
        e = e.parent
      }
      e.updateAllPrograms()
    }), f.addEventListener("downloadComplete", this.downloadComplete));
    this.fireEvent("childAdded", {obj:f});
    f.fireEvent && f.fireEvent("appened", {obj:this});
    this.fireEvent("childAdded", {obj:f});
    for(g = this;g = g.parent;) {
      g.fireEvent("childAdded", {obj:f, target:this})
    }
    return this
  };
  e.Group.prototype.addObject = e.Group.prototype.addChild;
  e.Group.prototype.addObjectInstance = e.Group.prototype.addChild;
  e.Group.prototype.addGroup = e.Group.prototype.addChild;
  e.Group.prototype.addLight = e.Group.prototype.addChild;
  e.Group.prototype.addText = e.Group.prototype.addChild;
  e.Group.prototype.addSkeleton = e.Group.prototype.addChild;
  e.Group.prototype.addCamera = e.Group.prototype.addChild;
  e.Group.prototype.addWavefront = e.Group.prototype.addChild;
  e.Group.prototype.removeChild = function(e) {
    for(var g = 0;g < this.children.length;g++) {
      if(this.children[g] == e) {
        this.children[g].removeEventListener && this.children[g].removeEventListener("downloadComplete", this.downloadComplete);
        this.children.splice(g, 1);
        if(this.scene && this.scene["remove" + e.className]) {
          this.scene["remove" + e.className](e)
        }
        e.fireEvent && e.fireEvent("removed", {obj:this});
        this.fireEvent("childRemoved", {obj:e});
        for(g = this;g = g.parent;) {
          g.fireEvent("childRemoved", {obj:e, target:this})
        }
        break
      }
    }
  };
  e.Group.prototype.getChildren = function() {
    return this.children
  };
  e.Group.prototype.GLInit = function(e) {
    this.gl = e;
    for(var g = 0;g < this.children.length;g++) {
      this.children[g].GLInit && this.children[g].GLInit(e)
    }
  };
  e.Group.prototype.getPickable = function() {
    return this.pickable
  };
  e.Group.prototype.setPickable = function(e) {
    for(var g = 0;g < this.children.length;g++) {
      this.children[g].setPickable && this.children[g].setPickable(e)
    }
    this.pickable = e;
    return this
  }
})(GLGE);
(function(e) {
  e.Object = function(f) {
    e.Assets.registerAsset(this, f);
    this.multimaterials = [];
    this.renderCaches = [];
    var h = this;
    this.downloadComplete = function() {
      h.isComplete() && h.fireEvent("downloadComplete")
    }
  };
  e.augment(e.Placeable, e.Object);
  e.augment(e.Animatable, e.Object);
  e.augment(e.QuickNotation, e.Object);
  e.augment(e.JSONLoader, e.Object);
  e.Object.prototype.className = "Object";
  e.Object.prototype.mesh = null;
  e.Object.prototype.skeleton = null;
  e.Object.prototype.scene = null;
  e.Object.prototype.transformMatrix = e.identMatrix();
  e.Object.prototype.material = null;
  e.Object.prototype.gl = null;
  e.Object.prototype.multimaterials = null;
  e.Object.prototype.zTrans = !1;
  e.Object.prototype.renderCaches = null;
  e.Object.prototype.id = "";
  e.Object.prototype.pickable = !0;
  e.Object.prototype.drawType = e.DRAW_TRIS;
  e.Object.prototype.pointSize = 1;
  e.Object.prototype.lineWidth = 1;
  e.Object.prototype.cull = !0;
  e.Object.prototype.culled = !0;
  e.Object.prototype.depthTest = !0;
  var f = [];
  f.push("#ifdef GL_ES\nprecision highp float;\n#endif\n");
  f.push("uniform float distance;\n");
  f.push("uniform bool shadowtype;\n");
  f.push("varying vec3 eyevec;\n");
  f.push("void main(void)\n  ");
  f.push("{\n");
  f.push("float depth = gl_FragCoord.z / gl_FragCoord.w;\n");
  f.push("vec4 rgba=fract(depth/distance * vec4(16777216.0, 65536.0, 256.0, 1.0));\n");
  f.push("gl_FragColor=rgba-rgba.rrgb*vec4(0.0,0.00390625,0.00390625,0.00390625);\n");
  f.push("}\n");
  e.Object.prototype.shfragStr = f.join("");
  f = [];
  f.push("#ifdef GL_ES\nprecision highp float;\n#endif\n");
  f.push("varying vec3 n;\n");
  f.push("void main(void)\n");
  f.push("{\n");
  f.push("float depth = gl_FragCoord.z / gl_FragCoord.w;\n");
  f.push("gl_FragColor=vec4(normalize(n)/2.0+0.5,depth/1000.0);\n");
  f.push("}\n");
  e.Object.prototype.nfragStr = f.join("");
  f = [];
  f.push("#ifdef GL_ES\nprecision highp float;\n#endif\n");
  f.push("uniform float far;\n");
  f.push("uniform vec3 pickcolor;\n");
  f.push("varying vec3 n;\n");
  f.push("varying vec4 UVCoord;\n");
  f.push("void main(void)\n");
  f.push("{\n");
  f.push("float Xcoord = gl_FragCoord.x+0.5;\n");
  f.push("if(Xcoord>0.0) gl_FragColor = vec4(pickcolor,1.0);\n");
  f.push("if(Xcoord>1.0) gl_FragColor = vec4(n,1.0);\n");
  f.push("if(Xcoord>2.0){");
  f.push("vec3 rgb=fract((gl_FragCoord.z/gl_FragCoord.w) * vec3(65536.0, 256.0, 1.0));\n");
  f.push("gl_FragColor=vec4(rgb-rgb.rrg*vec3(0.0,0.00390625,0.00390625),1.0);\n");
  f.push("}");
  f.push("if(Xcoord>3.0){");
  f.push("vec3 rgb=fract(UVCoord.x * vec3(65536.0, 256.0, 1.0));\n");
  f.push("gl_FragColor=vec4(rgb-rgb.rrg*vec3(0.0,0.00390625,0.00390625),1.0);\n");
  f.push("}");
  f.push("if(Xcoord>4.0){");
  f.push("vec3 rgb=fract(UVCoord.y * vec3(65536.0, 256.0, 1.0));\n");
  f.push("gl_FragColor=vec4(rgb-rgb.rrg*vec3(0.0,0.00390625,0.00390625),1.0);\n");
  f.push("}");
  f.push("}\n");
  e.Object.prototype.pkfragStr = f.join("");
  e.Object.prototype.getPickable = function() {
    return this.pickable
  };
  e.Object.prototype.setPickable = function(e) {
    this.pickable = e;
    return this
  };
  e.Object.prototype.getDepthTest = function() {
    return this.depthTest
  };
  e.Object.prototype.setDepthTest = function(e) {
    this.depthTest = e;
    return this
  };
  e.Object.prototype.getCull = function() {
    return this.cull
  };
  e.Object.prototype.setCull = function(e) {
    this.cull = e;
    return this
  };
  e.Object.prototype.getDrawType = function() {
    return this.drawType
  };
  e.Object.prototype.setDrawType = function(e) {
    this.drawType = e;
    return this
  };
  e.Object.prototype.getPointSize = function() {
    return this.pointSize
  };
  e.Object.prototype.setPointSize = function(e) {
    this.pointSize = parseFloat(e);
    return this
  };
  e.Object.prototype.getLineWidth = function() {
    return this.lineWidth
  };
  e.Object.prototype.setLineWidth = function(e) {
    this.lineWidth = parseFloat(e);
    return this
  };
  e.Object.prototype.setUniform = function(e, f, j) {
    if(!this.uniforms) {
      this.uniforms = {}
    }
    this.uniforms[f] = {type:e, value:j}
  };
  e.Object.prototype.getUniform = function(e) {
    if(!this.uniforms) {
      this.uniforms = {}
    }
    return this.uniforms[e].value
  };
  e.Object.prototype.getUniformType = function(e) {
    if(!this.uniforms) {
      this.uniforms = {}
    }
    return this.uniforms[e].type
  };
  e.Object.prototype.setVertexShaderInjection = function(e) {
    this.shaderVertexInjection = e;
    this.updateProgram();
    return this
  };
  e.Object.prototype.getVertexShaderInjection = function() {
    return this.shaderVertexInjection
  };
  e.Object.prototype.getSkeleton = function() {
    return this.skeleton
  };
  e.Object.prototype.setSkeleton = function(e) {
    this.skeleton = e;
    this.bones = null;
    return this
  };
  e.Object.prototype.getBoundingVolume = function(f) {
    f || (f = 0);
    if(!this.boundingVolume) {
      this.boundingVolume = []
    }
    if(!this.boundmatrix) {
      this.boundmatrix = []
    }
    var h = this.getModelMatrix();
    if(h != this.boundmatrix[f] || !this.boundingVolume[f]) {
      for(var j = this.multimaterials, m, p = 0;p < j.length;p++) {
        j[p].lods[0].mesh && (m ? m.addBoundingVolume(j[p].lods[0].mesh.getBoundingVolume()) : m = j[p].lods[0].mesh.getBoundingVolume().clone())
      }
      m || (m = new e.BoundingVolume(0, 0, 0, 0, 0, 0));
      f ? m.applyMatrix(this.getLocalMatrix()) : m.applyMatrix(this.getModelMatrix());
      this.boundingVolume[f] = m
    }
    this.boundmatrix[f] = h;
    return this.boundingVolume[f]
  };
  e.Object.prototype.setZtransparent = function(e) {
    this.zTrans = e;
    return this
  };
  e.Object.prototype.isZtransparent = function() {
    return this.zTrans
  };
  e.Object.prototype.isComplete = function() {
    for(var e = 0;e < this.multimaterials.length;e++) {
      if(!this.multimaterials[e].isComplete()) {
        return!1
      }
    }
    return!0
  };
  e.Object.prototype.setMaterial = function(f, h) {
    typeof f == "string" && (f = e.Assets.get(f));
    h || (h = 0);
    this.multimaterials[h] || (this.multimaterials[h] = new e.MultiMaterial, this.multimaterials[h].addEventListener("downloadComplete", this.downloadComplete));
    this.multimaterials[h].getMaterial() != f && (this.multimaterials[h].setMaterial(f), this.updateProgram());
    return this
  };
  e.Object.prototype.getMaterial = function(e) {
    e || (e = 0);
    return this.multimaterials[e] ? this.multimaterials[e].getMaterial() : !1
  };
  e.Object.prototype.setMesh = function(f, h) {
    typeof f == "string" && (f = e.Assets.get(f));
    h || (h = 0);
    this.multimaterials[h] || (this.multimaterials[h] = new e.MultiMaterial, this.multimaterials[h].addEventListener("downloadComplete", this.downloadComplete));
    this.multimaterials[h].setMesh(f);
    this.boundingVolume = null;
    return this
  };
  e.Object.prototype.getMesh = function(e) {
    e || (e = 0);
    return this.multimaterials[e] ? this.multimaterials[e].getMesh() : !1
  };
  e.Object.prototype.GLInit = function(e) {
    this.gl = e
  };
  e.Object.prototype.GLDestory = function() {
  };
  e.Object.prototype.updateProgram = function() {
    for(var e = 0;e < this.multimaterials.length;e++) {
      this.multimaterials[e].updateProgram()
    }
  };
  e.Object.prototype.addMultiMaterial = function(f) {
    typeof f == "string" && (f = e.Assets.get(f));
    this.multimaterials.push(f);
    f.addEventListener("downloadComplete", this.downloadComplete);
    this.boundingVolume = null;
    return this
  };
  e.Object.prototype.getMultiMaterials = function() {
    return this.multimaterials
  };
  e.Object.prototype.GLGenerateShader = function(f) {
    var h = UV = joints1 = joints2 = !1, j = f.lights, m = [], p = !1;
    this.mesh.normals || this.mesh.calcNormals();
    for(var o = 0;o < this.mesh.buffers.length;o++) {
      this.mesh.buffers[o].name == "tangent" && (p = !0), this.mesh.buffers[o].size > 1 ? m.push("attribute vec" + this.mesh.buffers[o].size + " " + this.mesh.buffers[o].name + ";\n") : m.push("attribute float " + this.mesh.buffers[o].name + ";\n"), this.mesh.buffers[o].name == "UV" && (UV = !0), this.mesh.buffers[o].name == "color" && (h = !0), this.mesh.buffers[o].name == "joints1" && (joints1 = this.mesh.buffers[o]), this.mesh.buffers[o].name == "joints2" && (joints2 = this.mesh.buffers[o])
    }
    m.push("uniform mat4 worldView;\n");
    m.push("uniform mat4 projection;\n");
    m.push("uniform mat4 worldInverseTranspose;\n");
    m.push("uniform mat4 envMat;\n");
    m.push("uniform float cascadeLevel;\n");
    for(o = 0;o < j.length;o++) {
      if(j[o].type != e.L_OFF && (m.push("uniform vec3 lightpos" + o + ";\n"), m.push("uniform vec3 lightdir" + o + ";\n"), (j[o].type == e.L_SPOT || j[o].type == e.L_DIR) && j[o].getCastShadows())) {
        m.push("uniform mat4 lightmat" + o + ";\n"), m.push("varying vec4 spotcoord" + o + ";\n")
      }
    }
    m.push("varying vec3 eyevec;\n");
    for(o = 0;o < j.length;o++) {
      j[o].type != e.L_OFF && (m.push("varying vec3 lightvec" + o + ";\n"), m.push("varying float lightdist" + o + ";\n"))
    }
    this.mesh.joints && this.mesh.joints.length > 0 && m.push("uniform vec4 jointMat[" + 3 * this.mesh.joints.length + "];\n");
    this.material && m.push(this.material.getVertexVarying(m));
    m.push("varying vec3 n;\n");
    m.push("varying vec3 t;\n");
    h && m.push("varying vec4 vcolor;\n");
    m.push("varying vec4 UVCoord;\n");
    m.push("varying vec3 OBJCoord;\n");
    this.shaderVertexInjection && m.push(this.shaderVertexInjection);
    m.push("void main(void)\n");
    m.push("{\n");
    h && m.push("vcolor=color;\n");
    UV ? m.push("UVCoord=UV;\n") : m.push("UVCoord=vec4(0.0,0.0,0.0,0.0);\n");
    m.push("OBJCoord = position;\n");
    m.push("vec3 tang;\n");
    m.push("vec4 pos = vec4(0.0, 0.0, 0.0, 1.0);\n");
    m.push("vec4 norm = vec4(0.0, 0.0, 0.0, 1.0);\n");
    p && m.push("vec4 tang4 = vec4(0.0, 0.0, 0.0, 1.0);\n");
    if(joints1) {
      if(joints1.size == 1) {
        m.push("pos += vec4(dot(jointMat[int(3.0*joints1)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints1+1.0)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints1+2.0)],vec4(position,1.0)),1.0)*weights1;\n"), m.push("norm += vec4(dot(jointMat[int(3.0*joints1)].xyz,normal),\n               dot(jointMat[int(3.0*joints1+1.0)].xyz,normal),\n               dot(jointMat[int(3.0*joints1+2.0)].xyz,normal),1.0)*weights1;\n"), p && m.push("tang4 += vec4(dot(jointMat[int(3.0*joints1)].xyz,tangent),\n               dot(jointMat[int(3.0*joints1+1.0)].xyz,tangent),\n               dot(jointMat[int(3.0*joints1+2.0)].xyz,tangent),1.0)*weights1;\n")
      }else {
        for(o = 0;o < joints1.size;o++) {
          m.push("pos += vec4(dot(jointMat[int(3.0*joints1[" + o + "])],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints1[" + o + "]+1.0)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints1[" + o + "]+2.0)],vec4(position,1.0)),1.0)*weights1[" + o + "];\n"), m.push("norm += vec4(dot(jointMat[int(3.0*joints1[" + o + "])].xyz,normal),\n               dot(jointMat[int(3.0*joints1[" + o + "]+1.0)].xyz,normal),\n               dot(jointMat[int(3.0*joints1[" + o + "]+2.0)].xyz,normal),1.0)*weights1[" +
          o + "];\n"), p && m.push("tang4 += vec4(dot(jointMat[int(3.0*joints1[" + o + "])].xyz,tangent),\n               dot(jointMat[int(3.0*joints1[" + o + "]+1.0)].xyz,tangent),\n               dot(jointMat[int(3.0*joints1[" + o + "]+2.0)].xyz,tangent),1.0)*weights1[" + o + "];\n")
        }
      }
      if(joints2) {
        if(joints2.size == 1) {
          m.push("pos += vec4(dot(jointMat[int(3.0*joints2)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints2+1.0)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints2+2.0)],vec4(position,1.0)),1.0)*weights2;\n"), m.push("norm += vec4(dot(jointMat[int(3.0*joints2)].xyz,normal),\n               dot(jointMat[int(3.0*joints2+1.0)].xyz,normal),\n               dot(jointMat[int(3.0*joints2+2.0)].xyz,normal),1.0)*weights2;\n"), p && m.push("tang4 += vec4(dot(jointMat[int(3.0*joints2)].xyz,tangent),\n               dot(jointMat[int(3.0*joints2+1.0)].xyz,tangent),\n               dot(jointMat[int(3.0*joints2+2.0)].xyz,tangent),1.0)*weights2;\n")
        }else {
          for(o = 0;o < joints2.size;o++) {
            m.push("pos += vec4(dot(jointMat[int(3.0*joints2[" + o + "])],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints2[" + o + "]+1.0)],vec4(position,1.0)),\n              dot(jointMat[int(3.0*joints2[" + o + "]+2.0)],vec4(position,1.0)),1.0)*weights2[" + o + "];\n"), m.push("norm += vec4(dot(jointMat[int(3.0*joints2[" + o + "])].xyz,normal),\n               dot(jointMat[int(3.0*joints2[" + o + "]+1.0)].xyz,normal),\n               dot(jointMat[int(3.0*joints2[" + o + "]+2.0)].xyz,normal),1.0)*weights2[" +
            o + "];\n"), p && m.push("tang4 += vec4(dot(jointMat[int(3.0*joints2[" + o + "])].xyz,tangent),\n               dot(jointMat[int(3.0*joints2[" + o + "]+1.0)].xyz,tangent),\n               dot(jointMat[int(3.0*joints2[" + o + "]+2.0)].xyz,tangent),1.0)*weights2[" + o + "];\n")
          }
        }
      }
      for(o = 0;o < j.length;o++) {
        j[o].type != e.L_OFF && (j[o].type == e.L_SPOT || j[o].type == e.L_DIR) && j[o].getCastShadows() && m.push("spotcoord" + o + "=lightmat" + o + "*vec4(pos.xyz,1.0);\n")
      }
      this.shaderVertexInjection && m.push("pos=GLGE_Position(vec4(pos.xyz, 1.0));\n");
      m.push("pos = worldView * vec4(pos.xyz, 1.0);\n");
      m.push("norm = worldInverseTranspose * vec4(norm.xyz, 1.0);\n");
      p && m.push("tang = (worldInverseTranspose*vec4(tang4.xyz,1.0)).xyz;\n")
    }else {
      m.push("vec4 pos4=vec4(position,1.0);\n");
      this.shaderVertexInjection && ~this.shaderVertexInjection.indexOf("GLGE_Position") && m.push("pos4=GLGE_Position(pos4);\n");
      for(o = 0;o < j.length;o++) {
        j[o].type != e.L_OFF && (j[o].type == e.L_SPOT || j[o].type == e.L_DIR) && j[o].getCastShadows() && m.push("spotcoord" + o + "=lightmat" + o + "*pos4;\n")
      }
      m.push("pos = worldView * pos4;\n");
      m.push("norm = worldInverseTranspose * vec4(normal, 1.0);\n");
      p && m.push("tang = (worldInverseTranspose*vec4(tangent,1.0)).xyz;\n")
    }
    m.push("gl_Position = projection * pos;\n");
    m.push("gl_PointSize=" + this.pointSize.toFixed(5) + ";\n");
    m.push("eyevec = -pos.xyz;\n");
    p ? m.push("t = normalize(tang);") : m.push("t = vec3(0.0,0.0,0.0);");
    m.push("n = normalize(norm.rgb);");
    for(o = 0;o < j.length;o++) {
      j[o].type != e.L_OFF && (j[o].getType() == e.L_DIR ? m.push("lightvec" + o + " = -lightdir" + o + ";\n") : m.push("lightvec" + o + " = pos.xyz-lightpos" + o + ";\n"), m.push("lightdist" + o + " = length(lightpos" + o + ".xyz-pos.xyz);\n"))
    }
    this.material && m.push(this.material.getLayerCoords(this.shaderVertexInjection));
    m.push("}\n");
    m = m.join("");
    fragStr = this.material.getFragmentShader(j, h);
    this.GLFragmentShaderNormal = e.getGLShader(f, f.FRAGMENT_SHADER, this.nfragStr);
    this.GLFragmentShaderShadow = e.getGLShader(f, f.FRAGMENT_SHADER, this.shfragStr);
    this.GLFragmentShaderPick = e.getGLShader(f, f.FRAGMENT_SHADER, this.pkfragStr);
    this.GLFragmentShader = e.getGLShader(f, f.FRAGMENT_SHADER, fragStr);
    this.GLVertexShader = e.getGLShader(f, f.VERTEX_SHADER, m + "//default");
    this.GLVertexShaderShadow = e.getGLShader(f, f.VERTEX_SHADER, m + "//shadow");
    this.GLVertexShaderPick = e.getGLShader(f, f.VERTEX_SHADER, m + "//pick");
    this.GLVertexShaderNormal = e.getGLShader(f, f.VERTEX_SHADER, m + "//normal");
    this.GLShaderProgramPick = e.getGLProgram(f, this.GLVertexShaderPick, this.GLFragmentShaderPick);
    this.GLShaderProgramNormal = e.getGLProgram(f, this.GLVertexShaderNormal, this.GLFragmentShaderNormal);
    this.GLShaderProgramShadow = e.getGLProgram(f, this.GLVertexShaderShadow, this.GLFragmentShaderShadow);
    this.GLShaderProgram = e.getGLProgram(f, this.GLVertexShaderShadow, this.GLFragmentShader)
  };
  e.Object.prototype.createShaders = function(e) {
    if(this.gl) {
      this.mesh = e.mesh, this.material = e.material, this.GLGenerateShader(this.gl), e.GLShaderProgramPick = this.GLShaderProgramPick, e.GLShaderProgramShadow = this.GLShaderProgramShadow, e.GLShaderProgram = this.GLShaderProgram
    }
  };
  e.Object.prototype.GLUniforms = function(f, h, j) {
    var m;
    switch(h) {
      case e.RENDER_DEFAULT:
        m = this.GLShaderProgram;
        e.setUniform(f, "1i", e.getUniformLocation(f, m, "emitpass"), 0);
        break;
      case e.RENDER_EMIT:
        m = this.GLShaderProgram;
        e.setUniform(f, "1i", e.getUniformLocation(f, m, "emitpass"), 1);
        break;
      case e.RENDER_SHADOW:
        m = this.GLShaderProgramShadow;
        e.setUniform(f, "1i", e.getUniformLocation(f, m, "shadowtype"), 1);
        break;
      case e.RENDER_DEPTH:
        m = this.GLShaderProgramShadow;
        e.setUniform(f, "1f", e.getUniformLocation(f, m, "cascadeLevel"), 2);
        e.setUniform(f, "1i", e.getUniformLocation(f, m, "shadowtype"), 0);
        break;
      case e.RENDER_NORMAL:
        m = this.GLShaderProgramNormal;
        break;
      case e.RENDER_PICK:
        m = this.GLShaderProgramPick;
        var p = j >> 16 & 255, o = j >> 8 & 255;
        j &= 255;
        e.setUniform3(f, "3f", e.getUniformLocation(f, m, "pickcolor"), j / 255, o / 255, p / 255)
    }
    f.lineWidth(this.lineWidth);
    for(key in this.uniforms) {
      p = this.uniforms[key], p.type == "Matrix4fv" ? e.setUniformMatrix(f, "Matrix4fv", e.getUniformLocation(f, m, key), !1, p.value) : e.setUniform(f, p.type, e.getUniformLocation(f, m, key), p.value)
    }
    if(!m.caches) {
      m.caches = {}
    }
    if(!m.glarrays) {
      m.glarrays = {}
    }
    var j = m.caches, p = m.glarrays, o = f.scene, r = o.camera;
    if(j.far != r.far) {
      e.setUniform(f, "1i", e.getUniformLocation(f, m, "far"), r.far), j.far = r.far
    }
    if(h == e.RENDER_DEFAULT || h == e.RENDER_EMIT) {
      if(j.ambientColor != o.ambientColor) {
        var s = o.ambientColor;
        e.setUniform3(f, "3f", e.getUniformLocation(f, m, "amb"), s.r, s.g, s.b);
        j.ambientColor = s
      }
      if(j.fogFar != o.fogFar) {
        e.setUniform(f, "1f", e.getUniformLocation(f, m, "fogfar"), o.fogFar), j.fogFar = o.fogFar
      }
      if(j.fogNear != o.fogNear) {
        e.setUniform(f, "1f", e.getUniformLocation(f, m, "fognear"), o.fogNear), j.fogNear = o.fogNear
      }
      if(j.fogType != o.fogType) {
        e.setUniform(f, "1i", e.getUniformLocation(f, m, "fogtype"), o.fogType), j.fogType = o.fogType
      }
      if(j.fogType != o.fogcolor) {
        e.setUniform3(f, "3f", e.getUniformLocation(f, m, "fogcolor"), o.fogColor.r, o.fogColor.g, o.fogColor.b), j.fogcolor = o.fogcolor
      }
    }
    s = r.getViewMatrix();
    o = this.getModelMatrix();
    if(!j.mvMatrix) {
      j.mvMatrix = {cameraMatrix:null, modelMatrix:null}
    }
    var t = j.mvMatrix;
    if(t.cameraMatrix != s || t.modelMatrix != o) {
      if(!this.caches.mvMatrix) {
        this.caches.mvMatrix = e.mulMat4(s, o)
      }
      mvMatrix = this.caches.mvMatrix;
      this.mesh.joints && (mvMatrix = s);
      var q = e.getUniformLocation(f, m, "worldView"), u = e.transposeMat4(mvMatrix);
      p.mvMatrix ? e.mat4gl(u, p.mvMatrixT) : p.mvMatrixT = new Float32Array(u);
      p.mvMatrix = mvMatrix;
      e.setUniformMatrix(f, "Matrix4fv", q, !1, m.glarrays.mvMatrixT);
      if(q = e.getUniformLocation(f, m, "envMat")) {
        if(!this.caches.envMat) {
          var v = e.inverseMat4(mvMatrix);
          v[3] = 0;
          v[7] = 0;
          v[11] = 0;
          this.caches.envMat = v
        }
        v = this.caches.envMat;
        u = e.transposeMat4(v);
        m.glarrays.envMat ? e.mat4gl(u, p.envMatT) : p.envMatT = new Float32Array(u);
        p.envMat = v;
        e.setUniformMatrix(f, "Matrix4fv", q, !1, p.envMatT)
      }
      if(!this.caches.normalMatrix) {
        u = e.inverseMat4(mvMatrix), this.caches.normalMatrix = u
      }
      u = this.caches.normalMatrix;
      q = e.getUniformLocation(f, m, "worldInverseTranspose");
      p.normalMatrix ? e.mat4gl(u, p.normalMatrix) : p.normalMatrix = new Float32Array(u);
      e.setUniformMatrix(f, "Matrix4fv", q, !1, p.normalMatrix);
      q = e.getUniformLocation(f, m, "view");
      u = e.transposeMat4(s);
      p.cameraMatrix ? e.mat4gl(u, p.cameraMatrixT) : p.cameraMatrixT = new Float32Array(u);
      p.cameraMatrix = s;
      e.setUniformMatrix(f, "Matrix4fv", q, !1, p.cameraMatrixT);
      t.cameraMatrix = s;
      t.modelMatrix = o
    }
    t = e.getUniformLocation(f, m, "projection");
    u = e.transposeMat4(r.getProjectionMatrix());
    p.pMatrix ? e.mat4gl(u, p.pMatrixT) : p.pMatrixT = new Float32Array(u);
    p.pMatrix = r.getProjectionMatrix();
    e.setUniformMatrix(f, "Matrix4fv", t, !1, p.pMatrixT);
    if(h == e.RENDER_DEFAULT || h == e.RENDER_SHADOW || h == e.RENDER_DEPTH || h == e.RENDER_EMIT) {
      var w = f.lights;
      if(!j.lights) {
        j.lights = []
      }
      if(!p.lights) {
        p.lights = []
      }
      if(!this.caches.lights) {
        this.caches.lights = []
      }
      t = j.lights;
      for(r = 0;r < w.length;r++) {
        if(w[r].type != e.L_OFF && (t[r] || (t[r] = {modelMatrix:null, cameraMatrix:null}), t[r].modelMatrix != o || t[r].cameraMatrix != s)) {
          this.caches.lights[r] || (this.caches.lights[r] = {});
          if(!this.caches.lights[r].pos) {
            this.caches.lights[r].pos = e.mulMat4Vec4(e.mulMat4(s, w[r].getModelMatrix()), [0, 0, 0, 1])
          }
          u = this.caches.lights[r].pos;
          e.setUniform3(f, "3f", e.getUniformLocation(f, m, "lightpos" + r), u[0], u[1], u[2]);
          if(!this.caches.lights[r].lpos) {
            this.caches.lights[r].lpos = e.mulMat4Vec4(e.mulMat4(s, w[r].getModelMatrix()), [0, 0, 1, 1])
          }
          q = this.caches.lights[r].lpos;
          e.setUniform3(f, "3f", e.getUniformLocation(f, m, "lightdir" + r), q[0] - u[0], q[1] - u[1], q[2] - u[2]);
          w[r].s_cache && (u = e.mulMat4(w[r].s_cache.smatrix, o), p.lights[r] ? e.mat4gl(u, p.lights[r]) : p.lights[r] = new Float32Array(u), e.setUniformMatrix(f, "Matrix4fv", e.getUniformLocation(f, m, "lightmat" + r), !0, p.lights[r]), e.setUniform2(f, "2f", e.getUniformLocation(f, m, "shadowoffset" + r), w[r].s_cache.pmatrix[3], w[r].s_cache.pmatrix[7]));
          t[r].modelMatrix = o;
          t[r].cameraMatrix = s
        }
      }
    }
    if(this.mesh.joints) {
      if(!j.joints) {
        j.joints = []
      }
      if(!p.joints) {
        p.joints = []
      }
      if(!p.jointsT) {
        p.jointsT = []
      }
      if(!p.jointsinv) {
        p.jointsinv = []
      }
      if(!p.jointsCombined || p.jointsCombined.length != this.mesh.joints.length * 12) {
        p.jointsCombined = new Float32Array(this.mesh.joints.length * 12)
      }
      j = j.joints;
      e.identMatrix();
      for(r = 0;r < this.mesh.joints.length;r++) {
        j[r] || (j[r] = {modelMatrix:null, invBind:null});
        if(typeof this.mesh.joints[r] == "string") {
          if(!this.bones) {
            this.bones = this.skeleton.getNames()
          }
          this.bones && (o = this.bones[this.mesh.joints[r]].getModelMatrix())
        }else {
          o = this.mesh.joints[r].getModelMatrix()
        }
        s = this.mesh.invBind[r];
        if(j[r].modelMatrix != o || j[r].invBind != s) {
          t = e.mulMat4(o, s), p.joints[r] ? e.mat4gl(e.transposeMat4(t), p.jointsT[r]) : p.jointsT[r] = new Float32Array(e.transposeMat4(t)), p.joints[r] = t, p.jointsinv[r] ? e.mat4gl(e.inverseMat4(t), p.jointsinv[r]) : p.jointsinv[r] = new Float32Array(e.inverseMat4(t)), t = p.jointsT[r], u = p.jointsCombined, u[r * 12] = t[0], u[r * 12 + 1] = t[4], u[r * 12 + 2] = t[8], u[r * 12 + 3] = t[12], u[r * 12 + 4] = t[1], u[r * 12 + 5] = t[5], u[r * 12 + 6] = t[9], u[r * 12 + 7] = t[13], u[r * 12 + 8] =
          t[2], u[r * 12 + 9] = t[6], u[r * 12 + 10] = t[10], u[r * 12 + 11] = t[14], j[r].modelMatrix = o, j[r].invBind = s
        }
      }
      f.uniform4fv(e.getUniformLocation(f, m, "jointMat"), p.jointsCombined)
    }
    if(this.material && (h == e.RENDER_DEFAULT || h == e.RENDER_EMIT) && f.scene.lastMaterial != this.material) {
      this.material.textureUniforms(f, m, w, this), f.scene.lastMaterial = this.material
    }
  };
  e.Object.prototype.GLRender = function(f, h, j, m, p) {
    if(f) {
      this.gl || this.GLInit(f);
      this.lookAt && this.Lookat(this.lookAt);
      h == e.RENDER_DEFAULT && this.animation && this.animate();
      this.renderCaches[h] || (this.renderCaches[h] = {});
      var o = f.scene.camera.getViewMatrix(), r = this.getModelMatrix();
      if(this.renderCaches[h].cameraMatrix != o || this.renderCaches[h].modelMatrix != r) {
        this.renderCaches[h] = {}, this.renderCaches[h].cameraMatrix = o, this.renderCaches[h].modelMatrix = r
      }
      this.caches = this.renderCaches[h];
      var s;
      m == void 0 ? (o = 0, m = this.multimaterials.length) : (o = m, m += 1);
      for(;o < m;o++) {
        if(this.multimaterials[o].lods.length > 1 && !s && (s = f.scene.camera.getPosition(), r = this.getPosition(), s = e.lengthVec3([s.x - r.x, s.y - r.y, s.z - r.z]), s = e.mulMat4Vec4(f.scene.camera.getProjectionMatrix(), [this.getBoundingVolume().getSphereRadius(), 0, -s, 1]), s = s[0] / s[3] * f.scene.renderer.canvas.width), r = this.multimaterials[o].getLOD(s), r.mesh && r.mesh.loaded) {
          if(h == e.RENDER_NULL) {
            r.material && r.material.registerPasses(f, this);
            break
          }
          r.GLShaderProgram ? (this.GLShaderProgramPick = r.GLShaderProgramPick, this.GLShaderProgramShadow = r.GLShaderProgramShadow, this.GLShaderProgram = r.GLShaderProgram) : this.createShaders(r);
          this.mesh = r.mesh;
          this.material = r.material;
          switch(this.drawType) {
            case e.DRAW_LINES:
              r = f.LINES;
              break;
            case e.DRAW_POINTS:
              r = f.POINTS;
              break;
            case e.DRAW_LINELOOPS:
              r = f.LINE_LOOP;
              break;
            case e.DRAW_LINESTRIPS:
              r = f.LINE_STRIP;
              break;
            default:
              r = f.TRIANGLES
          }
          switch(h) {
            case e.RENDER_DEFAULT:
            ;
            case e.RENDER_EMIT:
              if(f.program != this.GLShaderProgram) {
                f.useProgram(this.GLShaderProgram), f.program = this.GLShaderProgram
              }
              this.mesh.GLAttributes(f, this.GLShaderProgram);
              break;
            case e.RENDER_SHADOW:
            ;
            case e.RENDER_DEPTH:
              if(f.program != this.GLShaderProgramShadow) {
                f.useProgram(this.GLShaderProgramShadow), f.program = this.GLShaderProgramShadow
              }
              p || (p = f.scene.camera.getFar());
              e.setUniform(f, "1f", e.getUniformLocation(f, this.GLShaderProgramShadow, "distance"), p);
              this.mesh.GLAttributes(f, this.GLShaderProgramShadow);
              break;
            case e.RENDER_NORMAL:
              if(f.program != this.GLShaderProgramNormal) {
                f.useProgram(this.GLShaderProgramNormal), f.program = this.GLShaderProgramNormal
              }
              this.mesh.GLAttributes(f, this.GLShaderProgramNormal);
              break;
            case e.RENDER_PICK:
              if(f.program != this.GLShaderProgramPick) {
                f.useProgram(this.GLShaderProgramPick), f.program = this.GLShaderProgramPick
              }
              this.mesh.GLAttributes(f, this.GLShaderProgramPick);
              r = f.TRIANGLES
          }
          this.GLUniforms(f, h, j);
          switch(this.mesh.windingOrder) {
            case e.Mesh.WINDING_ORDER_UNKNOWN:
              f.disable(f.CULL_FACE);
              break;
            case e.Mesh.WINDING_ORDER_COUNTER:
              f.cullFace(f.FRONT)
          }
          this.mesh.GLfaces ? (f.bindBuffer(f.ELEMENT_ARRAY_BUFFER, this.mesh.GLfaces), f.drawElements(r, this.mesh.GLfaces.numItems, f.UNSIGNED_SHORT, 0)) : f.drawArrays(r, 0, this.mesh.positions.length / 3);
          switch(this.mesh.windingOrder) {
            case e.Mesh.WINDING_ORDER_UNKNOWN:
              f.scene.renderer.cullFaces && f.enable(f.CULL_FACE);
              break;
            case e.Mesh.WINDING_ORDER_COUNTER:
              f.cullFace(f.BACK)
          }
          r = this.caches;
          this.matrix = this.matrix;
          this.caches = r
        }
      }
    }
  }
})(GLGE);
(function(e) {
  e.PhysicsAbstract = function() {
    this.children = []
  };
  e.augment(e.Group, e.PhysicsAbstract);
  e.PHYSICS_ALL = 1;
  e.PHYSICS_LOC = 2;
  e.PhysicsAbstract.prototype.physicsType = e.PHYSICS_ALL;
  e.PhysicsAbstract.prototype.sync = !0;
  e.PhysicsAbstract.prototype.setType = function(e) {
    this.physicsType = e;
    return this
  };
  e.PhysicsAbstract.prototype.getType = function() {
    return this.physicsType
  };
  e.PhysicsAbstract.prototype.preProcess = function() {
    if(this.sync) {
      var e = this.getModelMatrix();
      this.jigLibObj.moveTo([e[3], e[7], e[11], 0]);
      if(this.physicsType == 1) {
        var g = Math.sqrt(e[0] * e[0] + e[1] * e[1] + e[2] * e[2]), h = Math.sqrt(e[4] * e[4] + e[5] * e[5] + e[6] * e[6]), j = Math.sqrt(e[8] * e[8] + e[9] * e[9] + e[10] * e[10]);
        this.jigLibObj.setOrientation(new jigLib.Matrix3D([e[0] / g, e[1] / g, e[2] / g, 0, e[4] / h, e[5] / h, e[6] / h, 0, e[8] / j, e[9] / j, e[10] / j, 0, 0, 0, 0, 1]))
      }
      this.sync = !1
    }
  };
  e.PhysicsAbstract.prototype.get_transform = function() {
    return new jigLib.Matrix3D(this.getModelMatrix())
  };
  e.PhysicsAbstract.prototype.updateMatrix = function() {
    this.globalMatrix = null;
    this.sync = !0;
    e.Placeable.prototype.updateMatrix.call(this)
  };
  e.PhysicsAbstract.prototype.getModelMatrix = function() {
    if(this.globalMatrix) {
      return this.globalMatrix
    }
    return e.Placeable.prototype.getModelMatrix.call(this)
  };
  e.PhysicsAbstract.prototype.set_transform = function(f) {
    var f = f.glmatrix, g = [f[0], f[1], f[2], f[3], f[4], f[5], f[6], f[7], f[8], f[9], f[10], f[11], f[12], f[13], f[14], f[15]];
    this.locX = f[3];
    this.locY = f[7];
    this.locZ = f[11];
    g = e.mulMat4(g, this.getScaleMatrix());
    this.physicsType != 1 && (f = this.getModelMatrix(), g[0] = f[0], g[1] = f[1], g[2] = f[2], g[4] = f[4], g[5] = f[5], g[6] = f[6], g[8] = f[8], g[9] = f[9], g[10] = f[10]);
    this.globalMatrix = g;
    if(this.children) {
      for(g = 0;g < this.children.length;g++) {
        this.children[g].updateMatrix()
      }
    }
    return this
  };
  e.PhysicsAbstract.prototype.setVelocity = function(f, g) {
    this.getMovable() || e.error("Cannot set velocity on static object");
    this.jigLibObj.setVelocity(f, g);
    return this
  };
  e.PhysicsAbstract.prototype.setVelocityX = function(f) {
    this.getMovable() || e.error("Cannot set velocity on static object");
    var g = this.jigLibObj.getVelocity([0, 0, 0]);
    g[0] = +f;
    this.jigLibObj.setVelocity(g);
    return this
  };
  e.PhysicsAbstract.prototype.setVelocityY = function(f) {
    this.getMovable() || e.error("Cannot set velocity on static object");
    var g = this.jigLibObj.getVelocity([0, 0, 0]);
    g[1] = +f;
    this.jigLibObj.setVelocity(g);
    return this
  };
  e.PhysicsAbstract.prototype.setVelocityZ = function(f) {
    this.getMovable() || e.error("Cannot set velocity on static object");
    var g = this.jigLibObj.getVelocity([0, 0, 0]);
    g[2] = +f;
    this.jigLibObj.setVelocity(g);
    return this
  };
  e.PhysicsAbstract.prototype.getVelocity = function() {
    return this.jigLibObj.getVelocity([0, 0, 0])
  };
  e.PhysicsAbstract.prototype.getVelocityX = function() {
    return this.jigLibObj.getVelocity([0, 0, 0])[0]
  };
  e.PhysicsAbstract.prototype.getVelocityY = function() {
    return this.jigLibObj.getVelocity([0, 0, 0])[1]
  };
  e.PhysicsAbstract.prototype.getVelocityZ = function() {
    return this.jigLibObj.getVelocity([0, 0, 0])[2]
  };
  e.PhysicsAbstract.prototype.setAngularVelocity = function(f) {
    this.getMovable() || e.error("Cannot set velocity on static object");
    this.jigLibObj.setAngVel(f);
    return this
  };
  e.PhysicsAbstract.prototype.setAngularVelocityX = function(f) {
    this.getMovable() || e.error("Cannot set velocity on static object");
    var g = this.jigLibObj.getAngVel();
    g[0] = +f;
    this.jigLibObj.setAngVel(g);
    return this
  };
  e.PhysicsAbstract.prototype.setAngularVelocityY = function(f) {
    this.getMovable() || e.error("Cannot set velocity on static object");
    var g = this.jigLibObj.getAngVel();
    g[1] = +f;
    this.jigLibObj.setAngVel(g);
    return this
  };
  e.PhysicsAbstract.prototype.setAngularVelocityZ = function(f) {
    this.getMovable() || e.error("Cannot set velocity on static object");
    var g = this.jigLibObj.getAngVel();
    g[2] = +f;
    this.jigLibObj.setAngVel(g);
    return this
  };
  e.PhysicsAbstract.prototype.getAngularVelocity = function() {
    return this.jigLibObj.getAngVel()
  };
  e.PhysicsAbstract.prototype.getAngularVelocityX = function() {
    return this.jigLibObj.getAngVel()[0]
  };
  e.PhysicsAbstract.prototype.getAngularVelocityY = function() {
    return this.jigLibObj.getAngVel()[1]
  };
  e.PhysicsAbstract.prototype.getAngularVelocityZ = function() {
    return this.jigLibObj.getAngVel()[2]
  };
  e.PhysicsAbstract.prototype.setMovable = function(e) {
    this.jigLibObj.set_movable(e);
    return this
  };
  e.PhysicsAbstract.prototype.getMovable = function() {
    return this.jigLibObj.get_movable()
  };
  e.PhysicsAbstract.prototype.setFriction = function(e) {
    this.jigLibObj.set_friction(e);
    return this
  };
  e.PhysicsAbstract.prototype.getFriction = function() {
    return this.jigLibObj.get_friction()
  };
  e.PhysicsAbstract.prototype.setRestitution = function(e) {
    this.jigLibObj.set_restitution(e);
    return this
  };
  e.PhysicsAbstract.prototype.getRestitution = function() {
    return this.jigLibObj.get_restitution()
  };
  e.PhysicsAbstract.prototype.addBodyForce = function(e, g) {
    this.jigLibObj.addBodyForce(e, g);
    return this
  };
  e.PhysicsAbstract.prototype.addWorldForce = function(e, g) {
    this.jigLibObj.addWorldForce(e, g);
    return this
  };
  e.PhysicsAbstract.prototype.addWorldTorque = function(e) {
    this.jigLibObj.addWorldTorque(e);
    return this
  };
  e.PhysicsAbstract.prototype.addBodyTorque = function(e) {
    this.jigLibObj.addBodyTorque(e);
    return this
  };
  e.PhysicsAbstract.prototype.setLinearVelocityDamping = function(e) {
    this.jigLibObj.set_linVelocityDamping(e);
    return this
  };
  e.PhysicsAbstract.prototype.getRotationalVelocityDamping = function() {
    return this.jigLibObj.get_rotVelocityDamping()
  };
  e.PhysicsAbstract.prototype.getLinearVelocityDamping = function() {
    return this.jigLibObj.get_linVelocityDamping()
  };
  e.PhysicsAbstract.prototype.setRotationalVelocityDamping = function(e) {
    this.jigLibObj.set_rotVelocityDamping(e);
    return this
  };
  e.PhysicsAbstract.prototype.clearForces = function() {
    this.jigLibObj.clearForces();
    return this
  }
})(GLGE);
(function(e) {
  e.FOG_NONE = 1;
  e.FOG_LINEAR = 2;
  e.FOG_QUADRATIC = 3;
  e.FOG_SKYLINEAR = 4;
  e.FOG_SKYQUADRATIC = 5;
  e.Scene = function(f) {
    e.Assets.registerAsset(this, f);
    e.Group.call(this);
    this.children = [];
    this.camera = new e.Camera;
    this.backgroundColor = {r:1, g:1, b:1, a:1};
    this.ambientColor = {r:0, g:0, b:0};
    this.fogColor = {r:0.5, g:0.5, b:0.5};
    this.passes = []
  };
  e.augment(e.Group, e.Scene);
  e.Scene.prototype.camera = null;
  e.Scene.prototype.className = "Scene";
  e.Scene.prototype.renderer = null;
  e.Scene.prototype.backgroundColor = null;
  e.Scene.prototype.filter = null;
  e.Scene.prototype.fogColor = null;
  e.Scene.prototype.ambientColor = null;
  e.Scene.prototype.fogNear = 10;
  e.Scene.prototype.fogFar = 80;
  e.Scene.prototype.fogType = e.FOG_NONE;
  e.Scene.prototype.passes = null;
  e.Scene.prototype.culling = !0;
  e.Scene.prototype.getFogType = function() {
    return this.fogType
  };
  e.Scene.prototype.setFogType = function(e) {
    this.fogType = e;
    return this
  };
  e.Scene.prototype.getFogFar = function() {
    return this.fogFar
  };
  e.Scene.prototype.setFogFar = function(e) {
    this.fogFar = e;
    return this
  };
  e.Scene.prototype.getFogNear = function() {
    return this.fogNear
  };
  e.Scene.prototype.setFogNear = function(e) {
    this.fogNear = e;
    return this
  };
  e.Scene.prototype.getFogColor = function() {
    return this.fogColor
  };
  e.Scene.prototype.setFogColor = function(f) {
    f = e.colorParse(f);
    this.fogColor = {r:f.r, g:f.g, b:f.b};
    return this
  };
  e.Scene.prototype.getBackgroundColor = function() {
    return this.backgroundColor
  };
  e.Scene.prototype.setBackgroundColor = function(f) {
    f = e.colorParse(f);
    this.backgroundColor = {r:f.r, g:f.g, b:f.b, a:f.a};
    return this
  };
  e.Scene.prototype.getAmbientColor = function() {
    return this.ambientColor
  };
  e.Scene.prototype.setAmbientColor = function(f) {
    f = e.colorParse(f);
    this.ambientColor = {r:f.r, g:f.g, b:f.b};
    this.renderer && this.renderer.gl.clearColor(this.backgroundColor.r, this.backgroundColor.g, this.backgroundColor.b, 1);
    return this
  };
  e.Scene.prototype.setAmbientColorR = function(e) {
    this.ambientColor.r = e;
    return this
  };
  e.Scene.prototype.setAmbientColorG = function(e) {
    this.ambientColor.g = e;
    return this
  };
  e.Scene.prototype.setAmbientColorB = function(e) {
    this.ambientColor.b = e;
    return this
  };
  e.Scene.prototype.setCamera = function(f) {
    typeof f == "string" && (f = e.Assets.get(f));
    this.camera = f;
    return this
  };
  e.Scene.prototype.getCamera = function() {
    return this.camera
  };
  e.Scene.prototype.setCull = function(e) {
    this.culling = e;
    return this
  };
  e.Scene.prototype.getCull = function() {
    return this.culling
  };
  e.Scene.prototype.GLInit = function(e) {
    this.gl = e;
    e.lights = this.getLights();
    this.camera.setAspect(this.renderer.canvas.width / this.renderer.canvas.height);
    this.renderer.gl.clearColor(this.backgroundColor.r, this.backgroundColor.g, this.backgroundColor.b, 1);
    for(var g = 0;g < this.children;g++) {
      this.children[g].GLInit && children[g].GLInit(e)
    }
  };
  e.Scene.prototype.GLDestroy = function() {
  };
  e.Scene.sortFunc = function(e, g) {
    return e.zdepth - g.zdepth
  };
  e.Scene.prototype.zSort = function(f, g) {
    for(var h = f.scene.camera.getViewMatrix(), j = 0;j < g.length;j++) {
      if(g[j].object.getBoundingVolume) {
        var m = g[j].object.getBoundingVolume().getCenter()
      }else {
        m = g[j].object.getModelMatrix(), m = [m[3], m[7], m[11]]
      }
      g[j].zdepth = m[0] * h[8] + m[1] * h[9] + m[2] * h[10] + h[11]
    }
    g.sort(e.Scene.sortFunc);
    return g
  };
  e.Scene.prototype.setFilter2d = function(e) {
    this.filter = e;
    return this
  };
  e.Scene.prototype.getFilter2d = function() {
    return this.filter
  };
  e.Scene.prototype.setSkyFilter = function(e) {
    this.skyfilter = e;
    return this
  };
  e.Scene.prototype.getSkyFilter = function() {
    return this.skyfilter
  };
  e.Scene.prototype.getFrameBuffer = function(e) {
    if(this.filter) {
      return this.filter.getFrameBuffer(e)
    }
    return null
  };
  e.Scene.prototype.objectsInViewFrustum = function(f, g) {
    for(var h, j = [], m = e.cameraViewProjectionToPlanes(g), p = 0;p < f.length;p++) {
      if(h = f[p], h.getBoundingVolume && h.cull) {
        var o = h.getBoundingVolume(), r = o.getCenter(), s = o.getSphereRadius();
        e.sphereInFrustumPlanes([r[0], r[1], r[2], s], m) ? (o = o.getCornerPoints(), e.pointsInFrustumPlanes(o, m) ? (j.push(h), h.culled && h.fireEvent("willRender", {}), h.culled = !1) : (h.culled || h.fireEvent("willCull", {}), h.culled = !0)) : (h.culled || h.fireEvent("willCull", {}), h.culled = !0)
      }else {
        j.push(h)
      }
    }
    return j
  };
  e.Scene.prototype.unfoldRenderObject = function(e) {
    for(var g = [], h = 0;h < e.length;h++) {
      var j = e[h];
      if(j.getMultiMaterials) {
        for(var m = j.getMultiMaterials(), p = 0;p < m.length;p++) {
          var o = m[p].getMaterial();
          m[p].getMesh();
          if(!o.meshIdx) {
            o.matIdx = p
          }
          if(!o.meshIdx) {
            o.meshIdx = p
          }
          g.push({object:j, multiMaterial:p})
        }
      }else {
        g.push({object:j, multiMaterial:0})
      }
    }
    return g
  };
  e.Scene.prototype.stateSort = function(e, g) {
    if(!e.object.GLShaderProgram) {
      return 1
    }
    if(!g.object.GLShaderProgram) {
      return-1
    }
    var h = e.object.GLShaderProgram.progIdx, j = g.object.GLShaderProgram.progIdx;
    if(h > j) {
      return 1
    }else {
      if(h < j) {
        return-1
      }else {
        if(!e.object.multimaterials || !g.object.multimaterials) {
          return-1
        }
        h = e.object.multimaterials[e.multiMaterial].getMaterial().matIdx;
        j = g.object.multimaterials[g.multiMaterial].getMaterial().matIdx;
        if(h > j) {
          return 1
        }else {
          if(h < j) {
            return-1
          }else {
            h = e.object.multimaterials[e.multiMaterial].getMesh();
            j = e.object.multimaterials[e.multiMaterial].getMesh();
            if(!h) {
              return-1
            }
            if(!j) {
              return 1
            }
            h = h.meshIdx;
            j = j.meshIdx;
            return h > j ? 1 : h < j ? -1 : 0
          }
        }
      }
    }
  };
  e.Scene.prototype.createSkyBuffer = function(e) {
    this.skyTexture = e.createTexture();
    e.bindTexture(e.TEXTURE_2D, this.skyTexture);
    e.texImage2D(e.TEXTURE_2D, 0, e.RGB, this.renderer.canvas.width, this.renderer.canvas.height, 0, e.RGB, e.UNSIGNED_BYTE, null)
  };
  e.Scene.prototype.render = function(f) {
    this.camera.lookAt && this.camera.Lookat(this.camera.lookAt);
    this.animate();
    f.lights = this.getLights();
    var g = f.lights;
    f.scene = this;
    this.lastMaterial = null;
    f.disable(f.BLEND);
    this.framebuffer = this.getFrameBuffer(f);
    var h = this.getObjects(), j = this.camera.getViewProjection();
    this.culling && (j = this.camera.getViewProjection(), h = this.objectsInViewFrustum(h, j));
    for(var h = this.unfoldRenderObject(h), h = h.sort(this.stateSort), m = 0;m < g.length;m++) {
      if(g[m].castShadows) {
        g[m].gl || g[m].GLInit(f);
        var p = this.camera.matrix, o = this.camera.getProjectionMatrix(), r = 0;
        if(g[m].getType() == e.L_DIR) {
          var r = g[m].getModelMatrix(), s = e.inverseMat4(p);
          r[3] = r[2] * g[m].distance / 2 + s[3];
          r[7] = r[6] * g[m].distance / 2 + s[7];
          r[11] = r[10] * g[m].distance / 2 + s[11];
          g[m].matrix = r;
          r = e.mulMat4Vec4(o, [0, 0, g[m].distance, 1]);
          r = r[3] / r[2]
        }
        f.bindFramebuffer(f.FRAMEBUFFER, g[m].frameBuffer);
        if(!g[m].s_cache) {
          g[m].s_cache = {}
        }
        g[m].s_cache.imvmatrix = e.inverseMat4(g[m].getModelMatrix());
        g[m].s_cache.mvmatrix = g[m].getModelMatrix();
        g[m].s_cache.pmatrix = g[m].getPMatrix(j, g[m].s_cache.imvmatrix, r, this.camera.far / 2);
        g[m].s_cache.smatrix = e.mulMat4(g[m].s_cache.pmatrix, g[m].s_cache.imvmatrix);
        g[m].shadowRendered = !1;
        r = g[m].getType() == e.L_DIR ? g[m].getCascadeLevels() : 1;
        f.viewport(0, 0, parseFloat(g[m].bufferWidth), parseFloat(g[m].bufferHeight));
        f.clearDepth(1);
        f.clearColor(0, 0, 0, 0);
        f.clear(f.COLOR_BUFFER_BIT | f.DEPTH_BUFFER_BIT);
        for(var s = parseFloat(g[m].bufferHeight) / r | 0, t = parseFloat(g[m].bufferWidth), q = 0;q < r;q++) {
          f.viewport(0, q * s, t, s);
          this.camera.setProjectionMatrix(g[m].s_cache.pmatrix);
          this.camera.matrix = g[m].s_cache.imvmatrix;
          for(var u = 0;u < h.length;u++) {
            g[m].getType() == e.L_SPOT ? h[u].object.GLRender(f, e.RENDER_SHADOW, u, h[u].multiMaterial, g[m].distance) : h[u].object.GLRender(f, e.RENDER_DEPTH, u, h[u].multiMaterial, g[m].distance)
          }
          g[m].s_cache.pmatrix[0] *= 2;
          g[m].s_cache.pmatrix[5] *= 2
        }
        g[m].s_cache.pmatrix[0] /= 2;
        g[m].s_cache.pmatrix[5] /= 2;
        g[m].s_cache.smatrix = e.mulMat4(g[m].s_cache.pmatrix, g[m].s_cache.imvmatrix);
        this.camera.matrix = p;
        this.camera.setProjectionMatrix(o)
      }
    }
    this.culling && (j = this.camera.getViewProjection(), h = this.objectsInViewFrustum(h, j));
    f.bindFramebuffer(f.FRAMEBUFFER, this.framebuffer);
    this.camera.animation && this.camera.animate();
    this.getPasses(f, h);
    p = this.camera.matrix;
    o = this.camera.getProjectionMatrix();
    for(this.allowPasses = !1;this.passes.length > 0;) {
      g = this.passes.pop(), f.bindFramebuffer(f.FRAMEBUFFER, g.frameBuffer), this.camera.matrix = g.cameraMatrix, this.camera.setProjectionMatrix(g.projectionMatrix), this.renderPass(f, h, 0, 0, g.width, g.height, e.RENDER_DEFAULT, g.self)
    }
    this.camera.matrix = p;
    this.camera.setProjectionMatrix(o);
    f.bindFramebuffer(f.FRAMEBUFFER, this.framebuffer);
    this.renderPass(f, h, this.renderer.getViewportOffsetX(), this.renderer.getViewportOffsetY(), this.renderer.getViewportWidth(), this.renderer.getViewportHeight());
    this.applyFilter(f, h, null);
    this.allowPasses = !0
  };
  e.Scene.prototype.getPasses = function(f, g) {
    for(var h = 0;h < g.length;h++) {
      g[h].object.GLRender(f, e.RENDER_NULL, 0, g[h].multiMaterial)
    }
  };
  e.Scene.prototype.renderPass = function(f, g, h, j, m, p, o, r) {
    f.clearDepth(1);
    f.depthFunc(f.LEQUAL);
    f.viewport(h, j, m, p);
    f.clearColor(this.backgroundColor.r, this.backgroundColor.g, this.backgroundColor.b, this.backgroundColor.a);
    o ? f.clear(f.DEPTH_BUFFER_BIT | f.COLOR_BUFFER_BIT | f.STENCIL_BUFFER_BIT) : (f.scissor(h, j, m, p), f.enable(f.SCISSOR_TEST), this.renderer.GLClear(), f.disable(f.SCISSOR_TEST));
    if(!o) {
      o = e.RENDER_DEFAULT
    }
    if(this.skyfilter && o == e.RENDER_DEFAULT && (this.skyfilter.GLRender(f), f.clear(f.DEPTH_BUFFER_BIT), this.skyfilter && this.fogType == e.FOG_SKYQUADRATIC || this.fogType == e.FOG_SKYLINEAR)) {
      this.skyTexture || this.createSkyBuffer(f), f.bindTexture(f.TEXTURE_2D, this.skyTexture), f.copyTexImage2D(f.TEXTURE_2D, 0, f.RGB, 0, 0, m, p, 0)
    }
    h = [];
    f.disable(f.BLEND);
    for(j = 0;j < g.length;j++) {
      !g[j].object.zTrans && g[j].object != r ? g[j].object.GLRender(f, o, 0, g[j].multiMaterial) : g[j].object != r && h.push(g[j])
    }
    f.enable(f.BLEND);
    h = this.zSort(f, h);
    for(j = 0;j < h.length;j++) {
      if(h[j].object.blending) {
        h[j].object.blending.length = 4, f.blendFuncSeparate(f[h[j].object.blending[0]], f[h[j].object.blending[1]], f[h[j].object.blending[2]], f[h[j].object.blending[3]])
      }
      h[j].object.depthTest === !1 ? f.disable(this.gl.DEPTH_TEST) : f.enable(this.gl.DEPTH_TEST);
      g[j] != r && h[j].object.GLRender(f, o, 0, h[j].multiMaterial)
    }
  };
  e.Scene.prototype.applyFilter = function(f, g, h) {
    this.filter && this.filter.renderDepth && (f.clearDepth(1), f.depthFunc(f.LEQUAL), f.bindFramebuffer(f.FRAMEBUFFER, this.filter.getDepthBuffer(f)), this.renderPass(f, g, 0, 0, this.filter.getDepthBufferWidth(), this.filter.getDepthBufferHeight(), e.RENDER_SHADOW));
    this.filter && this.filter.renderEmit && (f.clearDepth(1), f.depthFunc(f.LEQUAL), f.bindFramebuffer(f.FRAMEBUFFER, this.filter.getEmitBuffer(f)), this.renderPass(f, g, 0, 0, this.filter.getEmitBufferWidth(), this.filter.getEmitBufferHeight(), e.RENDER_EMIT));
    this.filter && this.filter.renderNormal && (f.clearDepth(1), f.depthFunc(f.LEQUAL), f.bindFramebuffer(f.FRAMEBUFFER, this.filter.getNormalBuffer(f)), this.renderPass(f, g, 0, 0, this.filter.getNormalBufferWidth(), this.filter.getNormalBufferHeight(), e.RENDER_NORMAL));
    this.filter && this.filter.GLRender(f, h)
  };
  e.Scene.prototype.addRenderPass = function(e, g, h, j, m, p) {
    this.allowPasses && this.passes.push({frameBuffer:e, cameraMatrix:g, projectionMatrix:h, height:m, width:j, self:p});
    return this
  };
  e.Scene.prototype.ray = function(f, g) {
    var h = this.renderer.gl, j = this.camera.matrix, m = this.camera.pMatrix;
    this.camera.matrix = e.inverseMat4(e.Mat4([g[2], g[1], g[0], f[0], g[0], g[2], g[1], f[1], g[1], g[0], g[2], f[2], 0, 0, 0, 1]));
    if(!this.pickPMatrix) {
      this.pickPMatrix = e.makeOrtho(-1.0E-4, 1.0E-4, -1.0E-4, 1.0E-4, this.camera.near, this.camera.far)
    }
    this.camera.pMatrix = this.pickPMatrix;
    h.viewport(0, 0, 8, 1);
    h.clear(h.DEPTH_BUFFER_BIT);
    h.disable(h.BLEND);
    h.scene = this;
    for(var p = this.getObjects(), o = 0;o < p.length;o++) {
      p[o].pickable && p[o].GLRender(h, e.RENDER_PICK, o + 1)
    }
    o = new Uint8Array(32);
    h.readPixels(0, 0, 8, 1, h.RGBA, h.UNSIGNED_BYTE, o);
    var r = [o[4] / 255, o[5] / 255, o[6] / 255], s = Math.sqrt(r[0] * r[0] + r[1] * r[1] + r[2] * r[2]) * 0.5, r = [r[0] / s - 1, r[1] / s - 1, r[2] / s - 1], p = p[o[0] + o[1] * 256 + o[2] * 65536 - 1], s = (o[10] / 255 + 0.00390625 * o[9] / 255 + 1.52587890625E-5 * o[8] / 255) * this.camera.far, t = [];
    t[0] = o[14] / 255 + 0.00390625 * o[13] / 255 + 1.52587890625E-5 * o[12] / 255;
    t[1] = o[18] / 255 + 0.00390625 * o[17] / 255 + 1.52587890625E-5 * o[16] / 255;
    h.bindFramebuffer(h.FRAMEBUFFER, null);
    h.viewport(0, 0, this.renderer.canvas.width, this.renderer.canvas.height);
    this.camera.matrix = j;
    this.camera.pMatrix = m;
    if(p) {
      return{object:p, distance:s, coord:[f[0] - g[0] * s, f[1] - g[1] * s, f[2] - g[2] * s], normal:r, texture:t}
    }
    return null
  };
  e.Scene.prototype.pick = function(e, g) {
    var h = this.makeRay(e, g);
    if(!h) {
      return null
    }
    return this.ray(h.origin, h.coord)
  };
  e.Scene.prototype.makeRay = function(f, g) {
    if(this.camera) {
      if(this.camera.matrix && this.camera.pMatrix) {
        var h = this.renderer.canvas, f = f / h.offsetWidth * h.width, g = g / h.offsetHeight * h.height, j = this.renderer.getViewportHeight(), h = this.renderer.getViewportWidth(), m = this.renderer.getViewportOffsetX(), p = this.renderer.getViewportHeight() - this.renderer.canvas.height + this.renderer.getViewportOffsetY(), h = ((f - m) / h - 0.5) * 2, p = -((g + p) / j - 0.5) * 2, m = e.mulMat4(e.inverseMat4(this.camera.matrix), e.inverseMat4(this.camera.pMatrix)), j = e.mulMat4Vec4(m, [h, p,
        -1, 1]), j = [j[0] / j[3], j[1] / j[3], j[2] / j[3]], h = e.mulMat4Vec4(m, [h, p, 1, 1]), h = [-(h[0] / h[3] - j[0]), -(h[1] / h[3] - j[1]), -(h[2] / h[3] - j[2])], h = e.toUnitVec3(h);
        return{origin:j, coord:h}
      }else {
        return null
      }
    }else {
      return e.error("No camera set for picking"), null
    }
  }
})(GLGE);
(function(e) {
  e.Light = function(f) {
    e.Assets.registerAsset(this, f);
    this.color = {r:1, g:1, b:1}
  };
  e.augment(e.Placeable, e.Light);
  e.augment(e.Animatable, e.Light);
  e.augment(e.QuickNotation, e.Light);
  e.augment(e.JSONLoader, e.Light);
  e.Light.prototype.className = "Light";
  e.L_POINT = 1;
  e.L_DIR = 2;
  e.L_SPOT = 3;
  e.L_OFF = 4;
  e.Light.prototype.constantAttenuation = 1;
  e.Light.prototype.linearAttenuation = 0.002;
  e.Light.prototype.quadraticAttenuation = 8.0E-4;
  e.Light.prototype.spotCosCutOff = 0.95;
  e.Light.prototype.spotPMatrix = null;
  e.Light.prototype.spotExponent = 10;
  e.Light.prototype.color = null;
  e.Light.prototype.diffuse = !0;
  e.Light.prototype.specular = !0;
  e.Light.prototype.samples = 0;
  e.Light.prototype.softness = 0.01;
  e.Light.prototype.type = e.L_POINT;
  e.Light.prototype.frameBuffer = null;
  e.Light.prototype.renderBuffer = null;
  e.Light.prototype.texture = null;
  e.Light.prototype.bufferHeight = 256;
  e.Light.prototype.bufferWidth = 256;
  e.Light.prototype.shadowBias = 0.002;
  e.Light.prototype.castShadows = !1;
  e.Light.prototype.cascadeLevels = 3;
  e.Light.prototype.distance = 500;
  e.Light.prototype.getCascadeLevels = function() {
    return this.cascadeLevels
  };
  e.Light.prototype.setCascadeLevels = function(e) {
    this.cascadeLevels = +e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Light.prototype.getPMatrix = function(f, g, h, j) {
    if(!this.spotPMatrix) {
      var m;
      m = this.scene && this.scene.camera ? this.scene.camera.far : 1E3;
      if(this.type == e.L_SPOT) {
        this.spotPMatrix = e.makePerspective(Math.acos(this.spotCosCutOff) / 3.14159 * 360, 1, 0.1, m)
      }
    }
    if(this.type == e.L_DIR) {
      this.spotPMatrix = e.getDirLightProjection(f, g, h, j)
    }
    return this.spotPMatrix
  };
  e.Light.prototype.setDistance = function(e) {
    this.distance = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Light.prototype.getDistance = function() {
    return this.distance
  };
  e.Light.prototype.setNegativeShadow = function(e) {
    this.negativeShadow = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Light.prototype.getNegative = function() {
    return this.negativeShadow
  };
  e.Light.prototype.setCastShadows = function(e) {
    this.castShadows = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Light.prototype.getCastShadows = function() {
    return this.castShadows
  };
  e.Light.prototype.setShadowBias = function(e) {
    this.shadowBias = e;
    return this
  };
  e.Light.prototype.getShadowBias = function() {
    return this.shadowBias
  };
  e.Light.prototype.setShadowSamples = function(e) {
    this.samples = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Light.prototype.getShadowSamples = function() {
    return this.samples
  };
  e.Light.prototype.setShadowSoftness = function(e) {
    this.softness = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Light.prototype.getShadowSamples = function() {
    return this.softness
  };
  e.Light.prototype.setBufferWidth = function(e) {
    this.bufferWidth = e;
    return this
  };
  e.Light.prototype.getBufferHeight = function() {
    return this.bufferHeight
  };
  e.Light.prototype.setBufferHeight = function(e) {
    this.bufferHeight = e;
    return this
  };
  e.Light.prototype.getBufferWidth = function() {
    return this.bufferWidth
  };
  e.Light.prototype.setSpotCosCutOff = function(e) {
    this.spotPMatrix = null;
    this.spotCosCutOff = e;
    return this
  };
  e.Light.prototype.getSpotCosCutOff = function() {
    return this.spotCosCutOff
  };
  e.Light.prototype.setSpotExponent = function(e) {
    this.spotExponent = e;
    return this
  };
  e.Light.prototype.getSpotExponent = function() {
    return this.spotExponent
  };
  e.Light.prototype.getAttenuation = function() {
    var e = {};
    e.constant = this.constantAttenuation;
    e.linear = this.linearAttenuation;
    e.quadratic = this.quadraticAttenuation;
    return e
  };
  e.Light.prototype.setAttenuation = function(e, g, h) {
    this.constantAttenuation = e;
    this.linearAttenuation = g;
    this.quadraticAttenuation = h;
    return this
  };
  e.Light.prototype.setAttenuationConstant = function(e) {
    this.constantAttenuation = e;
    return this
  };
  e.Light.prototype.setAttenuationLinear = function(e) {
    this.linearAttenuation = e;
    return this
  };
  e.Light.prototype.setAttenuationQuadratic = function(e) {
    this.quadraticAttenuation = e;
    return this
  };
  e.Light.prototype.setColor = function(f) {
    f = e.colorParse(f);
    this.color = {r:f.r, g:f.g, b:f.b};
    return this
  };
  e.Light.prototype.setColorR = function(e) {
    this.color.r = e;
    return this
  };
  e.Light.prototype.setColorG = function(e) {
    this.color.g = e;
    return this
  };
  e.Light.prototype.setColorB = function(e) {
    this.color.b = e;
    return this
  };
  e.Light.prototype.getColor = function() {
    return this.color
  };
  e.Light.prototype.getType = function() {
    return this.type
  };
  e.Light.prototype.setType = function(e) {
    this.type = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Light.prototype.enableLight = function() {
    this.type == e.L_OFF && this.old_type !== void 0 && (this.setType(this.old_type), delete this.old_type)
  };
  e.Light.prototype.disableLight = function() {
    if(this.type != e.L_OFF) {
      this.old_type = this.type, this.setType(e.L_OFF)
    }
  };
  e.Light.prototype.GLInit = function(f) {
    this.gl = f;
    (this.type == e.L_SPOT || this.type == e.L_DIR) && !this.texture && this.createSpotBuffer(f)
  };
  e.Light.prototype.createSpotBuffer = function(f) {
    this.frameBuffer = f.createFramebuffer();
    this.renderBuffer = f.createRenderbuffer();
    this.texture = f.createTexture();
    f.bindTexture(f.TEXTURE_2D, this.texture);
    try {
      f.texImage2D(f.TEXTURE_2D, 0, f.RGBA, this.bufferWidth, this.bufferHeight, 0, f.RGBA, f.UNSIGNED_BYTE, null)
    }catch(g) {
      e.error("incompatible texture creation method");
      var h = parseFloat(this.bufferWidth), j = parseFloat(this.bufferHeight), m = new Uint8Array(h * j * 4);
      f.texImage2D(f.TEXTURE_2D, 0, f.RGBA, h, j, 0, f.RGBA, f.UNSIGNED_BYTE, m)
    }
    f.bindFramebuffer(f.FRAMEBUFFER, this.frameBuffer);
    f.bindRenderbuffer(f.RENDERBUFFER, this.renderBuffer);
    f.renderbufferStorage(f.RENDERBUFFER, f.DEPTH_COMPONENT16, this.bufferWidth, this.bufferHeight);
    f.framebufferTexture2D(f.FRAMEBUFFER, f.COLOR_ATTACHMENT0, f.TEXTURE_2D, this.texture, 0);
    f.framebufferRenderbuffer(f.FRAMEBUFFER, f.DEPTH_ATTACHMENT, f.RENDERBUFFER, this.renderBuffer);
    f.bindFramebuffer(f.FRAMEBUFFER, null);
    f.bindRenderbuffer(f.RENDERBUFFER, null);
    f.bindTexture(f.TEXTURE_2D, null)
  }
})(GLGE);
(function(e) {
  e.C_PERSPECTIVE = 1;
  e.C_ORTHO = 2;
  e.Camera = function(f) {
    e.Assets.registerAsset(this, f)
  };
  e.augment(e.Placeable, e.Camera);
  e.augment(e.Animatable, e.Camera);
  e.augment(e.QuickNotation, e.Camera);
  e.augment(e.JSONLoader, e.Camera);
  e.Camera.prototype.className = "Camera";
  e.Camera.prototype.fovy = 35;
  e.Camera.prototype.aspect = 1;
  e.Camera.prototype.near = 0.1;
  e.Camera.prototype.far = 1E3;
  e.Camera.prototype.orthoscale = 5;
  e.Camera.prototype.type = e.C_PERSPECTIVE;
  e.Camera.prototype.pMatrix = null;
  e.Camera.prototype.getOrthoScale = function() {
    return this.type == e.C_ORTHO ? this.orthoscale : (e.error("You may only get a scale for a orthographic camera"), 1)
  };
  e.Camera.prototype.setOrthoScale = function(f) {
    this.type == e.C_ORTHO ? (this.orthoscale = f, this.pMatrix = null) : e.error("You may only set a scale for a orthographic camera");
    return this
  };
  e.Camera.prototype.getFar = function() {
    return this.far
  };
  e.Camera.prototype.setFar = function(e) {
    this.pMatrix = null;
    this.far = +e;
    return this
  };
  e.Camera.prototype.getNear = function() {
    return this.near
  };
  e.Camera.prototype.setNear = function(e) {
    this.pMatrix = null;
    this.near = +e;
    return this
  };
  e.Camera.prototype.getType = function() {
    this.pMatrix = null;
    return this.type
  };
  e.Camera.prototype.setType = function(f) {
    f == e.C_PERSPECTIVE || f == e.C_ORTHO ? (this.type = f, this.pMatrix = null) : e.error("unsuported camera type");
    return this
  };
  e.Camera.prototype.getFovY = function() {
    return this.type == e.C_PERSPECTIVE ? this.fovy : (e.error("You may only get a yfov for a perspective camera"), 1)
  };
  e.Camera.prototype.setFovY = function(f) {
    this.type == e.C_PERSPECTIVE ? (this.fovy = +f, this.pMatrix = this.ymax = null) : e.error("You may only set a yfov for a perspective camera");
    return this
  };
  e.Camera.prototype.getAspect = function() {
    return this.type == e.C_PERSPECTIVE || this.type == e.C_ORTHO ? this.aspect : (e.error("You may only set a aspect for a perspective or orthographic camera"), 1)
  };
  e.Camera.prototype.setAspect = function(f) {
    this.type == e.C_PERSPECTIVE || this.type == e.C_ORTHO ? (this.aspect = +f, this.pMatrix = null) : e.error("You may only set a aspect for a perspective or orthographic camera");
    return this
  };
  e.Camera.prototype.getProjectionMatrix = function() {
    if(!this.pMatrix) {
      switch(this.type) {
        case e.C_PERSPECTIVE:
          this.pMatrix = e.makePerspective(this.fovy, this.aspect, this.near, this.far);
          break;
        case e.C_ORTHO:
          this.pMatrix = e.makeOrtho(-this.orthoscale * this.aspect, this.orthoscale * this.aspect, -this.orthoscale, this.orthoscale, this.near, this.far)
      }
    }
    return this.pMatrix
  };
  e.Camera.prototype.setProjectionMatrix = function(e) {
    this.pMatrix = e;
    return this
  };
  e.Camera.prototype.updateMatrix = function() {
    var f = this.getPosition(), f = e.translateMatrix(f.x, f.y, f.z), f = e.mulMat4(f, this.getRotMatrix());
    this.parent && (f = e.mulMat4(this.parent.getModelMatrix(), f));
    this.location = [f[3], f[7], f[11]];
    this.matrix = e.inverseMat4(f)
  };
  e.Camera.prototype.getViewMatrix = function() {
    (!this.matrix || !this.rotmatrix) && this.updateMatrix();
    return this.matrix
  };
  e.Camera.prototype.getViewProjection = function() {
    var f = this.getProjectionMatrix(), g = this.getViewMatrix();
    if(f != this.vpProjectionMatrix || g != this.vpViewMatrix) {
      this.cameraViewProjection = e.mulMat4(f, g), this.vpProjectionMatrix = f, this.vpViewMatrix = g
    }
    return this.cameraViewProjection
  }
})(GLGE);
(function(e) {
  e.Renderer = function(f, g, h) {
    this.viewport = [];
    this.canvas = f;
    h || (h = {alpha:!0, depth:!0, stencil:!0, antialias:!0, premultipliedAlpha:!0});
    try {
      this.gl = f.getContext("experimental-webgl", h)
    }catch(j) {
    }
    try {
      if(!this.gl) {
        this.gl = f.getContext("webgl", h)
      }
    }catch(m) {
    }
    if(!this.gl) {
      throw console.log("GLGE err:", typeof globalNoWebGLError == "undefined"), !g && typeof globalNoWebGLError == "undefined" ? (f = document.createElement("div"), f.setAttribute("style", "position: absolute; top: 10px; left: 10px; font-family: sans-serif; font-size: 14px; padding: 10px;background-color: #fcffcb;color: #800; width: 200px; border:2px solid #f00"), f.innerHTML = "WebGL compatible Browser Required(Firefox 4 or Chrome 9 and up) or you may need to update your graphics card driver.",
      document.getElementsByTagName("body")[0].appendChild(f)) : g(), "cannot create webgl context";
    }
    try {
      this.gl.canvas = f
    }catch(p) {
    }
    if(!this.gl.getProgramParameter) {
      this.gl.getProgramParameter = this.gl.getProgrami
    }
    if(!this.gl.getShaderParameter) {
      this.gl.getShaderParameter = this.gl.getShaderi
    }
    this.gl.uniformMatrix4fvX = this.gl.uniformMatrix4fv;
    this.gl.uniformMatrix4fv = function(f, g, h) {
      g && e.mat4gl(e.transposeMat4(h), h);
      this.uniformMatrix4fvX(f, !1, h)
    };
    this.gl.clearDepth(1);
    this.gl.clearStencil(0);
    this.gl.enable(this.gl.DEPTH_TEST);
    this.gl.depthFunc(this.gl.LEQUAL);
    this.gl.blendFuncSeparate(this.gl.SRC_ALPHA, this.gl.ONE_MINUS_SRC_ALPHA, this.gl.ZERO, this.gl.ONE)
  };
  e.augment(e.QuickNotation, e.Renderer);
  e.Renderer.prototype.gl = null;
  e.Renderer.prototype.scene = null;
  e.C_STENCIL = 1;
  e.C_DEPTH = 2;
  e.C_COLOR = 4;
  e.C_ALL = 7;
  e.Renderer.prototype.clearType = e.C_ALL;
  e.Renderer.prototype.setViewportWidth = function(e) {
    this.viewport[0] = e;
    return this
  };
  e.Renderer.prototype.setViewportHeight = function(e) {
    this.viewport[1] = e;
    return this
  };
  e.Renderer.prototype.setViewportOffsetX = function(e) {
    this.viewport[2] = e;
    return this
  };
  e.Renderer.prototype.setViewportOffsetY = function(e) {
    this.viewport[3] = e;
    return this
  };
  e.Renderer.prototype.clearViewport = function() {
    this.viewport = []
  };
  e.Renderer.prototype.getViewportWidth = function() {
    return this.viewport.length > 0 ? this.viewport[0] : this.canvas.width
  };
  e.Renderer.prototype.getViewportHeight = function() {
    return this.viewport.length > 0 ? this.viewport[1] : this.canvas.height
  };
  e.Renderer.prototype.getViewportOffsetX = function() {
    return this.viewport.length > 0 ? this.viewport[2] : 0
  };
  e.Renderer.prototype.getViewportOffsetY = function() {
    return this.viewport.length > 0 ? this.viewport[3] : 0
  };
  e.Renderer.prototype.setClearType = function(e) {
    this.clearType = e;
    return this
  };
  e.Renderer.prototype.getClearType = function() {
    return this.clearType
  };
  e.Renderer.prototype.GLClear = function() {
    var f = this.gl, g = this.clearType, h = 0;
    g & e.C_COLOR == e.C_COLOR && (h |= f.COLOR_BUFFER_BIT);
    g & e.C_DEPTH == e.C_DEPTH && (h |= f.DEPTH_BUFFER_BIT);
    g & e.C_STENCIL == e.C_STENCIL && (h |= f.STENCIL_BUFFER_BIT);
    f.clear(h)
  };
  e.Renderer.prototype.getScene = function() {
    return this.scene
  };
  e.Renderer.prototype.setScene = function(e) {
    e.renderer = this;
    this.scene = e;
    e.GLInit(this.gl);
    this.render();
    e.camera.matrix = null;
    return this
  };
  e.Renderer.prototype.render = function() {
    this.cullFaces && this.gl.enable(this.gl.CULL_FACE);
    this.scene && this.scene.render(this.gl);
    if(!this.rendered && this.scene) {
      this.scene.render(this.gl), this.rendered = !0
    }
  }
})(GLGE);
(function(e) {
  e.Text = function(f) {
    e.Assets.registerAsset(this, f);
    this.canvas = document.createElement("canvas");
    this.color = {r:1, g:1, b:1}
  };
  e.augment(e.Placeable, e.Text);
  e.augment(e.Animatable, e.Text);
  e.augment(e.QuickNotation, e.Text);
  e.augment(e.JSONLoader, e.Text);
  e.Text.prototype.className = "Text";
  e.Text.prototype.zTrans = !0;
  e.Text.prototype.canvas = null;
  e.Text.prototype.aspect = 1;
  e.Text.prototype.color = null;
  e.Text.prototype.text = "";
  e.Text.prototype.font = "Times";
  e.Text.prototype.size = 100;
  e.Text.prototype.pickType = e.TEXT_TEXTPICK;
  e.Text.prototype.pickable = !0;
  e.Text.prototype.getPickType = function() {
    return this.pickType
  };
  e.Text.prototype.setPickType = function(e) {
    this.pickType = e;
    return this
  };
  e.Text.prototype.getFont = function() {
    return this.size
  };
  e.Text.prototype.setFont = function(e) {
    this.font = e;
    this.gl && this.updateCanvas(this.gl);
    return this
  };
  e.Text.prototype.getSize = function() {
    return this.size
  };
  e.Text.prototype.setSize = function(e) {
    this.size = e;
    this.gl && this.updateCanvas(this.gl);
    return this
  };
  e.Text.prototype.getText = function() {
    return this.text
  };
  e.Text.prototype.setText = function(e) {
    this.text = e;
    this.gl && this.updateCanvas(this.gl);
    return this
  };
  e.Text.prototype.setColor = function(f) {
    f = e.colorParse(f);
    this.color = {r:f.r, g:f.g, b:f.b};
    return this
  };
  e.Text.prototype.setColorR = function(e) {
    this.color.r = e;
    return this
  };
  e.Text.prototype.setColorG = function(e) {
    this.color.g = e;
    return this
  };
  e.Text.prototype.setColorB = function(e) {
    this.color.b = e;
    return this
  };
  e.Text.prototype.getColor = function() {
    return this.color
  };
  e.Text.prototype.setZtransparent = function(e) {
    this.zTrans = e;
    return this
  };
  e.Text.prototype.isZtransparent = function() {
    return this.zTrans
  };
  e.Text.prototype.GLGenerateShader = function(f) {
    this.GLShaderProgram && f.deleteProgram(this.GLShaderProgram);
    var g = "";
    g += "attribute vec3 position;\n";
    g += "attribute vec2 uvcoord;\n";
    g += "varying vec2 texcoord;\n";
    g += "uniform mat4 Matrix;\n";
    g += "uniform mat4 PMatrix;\n";
    g += "varying vec4 pos;\n";
    g += "void main(void){\n";
    g += "texcoord=uvcoord;\n";
    g += "pos = Matrix * vec4(0,0,0,1.0);\n";
    g += "float scalepos = length((Matrix * vec4(position,1.0)-pos).xyz);\n";
    g += "pos.xyz+=position*scalepos/sqrt(2.0);\n";
    g += "gl_Position = PMatrix * pos;\n";
    g += "}\n";
    var h = "#ifdef GL_ES\nprecision highp float;\n#endif\n";
    h += "uniform sampler2D TEXTURE;\n";
    h += "varying vec2 texcoord;\n";
    h += "varying vec4 pos;\n";
    h += "uniform float far;\n";
    h += "uniform int picktype;\n";
    h += "uniform vec3 pickcolor;\n";
    h += "uniform vec3 color;\n";
    h += "void main(void){\n";
    h += "float alpha=texture2D(TEXTURE,texcoord).a;\n";
    h = h + "if(picktype==" + e.TEXT_BOXPICK + "){gl_FragColor = vec4(pickcolor,1.0);}";
    h = h + "else if(picktype==" + e.TEXT_TEXTPICK + "){if(alpha<1.0) discard; gl_FragColor = vec4(pickcolor,alpha);}";
    h += "else{gl_FragColor = vec4(color.rgb*alpha,alpha);};\n";
    h += "}\n";
    this.GLFragmentShader = f.createShader(f.FRAGMENT_SHADER);
    this.GLVertexShader = f.createShader(f.VERTEX_SHADER);
    f.shaderSource(this.GLFragmentShader, h);
    f.compileShader(this.GLFragmentShader);
    f.getShaderParameter(this.GLFragmentShader, f.COMPILE_STATUS) ? (f.shaderSource(this.GLVertexShader, g), f.compileShader(this.GLVertexShader), f.getShaderParameter(this.GLVertexShader, f.COMPILE_STATUS) ? (this.GLShaderProgram = f.createProgram(), f.attachShader(this.GLShaderProgram, this.GLVertexShader), f.attachShader(this.GLShaderProgram, this.GLFragmentShader), f.linkProgram(this.GLShaderProgram)) : e.error(f.getShaderInfoLog(this.GLVertexShader))) : e.error(f.getShaderInfoLog(this.GLFragmentShader))
  };
  e.Text.prototype.GLInit = function(e) {
    this.gl = e;
    this.createPlane(e);
    this.GLGenerateShader(e);
    this.glTexture = e.createTexture();
    this.updateCanvas(e)
  };
  e.Text.prototype.updateCanvas = function(e) {
    var g = this.canvas;
    g.width = 1;
    g.height = this.size * 1.2;
    var h = g.getContext("2d");
    h.font = this.size + "px " + this.font;
    g.width = h.measureText(this.text).width;
    g.height = this.size * 1.2;
    h = g.getContext("2d");
    h.textBaseline = "top";
    h.font = this.size + "px " + this.font;
    this.aspect = g.width / g.height;
    h.fillText(this.text, 0, 0);
    e.bindTexture(e.TEXTURE_2D, this.glTexture);
    try {
      e.texImage2D(e.TEXTURE_2D, 0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, g)
    }catch(j) {
      e.texImage2D(e.TEXTURE_2D, 0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, g, null)
    }
    e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MAG_FILTER, e.LINEAR);
    e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MIN_FILTER, e.LINEAR);
    e.texParameteri(e.TEXTURE_2D, e.TEXTURE_WRAP_S, e.CLAMP_TO_EDGE);
    e.texParameteri(e.TEXTURE_2D, e.TEXTURE_WRAP_T, e.CLAMP_TO_EDGE);
    e.bindTexture(e.TEXTURE_2D, null)
  };
  e.Text.prototype.GLRender = function(f, g, h) {
    this.gl || this.GLInit(f);
    if(g == e.RENDER_DEFAULT || g == e.RENDER_PICK) {
      this.lookAt && this.Lookat(this.lookAt);
      if(f.program != this.GLShaderProgram) {
        f.useProgram(this.GLShaderProgram), f.program = this.GLShaderProgram
      }
      var j;
      for(j = 0;j < 8;j++) {
        f.disableVertexAttribArray(j)
      }
      j = e.getAttribLocation(f, this.GLShaderProgram, "position");
      f.bindBuffer(f.ARRAY_BUFFER, this.posBuffer);
      f.enableVertexAttribArray(j);
      f.vertexAttribPointer(j, this.posBuffer.itemSize, f.FLOAT, !1, 0, 0);
      j = e.getAttribLocation(f, this.GLShaderProgram, "uvcoord");
      f.bindBuffer(f.ARRAY_BUFFER, this.uvBuffer);
      f.enableVertexAttribArray(j);
      f.vertexAttribPointer(j, this.uvBuffer.itemSize, f.FLOAT, !1, 0, 0);
      f.activeTexture(f.TEXTURE0);
      f.bindTexture(f.TEXTURE_2D, this.glTexture);
      e.setUniform(f, "1i", e.getUniformLocation(f, this.GLShaderProgram, "TEXTURE"), 0);
      h || (h = 0);
      j = h >> 16 & 255;
      var m = h >> 8 & 255;
      h &= 255;
      e.setUniform3(f, "3f", e.getUniformLocation(f, this.GLShaderProgram, "pickcolor"), h / 255, m / 255, j / 255);
      g == e.RENDER_PICK ? e.setUniform(f, "1i", e.getUniformLocation(f, this.GLShaderProgram, "picktype"), this.pickType) : e.setUniform(f, "1i", e.getUniformLocation(f, this.GLShaderProgram, "picktype"), 0);
      if(!this.GLShaderProgram.glarrays) {
        this.GLShaderProgram.glarrays = {}
      }
      g = this.size / 100;
      g = e.mulMat4(f.scene.camera.getViewMatrix(), e.mulMat4(this.getModelMatrix(), e.scaleMatrix(this.aspect * g, g, g)));
      h = e.getUniformLocation(f, this.GLShaderProgram, "Matrix");
      this.GLShaderProgram.glarrays.mMatrix ? e.mat4gl(g, this.GLShaderProgram.glarrays.mMatrix) : this.GLShaderProgram.glarrays.mMatrix = new Float32Array(g);
      e.setUniformMatrix(f, "Matrix4fv", h, !0, this.GLShaderProgram.glarrays.mMatrix);
      h = e.getUniformLocation(f, this.GLShaderProgram, "PMatrix");
      this.GLShaderProgram.glarrays.pMatrix ? e.mat4gl(f.scene.camera.getProjectionMatrix(), this.GLShaderProgram.glarrays.pMatrix) : this.GLShaderProgram.glarrays.pMatrix = new Float32Array(f.scene.camera.getProjectionMatrix());
      e.setUniformMatrix(f, "Matrix4fv", h, !0, this.GLShaderProgram.glarrays.pMatrix);
      g = e.getUniformLocation(f, this.GLShaderProgram, "far");
      e.setUniform(f, "1f", g, f.scene.camera.getFar());
      e.setUniform3(f, "3f", e.getUniformLocation(f, this.GLShaderProgram, "color"), this.color.r, this.color.g, this.color.b);
      f.bindBuffer(f.ELEMENT_ARRAY_BUFFER, this.GLfaces);
      f.drawElements(f.TRIANGLES, this.GLfaces.numItems, f.UNSIGNED_SHORT, 0);
      f.scene.lastMaterial = null
    }
  };
  e.Text.prototype.createPlane = function(e) {
    if(!this.posBuffer) {
      this.posBuffer = e.createBuffer()
    }
    e.bindBuffer(e.ARRAY_BUFFER, this.posBuffer);
    e.bufferData(e.ARRAY_BUFFER, new Float32Array([-1, 1, 0, 1, 1, 0, 1, -1, 0, -1, -1, 0]), e.STATIC_DRAW);
    this.posBuffer.itemSize = 3;
    this.posBuffer.numItems = 4;
    if(!this.uvBuffer) {
      this.uvBuffer = e.createBuffer()
    }
    e.bindBuffer(e.ARRAY_BUFFER, this.uvBuffer);
    e.bufferData(e.ARRAY_BUFFER, new Float32Array([0, 0, 1, 0, 1, 1, 0, 1]), e.STATIC_DRAW);
    this.uvBuffer.itemSize = 2;
    this.uvBuffer.numItems = 4;
    if(!this.GLfaces) {
      this.GLfaces = e.createBuffer()
    }
    e.bindBuffer(e.ELEMENT_ARRAY_BUFFER, this.GLfaces);
    e.bufferData(e.ELEMENT_ARRAY_BUFFER, new Uint16Array([2, 1, 0, 0, 3, 2]), e.STATIC_DRAW);
    this.GLfaces.itemSize = 1;
    this.GLfaces.numItems = 6
  }
})(GLGE);
(function(e) {
  e.ObjectLod = function(f) {
    e.Assets.registerAsset(this, f);
    this.setMaterial(e.DEFAULT_MATERIAL)
  };
  e.augment(e.QuickNotation, e.ObjectLod);
  e.augment(e.JSONLoader, e.ObjectLod);
  e.augment(e.Events, e.ObjectLod);
  e.ObjectLod.prototype.mesh = null;
  e.ObjectLod.prototype.className = "ObjectLod";
  e.ObjectLod.prototype.material = null;
  e.ObjectLod.prototype.program = null;
  e.ObjectLod.prototype.GLShaderProgramPick = null;
  e.ObjectLod.prototype.GLShaderProgramShadow = null;
  e.ObjectLod.prototype.GLShaderProgram = null;
  e.ObjectLod.prototype.pixelSize = 0;
  e.ObjectLod.prototype.setMesh = function(f) {
    typeof f == "string" && (f = e.Assets.get(f));
    this.mesh && this.mesh.removeEventListener("shaderupdate", this.meshupdated);
    var g = this;
    this.meshupdated = function() {
      g.GLShaderProgram = null
    };
    f.addEventListener("shaderupdate", this.meshupdated);
    this.GLShaderProgram = null;
    this.mesh = f;
    return this
  };
  e.ObjectLod.prototype.isComplete = function() {
    return this.material.isComplete()
  };
  e.ObjectLod.prototype.getMesh = function() {
    return this.mesh
  };
  e.ObjectLod.prototype.setMaterial = function(f) {
    typeof f == "string" && (f = e.Assets.get(f));
    this.material && (this.material.removeEventListener("shaderupdate", this.materialupdated), this.material.removeEventListener("downloadComplete", this.downloadComplete));
    var g = this;
    this.materialupdated = function() {
      g.GLShaderProgram = null
    };
    f.addEventListener("shaderupdate", this.materialupdated);
    this.downloadComplete = function() {
      g.fireEvent("downloadComplete")
    };
    f.addEventListener("downloadComplete", this.downloadComplete);
    this.GLShaderProgram = null;
    this.material = f;
    return this
  };
  e.ObjectLod.prototype.getMaterial = function() {
    return this.material
  };
  e.ObjectLod.prototype.getPixelSize = function() {
    return this.pixelSize
  };
  e.ObjectLod.prototype.setPixelSize = function(e) {
    this.pixelSize = parseFloat(e)
  }
})(GLGE);
(function(e) {
  e.PhysicsSphere = function(f) {
    this.jigLibObj = new jigLib.JSphere(this, this.radius);
    this.jigLibObj.GLGE = this;
    this.jigLibObj.addEventListener(jigLib.JCollisionEvent.COLLISION, function(e) {
      this.GLGE.fireEvent("collision", {obj:e.collisionBody.GLGE, impulse:e.collisionImpulse})
    });
    e.PhysicsAbstract.call(this, f)
  };
  e.augment(e.PhysicsAbstract, e.PhysicsSphere);
  e.PhysicsSphere.prototype.radius = 1;
  e.PhysicsSphere.prototype.className = "PhysicsSphere";
  e.PhysicsSphere.prototype.setRadius = function(e) {
    this.physicsRadius = +e;
    this.jigLibObj.set_radius(+e);
    return this
  };
  e.PhysicsSphere.prototype.getRadius = function() {
    return this.jigLibObj.get_radius()
  }
})(GLGE);
(function(e) {
  e.PhysicsPlane = function(f) {
    this.jigLibObj = new jigLib.JPlane(this, this.normal, this.distance);
    this.jigLibObj.GLGE = this;
    this.jigLibObj.addEventListener(jigLib.JCollisionEvent.COLLISION, function(e) {
      this.GLGE.fireEvent("collision", {obj:e.collisionBody.GLGE, impulse:e.collisionImpulse})
    });
    e.PhysicsAbstract.call(this, f)
  };
  e.augment(e.PhysicsAbstract, e.PhysicsPlane);
  e.PhysicsPlane.prototype.normal = [0, 0, 1, 0];
  e.PhysicsPlane.prototype.distance = 0;
  e.PhysicsPlane.prototype.className = "PhysicsPlane";
  e.PhysicsPlane.prototype.setNormal = function(e) {
    this.normal = e;
    this.jigLibObj.set_normal(e);
    return this
  };
  e.PhysicsPlane.prototype.setDistance = function(e) {
    this.distance = e;
    this.jigLibObj.set_distance(e);
    return this
  };
  e.PhysicsPlane.prototype.getNormal = function() {
    return this.jigLibObj.get_normal()
  };
  e.PhysicsPlane.prototype.getDistance = function() {
    return this.jigLibObj.get_distance()
  }
})(GLGE);
(function(e) {
  e.PhysicsMesh = function(f) {
    this.jigLibObj = new jigLib.JTriangleMesh(null, 100, 0.05);
    this.jigLibObj.GLGE = this;
    this.jigLibObj.addEventListener(jigLib.JCollisionEvent.COLLISION, function(e) {
      this.GLGE.fireEvent("collision", {obj:e.collisionBody.GLGE, impulse:e.collisionImpulse})
    });
    this.dirty = !0;
    this.addEventListener("matrixUpdate", this.makeDirty);
    this.addEventListener("childMatrixUpdate", this.makeDirty);
    this.addEventListener("childAdded", this.makeDirty);
    this.addEventListener("childRemoved", this.makeDirty);
    e.PhysicsAbstract.call(this, f)
  };
  e.augment(e.PhysicsAbstract, e.PhysicsMesh);
  e.PhysicsMesh.prototype.className = "PhysicsMesh";
  e.PhysicsMesh.prototype.forceUpdate = function() {
    this.dirty = !0;
    return this
  };
  e.PhysicsMesh.prototype.makeDirty = function() {
    this.dirty = !0
  };
  e.PhysicsMesh.prototype.preProcess = function() {
    if(this.dirty) {
      var e = this.getTriangles();
      this.jigLibObj.createMesh(e.verts, e.faces);
      this.dirty = !1
    }
  };
  e.PhysicsMesh.prototype.getTriangles = function() {
    for(var f = this.getObjects(), g = [], h = [], j = 0;j < f.length;j++) {
      if(f[j].multimaterials) {
        for(var m = f[j].getModelMatrix(), p = 0;p < f[j].multimaterials.length;p++) {
          var o = f[j].multimaterials[p].getMesh(), r = g.length;
          if(o) {
            for(var s = 0;s < o.positions.length;s += 3) {
              var t = e.mulMat4Vec4(m, [o.positions[s], o.positions[s + 1], o.positions[s + 2], 1]);
              g.push([t[0], t[1], t[2], 1])
            }
            if(t = o.faces.data) {
              o = t.length;
              o = (o / 3 | 0) * 3;
              for(s = 0;s < o;s += 3) {
                h.push([+t[s] + r, +t[s + 1] + r, +t[s + 2] + r])
              }
            }else {
              for(s = 0;s < o.positions.length / 3;s += 3) {
                h.push([s + r, s + 1 + r, s + 2 + r])
              }
            }
          }
        }
      }
    }
    return{verts:g, faces:h}
  }
})(GLGE);
(function(e) {
  e.Scene.prototype.physicsGravity = [0, 0, -9.8, 0];
  e.Scene.prototype.getPhysicsNodes = function(f) {
    f || (f = []);
    this.jigLibObj && f.push(this);
    if(this.children) {
      for(var g = 0;g < this.children.length;g++) {
        e.Scene.prototype.getPhysicsNodes.call(this.children[g], f)
      }
    }
    return f
  };
  e.Scene.prototype.physicsPick = function(f, g, h) {
    this.physicsSystem || this.physicsTick(0, !0);
    if(g = this.makeRay(f, g)) {
      var f = this.physicsSystem.getCollisionSystem(), g = new jigLib.JSegment(g.origin, e.scaleVec3(g.coord, -1E3)), j = {};
      return f.segmentIntersect(j, g, h ? h.jigLibObj : null) ? {object:j.rigidBody.GLGE, normal:j.normal, distance:j.frac, position:j.position} : !1
    }
  };
  e.Scene.prototype.physicsPickObject = function(f, g, h) {
    this.physicsSystem || this.physicsTick(0, !0);
    if(f = this.makeRay(f, g)) {
      return h = h.jigLibObj, f = new jigLib.JSegment(f.origin, e.scaleVec3(f.coord, -1E3)), g = {}, h.segmentIntersect(g, f) ? {normal:g.normal, distance:g.frac, position:g.position} : !1
    }
  };
  e.Scene.prototype.physicsTick = function(e, g) {
    var h = this.getPhysicsNodes();
    if(!this.physicsSystem) {
      this.physicsSystem = jigLib.PhysicsSystem.getInstance();
      this.physicsSystem.setGravity(this.physicsGravity);
      for(var j = 0;j < h.length;j++) {
        h[j].jigLibObj && this.physicsSystem.addBody(h[j].jigLibObj)
      }
      var m = this;
      this.addEventListener("childAdded", function(e) {
        e.obj.jigLibObj && m.physicsSystem.addBody(e.obj.jigLibObj)
      });
      this.addEventListener("childRemoved", function(e) {
        e.obj.jigLibObj && m.physicsSystem.removeBody(e.obj.jigLibObj)
      })
    }
    for(j = 0;j < h.length;j++) {
      h[j].jigLibObj && h[j].preProcess()
    }
    g || this.physicsSystem.integrate(e)
  };
  e.Scene.prototype.setGravity = function(e) {
    this.physicsGravity = e;
    this.physicsSystem && this.physicsSystem.setGravity(e);
    return this
  };
  e.Scene.prototype.setGravity = function(e) {
    return this.physicsSystem.getGravity(e)
  };
  e.Group.prototype.addPhysicsPlane = e.Group.prototype.addChild;
  e.Group.prototype.addPhysicsBox = e.Group.prototype.addChild;
  e.Group.prototype.addPhysicsSphere = e.Group.prototype.addChild;
  e.Group.prototype.addPhysicsMesh = e.Group.prototype.addChild;
  e.Scene.prototype.addPhysicsPlane = e.Group.prototype.addChild;
  e.Scene.prototype.addPhysicsBox = e.Group.prototype.addChild;
  e.Scene.prototype.addPhysicsSphere = e.Group.prototype.addChild;
  e.Scene.prototype.addPhysicsMesh = e.Group.prototype.addChild
})(GLGE);
(function(e) {
  e.PhysicsConstraintPoint = function() {
  };
  e.augment(e.QuickNotation, e.PhysicsConstraintPoint);
  e.augment(e.JSONLoader, e.PhysicsConstraintPoint);
  e.PhysicsConstraintPoint.constraint = null;
  e.PhysicsConstraintPoint.prototype.className = "PhysicsConstraintPoint";
  e.PhysicsConstraintPoint.prototype.setBody1 = function(e) {
    this.body1 = e;
    this.updateConstraint();
    return this
  };
  e.PhysicsConstraintPoint.prototype.setBody2 = function(e) {
    this.body2 = e;
    this.updateConstraint();
    return this
  };
  e.PhysicsConstraintPoint.prototype.setBodyPos1 = function(e) {
    typeof e == "string" && (e = e.split(","));
    this.bodypos1 = [parseFloat(e[0]), parseFloat(e[1]), parseFloat(e[2])];
    this.updateConstraint();
    return this
  };
  e.PhysicsConstraintPoint.prototype.setBodyPos2 = function(e) {
    typeof e == "string" && (e = e.split(","));
    this.bodypos2 = [parseFloat(e[0]), parseFloat(e[1]), parseFloat(e[2])];
    this.updateConstraint();
    return this
  };
  e.PhysicsConstraintPoint.prototype.updateConstraint = function() {
    if(this.body1 && this.body2 && this.bodypos1 && this.bodypos2) {
      this.constraint && (this.parent && this.parent.physicsSystem && this.parent.physicsSystem.removeConstraint(this.constraint), this.body1.removeConstraint(this.constraint), this.body2.removeConstraint(this.constraint)), this.constraint = new jigLib.JConstraintPoint(this.body1.jigLibObj, this.bodypos1, this.body2.jigLibObj, this.bodypos2), this.parent && this.parent.physicsSystem && this.parent.physicsSystem.addConstraint(this.constraint)
    }
  };
  e.Scene.prototype.addPhysicsConstraintPoint = function(e) {
    if(!this.constraints) {
      this.constraints = []
    }
    this.constraints.push(e);
    this.physicsSystem && this.physicsSystem.addConstraint(e.constraint);
    return this
  };
  e.Scene.prototype.removePhysicsConstraintPoint = function(e) {
    if(!this.constraints) {
      this.constraints = []
    }
    this.constraints.indexOf(e) > -1 && (this.constraints.push(e), this.physicsSystem && this.physicsSystem.removeConstraint(e.constraint));
    return this
  }
})(GLGE);
(function(e) {
  e.PhysicsBox = function(f) {
    this.jigLibObj = new jigLib.JBox(this, this.width, this.height, this.depth);
    this.jigLibObj.GLGE = this;
    this.jigLibObj.addEventListener(jigLib.JCollisionEvent.COLLISION, function(e) {
      this.GLGE.fireEvent("collision", {obj:e.collisionBody.GLGE, impulse:e.collisionImpulse})
    });
    e.PhysicsAbstract.call(this, f)
  };
  e.augment(e.PhysicsAbstract, e.PhysicsBox);
  e.PhysicsBox.prototype.width = 1;
  e.PhysicsBox.prototype.height = 1;
  e.PhysicsBox.prototype.depth = 1;
  e.PhysicsBox.prototype.className = "PhysicsBox";
  e.PhysicsBox.prototype.setWidth = function(e) {
    this.width = e;
    var g = this.jigLibObj.get_sideLengths();
    g[0] = +e;
    this.jigLibObj.set_sideLengths(g);
    return this
  };
  e.PhysicsBox.prototype.setHeight = function(e) {
    this.height = e;
    var g = this.jigLibObj.get_sideLengths();
    g[1] = +e;
    this.jigLibObj.set_sideLengths(g);
    return this
  };
  e.PhysicsBox.prototype.setDepth = function(e) {
    this.depth = e;
    var g = this.jigLibObj.get_sideLengths();
    g[2] = +e;
    this.jigLibObj.set_sideLengths(g);
    return this
  };
  e.PhysicsBox.prototype.getWidth = function() {
    return this.jigLibObj.get_sideLengths()[0]
  };
  e.PhysicsBox.prototype.getHeight = function() {
    return this.jigLibObj.get_sideLengths()[1]
  };
  e.PhysicsBox.prototype.getDepth = function() {
    return this.jigLibObj.get_sideLengths()[2]
  }
})(GLGE);
(function(e) {
  e.TextureVideo = function(f) {
    e.Assets.registerAsset(this, f);
    this.video = document.createElement("video");
    this.video.style.display = "none";
    this.video.setAttribute("loop", "loop");
    this.video.autoplay = !0;
    this.video.addEventListener("ended", function() {
      this.play()
    }, !0);
    document.getElementsByTagName("body")[0].appendChild(this.video);
    this.canvas = document.createElement("canvas");
    this.ctx = this.canvas.getContext("2d")
  };
  e.augment(e.QuickNotation, e.TextureVideo);
  e.augment(e.JSONLoader, e.TextureVideo);
  e.augment(e.Events, e.TextureVideo);
  e.TextureVideo.prototype.className = "TextureVideo";
  e.TextureVideo.prototype.glTexture = null;
  e.TextureVideo.prototype.getVideo = function() {
    return this.video
  };
  e.TextureVideo.prototype.setVideo = function(e) {
    this.video = e;
    return this
  };
  e.TextureVideo.prototype.setSrc = function(e) {
    this.video.src = e;
    return this
  };
  e.TextureVideo.prototype.getSrc = function() {
    return this.video.src
  };
  e.TextureVideo.prototype.doTexture = function(e) {
    this.gl = e;
    if(!this.glTexture) {
      this.glTexture = e.createTexture()
    }
    e.bindTexture(e.TEXTURE_2D, this.glTexture);
    this.updateTexture(e);
    return!0
  };
  e.TextureVideo.prototype.updateTexture = function(e) {
    var g = this.video;
    e.bindTexture(e.TEXTURE_2D, this.glTexture);
    if(g.readyState > 0) {
      if(g.height <= 0) {
        g.style.display = "", g.height = g.offsetHeight, g.width = g.offsetWidth, g.style.display = "none"
      }
      this.canvas.height = g.height;
      this.canvas.width = g.width;
      this.ctx.drawImage(g, 0, 0);
      try {
        e.texImage2D(e.TEXTURE_2D, 0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, this.canvas)
      }catch(h) {
        e.texImage2D(e.TEXTURE_2D, 0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, this.canvas, null)
      }
      e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MAG_FILTER, e.LINEAR);
      e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MIN_FILTER, e.LINEAR);
      e.generateMipmap(e.TEXTURE_2D)
    }
  }
})(GLGE);
(function(e) {
  e.Texture = function(f) {
    e.Assets.registerAsset(this, f)
  };
  e.augment(e.QuickNotation, e.Texture);
  e.augment(e.JSONLoader, e.Texture);
  e.augment(e.Events, e.Texture);
  e.Texture.prototype.className = "Texture";
  e.Texture.prototype.image = null;
  e.Texture.prototype.glTexture = null;
  e.Texture.prototype.url = null;
  e.Texture.prototype.state = 0;
  e.Texture.prototype.getSrc = function() {
    return this.url
  };
  e.Texture.prototype.setSrc = function(f) {
    this.url = f;
    this.state = 0;
    this.image = new Image;
    var g = this;
    this.image.onload = function() {
      g.state = 1;
      g.fireEvent("downloadComplete")
    };
    e.loadImage(this.image, f);
    if(this.glTexture && this.gl) {
      this.gl.deleteTexture(this.glTexture), this.glTexture = null
    }
    return this
  };
  e.Texture.prototype.doTexture = function(e) {
    this.gl = e;
    this.image || this.setSrc(this.url);
    if(!this.glTexture) {
      this.glTexture = e.createTexture()
    }
    if(this.state == 1) {
      e.bindTexture(e.TEXTURE_2D, this.glTexture);
      var g = Math.pow(2, Math.round(Math.log(this.image.width) / Math.log(2))), h = Math.pow(2, Math.round(Math.log(this.image.height) / Math.log(2))), j;
      g == this.image.width && h == this.image.height ? j = this.image : (j = document.createElement("canvas"), j.width = g, j.height = h, j.getContext("2d").drawImage(this.image, 0, 0, g, h));
      e.texImage2D(e.TEXTURE_2D, 0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, j);
      e.generateMipmap(e.TEXTURE_2D);
      e.bindTexture(e.TEXTURE_2D, null);
      this.state = 2
    }
    e.bindTexture(e.TEXTURE_2D, this.glTexture);
    e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MAG_FILTER, e.LINEAR);
    e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MIN_FILTER, e.LINEAR_MIPMAP_LINEAR);
    e.texParameteri(e.TEXTURE_2D, e.TEXTURE_WRAP_S, e.REPEAT);
    e.texParameteri(e.TEXTURE_2D, e.TEXTURE_WRAP_T, e.REPEAT);
    return this.state == 2 ? !0 : !1
  };
  e.Texture.prototype.isComplete = function() {
    return this.state > 0
  }
})(GLGE);
(function(e) {
  e.TextureCube = function(f) {
    e.Assets.registerAsset(this, f)
  };
  e.augment(e.QuickNotation, e.TextureCube);
  e.augment(e.JSONLoader, e.TextureCube);
  e.augment(e.Events, e.TextureCube);
  e.TextureCube.prototype.className = "TextureCube";
  e.TextureCube.prototype.posX = null;
  e.TextureCube.prototype.negX = null;
  e.TextureCube.prototype.posY = null;
  e.TextureCube.prototype.negY = null;
  e.TextureCube.prototype.posZ = null;
  e.TextureCube.prototype.negZ = null;
  e.TextureCube.prototype.texture = null;
  e.TextureCube.prototype.glTexture = null;
  e.TextureCube.prototype.loadState = 0;
  e.TextureCube.prototype.setSrc = function(f, g, h) {
    this.url = f;
    this.state = 0;
    this[g] = new Image;
    var j = this;
    this[g].onload = function() {
      j.loadState += h
    };
    e.loadImage(this[g], f);
    if(this.glTexture && this.gl) {
      this.gl.deleteTexture(this.glTexture), this.glTexture = null
    }
    return this
  };
  e.TextureCube.prototype.setSrcPosX = function(e) {
    this.setSrc(e, "posX", 1);
    return this
  };
  e.TextureCube.prototype.setSrcNegX = function(e) {
    this.setSrc(e, "negX", 2);
    return this
  };
  e.TextureCube.prototype.setSrcPosY = function(e) {
    this.setSrc(e, "posY", 4);
    return this
  };
  e.TextureCube.prototype.setSrcNegY = function(e) {
    typeof e != "string" ? (this.negY = e, this.loadState += 8) : this.setSrc(e, "negY", 8);
    return this
  };
  e.TextureCube.prototype.setSrcPosZ = function(e) {
    this.setSrc(e, "posZ", 16);
    return this
  };
  e.TextureCube.prototype.setSrcNegZ = function(e) {
    this.setSrc(e, "negZ", 32);
    return this
  };
  e.TextureCube.prototype.doTexture = function(e) {
    this.gl = e;
    if(!this.glTexture) {
      this.glTexture = e.createTexture()
    }
    e.bindTexture(e.TEXTURE_CUBE_MAP, this.glTexture);
    if(this.loadState == 63 && this.state == 0) {
      e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X, 0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, this.posX), e.texImage2D(e.TEXTURE_CUBE_MAP_NEGATIVE_X, 0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, this.negX), e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_Y, 0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, this.posY), e.texImage2D(e.TEXTURE_CUBE_MAP_NEGATIVE_Y, 0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, this.negY), e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_Z, 0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, this.posZ), e.texImage2D(e.TEXTURE_CUBE_MAP_NEGATIVE_Z,
      0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, this.negZ), e.texParameteri(e.TEXTURE_CUBE_MAP, e.TEXTURE_MAG_FILTER, e.LINEAR), e.texParameteri(e.TEXTURE_CUBE_MAP, e.TEXTURE_MIN_FILTER, e.LINEAR_MIPMAP_LINEAR), e.texParameteri(e.TEXTURE_CUBE_MAP, e.TEXTURE_WRAP_S, e.CLAMP_TO_EDGE), e.texParameteri(e.TEXTURE_CUBE_MAP, e.TEXTURE_WRAP_T, e.CLAMP_TO_EDGE), e.generateMipmap(e.TEXTURE_CUBE_MAP), e.bindTexture(e.TEXTURE_CUBE_MAP, null), this.state = 1
    }
    e.bindTexture(e.TEXTURE_CUBE_MAP, this.glTexture);
    return this.state == 1 ? !0 : !1
  }
})(GLGE);
(function(e) {
  e.TextureCanvas = function(f) {
    e.Assets.registerAsset(this, f);
    this.canvas = document.createElement("canvas")
  };
  e.augment(e.QuickNotation, e.TextureCanvas);
  e.augment(e.JSONLoader, e.TextureCanvas);
  e.augment(e.Events, e.TextureCanvas);
  e.TextureCanvas.prototype.className = "TextureCanvas";
  e.TextureCanvas.prototype.glTexture = null;
  e.TextureCanvas.prototype.autoUpdate = !0;
  e.TextureCanvas.prototype.getAutoUpdate = function() {
    return this.autoUpdate
  };
  e.TextureCanvas.prototype.setAutoUpdate = function(e) {
    this.autoUpdate = e;
    return this
  };
  e.TextureCanvas.prototype.getCanvas = function() {
    return this.canvas
  };
  e.TextureCanvas.prototype.setCanvas = function(e) {
    this.canvas = e;
    return this
  };
  e.TextureCanvas.prototype.setHeight = function(e) {
    this.canvas.height = e;
    return this
  };
  e.TextureCanvas.prototype.setWidth = function(e) {
    this.canvas.width = e;
    return this
  };
  e.TextureCanvas.prototype.getHeight = function() {
    return this.canvas.height
  };
  e.TextureCanvas.prototype.getWidth = function() {
    return this.canvas.width
  };
  e.TextureCanvas.prototype.doTexture = function(e) {
    this.gl = e;
    this.glTexture ? (e.bindTexture(e.TEXTURE_2D, this.glTexture), (this.autoUpdate || this.doUpdate) && this.updateCanvas(e)) : (this.glTexture = e.createTexture(), e.bindTexture(e.TEXTURE_2D, this.glTexture), this.updateCanvas(e));
    this.doUpdate = !1;
    return!0
  };
  e.TextureCanvas.prototype.update = function() {
    this.doUpdate = !0
  };
  e.TextureCanvas.prototype.updateCanvas = function(e) {
    var g = this.canvas;
    e.bindTexture(e.TEXTURE_2D, this.glTexture);
    try {
      e.texImage2D(e.TEXTURE_2D, 0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, g)
    }catch(h) {
      e.texImage2D(e.TEXTURE_2D, 0, e.RGBA, e.RGBA, e.UNSIGNED_BYTE, g, null)
    }
    e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MAG_FILTER, e.LINEAR);
    e.texParameteri(e.TEXTURE_2D, e.TEXTURE_MIN_FILTER, e.LINEAR);
    e.generateMipmap(e.TEXTURE_2D)
  }
})(GLGE);
(function(e) {
  e.TextureCamera = function(f) {
    e.Assets.registerAsset(this, f)
  };
  e.augment(e.QuickNotation, e.TextureCamera);
  e.augment(e.JSONLoader, e.TextureCamera);
  e.augment(e.Events, e.TextureCamera);
  e.TextureCamera.prototype.className = "Texture";
  e.TextureCamera.prototype.texture = null;
  e.TextureCamera.prototype.glTexture = null;
  e.TextureCamera.prototype.object = null;
  e.TextureCamera.prototype.camera = null;
  e.TextureCamera.prototype.bufferHeight = 0;
  e.TextureCamera.prototype.bufferWidth = 0;
  e.TextureCamera.prototype.mirrorAxis = e.NONE;
  e.TextureCamera.prototype.clipAxis = e.NONE;
  e.TextureCamera.prototype.setBufferWidth = function(e) {
    this.bufferWidth = e;
    this.update = !0;
    return this
  };
  e.TextureCamera.prototype.getBufferWidth = function() {
    return this.bufferWidth
  };
  e.TextureCamera.prototype.setBufferHeight = function(e) {
    this.bufferHeight = e;
    this.update = !0;
    return this
  };
  e.TextureCamera.prototype.getBufferHeight = function() {
    return this.bufferHeight
  };
  e.TextureCamera.prototype.setClipAxis = function(e) {
    this.clipAxis = e;
    return this
  };
  e.TextureCamera.prototype.getClipAxis = function() {
    return this.clipAxis
  };
  e.TextureCamera.prototype.setMirrorAxis = function(e) {
    this.mirrorAxis = e;
    return this
  };
  e.TextureCamera.prototype.getMirrorAxis = function() {
    return this.mirrorAxis
  };
  e.TextureCamera.prototype.setCamera = function(e) {
    this.camera = e;
    return this
  };
  e.TextureCamera.prototype.getCamera = function() {
    return this.camera
  };
  e.TextureCamera.prototype.doTexture = function(f, g) {
    if(this.camera) {
      this.gl = f;
      var h = g.getModelMatrix(), j = f.scene.camera.getProjectionMatrix(), m = this.camera.getViewMatrix(), p;
      if(this.mirrorAxis) {
        switch(this.mirrorAxis) {
          case e.XAXIS:
            p = e.mulMat4(e.mulMat4(e.mulMat4(m, h), e.scaleMatrix(-1, 1, 1)), e.inverseMat4(h));
            break;
          case e.YAXIS:
            p = e.mulMat4(e.mulMat4(e.mulMat4(m, h), e.scaleMatrix(1, -1, 1)), e.inverseMat4(h));
            break;
          case e.ZAXIS:
            p = e.mulMat4(e.mulMat4(e.mulMat4(m, h), e.scaleMatrix(1, 1, -1)), e.inverseMat4(h))
        }
      }else {
        p = m
      }
      if(this.clipAxis) {
        var o;
        switch(this.clipAxis) {
          case e.NEG_XAXIS:
            o = e.toUnitVec3([-h[0], -h[4], -h[8]]);
            o = [o[0], o[1], o[2], -e.dotVec3([h[3], h[7], h[11]], o)];
            break;
          case e.POS_XAXIS:
            o = e.toUnitVec3([h[0], h[4], h[8]]);
            o = [o[0], o[1], o[2], -e.dotVec3([h[3], h[7], h[11]], o)];
            break;
          case e.NEG_YAXIS:
            o = e.toUnitVec3([-h[1], -h[5], -h[9]]);
            o = [o[0], o[1], o[2], -e.dotVec3([h[3], h[7], h[11]], o)];
            break;
          case e.POS_YAXIS:
            o = e.toUnitVec3([h[1], h[5], h[9]]);
            o = [o[0], o[1], o[2], -e.dotVec3([h[3], h[7], h[11]], o)];
            break;
          case e.NEG_ZAXIS:
            o = e.toUnitVec3([-h[2], -h[6], -h[10]]);
            o = [o[0], o[1], o[2], -e.dotVec3([h[3], h[7], h[11]], o)];
            break;
          case e.POS_ZAXIS:
            o = e.toUnitVec3([h[2], h[6], h[10]]), o = [o[0], o[1], o[2], -e.dotVec3([h[3], h[7], h[11]], o)]
        }
        h = e.transposeMat4(e.inverseMat4(e.mulMat4(j, p)));
        o = e.mulMat4Vec4(h, o);
        o = e.scaleVec4(o, j[10]);
        o[3] -= 1;
        o[2] < 0 && e.scaleVec4(o, -1);
        j = e.mulMat4([1, 0, 0, 0, 0, 1, 0, 0, o[0], o[1], o[2], o[3], 0, 0, 0, 1], j)
      }
      h = !this.bufferHeight ? f.scene.renderer.canvas.height : this.bufferHeight;
      o = !this.bufferWidth ? f.scene.renderer.canvas.width : this.bufferWidth;
      return!this.glTexture || this.update ? (this.createFrameBuffer(f), f.scene.addRenderPass(this.frameBuffer, p, f.scene.camera.getProjectionMatrix(), o, h, g), f.bindTexture(f.TEXTURE_2D, this.glTexture), this.update = !1) : (f.bindTexture(f.TEXTURE_2D, this.glTexture), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_MAG_FILTER, f.LINEAR), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_MIN_FILTER, f.LINEAR), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_WRAP_S, f.CLAMP_TO_EDGE), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_WRAP_T,
      f.CLAMP_TO_EDGE), f.scene.addRenderPass(this.frameBuffer, p, j, o, h, g), !0)
    }else {
      return!1
    }
  };
  e.TextureCamera.prototype.registerPasses = e.TextureCamera.prototype.doTexture;
  e.TextureCamera.prototype.createFrameBuffer = function(e) {
    var g = !this.bufferHeight ? e.scene.renderer.canvas.height : this.bufferHeight, h = !this.bufferWidth ? e.scene.renderer.canvas.width : this.bufferWidth;
    if(!this.frameBuffer) {
      this.frameBuffer = e.createFramebuffer()
    }
    if(!this.renderBuffer) {
      this.renderBuffer = e.createRenderbuffer()
    }
    if(!this.glTexture) {
      this.glTexture = e.createTexture()
    }
    e.bindTexture(e.TEXTURE_2D, this.glTexture);
    var j = new Uint8Array(h * g * 4);
    e.texImage2D(e.TEXTURE_2D, 0, e.RGBA, h, g, 0, e.RGBA, e.UNSIGNED_BYTE, j);
    e.bindFramebuffer(e.FRAMEBUFFER, this.frameBuffer);
    e.bindRenderbuffer(e.RENDERBUFFER, this.renderBuffer);
    e.renderbufferStorage(e.RENDERBUFFER, e.DEPTH_COMPONENT16, h, g);
    e.framebufferRenderbuffer(e.FRAMEBUFFER, e.DEPTH_ATTACHMENT, e.RENDERBUFFER, this.renderBuffer);
    e.framebufferTexture2D(e.FRAMEBUFFER, e.COLOR_ATTACHMENT0, e.TEXTURE_2D, this.glTexture, 0);
    e.bindRenderbuffer(e.RENDERBUFFER, null);
    e.bindFramebuffer(e.FRAMEBUFFER, null);
    e.bindTexture(e.TEXTURE_2D, null)
  }
})(GLGE);
(function(e) {
  e.MultiMaterial = function(f) {
    e.Assets.registerAsset(this, f);
    var g = this;
    this.downloadComplete = function() {
      g.isComplete() && g.fireEvent("downloadComplete")
    };
    this.lods = [new e.ObjectLod];
    this.lods[0].addEventListener("downloadComplete", this.downloadComplete)
  };
  e.augment(e.QuickNotation, e.MultiMaterial);
  e.augment(e.JSONLoader, e.MultiMaterial);
  e.augment(e.Events, e.MultiMaterial);
  e.MultiMaterial.prototype.className = "MultiMaterial";
  e.MultiMaterial.prototype.isComplete = function() {
    for(var e = 0;e < this.lods.length;e++) {
      if(!this.lods[e].isComplete()) {
        return!1
      }
    }
    return!0
  };
  e.MultiMaterial.prototype.setMesh = function(e) {
    this.lods[0].setMesh(e);
    return this
  };
  e.MultiMaterial.prototype.getMesh = function() {
    return this.lods[0].getMesh()
  };
  e.MultiMaterial.prototype.setMaterial = function(e) {
    this.lods[0].setMaterial(e);
    return this
  };
  e.MultiMaterial.prototype.getMaterial = function() {
    return this.lods[0].getMaterial()
  };
  e.MultiMaterial.prototype.getLOD = function(e) {
    var g = 0, h = this.lods[0];
    if(this.lods.length > 1) {
      for(var j = 1;j < this.lods.length;j++) {
        var m = this.lods[j].pixelSize;
        m > g && m < e && this.lods[j].mesh && this.lods[j].mesh.loaded && (g = m, h = this.lods[j])
      }
    }
    return h
  };
  e.MultiMaterial.prototype.addObjectLod = function(e) {
    this.lods.push(e);
    e.addEventListener("downloadComplete", this.downloadComplete);
    return this
  };
  e.MultiMaterial.prototype.updateProgram = function() {
    for(var e = 0;e < this.lods.length;e++) {
      this.lods[e].GLShaderProgram = null
    }
    return this
  };
  e.MultiMaterial.prototype.removeObjectLod = function(e) {
    e = this.lods.indexOf(e);
    lods[e].removeEventListener("downloadComplete", this.downloadComplete);
    e && this.lods.splice(e, 1);
    return this
  }
})(GLGE);
(function(e) {
  e.MaterialLayer = function(f) {
    e.Assets.registerAsset(this, f);
    this.blendMode = e.BL_MIX
  };
  e.augment(e.Animatable, e.MaterialLayer);
  e.augment(e.QuickNotation, e.MaterialLayer);
  e.augment(e.JSONLoader, e.MaterialLayer);
  e.augment(e.Events, e.MaterialLayer);
  e.MaterialLayer.prototype.className = "MaterialLayer";
  e.MaterialLayer.prototype.texture = null;
  e.MaterialLayer.prototype.blendMode = null;
  e.MaterialLayer.prototype.mapto = e.M_COLOR;
  e.MaterialLayer.prototype.mapinput = e.UV1;
  e.MaterialLayer.prototype.scaleX = 1;
  e.MaterialLayer.prototype.offsetX = 0;
  e.MaterialLayer.prototype.rotX = 0;
  e.MaterialLayer.prototype.scaleY = 1;
  e.MaterialLayer.prototype.offsetY = 0;
  e.MaterialLayer.prototype.rotY = 0;
  e.MaterialLayer.prototype.scaleZ = 1;
  e.MaterialLayer.prototype.offsetZ = 0;
  e.MaterialLayer.prototype.rotZ = 0;
  e.MaterialLayer.prototype.dScaleX = 0;
  e.MaterialLayer.prototype.dOffsetX = 0;
  e.MaterialLayer.prototype.dRotX = 0;
  e.MaterialLayer.prototype.dScaleY = 0;
  e.MaterialLayer.prototype.dOffsetY = 0;
  e.MaterialLayer.prototype.dRotY = 0;
  e.MaterialLayer.prototype.dScaleZ = 0;
  e.MaterialLayer.prototype.dOffsetZ = 0;
  e.MaterialLayer.prototype.dRotZ = 0;
  e.MaterialLayer.prototype.alpha = 1;
  e.MaterialLayer.prototype.height = 0.05;
  e.MaterialLayer.prototype.matrix = null;
  e.MaterialLayer.prototype.getMatrix = function() {
    if(!this.matrix) {
      var f = this.getOffset(), g = this.getScale(), h = this.getRotation();
      this.matrix = e.mulMat4(e.mulMat4(e.translateMatrix(f.x, f.y, f.z), e.scaleMatrix(g.x, g.y, g.z)), e.rotateMatrix(h.x, h.y, h.z))
    }
    return this.matrix
  };
  e.MaterialLayer.prototype.setHeight = function(e) {
    this.height = e;
    return this
  };
  e.MaterialLayer.prototype.getHeight = function() {
    return this.height
  };
  e.MaterialLayer.prototype.setAlpha = function(e) {
    this.alpha = e;
    return this
  };
  e.MaterialLayer.prototype.getAlpha = function() {
    return this.alpha
  };
  e.MaterialLayer.prototype.setTexture = function(f) {
    typeof f == "string" && (f = e.Assets.get(f));
    this.texture = f;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.MaterialLayer.prototype.getTexture = function() {
    return this.texture
  };
  e.MaterialLayer.prototype.setMapto = function(e) {
    this.mapto = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.MaterialLayer.prototype.getMapto = function() {
    return this.mapto
  };
  e.MaterialLayer.prototype.setMapinput = function(e) {
    this.mapinput = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.MaterialLayer.prototype.getMapinput = function() {
    return this.mapinput
  };
  e.MaterialLayer.prototype.getOffset = function() {
    var e = {};
    e.x = parseFloat(this.getOffsetX()) + parseFloat(this.getDOffsetX());
    e.y = parseFloat(this.getOffsetY()) + parseFloat(this.getDOffsetY());
    e.z = parseFloat(this.getOffsetZ()) + parseFloat(this.getDOffsetZ());
    return e
  };
  e.MaterialLayer.prototype.getRotation = function() {
    var e = {};
    e.x = parseFloat(this.getRotX()) + parseFloat(this.getDRotX());
    e.y = parseFloat(this.getRotY()) + parseFloat(this.getDRotY());
    e.z = parseFloat(this.getRotZ()) + parseFloat(this.getDRotZ());
    return e
  };
  e.MaterialLayer.prototype.getScale = function() {
    var e = {};
    e.x = parseFloat(this.getScaleX()) + parseFloat(this.getDScaleX());
    e.y = parseFloat(this.getScaleY()) + parseFloat(this.getDScaleY());
    e.z = parseFloat(this.getScaleZ()) + parseFloat(this.getDScaleZ());
    return e
  };
  e.MaterialLayer.prototype.setOffsetX = function(e) {
    this.matrix = null;
    this.offsetX = e;
    return this
  };
  e.MaterialLayer.prototype.getOffsetX = function() {
    return this.offsetX
  };
  e.MaterialLayer.prototype.setOffsetY = function(e) {
    this.matrix = null;
    this.offsetY = e;
    return this
  };
  e.MaterialLayer.prototype.getOffsetY = function() {
    return this.offsetY
  };
  e.MaterialLayer.prototype.setOffsetZ = function(e) {
    this.matrix = null;
    this.offsetZ = e;
    return this
  };
  e.MaterialLayer.prototype.getOffsetZ = function() {
    return this.offsetZ
  };
  e.MaterialLayer.prototype.setDOffsetX = function(e) {
    this.matrix = null;
    this.dOffsetX = e;
    return this
  };
  e.MaterialLayer.prototype.getDOffsetX = function() {
    return this.dOffsetX
  };
  e.MaterialLayer.prototype.setDOffsetY = function(e) {
    this.matrix = null;
    this.dOffsetY = e;
    return this
  };
  e.MaterialLayer.prototype.getDOffsetY = function() {
    return this.dOffsetY
  };
  e.MaterialLayer.prototype.setDOffsetZ = function(e) {
    this.matrix = null;
    this.dOffsetZ = e;
    return this
  };
  e.MaterialLayer.prototype.getDOffsetZ = function() {
    return this.dOffsetZ
  };
  e.MaterialLayer.prototype.setScaleX = function(e) {
    this.matrix = null;
    this.scaleX = e;
    return this
  };
  e.MaterialLayer.prototype.getScaleX = function() {
    return this.scaleX
  };
  e.MaterialLayer.prototype.setScaleY = function(e) {
    this.matrix = null;
    this.scaleY = e;
    return this
  };
  e.MaterialLayer.prototype.getScaleY = function() {
    return this.scaleY
  };
  e.MaterialLayer.prototype.setScaleZ = function(e) {
    this.matrix = null;
    this.scaleZ = e;
    return this
  };
  e.MaterialLayer.prototype.getScaleZ = function() {
    return this.scaleZ
  };
  e.MaterialLayer.prototype.setDScaleX = function(e) {
    this.matrix = null;
    this.dScaleX = e;
    return this
  };
  e.MaterialLayer.prototype.getDScaleX = function() {
    return this.dScaleX
  };
  e.MaterialLayer.prototype.setDScaleY = function(e) {
    this.matrix = null;
    this.dScaleY = e;
    return this
  };
  e.MaterialLayer.prototype.getDScaleY = function() {
    return this.dScaleY
  };
  e.MaterialLayer.prototype.setDScaleZ = function(e) {
    this.matrix = null;
    this.dScaleZ = e;
    return this
  };
  e.MaterialLayer.prototype.getDScaleZ = function() {
    return this.dScaleZ
  };
  e.MaterialLayer.prototype.setRotX = function(e) {
    this.matrix = null;
    this.rotX = e;
    return this
  };
  e.MaterialLayer.prototype.getRotX = function() {
    return this.rotX
  };
  e.MaterialLayer.prototype.setRotY = function(e) {
    this.matrix = null;
    this.rotY = e;
    return this
  };
  e.MaterialLayer.prototype.getRotY = function() {
    return this.rotY
  };
  e.MaterialLayer.prototype.setRotZ = function(e) {
    this.matrix = null;
    this.rotZ = e;
    return this
  };
  e.MaterialLayer.prototype.getRotZ = function() {
    return this.rotZ
  };
  e.MaterialLayer.prototype.setDRotX = function(e) {
    this.matrix = null;
    this.dRotX = e;
    return this
  };
  e.MaterialLayer.prototype.getDRotX = function() {
    return this.dRotX
  };
  e.MaterialLayer.prototype.setDRotY = function(e) {
    this.matrix = null;
    this.dRotY = e;
    return this
  };
  e.MaterialLayer.prototype.getDRotY = function() {
    return this.dRotY
  };
  e.MaterialLayer.prototype.setDRotZ = function(e) {
    this.matrix = null;
    this.dRotZ = e;
    return this
  };
  e.MaterialLayer.prototype.getDRotZ = function() {
    return this.dRotZ
  };
  e.MaterialLayer.prototype.setBlendMode = function(e) {
    this.blendMode = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.MaterialLayer.prototype.getBlendMode = function() {
    return this.blendMode
  }
})(GLGE);
(function(e) {
  var f = 0;
  e.Material = function(g) {
    e.Assets.registerAsset(this, g);
    this.layers = [];
    this.layerlisteners = [];
    this.textures = [];
    this.lights = [];
    this.color = {r:1, g:1, b:1, a:1};
    this.specColor = {r:1, g:1, b:1};
    this.reflect = 0.8;
    this.shine = 10;
    this.specular = 1;
    this.emit = {r:0, g:0, b:0};
    this.alpha = 1;
    this.materialIdx = f++
  };
  e.augment(e.Animatable, e.Material);
  e.augment(e.QuickNotation, e.Material);
  e.augment(e.JSONLoader, e.Material);
  e.augment(e.Events, e.Material);
  e.M_COLOR = 1;
  e.M_NOR = 2;
  e.M_ALPHA = 4;
  e.M_SPECCOLOR = 8;
  e.M_SPECULAR = 16;
  e.M_SHINE = 32;
  e.M_REFLECT = 64;
  e.M_EMIT = 128;
  e.M_ALPHA = 256;
  e.M_MSKR = 512;
  e.M_MSKG = 1024;
  e.M_MSKB = 2048;
  e.M_MSKA = 4096;
  e.M_HEIGHT = 8192;
  e.M_AMBIENT = 16384;
  e.UV1 = 0;
  e.UV2 = 1;
  e.MAP_NORM = 3;
  e.MAP_OBJ = 4;
  e.MAP_REF = 5;
  e.MAP_ENV = 6;
  e.MAP_VIEW = 7;
  e.MAP_POINT = 8;
  e.BL_MIX = 0;
  e.BL_MUL = 1;
  e.Material.prototype.layers = null;
  e.Material.prototype.className = "Material";
  e.Material.prototype.textures = null;
  e.Material.prototype.color = null;
  e.Material.prototype.specColor = null;
  e.Material.prototype.specular = null;
  e.Material.prototype.emit = {r:0, g:0, b:0};
  e.Material.prototype.shine = null;
  e.Material.prototype.reflect = null;
  e.Material.prototype.lights = null;
  e.Material.prototype.alpha = null;
  e.Material.prototype.ambient = null;
  e.Material.prototype.shadow = !0;
  e.Material.prototype.shadeless = !1;
  e.Material.prototype.downloadComplete = !1;
  e.Material.prototype.setShadeless = function(e) {
    this.shadeless = e;
    return this
  };
  e.Material.prototype.getShadeless = function() {
    return this.shadeless
  };
  e.Material.prototype.setShadow = function(e) {
    this.shadow = e;
    return this
  };
  e.Material.prototype.getShadow = function() {
    return this.shadow
  };
  e.Material.prototype.setColor = function(f) {
    f.r || (f = e.colorParse(f));
    this.color = {r:f.r, g:f.g, b:f.b};
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.setColorR = function(e) {
    this.color.r = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.setColorG = function(e) {
    this.color.g = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.setColorB = function(e) {
    this.color.b = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.getColor = function() {
    return this.color
  };
  e.Material.prototype.setSpecularColor = function(f) {
    f.r || (f = e.colorParse(f));
    this.specColor = {r:parseFloat(f.r), g:parseFloat(f.g), b:parseFloat(f.b)};
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.getAmbient = function() {
    return this.ambient
  };
  e.Material.prototype.setAmbient = function(f) {
    f.r || (f = e.colorParse(f));
    this.ambient = {r:parseFloat(f.r), g:parseFloat(f.g), b:parseFloat(f.b)};
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.getSpecularColor = function() {
    return this.specColor
  };
  e.Material.prototype.setAlpha = function(e) {
    this.alpha = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.getAlpha = function() {
    return this.alpha
  };
  e.Material.prototype.setSpecular = function(e) {
    this.specular = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.getSpecular = function() {
    return this.specular
  };
  e.Material.prototype.setShininess = function(e) {
    e <= 0 && (e = 0.001);
    this.shine = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.getShininess = function() {
    return this.shine
  };
  e.Material.prototype.setEmit = function(f) {
    f > 0 && (f = {r:f, g:f, b:f});
    f.r || (f = e.colorParse(f));
    this.emit = {r:parseFloat(f.r), g:parseFloat(f.g), b:parseFloat(f.b)};
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.getEmit = function() {
    return this.emit
  };
  e.Material.prototype.setReflectivity = function(e) {
    this.reflect = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.getReflectivity = function() {
    return this.reflect
  };
  e.Material.prototype.setBinaryAlpha = function(e) {
    this.binaryAlpha = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.getBinaryAlpha = function() {
    return this.binaryAlpha
  };
  e.Material.prototype.addMaterialLayer = function(f) {
    typeof f == "string" && (f = e.Assets.get(f));
    this.layers.push(f);
    var h = this, j = function() {
      h.fireEvent("shaderupdate", {})
    };
    this.layerlisteners.push(j);
    f.addEventListener("shaderupdate", j);
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.removeMaterialLayer = function(e) {
    var f = this.layers.indexOf(e);
    f >= 0 && (this.layers.splice(f, 1), e.removeEventListener("shaderupdate", this.layerlisteners[f]), this.layerlisteners.splice(f, 1), this.fireEvent("shaderupdate", {}));
    return this
  };
  e.Material.prototype.getLayers = function() {
    return this.layers
  };
  e.Material.prototype.getLayerCoords = function(f) {
    var h = [];
    h.push("vec4 texturePos;\n");
    for(i = 0;i < this.layers.length;i++) {
      h.push("textureCoords" + i + "=vec3(0.0,0.0,0.0);\n"), (this.layers[i].mapinput == e.UV1 || this.layers[i].mapinput == e.UV2) && h.push("texturePos=vec4(vec2(UVCoord[" + this.layers[i].mapinput * 2 + "],(1.0-UVCoord[" + (this.layers[i].mapinput * 2 + 1) + "])),1.0,1.0);\n"), this.layers[i].mapinput == e.MAP_NORM && h.push("texturePos=vec4(normalize(n.xyz),1.0);\n"), this.layers[i].mapinput == e.MAP_OBJ && h.push("texturePos=vec4(normalize(OBJCoord.xyz),1.0);\n"), this.layers[i].mapinput ==
      e.MAP_REF && h.push("texturePos=vec4(reflect(normalize(eyevec.xyz),normalize(n.xyz)),1.0);\n"), this.layers[i].mapinput == e.MAP_ENV && h.push("texturePos=envMat * vec4(reflect(normalize(eyevec.xyz),normalize(n.xyz)),1.0);\n"), h.push("textureCoords" + i + "=(layer" + i + "Matrix * texturePos).xyz;\n"), f && ~f.indexOf("GLGE_Texcoord") && h.push("textureCoords" + i + "=GLGE_Texcoord(" + i + ",textureCoords" + i + ");\n")
    }
    return h.join("")
  };
  e.Material.prototype.getVertexVarying = function() {
    var e = [];
    for(i = 0;i < this.layers.length;i++) {
      e.push("uniform mat4 layer" + i + "Matrix;\n"), e.push("varying vec3 textureCoords" + i + ";\n")
    }
    return e.join("")
  };
  e.Material.prototype.registerPasses = function(e, f) {
    for(var j = 0;j < this.textures.length;j++) {
      this.textures[j].registerPasses && this.textures[j].registerPasses(e, f)
    }
  };
  e.Material.prototype.getFragmentShader = function(f, h) {
    for(var j = "#ifdef GL_ES\nprecision highp float;\n#endif\n", m = 0;m < f.length;m++) {
      if(f[m].type == e.L_POINT || f[m].type == e.L_SPOT || f[m].type == e.L_DIR) {
        j = j + "varying vec3 lightvec" + m + ";\n", j = j + "varying float lightdist" + m + ";\n"
      }
    }
    j += "varying vec3 n;\n";
    j += "varying vec3 t;\n";
    j += "varying vec4 UVCoord;\n";
    j += "varying vec3 eyevec;\n";
    j += "varying vec3 OBJCoord;\n";
    h && (j += "varying vec4 vcolor;\n");
    j += "uniform sampler2D sky;\n";
    for(m = 0;m < this.textures.length;m++) {
      this.textures[m].className == "Texture" && (j = j + "uniform sampler2D TEXTURE" + m + ";\n"), this.textures[m].className == "TextureCanvas" && (j = j + "uniform sampler2D TEXTURE" + m + ";\n"), this.textures[m].className == "TextureVideo" && (j = j + "uniform sampler2D TEXTURE" + m + ";\n"), this.textures[m].className == "TextureCube" && (j = j + "uniform samplerCube TEXTURE" + m + ";\n")
    }
    for(var p = 1, o = [], r, m = 0;m < f.length;m++) {
      f[m].type != e.L_OFF && (j = j + "uniform vec3 lightcolor" + m + ";\n", j = j + "uniform vec3 lightAttenuation" + m + ";\n", j = j + "uniform float spotCosCutOff" + m + ";\n", j = j + "uniform float spotExp" + m + ";\n", j = j + "uniform vec3 lightdir" + m + ";\n", j = j + "uniform mat4 lightmat" + m + ";\n", j = j + "uniform float shadowbias" + m + ";\n", j = j + "uniform int shadowsamples" + m + ";\n", j = j + "uniform float shadowsoftness" + m + ";\n", j = j + "uniform bool castshadows" +
      m + ";\n", j = j + "uniform vec2 shadowoffset" + m + ";\n", f[m].getCastShadows() && this.shadow && (j = j + "varying vec4 spotcoord" + m + ";\n", r = this.textures.length + p++, j = j + "uniform sampler2D TEXTURE" + r + ";\n", o[m] = r))
    }
    for(m = 0;m < this.layers.length;m++) {
      j = j + "varying vec3 textureCoords" + m + ";\n", j = j + "uniform float layeralpha" + m + ";\n", (this.layers[m].mapto & e.M_HEIGHT) == e.M_HEIGHT && (j = j + "uniform float layerheight" + m + ";\n")
    }
    j += "uniform vec4 baseColor;\n";
    j += "uniform vec3 specColor;\n";
    j += "uniform float shine;\n";
    j += "uniform float specular;\n";
    j += "uniform float reflective;\n";
    j += "uniform vec3 emit;\n";
    j += "uniform float alpha;\n";
    j += "uniform vec3 amb;\n";
    j += "uniform float fognear;\n";
    j += "uniform float fogfar;\n";
    j += "uniform int fogtype;\n";
    j += "uniform vec3 fogcolor;\n";
    j += "uniform float far;\n";
    j += "uniform mat4 worldInverseTranspose;\n";
    j += "uniform mat4 projection;\n";
    j += "uniform bool emitpass;\n";
    j += "uniform bool shadeless;\n";
    j += "void main(void)\n";
    j += "{\n";
    j += "float att;\n";
    j += "int texture;\n";
    j += "float mask=1.0;\n";
    j += "float spec=specular;\n";
    j += "vec3 specC=specColor;\n";
    j += "vec4 view;\n";
    j += "vec3 textureCoords=vec3(0.0,0.0,0.0);\n";
    j += "float ref=reflective;\n";
    j += "float sh=shine;\n";
    j += "vec3 em=emit;\n";
    j += "float al=alpha;\n";
    j += "vec3 amblight=amb;\n";
    j += "vec4 normalmap= vec4(n,0.0);\n";
    h ? (j += "vec4 color = vcolor;", j += "al = vcolor.a;") : j += "vec4 color = baseColor;";
    j += "float pheight=0.0;\n";
    j += "vec3 textureHeight=vec3(0.0,0.0,0.0);\n";
    j += "vec3 normal = normalize(n);\n";
    j += "vec3 b = vec3(0.0,0.0,0.0);\n";
    p = 0;
    r = !1;
    for(m = 0;m < this.layers.length;m++) {
      j = j + "textureCoords=textureCoords" + m + "+textureHeight;\n";
      j = j + "mask=layeralpha" + m + "*mask;\n";
      this.layers[m].mapinput == e.MAP_VIEW && (j += "view=projection * vec4(-eyevec,1.0);\n", j += "textureCoords=view.xyz/view.w*0.5+0.5;\n", j += "textureCoords=textureCoords+textureHeight;\n");
      this.layers[m].mapinput == e.MAP_POINT && (j += "textureCoords=vec3(gl_PointCoord,1.0);\n");
      if(this.layers[m].getTexture().className == "Texture" || this.layers[m].getTexture().className == "TextureCanvas" || this.layers[m].getTexture().className == "TextureVideo") {
        var s = "xy", t = "2D"
      }else {
        s = "xyz", t = "Cube"
      }
      (this.layers[m].mapto & e.M_COLOR) == e.M_COLOR && (p = m, j = this.layers[m].blendMode == e.BL_MUL ? j + "color = color*(1.0-mask) + color*texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ")*mask;\n" : j + "color = color*(1.0-mask) + texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ")*mask;\n");
      (this.layers[m].mapto & e.M_HEIGHT) == e.M_HEIGHT && (j = j + "pheight = texture2D(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ").x;\n", j = j + "textureHeight =vec3((layerheight" + m + "* (pheight-0.5)  * normalize(eyevec).xy*vec2(1.0,-1.0)),0.0);\n");
      (this.layers[m].mapto & e.M_SPECCOLOR) == e.M_SPECCOLOR && (j = j + "specC = specC*(1.0-mask) + texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ").rgb*mask;\n");
      (this.layers[m].mapto & e.M_MSKR) == e.M_MSKR && (j = j + "mask = texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ").r;\n");
      (this.layers[m].mapto & e.M_MSKG) == e.M_MSKG && (j = j + "mask = texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ").g;\n");
      (this.layers[m].mapto & e.M_MSKB) == e.M_MSKB && (j = j + "mask = texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ").b;\n");
      (this.layers[m].mapto & e.M_MSKA) == e.M_MSKA && (j = j + "mask = texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ").a;\n");
      (this.layers[m].mapto & e.M_SPECULAR) == e.M_SPECULAR && (j = j + "spec = spec*(1.0-mask) + texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ").r*mask;\n");
      (this.layers[m].mapto & e.M_REFLECT) == e.M_REFLECT && (j = j + "ref = ref*(1.0-mask) + texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ").g*mask;\n");
      (this.layers[m].mapto & e.M_SHINE) == e.M_SHINE && (j = j + "sh = sh*(1.0-mask) + texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ").b*mask*255.0;\n");
      (this.layers[m].mapto & e.M_EMIT) == e.M_EMIT && (j = j + "em = em*(1.0-mask) + texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ").rgb*mask;\n");
      (this.layers[m].mapto & e.M_NOR) == e.M_NOR && (j = j + "normalmap = normalmap*(1.0-mask) + texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ")*mask;\n", j += "normal = normalmap.rgb;\n", j += "normal = 2.0*(vec3(normal.r, -normal.g, normal.b) - vec3(0.5, -0.5, 0.5));", j += "b=normalize(cross(t.xyz,n));\n", j += "normal = normal.x*t + normal.y*b + normal.z*n;", j += "normal = normalize(normal);");
      (this.layers[m].mapto & e.M_ALPHA) == e.M_ALPHA && (r = !0, j = j + "al = al*(1.0-mask) + texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ").a*mask;\n");
      (this.layers[m].mapto & e.M_AMBIENT) == e.M_AMBIENT && (j = j + "amblight = amblight*(1.0-mask) + texture" + t + "(TEXTURE" + this.layers[m].texture.idx + ", textureCoords." + s + ").rgb*mask;\n")
    }
    !r && this.layers.length && (this.layers[p].getTexture().className == "Texture" || this.layers[p].getTexture().className == "TextureCanvas" || this.layers[p].getTexture().className == "TextureVideo" ? (s = "xy", t = "2D") : (s = "xyz", t = "Cube"), j = j + "al = al*(1.0-mask) + texture" + t + "(TEXTURE" + this.layers[p].texture.idx + ", textureCoords." + s + ").a*al*mask;\n");
    this.binaryAlpha ? (j += "if(al<0.5) discard;\n", j += "al=1.0;\n") : j += "if(al<0.0625) discard;\n";
    j += "vec3 lightvalue=amblight;\n";
    j += "float dotN,spotEffect;";
    j += "vec3 lightvec=vec3(0.0,0.0,0.0);";
    j += "vec3 viewvec=vec3(0.0,0.0,0.0);";
    j += "vec3 specvalue=vec3(0.0,0.0,0.0);";
    j += "vec2 scoord=vec2(0.0,0.0);";
    j += "float sDepth=0.0;";
    j += "float spotmul=0.0;";
    j += "float rnd=0.0;";
    j += "float spotsampleX=0.0;";
    j += "float spotsampleY=0.0;";
    j += "float totalweight=0.0;";
    j += "int cnt=0;";
    j += "float specularSmoothStepValue=.125;\n";
    j += "vec2 spotoffset=vec2(0.0,0.0);";
    j += "float dp=0.0;";
    j += "vec4 dist;float depth;\n";
    j += "if (normal.z<0.0) {normal.z=0.0;}\n";
    j += "float fogfact=1.0;";
    j = j + "if(fogtype==" + e.FOG_QUADRATIC + " || fogtype==" + e.FOG_SKYQUADRATIC + ") fogfact=clamp(pow(max((fogfar - length(eyevec)) / (fogfar - fognear),0.0),2.0),0.0,1.0);\n";
    j = j + "if(fogtype==" + e.FOG_LINEAR + " || fogtype==" + e.FOG_SKYLINEAR + ") fogfact=clamp((fogfar - length(eyevec)) / (fogfar - fognear),0.0,1.0);\n";
    j += "if (emitpass) {gl_FragColor=vec4(em,1.0);} else if (shadeless) {\n";
    j += "gl_FragColor=vec4(color.rgb,1.0);\n";
    j += "} else {\n";
    for(m = 0;m < f.length;m++) {
      if(f[m].type != e.L_OFF && (j = j + "lightvec=lightvec" + m + ";\n", j += "viewvec=eyevec;\n", f[m].type == e.L_POINT && (j += "dotN=max(dot(normal,normalize(-lightvec)),0.0);\n", j = j + "att = 1.0 / (lightAttenuation" + m + "[0] + lightAttenuation" + m + "[1] * lightdist" + m + " + lightAttenuation" + m + "[2] * lightdist" + m + " * lightdist" + m + ");\n", j += "if(dotN>0.0){\n", f[m].diffuse && (j = j + "lightvalue += att * dotN * lightcolor" + m + ";\n"), j += "}\n", f[m].specular && (j =
      j + "specvalue += smoothstep(-specularSmoothStepValue,specularSmoothStepValue,dotN)*att * specC * lightcolor" + m + " * spec  * pow(max(dot(reflect(normalize(lightvec), normal),normalize(viewvec)),0.0), 0.3*sh);\n")), j += "spotEffect = 0.0;\n", f[m].type == e.L_SPOT && (j = j + "spotEffect = dot(normalize(lightdir" + m + "), normalize(-lightvec" + m + "));", j = j + "if (spotEffect > spotCosCutOff" + m + ") {\n", j = j + "spotEffect = pow(spotEffect, spotExp" + m + ");", f[m].getCastShadows() &&
      this.shadow && (j = j + "scoord=(((spotcoord" + m + ".xy)/spotcoord" + m + ".w)+1.0)/2.0;\n", j += "if(scoord.x>0.0 && scoord.x<1.0 && scoord.y>0.0 && scoord.y<1.0){\n", j = j + "dist=texture2D(TEXTURE" + o[m] + ", scoord);\n", j = j + "depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0))*" + f[m].distance + ".0;\n", j += "spotmul=0.0;\n", j += "totalweight=0.0;\n", j = j + "if((depth+shadowbias" + m + "-length(lightvec" + m + "))<0.0) {spotmul=1.0; totalweight=1.0;}\n",
      f[m].samples > 0 && (j += "for(int cnt=0; cnt<4; cnt++){;\n", j += "spotsampleX=-0.707106781;spotsampleY=-0.707106781;\n", j += "if(cnt==0 || cnt==3) spotsampleX=0.707106781;\n", j += "if(cnt==1 || cnt==3) spotsampleY=0.707106781;\n", j += "spotoffset=vec2(spotsampleX,spotsampleY)*0.5;\n", j = j + "dist=texture2D(TEXTURE" + o[m] + ", scoord+spotoffset*shadowsoftness" + m + ");\n", j = j + "depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0))*" + f[m].distance +
      ".0;\n", j = j + "if((depth+shadowbias" + m + "-length(lightvec" + m + "))<0.0){\n", j += "spotmul+=length(spotoffset);\n", j += "}\n", j += "totalweight+=length(spotoffset);\n", j += "};\n", j += "if(totalweight!=spotmul){\n", j += "spotmul=0.0;\n", j += "totalweight=0.0;\n", j = j + "for(int cnt=0; cnt<" + f[m].samples + "; cnt++){;\n", j += "rnd=(fract(sin(dot(scoord,vec2(12.9898,78.233))) * 43758.5453)-0.5)*2.0;\n", j = j + "spotsampleX=cos(float(cnt)*" + (360 / f[m].samples).toFixed(2) +
      "+rnd);\n", j = j + "spotsampleY=sin(float(cnt)*" + (360 / f[m].samples).toFixed(2) + "+rnd);\n", j += "spotoffset=vec2(spotsampleX,spotsampleY)*0.5;\n", j = j + "dist=texture2D(TEXTURE" + o[m] + ", scoord+spotoffset*shadowsoftness" + m + ");\n", j = j + "depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0))*" + f[m].distance + ".0;\n", j = j + "if((depth+shadowbias" + m + "-length(lightvec" + m + "))<0.0){\n", j += "spotmul+=length(spotoffset);\n", j += "}\n",
      j += "totalweight+=length(spotoffset);\n", j += "};\n", j += "}\n"), j += "if(totalweight>0.0) spotEffect=spotEffect*pow(1.0-spotmul/totalweight,3.0);\n", j += "}\n"), j += "dotN=max(dot(normal,normalize(-lightvec)),0.0);\n", f[m].negativeShadow ? (j += "if(dotN>0.0){\n", f[m].diffuse && (j = j + "lightvalue -= (1.0-spotEffect) / (lightAttenuation" + m + "[0] + lightAttenuation" + m + "[1] * lightdist" + m + " + lightAttenuation" + m + "[2] * lightdist" + m + " * lightdist" + m + ");\n"), j +=
      "}\n") : (j = j + "att = spotEffect / (lightAttenuation" + m + "[0] + lightdist" + m + "*(lightAttenuation" + m + "[1]  + lightAttenuation" + m + "[2] * lightdist" + m + "));\n", j += "if(dotN>0.0){\n", f[m].diffuse && (j = j + "lightvalue += att * dotN * lightcolor" + m + ";\n"), j += "}\n", f[m].specular && (j = j + "specvalue += smoothstep(-specularSmoothStepValue,specularSmoothStepValue,dotN) * att * specC * lightcolor" + m + " * spec  * pow(max(dot(reflect(normalize(lightvec), normal),normalize(viewvec)),0.0), 0.3 * sh);\n")),
      j += "}\n"), f[m].type == e.L_DIR)) {
        j += "dotN=max(dot(normal,-normalize(lightvec)),0.0);\n";
        if(f[m].getCastShadows() && this.shadow) {
          j = j + "float shadowfact" + m + " = 0.0;\n";
          j = j + "float level" + m + " = 1.0;\n";
          j = j + "scoord=((spotcoord" + m + ".xy)+1.0)/2.0;\n";
          p = f[m].getCascadeLevels();
          for(r = 1;r < p;r++) {
            j = j + "if(scoord.x<0.0 || scoord.x>1.0 || scoord.y<0.0 || scoord.y>1.0) {scoord=((spotcoord" + m + ".xy-shadowoffset" + m + ")*" + Math.pow(0.5, r).toFixed(5) + "+shadowoffset" + m + "+1.0)/2.0;level" + m + "=" + (r + 1).toFixed(2) + ";};\n"
          }
          j = j + "scoord.y=scoord.y/" + p.toFixed(2) + "+1.0-" + 1 / p + "*level" + m + ";\n";
          if(f[m].samples == 0) {
            j = j + "dist=texture2D(TEXTURE" + o[m] + ", scoord);\n", j = j + "depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0))*" + (+f[m].distance).toFixed(2) + ";\n", j = j + "sDepth = ((spotcoord" + m + ".z)/spotcoord" + m + ".w+1.0)/2.0;\n", j = j + "if(scoord.x>0.0 && scoord.x<1.0 && scoord.y>0.0 && scoord.y<1.0 && sDepth-shadowbias" + m + "-depth>0.0) {\n", j = j + "shadowfact" + m + "=pow(clamp(2.0*length(eyevec)/" + (+f[m].distance).toFixed(2) + ",0.0,1.0),2.0);\n",
            j = j + "}else{shadowfact" + m + "=1.0;}\n"
          }else {
            j += "rnd=(fract(sin(dot(scoord,vec2(12.9898,78.233))) * 43758.5453)-0.5)*2.0;\n";
            for(p = -f[m].samples;p <= f[m].samples;p++) {
              for(r = -f[m].samples;r <= f[m].samples;r++) {
                j = j + "dist=texture2D(TEXTURE" + o[m] + ", scoord+vec2(" + (p / f[m].bufferWidth).toFixed(4) + "," + (r / f[m].bufferHeight).toFixed(4) + ")*shadowsoftness" + m + "*100.0/level" + m + "+vec2(" + (1 / f[m].bufferWidth).toFixed(4) + "," + (1 / f[m].bufferHeight).toFixed(4) + ")*rnd);\n", j = j + "depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0))*" + (+f[m].distance).toFixed(2) + ";\n", j = j + "sDepth = ((spotcoord" + m + ".z)/spotcoord" + m + ".w+1.0)/2.0;\n",
                j = j + "if(scoord.x>0.0 && scoord.x<1.0 && scoord.y>0.0 && scoord.y<1.0 && sDepth-shadowbias" + m + "-depth>0.0) {\n", j = j + "shadowfact" + m + "+=pow(clamp(2.0*length(eyevec)/" + (+f[m].distance).toFixed(2) + ",0.0,1.0),2.0);\n", j = j + "}else{shadowfact" + m + "+=1.0;}\n"
              }
            }
            j = j + "shadowfact" + m + "/=" + ((f[m].samples * 2 + 1) * (f[m].samples * 2 + 1)).toFixed(1) + ";\n"
          }
        }else {
          j = j + "float shadowfact" + m + " = 1.0;\n"
        }
        f[m].diffuse && (j = j + "lightvalue += dotN * lightcolor" + m + " * shadowfact" + m + ";\n");
        f[m].specular && (j = j + "specvalue += smoothstep(-specularSmoothStepValue,specularSmoothStepValue,dotN) * specC * lightcolor" + m + " * spec  * pow(max(dot(reflect(normalize(lightvec), normal),normalize(viewvec)),0.0), 0.3 * sh);\n")
      }
    }
    j += "lightvalue = (lightvalue)*ref;\n";
    j += "vec3 fc=fogcolor.rgb;\n";
    j = j + "if(fogtype==" + e.FOG_SKYLINEAR + " || fogtype==" + e.FOG_SKYQUADRATIC + "){";
    j += "vec4 view=projection * vec4(-eyevec,1.0);\n";
    j += "vec2 fogCoords=view.xy/view.w*0.5+0.5;\n";
    j += "fc=texture2D(sky,fogCoords.xy).rgb;\n";
    j += "}\n";
    j += "gl_FragColor =vec4(specvalue.rgb+color.rgb*lightvalue.rgb+em.rgb,al)*fogfact+vec4(fc,al)*(1.0-fogfact);\n";
    j += "}\n";
    j += "}\n";
    return j
  };
  e.Material.prototype.textureUniforms = function(f, h, j, m) {
    this.animation && this.animate();
    var p = h.caches;
    if(p.baseColor != this.color) {
      if(this.ccache != this.color) {
        this.ccache = this.color, this.glColor = new Float32Array([this.color.r, this.color.g, this.color.b, this.color.a])
      }
      f.uniform4fv(e.getUniformLocation(f, h, "baseColor"), this.glColor);
      p.baseColor = this.color
    }
    if(p.specColor != this.specColor) {
      if(this.sccache != this.specColor) {
        this.sccache = this.specColor, this.glspecColor = new Float32Array([this.specColor.r, this.specColor.g, this.specColor.b])
      }
      f.uniform3fv(e.getUniformLocation(f, h, "specColor"), this.glspecColor);
      p.specColor = this.specColor
    }
    if(p.emit != this.emit) {
      f.uniform3f(e.getUniformLocation(f, h, "emit"), this.emit.r, this.emit.g, this.emit.b), p.emit = this.emit
    }
    if(p.specular != this.specular) {
      e.setUniform(f, "1f", e.getUniformLocation(f, h, "specular"), this.specular), p.specular = this.specular
    }
    if(p.shine != this.shine) {
      e.setUniform(f, "1f", e.getUniformLocation(f, h, "shine"), this.shine), p.shine = this.shine
    }
    if(p.reflect != this.reflect) {
      e.setUniform(f, "1f", e.getUniformLocation(f, h, "reflective"), this.reflect), p.reflect = this.reflect
    }
    if(p.alpha != this.alpha) {
      e.setUniform(f, "1f", e.getUniformLocation(f, h, "alpha"), this.alpha), p.alpha = this.alpha
    }
    if(p.shadeless == void 0 || p.shadeless != this.shadeless) {
      e.setUniform(f, "1i", e.getUniformLocation(f, h, "shadeless"), this.shadeless), p.shadeless = this.shadeless
    }
    f.scene.skyTexture && (f.activeTexture(f.TEXTURE0), f.bindTexture(f.TEXTURE_2D, f.scene.skyTexture), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_MAG_FILTER, f.LINEAR), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_MIN_FILTER, f.LINEAR), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_WRAP_S, f.CLAMP_TO_EDGE), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_WRAP_T, f.CLAMP_TO_EDGE), e.setUniform(f, "1i", e.getUniformLocation(f, h, "sky"), 0));
    var o = 1, r = 0;
    if(!p.lightcolor) {
      p.lightcolor = [], p.lightAttenuation = [], p.spotCosCutOff = [], p.spotExponent = [], p.shadowbias = [], p.castshadows = [], p.shadowsamples = [], p.shadowsoftness = []
    }
    for(var s = 0;s < j.length;s++) {
      if(j[s].type != e.L_OFF) {
        if(p.lightcolor[s] != j[s].color) {
          e.setUniform3(f, "3f", e.getUniformLocation(f, h, "lightcolor" + s), j[s].color.r, j[s].color.g, j[s].color.b), p.lightcolor[s] = j[s].color
        }
        if(p.lightAttenuation[s] != j[s].constantAttenuation) {
          e.setUniform3(f, "3f", e.getUniformLocation(f, h, "lightAttenuation" + s), j[s].constantAttenuation, j[s].linearAttenuation, j[s].quadraticAttenuation), p.lightAttenuation[s] = j[s].constantAttenuation
        }
        if(p.spotCosCutOff[s] != j[s].spotCosCutOff) {
          e.setUniform(f, "1f", e.getUniformLocation(f, h, "spotCosCutOff" + s), j[s].spotCosCutOff), p.spotCosCutOff[s] = j[s].spotCosCutOff
        }
        if(p.spotExponent[s] != j[s].spotExponent) {
          e.setUniform(f, "1f", e.getUniformLocation(f, h, "spotExp" + s), j[s].spotExponent), p.spotExponent[s] = j[s].spotExponent
        }
        if(p.shadowbias[s] != j[s].shadowBias) {
          e.setUniform(f, "1f", e.getUniformLocation(f, h, "shadowbias" + s), j[s].shadowBias), p.shadowbias[s] = j[s].shadowBias
        }
        if(p.shadowsoftness[s] != j[s].softness) {
          e.setUniform(f, "1f", e.getUniformLocation(f, h, "shadowsoftness" + s), j[s].softness), p.shadowsoftness[s] = j[s].softness
        }
        j[s].getCastShadows() && this.shadow && (r = this.textures.length + o++, f.activeTexture(f["TEXTURE" + r]), f.bindTexture(f.TEXTURE_2D, j[s].texture), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_MAG_FILTER, f.LINEAR), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_MIN_FILTER, f.LINEAR), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_WRAP_S, f.CLAMP_TO_EDGE), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_WRAP_T, f.CLAMP_TO_EDGE), e.setUniform(f, "1i", e.getUniformLocation(f, h, "TEXTURE" + r), r))
      }
    }
    if(!h.glarrays.layermat) {
      h.glarrays.layermat = []
    }
    for(s = 0;s < this.layers.length;s++) {
      this.layers[s].animation && this.layers[s].animate();
      this.layers[s].getScale();
      this.layers[s].getOffset();
      h.glarrays.layermat[s] ? e.mat4gl(this.layers[s].getMatrix(), h.glarrays.layermat[s]) : h.glarrays.layermat[s] = new Float32Array(this.layers[s].getMatrix());
      try {
        e.setUniformMatrix(f, "Matrix4fv", e.getUniformLocation(f, h, "layer" + s + "Matrix"), !0, h.glarrays.layermat[s])
      }catch(t) {
      }
      e.setUniform(f, "1f", e.getUniformLocation(f, h, "layeralpha" + s), this.layers[s].getAlpha());
      e.setUniform(f, "1f", e.getUniformLocation(f, h, "layerheight" + s), this.layers[s].getHeight())
    }
    for(s = 0;s < this.textures.length;s++) {
      f.activeTexture(f["TEXTURE" + (s + 1)]), this.textures[s].doTexture(f, m), e.setUniform(f, "1i", e.getUniformLocation(f, h, "TEXTURE" + s), s + 1)
    }
  };
  e.Material.prototype.isComplete = function() {
    for(var e = 0;e < this.textures.length;e++) {
      if(this.textures[e].isComplete && !this.textures[e].isComplete()) {
        return!1
      }
    }
    return!0
  };
  e.Material.prototype.addTexture = function(f) {
    typeof f == "string" && (f = e.Assets.get(f));
    var h = this;
    f.addEventListener("downloadComplete", function() {
      h.isComplete() && h.fireEvent("downloadComplete")
    });
    this.textures.push(f);
    f.idx = this.textures.length - 1;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Material.prototype.addTextureCube = e.Material.prototype.addTexture;
  e.Material.prototype.addTextureCamera = e.Material.prototype.addTexture;
  e.Material.prototype.addTextureCanvas = e.Material.prototype.addTexture;
  e.Material.prototype.addTextureVideo = e.Material.prototype.addTexture;
  e.DEFAULT_MATERIAL = new e.Material
})(GLGE);
(function(e) {
  e.Mesh = function(f, g) {
    e.Assets.registerAsset(this, f);
    this.GLbuffers = [];
    this.buffers = [];
    this.UV = [];
    this.boneWeights = [];
    this.setBuffers = [];
    this.faces = {};
    this.windingOrder = g !== void 0 ? g : e.Mesh.WINDING_ORDER_CLOCKWISE
  };
  e.Mesh.WINDING_ORDER_UNKNOWN = 2;
  e.Mesh.WINDING_ORDER_CLOCKWISE = 1;
  e.Mesh.WINDING_ORDER_COUNTER = 0;
  e.augment(e.QuickNotation, e.Mesh);
  e.augment(e.JSONLoader, e.Mesh);
  e.augment(e.Events, e.Mesh);
  e.Mesh.prototype.gl = null;
  e.Mesh.prototype.className = "Mesh";
  e.Mesh.prototype.GLbuffers = null;
  e.Mesh.prototype.buffers = null;
  e.Mesh.prototype.setBuffers = null;
  e.Mesh.prototype.GLfaces = null;
  e.Mesh.prototype.faces = null;
  e.Mesh.prototype.UV = null;
  e.Mesh.prototype.joints = null;
  e.Mesh.prototype.invBind = null;
  e.Mesh.prototype.loaded = !1;
  e.Mesh.prototype.getBoundingVolume = function() {
    if(!this.boundingVolume) {
      for(var f, g, h, j, m, p, o = 0;o < this.buffers.length;o++) {
        if(this.buffers[o].name == "position") {
          var r = this.buffers[o].data
        }
      }
      for(o = 0;o < r.length;o += 3) {
        o == 0 ? (f = g = r[o], h = j = r[o + 1], m = p = r[o + 2]) : (f = Math.min(f, r[o]), g = Math.max(g, r[o]), h = Math.min(h, r[o + 1]), j = Math.max(j, r[o + 1]), m = Math.min(m, r[o + 2]), p = Math.max(p, r[o + 2]))
      }
      this.boundingVolume = new e.BoundingVolume(f, g, h, j, m, p)
    }
    return this.boundingVolume
  };
  e.Mesh.prototype.setJoints = function(e) {
    this.joints = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Mesh.prototype.setInvBindMatrix = function(e) {
    this.invBind = e;
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Mesh.prototype.setVertexJoints = function(e, g) {
    g || (g = e.length * 3 / this.positions.length);
    if(g < 5) {
      this.setBuffer("joints1", e, g)
    }else {
      for(var h = [], j = [], m = 0;m < e.length;m++) {
        m % g < 4 ? h.push(e[m]) : j.push(e[m])
      }
      this.setBuffer("joints1", h, 4);
      this.setBuffer("joints2", j, g - 4)
    }
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Mesh.prototype.setVertexWeights = function(e, g) {
    g || (g = e.length * 3 / this.positions.length);
    for(var h = 0;h < e.length;h += parseInt(g)) {
      for(var j = 0, m = 0;m < g;m++) {
        j += parseFloat(e[h + m])
      }
      j == 0 && (j = 1);
      for(m = 0;m < g;m++) {
        e[h + m] /= j
      }
    }
    if(g < 4) {
      this.setBuffer("weights1", e, g)
    }else {
      j = [];
      m = [];
      for(h = 0;h < e.length;h++) {
        h % g < 4 ? j.push(e[h]) : m.push(e[h])
      }
      this.setBuffer("weights1", j, 4);
      this.setBuffer("weights2", m, g - 4)
    }
    this.fireEvent("shaderupdate", {});
    return this
  };
  e.Mesh.prototype.clearBuffers = function() {
    this.GLFaces = null;
    delete this.GLFaces;
    for(i in this.buffers) {
      this.buffers[i] = null, delete this.buffers[i]
    }
    this.buffers = [];
    this.loaded = !1
  };
  e.Mesh.prototype.setUV = function(e) {
    for(var g = 0, h = 0;h < e.length;h += 2) {
      this.UV[g] = e[h], this.UV[g + 1] = e[h + 1], this.UV[g + 2] || (this.UV[g + 2] = e[h]), this.UV[g + 3] || (this.UV[g + 3] = e[h + 1]), g += 4
    }
    this.setBuffer("UV", this.UV, 4);
    return this
  };
  e.Mesh.prototype.setUV2 = function(e) {
    for(var g = 0, h = 0;h < e.length;h += 2) {
      this.UV[g] || (this.UV[g] = e[h]), this.UV[g + 1] || (this.UV[g + 1] = e[h + 1]), this.UV[g + 2] = e[h], this.UV[g + 3] = e[h + 1], g += 4
    }
    this.setBuffer("UV", this.UV, 4);
    return this
  };
  e.Mesh.prototype.setPositions = function(e) {
    this.loaded = !0;
    this.positions = e;
    this.setBuffer("position", e, 3);
    return this
  };
  e.Mesh.prototype.setVertexColors = function(e) {
    this.colors = e;
    this.setBuffer("color", e, 4);
    return this
  };
  e.Mesh.prototype.setNormals = function(e) {
    this.normals = e;
    this.setBuffer("normal", e, 3);
    return this
  };
  e.Mesh.prototype.setBuffer = function(e, g, h) {
    for(var j = 0;j < g.length;j++) {
      g[j] = parseFloat(g[j])
    }
    for(var m, j = 0;j < this.buffers.length;j++) {
      this.buffers[j].name == e && (m = j)
    }
    m ? this.buffers[m] = {name:e, data:g, size:h, GL:!1} : this.buffers.push({name:e, data:g, size:h, GL:!1});
    return this
  };
  e.Mesh.prototype.tangentFromUV = function(f, g, h, j, m, p, o) {
    var r = e.subVec3, s = e.scaleVec3;
    uv21 = [m[0] - j[0], m[1] - j[1]];
    uv31 = [p[0] - j[0], p[1] - j[1]];
    p21 = e.subVec3(g, f);
    p31 = e.subVec3(h, f);
    g = uv21[0] * uv31[1] - uv31[0] * uv21[1];
    g != 0 ? (g = 1 / g, f = r(s(p21, uv31[1] * g), s(p31, uv21[1] * g)), r = r(s(p31, uv21[0] * g), s(p21, uv31[0] * g))) : (f = [0, 0, 0], r = [0, 0, 0]);
    e.dotVec3(e.crossVec3(p21, p31), o) > 0 && (f = s(f, -1), r = s(r, -1));
    return[f, r]
  };
  e.Mesh.prototype.setFaces = function(f) {
    this.faces = {data:f, GL:!1};
    this.normals || this.calcNormals();
    for(f = 0;f < this.buffers.length;f++) {
      if(this.buffers[f].name == "position") {
        var g = this.buffers[f].data
      }
      if(this.buffers[f].name == "UV") {
        var h = this.buffers[f].data
      }
      if(this.buffers[f].name == "normal") {
        var j = this.buffers[f].data
      }
    }
    if(g && h) {
      for(var m = [], p = {}, f = 0;f < g.length;f++) {
        m[f] = 0
      }
      for(f = 0;f < this.faces.data.length;f += 3) {
        var o = [g[parseInt(this.faces.data[f]) * 3], g[parseInt(this.faces.data[f]) * 3 + 1], g[parseInt(this.faces.data[f]) * 3 + 2]], r = [g[parseInt(this.faces.data[f + 1]) * 3], g[parseInt(this.faces.data[f + 1]) * 3 + 1], g[parseInt(this.faces.data[f + 1]) * 3 + 2]], s = [g[parseInt(this.faces.data[f + 2]) * 3], g[parseInt(this.faces.data[f + 2]) * 3 + 1], g[parseInt(this.faces.data[f + 2]) * 3 + 2]], t = [j[parseInt(this.faces.data[f]) * 3], j[parseInt(this.faces.data[f]) * 3 + 1], j[parseInt(this.faces.data[f]) *
        3 + 2]], q = [j[parseInt(this.faces.data[f + 1]) * 3], j[parseInt(this.faces.data[f + 1]) * 3 + 1], j[parseInt(this.faces.data[f + 1]) * 3 + 2]], u = [j[parseInt(this.faces.data[f + 2]) * 3], j[parseInt(this.faces.data[f + 2]) * 3 + 1], j[parseInt(this.faces.data[f + 2]) * 3 + 2]], v = [h[parseInt(this.faces.data[f]) * 4], h[parseInt(this.faces.data[f]) * 4 + 1]], w = [h[parseInt(this.faces.data[f + 1]) * 4], h[parseInt(this.faces.data[f + 1]) * 4 + 1]], B = [h[parseInt(this.faces.data[f +
        2]) * 4], h[parseInt(this.faces.data[f + 2]) * 4 + 1]], A = this.tangentFromUV(r, o, s, w, v, B, q);
        p[[o[0], o[1], o[2], v[0], v[1], t[0], t[1], t[2]].join(",")] ? (p[[o[0], o[1], o[2], v[0], v[1], t[0], t[1], t[2]].join(",")][0][0] += A[0][0], p[[o[0], o[1], o[2], v[0], v[1], t[0], t[1], t[2]].join(",")][0][1] += A[0][1], p[[o[0], o[1], o[2], v[0], v[1], t[0], t[1], t[2]].join(",")][0][2] += A[0][2], p[[o[0], o[1], o[2], v[0], v[1], t[0], t[1], t[2]].join(",")][1][0] += A[1][0], p[[o[0], o[1], o[2], v[0], v[1], t[0], t[1], t[2]].join(",")][1][1] += A[1][1], p[[o[0], o[1], o[2], v[0], v[1],
        t[0], t[1], t[2]].join(",")][1][2] += A[1][2]) : p[[o[0], o[1], o[2], v[0], v[1], t[0], t[1], t[2]].join(",")] = A;
        p[[r[0], r[1], r[2], w[0], w[1], q[0], q[1], q[2]].join(",")] ? (p[[r[0], r[1], r[2], w[0], w[1], q[0], q[1], q[2]].join(",")][0][0] += A[0][0], p[[r[0], r[1], r[2], w[0], w[1], q[0], q[1], q[2]].join(",")][0][1] += A[0][1], p[[r[0], r[1], r[2], w[0], w[1], q[0], q[1], q[2]].join(",")][0][2] += A[0][2], p[[r[0], r[1], r[2], w[0], w[1], q[0], q[1], q[2]].join(",")][1][0] += A[1][0], p[[r[0], r[1], r[2], w[0], w[1], q[0], q[1], q[2]].join(",")][1][1] += A[1][1], p[[r[0], r[1], r[2], w[0], w[1],
        q[0], q[1], q[2]].join(",")][1][2] += A[1][2]) : p[[r[0], r[1], r[2], w[0], w[1], q[0], q[1], q[2]].join(",")] = A;
        p[[s[0], s[1], s[2], B[0], B[1], u[0], u[1], u[2]].join(",")] ? (p[[s[0], s[1], s[2], B[0], B[1], u[0], u[1], u[2]].join(",")][0][0] += A[0][0], p[[s[0], s[1], s[2], B[0], B[1], u[0], u[1], u[2]].join(",")][0][1] += A[0][1], p[[s[0], s[1], s[2], B[0], B[1], u[0], u[1], u[2]].join(",")][0][2] += A[0][2], p[[s[0], s[1], s[2], B[0], B[1], u[0], u[1], u[2]].join(",")][1][0] += A[1][0], p[[s[0], s[1], s[2], B[0], B[1], u[0], u[1], u[2]].join(",")][1][1] += A[1][1], p[[s[0], s[1], s[2], B[0], B[1],
        u[0], u[1], u[2]].join(",")][1][2] += A[1][2]) : p[[s[0], s[1], s[2], B[0], B[1], u[0], u[1], u[2]].join(",")] = A
      }
      for(f = 0;f < g.length / 3;f++) {
        o = [g[f * 3], g[f * 3 + 1], g[f * 3 + 2]], t = [j[f * 3], j[f * 3 + 1], j[f * 3 + 2]], v = [h[f * 4], h[f * 4 + 1]], r = e.toUnitVec3(p[[o[0], o[1], o[2], v[0], v[1], t[0], t[1], t[2]].join(",")][0]), e.toUnitVec3(p[[o[0], o[1], o[2], v[0], v[1], t[0], t[1], t[2]].join(",")][1]), r && (m[f * 3] = r[0], m[f * 3 + 1] = r[1], m[f * 3 + 2] = r[2])
      }
      this.setBuffer("tangent", m, 3)
    }
    return this
  };
  e.Mesh.prototype.GLSetFaceBuffer = function(e) {
    if(!this.GLfaces) {
      this.GLfaces = e.createBuffer()
    }
    e.bindBuffer(e.ELEMENT_ARRAY_BUFFER, this.GLfaces);
    e.bufferData(e.ELEMENT_ARRAY_BUFFER, new Uint16Array(this.faces.data), e.STATIC_DRAW);
    this.GLfaces.itemSize = 1;
    this.GLfaces.numItems = this.faces.data.length
  };
  e.Mesh.prototype.GLSetBuffer = function(e, g, h, j) {
    this.GLbuffers[g] || (this.GLbuffers[g] = e.createBuffer());
    e.bindBuffer(e.ARRAY_BUFFER, this.GLbuffers[g]);
    e.bufferData(e.ARRAY_BUFFER, new Float32Array(h), e.STATIC_DRAW);
    this.GLbuffers[g].itemSize = j;
    this.GLbuffers[g].numItems = h.length / j
  };
  e.Mesh.prototype.calcNormals = function() {
    var f = [], g = this.positions, h = this.faces.data;
    if(!h) {
      for(var h = [], j = 0;j < g.length / 3;j++) {
        h[j] = j
      }
    }
    for(j = 0;j < h.length;j += 3) {
      var m = [g[h[j] * 3], g[h[j] * 3 + 1], g[h[j] * 3 + 2]], p = [g[h[j + 2] * 3], g[h[j + 2] * 3 + 1], g[h[j + 2] * 3 + 2]], o = e.subVec3([g[h[j + 1] * 3], g[h[j + 1] * 3 + 1], g[h[j + 1] * 3 + 2]], m), m = e.subVec3(p, m), o = e.toUnitVec3(e.crossVec3(o, m));
      f[h[j]] == void 0 && (f[h[j]] = []);
      f[h[j]].push(o);
      f[h[j + 1]] == void 0 && (f[h[j + 1]] = []);
      f[h[j + 1]].push(o);
      f[h[j + 2]] == void 0 && (f[h[j + 2]] = []);
      f[h[j + 2]].push(o)
    }
    g = [];
    for(j = 0;j < f.length;j++) {
      if(m = o = h = 0, f[j] != void 0) {
        for(p = 0;p < f[j].length;p++) {
          h += f[j][p][0], o += f[j][p][1], m += f[j][p][2]
        }
        h /= f[j].length;
        o /= f[j].length;
        m /= f[j].length;
        g[j * 3] = h;
        g[j * 3 + 1] = o;
        g[j * 3 + 2] = m
      }
    }
    this.setNormals(g)
  };
  e.Mesh.prototype.GLAttributes = function(f, g) {
    this.gl = f;
    this.normals || this.calcNormals();
    for(var h = 0;h < 8;h++) {
      f.disableVertexAttribArray(h)
    }
    if(!this.faces.GL && this.faces.data && this.faces.data.length > 0) {
      this.GLSetFaceBuffer(f), this.faces.GL = !0
    }
    for(h = 0;h < this.buffers.length;h++) {
      if(!this.buffers[h].GL) {
        this.GLSetBuffer(f, this.buffers[h].name, this.buffers[h].data, this.buffers[h].size), this.buffers[h].GL = !0
      }
      attribslot = e.getAttribLocation(f, g, this.buffers[h].name);
      attribslot > -1 && (f.bindBuffer(f.ARRAY_BUFFER, this.GLbuffers[this.buffers[h].name]), f.enableVertexAttribArray(attribslot), f.vertexAttribPointer(attribslot, this.GLbuffers[this.buffers[h].name].itemSize, f.FLOAT, !1, 0, 0))
    }
  }
})(GLGE);
(function(e) {
  e.AnimationVector = function(f) {
    e.Assets.registerAsset(this, f);
    this.curves = {}
  };
  e.augment(e.QuickNotation, e.AnimationVector);
  e.augment(e.JSONLoader, e.AnimationVector);
  e.AnimationVector.prototype.curves = {};
  e.AnimationVector.prototype.frames = 250;
  e.AnimationVector.prototype.startFrame = 0;
  e.AnimationVector.prototype.addAnimationCurve = function(e) {
    this.curves[e.channel] = e;
    return this
  };
  e.AnimationVector.prototype.removeAnimationCurve = function(e) {
    delete this.curves[e]
  };
  e.AnimationVector.prototype.setFrames = function(e) {
    this.frames = e;
    return this
  };
  e.AnimationVector.prototype.getFrames = function() {
    return this.frames
  };
  e.AnimationVector.prototype.setStartFrame = function(e) {
    this.startFrame = e;
    return this
  };
  e.AnimationVector.prototype.getStartFrame = function() {
    return this.startFrame
  }
})(GLGE);
(function(e) {
  e.BezTriple = function(f) {
    e.Assets.registerAsset(this, f)
  };
  e.augment(e.QuickNotation, e.BezTriple);
  e.augment(e.JSONLoader, e.BezTriple);
  e.BezTriple.prototype.className = "BezTriple";
  e.BezTriple.prototype.setX1 = function(e) {
    this.x1 = parseFloat(e);
    return this
  };
  e.BezTriple.prototype.setY1 = function(e) {
    this.y1 = parseFloat(e);
    return this
  };
  e.BezTriple.prototype.setX2 = function(e) {
    this.x = parseFloat(e);
    return this
  };
  e.BezTriple.prototype.setY2 = function(e) {
    this.y = parseFloat(e);
    return this
  };
  e.BezTriple.prototype.setX3 = function(e) {
    this.x3 = parseFloat(e);
    return this
  };
  e.BezTriple.prototype.setY3 = function(e) {
    this.y3 = parseFloat(e);
    return this
  };
  e.LinearPoint = function() {
  };
  e.augment(e.QuickNotation, e.LinearPoint);
  e.augment(e.JSONLoader, e.LinearPoint);
  e.LinearPoint.prototype.className = "LinearPoint";
  e.LinearPoint.prototype.x = 0;
  e.LinearPoint.prototype.y = 0;
  e.LinearPoint.prototype.setX = function(e) {
    this.x = parseFloat(e);
    return this
  };
  e.LinearPoint.prototype.setY = function(e) {
    this.y = parseFloat(e);
    return this
  };
  e.StepPoint = function(e, g) {
    this.x = parseFloat(e);
    this.y = g
  }
})(GLGE);
(function(e) {
  e.AnimationCurve = function(f) {
    e.Assets.registerAsset(this, f);
    this.keyFrames = [];
    this.solutions = {};
    this.caches = {}
  };
  e.augment(e.QuickNotation, e.AnimationCurve);
  e.augment(e.JSONLoader, e.AnimationCurve);
  e.AnimationCurve.prototype.className = "AnimationCurve";
  e.AnimationCurve.prototype.keyFrames = null;
  e.AnimationCurve.prototype.addPoint = function(e) {
    this.keyFrames.push(e);
    return this.keyFrames.length - 1
  };
  e.AnimationCurve.prototype.addStepPoint = e.AnimationCurve.prototype.addPoint;
  e.AnimationCurve.prototype.addLinearPoint = e.AnimationCurve.prototype.addPoint;
  e.AnimationCurve.prototype.addBezTriple = e.AnimationCurve.prototype.addPoint;
  e.AnimationCurve.prototype.coord = function(e, g) {
    return{x:e, y:g}
  };
  e.AnimationCurve.prototype.setChannel = function(e) {
    this.channel = e
  };
  e.AnimationCurve.prototype.getValue = function(f, g, h) {
    if(this.keyFrames.length == 0) {
      return 0
    }
    if(this.caches[f]) {
      return this.caches[f]
    }
    var j, m, p, o;
    f < this.keyFrames[0].x && (f = 0);
    for(var r = 0;r < this.keyFrames.length;r++) {
      if(this.keyFrames[r].x <= f && (j == void 0 || this.keyFrames[r].x > this.keyFrames[j].x)) {
        p = j, j = r
      }else {
        if(this.keyFrames[r].x <= f && (p == void 0 || this.keyFrames[r].x > this.keyFrames[p].x)) {
          p = r
        }
      }
      if(this.keyFrames[r].x > f && (m == void 0 || this.keyFrames[r].x <= this.keyFrames[m].x)) {
        o = m, m = r
      }else {
        if(this.keyFrames[r].x > f && (o == void 0 || this.keyFrames[r].x <= this.keyFrames[o].x)) {
          o = r
        }
      }
    }
    o == void 0 && (m == void 0 && (m = j), o = m);
    j == void 0 && (j = m, m = o);
    p == void 0 && (p = j);
    m == void 0 && (m = j, j = p);
    if(this.keyFrames[j] instanceof e.BezTriple && this.keyFrames[m] instanceof e.BezTriple) {
      return g = this.coord(this.keyFrames[j].x, this.keyFrames[j].y), h = this.coord(this.keyFrames[j].x3, this.keyFrames[j].y3), j = this.coord(this.keyFrames[m].x1, this.keyFrames[m].y1), m = this.coord(this.keyFrames[m].x, this.keyFrames[m].y), this.atX(f, g, h, j, m).y
    }
    if(this.keyFrames[j] instanceof e.LinearPoint && this.keyFrames[m] instanceof e.BezTriple) {
      return g = this.coord(this.keyFrames[j].x, this.keyFrames[j].y), h = this.coord(this.keyFrames[m].x1, this.keyFrames[m].y1), j = this.coord(this.keyFrames[m].x1, this.keyFrames[m].y1), m = this.coord(this.keyFrames[m].x, this.keyFrames[m].y), this.atX(f, g, h, j, m).y
    }
    if(this.keyFrames[j] instanceof e.BezTriple && this.keyFrames[m] instanceof e.LinearPoint) {
      return g = this.coord(this.keyFrames[j].x, this.keyFrames[j].y), h = this.coord(this.keyFrames[j].x3, this.keyFrames[j].y3), j = this.coord(this.keyFrames[j].x3, this.keyFrames[j].y3), m = this.coord(this.keyFrames[m].x, this.keyFrames[m].y), this.atX(f, g, h, j, m).y
    }
    if(this.keyFrames[j] instanceof e.LinearPoint && this.keyFrames[m] instanceof e.LinearPoint) {
      p = this.keyFrames[m].y;
      o = this.keyFrames[j].y;
      if(h) {
        if(!g) {
          g = this.keyFrames[1 % this.keyFrames.length].y
        }
        h = function(e, f, g) {
          if(Math.abs(e + g - f) < Math.abs(e - f)) {
            return e + g
          }
          if(Math.abs(e - g - f) < Math.abs(e - f)) {
            return e - g
          }
          return e
        };
        p = h(p, g, 360);
        p = h(p, g, 180);
        o = h(o, g, 360);
        o = h(o, g, 180)
      }
      m = this.keyFrames[m].x - this.keyFrames[j].x;
      m == 0 && (m = 1);
      return(f - this.keyFrames[j].x) * (p - o) / m + o
    }
    if(this.keyFrames[j] instanceof e.StepPoint) {
      return this.keyFrames[j].y
    }
    if(!this.keyFrames.preStartKey) {
      this.keyFrames.preStartKey = this.keyFrames[0].y
    }
    this.caches[f] = this.keyFrames.preStartKey;
    return this.caches[f]
  };
  e.AnimationCurve.prototype.B1 = function(e) {
    return e * e * e
  };
  e.AnimationCurve.prototype.B2 = function(e) {
    return 3 * e * e * (1 - e)
  };
  e.AnimationCurve.prototype.B3 = function(e) {
    return 3 * e * (1 - e) * (1 - e)
  };
  e.AnimationCurve.prototype.B4 = function(e) {
    return(1 - e) * (1 - e) * (1 - e)
  };
  e.AnimationCurve.prototype.getBezier = function(e, g, h, j, m) {
    var p = {};
    p.x = g.x * this.B1(e) + h.x * this.B2(e) + j.x * this.B3(e) + m.x * this.B4(e);
    p.y = g.y * this.B1(e) + h.y * this.B2(e) + j.y * this.B3(e) + m.y * this.B4(e);
    return p
  };
  e.AnimationCurve.prototype.Quad3Solve = function(e, g, h, j) {
    ref = e + "-" + g + "--" + h + "-" + j;
    return this.solutions[ref] ? this.solutions[ref] : (g /= e, h /= e, j /= e, e = (3 * h - g * g) / 9, h = -(27 * j) + g * (9 * h - 2 * g * g), h /= 54, g /= 3, discrim = e * e * e + h * h, result = [], discrim > 0 ? (e = h + Math.sqrt(discrim), e = e < 0 ? -Math.pow(-e, 1 / 3) : Math.pow(e, 1 / 3), h -= Math.sqrt(discrim), h = h < 0 ? -Math.pow(-h, 1 / 3) : Math.pow(h, 1 / 3), result[0] = -g + e + h, g += (e + h) / 2, result[1] = result[2] = -g) : discrim == 0 ? (e = h < 0 ? -Math.pow(-h, 1 /
    3) : Math.pow(h, 1 / 3), result[1] = -g + 2 * e, result[1] = result[2] = -(e + g)) : (h = Math.acos(h / Math.sqrt(1)), e = 2 * Math.sqrt(-e), result[0] = -g + e * Math.cos(h / 3), result[1] = -g + e * Math.cos((h + 2 * Math.PI) / 3), result[2] = -g + e * Math.cos((h + 4 * Math.PI) / 3)), e = !1, result[0] >= 0 && result[0] <= 1 && (e = result[0]), !e && result[1] >= 0 && result[1] <= 1 && (e = result[1]), !e && result[2] >= 0 && result[2] <= 1 && (e = result[2]), this.solutions[ref] = e)
  };
  e.AnimationCurve.prototype.atX = function(e, g, h, j, m) {
    a = g.x - h.x * 3 + j.x * 3 - m.x;
    b = h.x * 3 - j.x * 6 + m.x * 3;
    c = j.x * 3 - m.x * 3;
    d = m.x - e;
    return this.getBezier(this.Quad3Solve(a, b, c, d), g, h, j, m)
  }
})(GLGE);
(function(e) {
  e.Action = function(f) {
    e.Assets.registerAsset(this, f);
    this.channels = []
  };
  e.augment(e.QuickNotation, e.Action);
  e.augment(e.JSONLoader, e.Action);
  e.augment(e.Events, e.Action);
  e.Action.prototype.start = function(e, g, h) {
    g || (g = !1);
    e || (e = 0);
    var j = this.channels, m = (new Date).getTime();
    this.animFinished = !1;
    for(var p = 0;p < j.length;p++) {
      var o = j[p].getAnimation(), r = this, s = j[p].getTarget();
      typeof s == "string" && h && h[s] && (s = h[s]);
      var t = {};
      t.finishEvent = function() {
        s.removeEventListener("animFinished", t.finishEvent);
        if(!r.animFinished && s.animation == o) {
          r.fireEvent("animFinished", {}), r.animFinished = !0
        }
      };
      s.addEventListener("animFinished", t.finishEvent);
      s.setAnimation(o, e, m);
      s.setLoop(g)
    }
  };
  e.Action.prototype.setStartFrame = function(e) {
    for(var g = 0;g < this.channels.length;g++) {
      this.channels[g].getAnimation().setStartFrame(e)
    }
    return this
  };
  e.Action.prototype.setFrames = function(e) {
    for(var g = 0;g < this.channels.length;g++) {
      this.channels[g].getAnimation().setFrames(e)
    }
    return this
  };
  e.Action.prototype.addActionChannel = function(e) {
    this.channels.push(e);
    return this
  };
  e.Action.prototype.removeActionChannel = function() {
    for(var e = 0;e < this.channels.length;e++) {
      if(this.channels[e] == channels) {
        this.channels.splice(e, 1);
        break
      }
    }
  }
})(GLGE);
(function(e) {
  e.ActionChannel = function(f) {
    e.Assets.registerAsset(this, f)
  };
  e.augment(e.QuickNotation, e.ActionChannel);
  e.augment(e.JSONLoader, e.ActionChannel);
  e.ActionChannel.prototype.setTarget = function(e) {
    this.target = e
  };
  e.ActionChannel.prototype.setAnimation = function(e) {
    this.animation = e
  };
  e.ActionChannel.prototype.getTarget = function() {
    return this.target
  };
  e.ActionChannel.prototype.getAnimation = function() {
    return this.animation
  }
})(GLGE);
var XML = {};
(function(e) {
  e.TextNode = function(e) {
    this.nodeValue = e
  };
  e.Element = function(e) {
    this.tagName = e;
    this.children = [];
    this.attributes = {}
  };
  e.Element.prototype.children = null;
  e.Element.prototype.attributes = null;
  e.Element.prototype.addChild = function(e) {
    e.parentNode = this;
    this.children.length == 0 ? (this.hasChildren = !0, this.firstChild = e) : (this.children[this.children.length - 1].nextSibling = e, e.previousSibling = this.children[this.children.length - 1]);
    this.children.push(e)
  };
  e.Element.prototype.setAttributes = function(e) {
    this.attributes = e
  };
  e.Element.prototype.getAttribute = function(e) {
    return this.attributes[e]
  };
  e.Element.prototype.hasAttribute = function(e) {
    return this.attributes[e] ? !0 : !1
  };
  e.Element.prototype.getElementsByTagName = function(e) {
    for(var g = [], h = 0;h < this.children.length;h++) {
      (this.children[h].tagName == e || e == "*") && this.children[h].tagName && g.push(this.children[h]), this.children[h].hasChildren && (g = g.concat(this.children[h].getElementsByTagName(e)))
    }
    return g
  };
  e.Document = function(e) {
    this.rootElement = this.currentElement = null;
    this.eleStack = [];
    this.idCache = {};
    this.xml = e;
    this.sPointer = 0;
    this.parseXML()
  };
  e.Document.prototype.parseXML = function() {
    var f = this.xml, g = "", h = !1;
    do {
      f[this.sPointer] == "<" && !h ? (g != "" && this.currentElement && this.currentElement.addChild(new e.TextNode(g)), g = "", f[this.sPointer + 1] == "!" ? f[this.sPointer + 2] == "[" && f[this.sPointer + 3] == "C" && f[this.sPointer + 4] == "D" && f[this.sPointer + 5] == "A" && f[this.sPointer + 6] == "T" && f[this.sPointer + 7] == "A" && f[this.sPointer + 8] == "[" ? (h = !0, this.sPointer += 8) : (this.closeElement(), this.sPointer++) : f[this.sPointer + 1] == "?" ? (this.closeElement(), this.sPointer++) :
      f[this.sPointer + 1] != "/" ? (newElement = this.parseElement(), f[this.sPointer] == ">" ? (this.eleStack.push(this.currentElement), this.currentElement = newElement) : (this.currentElement.addChild(newElement), this.sPointer++)) : ((parentElement = this.eleStack.pop()) ? (parentElement.addChild(this.currentElement), this.currentElement = parentElement) : this.rootElement = this.currentElement, this.closeElement())) : h && f[this.sPointer] == "]" && f[this.sPointer + 1] == "]" && f[this.sPointer +
      2] == ">" ? (this.currentElement.addChild(new e.TextNode(g)), g = "", this.sPointer += 2, h = !1) : (g += f[this.sPointer], g.length == 32768 && (this.currentElement.addChild(new e.TextNode(g)), g = "")), this.sPointer++
    }while(this.sPointer < f.length)
  };
  e.Document.prototype.closeElement = function() {
    var e = this.xml;
    do {
      this.sPointer++
    }while(e[this.sPointer] != ">" && this.sPointer < e.length)
  };
  e.Document.prototype.parseElement = function() {
    var f = this.xml, g = "";
    this.sPointer++;
    do {
      if(f[this.sPointer] == " ") {
        var h = this.parseAttributes()
      }else {
        g += f[this.sPointer], this.sPointer++
      }
    }while(f[this.sPointer] != "/" && f[this.sPointer] != ">" && this.sPointer < f.length);
    f = new e.Element(g);
    h && (f.setAttributes(h), h.id && (this.idCache[h.id] = f));
    return f
  };
  e.Document.prototype.parseAttributes = function() {
    var e = this.xml, g = {};
    do {
      var h = "";
      do {
        e[this.sPointer] != " " && (h += e[this.sPointer]), this.sPointer++
      }while(e[this.sPointer] != "=" && this.sPointer < e.length);
      var j = e[++this.sPointer], m = "";
      this.sPointer++;
      do {
        m += e[this.sPointer], this.sPointer++
      }while(e[this.sPointer] != j && this.sPointer < e.length);
      h != "" && (g[h] = m);
      this.sPointer++
    }while(e[this.sPointer] != "/" && e[this.sPointer] != ">" && this.sPointer < e.length);
    return g
  };
  e.Document.prototype.getElementsByTagName = function(e) {
    return this.rootElement.getElementsByTagName(e)
  };
  e.Document.prototype.getElementById = function(e) {
    return this.idCache[e] ? this.idCache[e] : !1
  }
})(XML);
(function(e) {
  e.Wavefront = function(f) {
    e.Assets.registerAsset(this, f);
    this.multimaterials = [];
    this.materials = {};
    this.instances = [];
    this.queue = [];
    e.Object.call(this, f)
  };
  e.augment(e.Object, e.Wavefront);
  e.Wavefront.prototype.getAbsolutePath = function(e, g) {
    if(e.substr(0, 7) == "http://" || e.substr(0, 7) == "file://" || e.substr(0, 7) == "https://") {
      return e
    }else {
      if(!g) {
        g = window.location.href
      }
      g.indexOf("?") > 0 && (g = g.substr(0, g.indexOf("?")));
      for(var h = g.split("/"), j = h[2], m = h[0], p = [], o = 3;o < h.length - 1;o++) {
        p.push(h[o])
      }
      e.substr(0, 1) == "/" && (p = []);
      h = e.split("/");
      for(o = 0;o < h.length;o++) {
        h[o] == ".." ? p.pop() : h[o] != "" && p.push(h[o])
      }
      return m + "//" + j + "/" + p.join("/")
    }
  };
  e.Wavefront.prototype.loadMaterials = function(e) {
    this.loading ? this.queue.push(e) : this.loadFile(e, null, function(e, f) {
      this.parseMaterials(f.split("\n"));
      this.queue.length > 0 ? this.loadMaterials(this.queue.pop(), this.src) : (this.parseMesh(), this.fireEvent("loaded", {}))
    })
  };
  e.Wavefront.prototype.parseMaterials = function(f) {
    for(var g = 0;g < f.length;g++) {
      if(f[g].substr(0, 6) == "newmtl") {
        var h = f[g].replace(/^\s+|\s+$/g, "").replace(/\s+/g, " ").split(" "), j = new e.Material;
        this.materials[h[1].replace(/\s+$/, "").replace("\r", "").replace("\t", "")] = j;
        g++
      }
      h = f[g].replace(/^\s+|\s+$/g, "").replace(/\s+/g, " ").split(" ");
      if(h.length > 1) {
        switch(h[0]) {
          case "Kd":
            j.setColorR(parseFloat(h[1]));
            j.setColorG(parseFloat(h[2]));
            j.setColorB(parseFloat(h[3]));
            break;
          case "Ks":
            j.setSpecularColor({r:parseFloat(h[1]), g:parseFloat(h[2]), b:parseFloat(h[3])});
            break;
          case "Ns":
            j.setShininess(parseFloat(h[1]));
            break;
          case "d":
            this.setZtransparent(!0);
            j.setAlpha(parseFloat(h[1]));
            break;
          case "map_Kd":
            var m = new e.MaterialLayer;
            m.setMapto(e.M_COLOR);
            m.setMapinput(e.UV1);
            for(var p = new e.Texture, o = 1;h[o][0] == "-";) {
              o += 2
            }
            p.setSrc(this.getAbsolutePath(h[o], this.relativeTo));
            j.addTexture(p);
            m.setTexture(p);
            j.addMaterialLayer(m);
          case "map_Ks":
          ;
          case "map_spec":
            m = new e.MaterialLayer;
            m.setMapto(e.M_SPECULAR);
            m.setMapinput(e.UV1);
            p = new e.Texture;
            for(o = 1;h[o][0] == "-";) {
              o += 2
            }
            p.setSrc(this.getAbsolutePath(h[o], this.relativeTo));
            j.addTexture(p);
            m.setTexture(p);
            j.addMaterialLayer(m);
          case "bump":
          ;
          case "map_bump":
            m = new e.MaterialLayer;
            m.setMapto(e.M_NOR);
            m.setMapinput(e.UV1);
            p = new e.Texture;
            for(o = 1;h[o][0] == "-";) {
              o += 2
            }
            p.setSrc(this.getAbsolutePath(h[o], this.relativeTo));
            j.addTexture(p);
            m.setTexture(p);
            j.addMaterialLayer(m)
        }
      }
    }
  };
  e.Wavefront.prototype.loadFile = function(f, g, h) {
    this.loading = !0;
    if(!h) {
      h = this.loaded
    }
    if(!g && this.relativeTo) {
      g = this.relativeTo
    }
    f = this.getAbsolutePath(f, g);
    if(!this.relativeTo) {
      this.relativeTo = f
    }
    var g = new e.XMLHttpRequest, j = this;
    if(g) {
      g.overrideMimeType("text/plain"), g.onreadystatechange = function() {
        if(this.readyState == 4) {
          this.status == 200 || this.status == 0 ? (j.loading = !1, h.call(j, f, this.responseText)) : e.error("Error loading Document: " + f + " status " + this.status)
        }
      }, g.open("GET", f, !0), g.send("")
    }
  };
  e.Wavefront.prototype.setSrc = function(e, g) {
    this.src = this.getAbsolutePath(e, g);
    this.loadFile(this.src, g)
  };
  e.Wavefront.prototype.loaded = function(e, g) {
    this.file = objArray = g.split("\n");
    for(var h = !1, j = 0;j < objArray.length;j++) {
      var m = objArray[j].split(" ");
      m.length > 1 && m[0] == "mtllib" && (h = !0, this.loadMaterials(m[1]))
    }
    h || (this.parseMesh(), this.fireEvent("loaded", {}))
  };
  e.Wavefront.prototype.createMultiMaterial = function(f, g, h, j, m, p, o) {
    var r = [], s = [], t = [], q = [], u = [];
    for(i = 0;i < m.length;i++) {
      var v = f[m[i]];
      u.indexOf(v) == -1 || !o ? (u.push(v), q.push(u.length - 1)) : q.push(u.indexOf(v))
    }
    m = q;
    for(i = 0;i < u.length;i++) {
      f = u[i].indexOf("/") > 0 ? u[i].split("/") : [u[i]], g[f[0] - 1] || e.error(f[0]), r.push(g[f[0] - 1][1]), r.push(g[f[0] - 1][2]), r.push(g[f[0] - 1][3]), f[1] && (t.push(j[f[1] - 1][1]), t.push(j[f[1] - 1][2])), f[2] && (s.push(h[f[2] - 1][1]), s.push(h[f[2] - 1][2]), s.push(h[f[2] - 1][3]))
    }
    g = new e.MultiMaterial;
    h = new e.Mesh;
    h.setPositions(r);
    t.length > 0 && h.setUV(t);
    s.length > 0 && h.setNormals(s);
    h.setFaces(m);
    g.setMesh(h);
    g.setMaterial(p);
    this.addMultiMaterial(g)
  };
  e.Wavefront.prototype.parseMesh = function() {
    objArray = this.file;
    for(var f = [], g = [], h = [], j = [], m = [], p = !0, o = new e.Material, r = 0;r < objArray.length;r++) {
      if(objArray[r][0] != "#") {
        var s = objArray[r].replace(/^\s+|\s+$/g, "").replace(/\s+/g, " ").split(" ");
        if(s.length > 0) {
          switch(s[0]) {
            case "s":
              p = s[1] == "1" ? !0 : !1;
            case "o":
              j.length > 0 && (this.createMultiMaterial(m, g, h, f, j, o, p), j = [], o = new e.Material);
              break;
            case "usemtl":
              j.length > 0 && (this.createMultiMaterial(m, g, h, f, j, o, p), j = []);
              o = this.materials[s[1]];
              break;
            case "v":
              g.push(s);
              break;
            case "vt":
              f.push(s);
              break;
            case "vn":
              h.push(s);
              break;
            case "f":
              for(var t = [], q = 1;q < s.length;q++) {
                var u = m.indexOf(s[q]);
                if(u == -1 || !p) {
                  m.push(s[q]), u = m.length - 1
                }
                t.push(u)
              }
              for(q = 0;q < t.length - 2;q++) {
                j.push(t[0] - 0), j.push(t[1 + q] - 0), j.push(t[2 + q] - 0)
              }
          }
        }
      }
    }
    this.createMultiMaterial(m, g, h, f, j, o, p)
  };
  e.Document.prototype.getWavefront = function(f) {
    if(!f.object) {
      var g = this.getAbsolutePath(this.rootURL, null);
      f.object = new (e[this.classString(f.tagName)]);
      f.object.setSrc(f.getAttribute("src"), g);
      f.removeAttribute("src");
      this.setProperties(f)
    }
    return f.object
  }
})(GLGE);
(function(e) {
  e.ParticleSystem = function() {
    this.startTime = (new Date).getTime();
    this.texture = {};
    this.startMaxVelocity = {x:0, y:0, z:0};
    this.startMinVelocity = {x:0, y:0, z:0};
    this.startMaxAcceleration = {x:0, y:0, z:0};
    this.endMaxAcceleration = {x:0, y:0, z:0};
    this.startMinAcceleration = {x:0, y:0, z:0};
    this.endMinAcceleration = {x:0, y:0, z:0};
    this.startColor = {r:0, g:0, b:0, a:1};
    this.endColor = {r:0, g:0, b:0, a:1}
  };
  e.augment(e.Placeable, e.ParticleSystem);
  e.augment(e.Animatable, e.ParticleSystem);
  e.ParticleSystem.prototype.setMaxVelX = function(e) {
    this.startMaxVelocity.x = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMaxVelY = function(e) {
    this.startMaxVelocity.y = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMaxVelZ = function(e) {
    this.startMaxVelocity.z = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMaxVelocity = function(e, g, h) {
    this.startMaxVelocity = {x:parseFloat(e), y:parseFloat(g), z:parseFloat(h)};
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMinVelX = function(e) {
    this.startMinVelocity.x = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMinVelY = function(e) {
    this.startMinVelocity.y = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMinVelZ = function(e) {
    this.startMinVelocity.z = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMinVelocity = function(e, g, h) {
    this.startMinVelocity = {x:parseFloat(e), y:parseFloat(g), z:parseFloat(h)};
    this.attribute = null
  };
  e.ParticleSystem.prototype.setVelX = function(e) {
    this.startMaxVelocity.x = parseFloat(e);
    this.startMinVelocity.x = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setVelY = function(e) {
    this.startMaxVelocity.y = parseFloat(e);
    this.startMinVelocity.y = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setVelZ = function(e) {
    this.startMaxVelocity.z = parseFloat(e);
    this.startMinVelocity.z = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setVelocity = function(e, g, h) {
    this.startMaxVelocity = {x:parseFloat(e), y:parseFloat(g), z:parseFloat(h)};
    this.startMinVelocity = {x:parseFloat(e), y:parseFloat(g), z:parseFloat(h)};
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMaxStartAccX = function(e) {
    this.startMaxAcceleration.x = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMaxStartAccY = function(e) {
    this.startMaxAcceleration.y = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMaxStartAccZ = function(e) {
    this.startMaxAcceleration.z = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMaxStartAccelertaion = function(e, g, h) {
    this.startMaxAcceleration = {x:parseFloat(e), y:parseFloat(g), z:parseFloat(h)};
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMinStartAccX = function(e) {
    this.startMinAcceleration.x = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMinStartAccY = function(e) {
    this.startMinAcceleration.y = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMinStartAccZ = function(e) {
    this.startMinAcceleration.z = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMinStartAccelertaion = function(e, g, h) {
    this.startMinAcceleration = {x:parseFloat(e), y:parseFloat(g), z:parseFloat(h)};
    this.attribute = null
  };
  e.ParticleSystem.prototype.setStartAccX = function(e) {
    this.startMaxAcceleration.x = parseFloat(e);
    this.startMinAcceleration.x = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setStartAccY = function(e) {
    this.startMaxAcceleration.y = parseFloat(e);
    this.startMinAcceleration.y = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setStartAccZ = function(e) {
    this.startMaxAcceleration.z = parseFloat(e);
    this.startMinAcceleration.z = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setStartAccelertaion = function(e, g, h) {
    this.startMaxAcceleration = {x:parseFloat(e), y:parseFloat(g), z:parseFloat(h)};
    this.startMinAcceleration = {x:parseFloat(e), y:parseFloat(g), z:parseFloat(h)};
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMaxEndAccX = function(e) {
    this.endMaxAcceleration.x = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMaxEndAccY = function(e) {
    this.endMaxAcceleration.y = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMaxEndAccZ = function(e) {
    this.endMaxAcceleration.z = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMaxEndAccelertaion = function(e, g, h) {
    this.endMaxAcceleration = {x:parseFloat(e), y:parseFloat(g), z:parseFloat(h)};
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMinEndAccX = function(e) {
    this.endMinAcceleration.x = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMinEndAccY = function(e) {
    this.endMinAcceleration.y = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMinEndAccZ = function(e) {
    this.endMinAcceleration.z = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMinEndAccelertaion = function(e, g, h) {
    this.endMinAcceleration = {x:parseFloat(e), y:parseFloat(g), z:parseFloat(h)};
    this.attribute = null
  };
  e.ParticleSystem.prototype.setEndAccX = function(e) {
    this.endMinAcceleration.x = parseFloat(e);
    this.endMaxAcceleration.x = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setEndAccY = function(e) {
    this.endMinAcceleration.y = parseFloat(e);
    this.endMaxAcceleration.y = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setEndAccZ = function(e) {
    this.endMinAcceleration.z = parseFloat(e);
    this.endMaxAcceleration.z = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setEndAccelertaion = function(e, g, h) {
    this.endMinAcceleration = {x:parseFloat(e), y:parseFloat(g), z:parseFloat(h)};
    this.endMaxAcceleration = {x:parseFloat(e), y:parseFloat(g), z:parseFloat(h)};
    this.attribute = null
  };
  e.ParticleSystem.prototype.setStartColor = function(f) {
    this.startColor = e.colorParse(f);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setEndColor = function(f) {
    this.endColor = e.colorParse(f);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setStartSize = function(e) {
    this.startSize = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setEndSize = function(e) {
    this.endSize = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setLifeTime = function(e) {
    this.maxLifeTime = parseFloat(e);
    this.minLifeTime = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMaxLifeTime = function(e) {
    this.maxLifeTime = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setMinLifeTime = function(e) {
    this.minLifeTime = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.setNumParticles = function(e) {
    this.numParticles = parseFloat(e);
    this.attribute = null
  };
  e.ParticleSystem.prototype.velocityFunction = function() {
    return[(this.startMaxVelocity.x - this.startMinVelocity.x) * Math.random() + this.startMinVelocity.x, (this.startMaxVelocity.y - this.startMinVelocity.y) * Math.random() + this.startMinVelocity.y, (this.startMaxVelocity.z - this.startMinVelocity.z) * Math.random() + this.startMinVelocity.z]
  };
  e.ParticleSystem.prototype.accelerationFunction = function() {
    return[[(this.startMaxAcceleration.x - this.startMinAcceleration.x) * Math.random() + this.startMinAcceleration.x, (this.startMaxAcceleration.y - this.startMinAcceleration.y) * Math.random() + this.startMinAcceleration.y, (this.startMaxAcceleration.z - this.startMinAcceleration.z) * Math.random() + this.startMinAcceleration.z], [(this.endMaxAcceleration.x - this.endMinAcceleration.x) * Math.random() + this.endMinAcceleration.x, (this.endMaxAcceleration.y - this.endMinAcceleration.y) * Math.random() +
    this.endMinAcceleration.y, (this.endMaxAcceleration.z - this.endMinAcceleration.z) * Math.random() + this.endMinAcceleration.z]]
  };
  e.ParticleSystem.prototype.colorFunction = function() {
    return[[this.startColor.r, this.startColor.g, this.startColor.b, this.startColor.a], [this.endColor.r, this.endColor.g, this.endColor.b, this.endColor.a]]
  };
  e.ParticleSystem.prototype.positionFunction = function() {
    return[0, 0, 0]
  };
  e.ParticleSystem.prototype.sizeFunction = function() {
    return[this.startSize, this.endSize]
  };
  e.ParticleSystem.prototype.lifeTimeFunction = function() {
    return(this.maxLifeTime - this.minLifeTime) * Math.random() + this.minLifeTime
  };
  e.ParticleSystem.prototype.minLifeTime = 2E3;
  e.ParticleSystem.prototype.maxLifeTime = 2E3;
  e.ParticleSystem.prototype.numParticles = 200;
  e.ParticleSystem.prototype.startTime = 0;
  e.ParticleSystem.prototype.startSize = 0;
  e.ParticleSystem.prototype.endSize = 1;
  e.ParticleSystem.prototype.toRender = !0;
  e.ParticleSystem.prototype.renderFirst = !0;
  e.ParticleSystem.prototype.className = "ParticleSystem";
  e.ParticleSystem.prototype.zTrans = !0;
  e.ParticleSystem.prototype.velocity = null;
  e.ParticleSystem.prototype.loop = 1;
  e.ParticleSystem.prototype.setVelocityFunction = function(e) {
    this.vecoityFunction = e;
    this.particles = null
  };
  e.ParticleSystem.prototype.setAccelerationFunction = function(e) {
    this.accelerationFunction = e;
    this.particles = null
  };
  e.ParticleSystem.prototype.setPositionFunction = function(e) {
    this.colorFunction = e;
    this.particles = null
  };
  e.ParticleSystem.prototype.setColorFunction = function(e) {
    this.positionFunction = e;
    this.particles = null
  };
  e.ParticleSystem.prototype.setSizeFunction = function(e) {
    this.sizeFunction = e;
    this.particles = null
  };
  e.ParticleSystem.prototype.generateParticles = function(e) {
    var g = this.numParticles;
    this.attribute = {initPos:[], initAcc:[], endAcc:[], initVel:[], initColor:[], endColor:[], sizeAndOffset:[]};
    this.faces = [];
    for(var h = 0;h < g;h++) {
      for(var j = this.positionFunction(h), m = this.velocityFunction(h), p = this.accelerationFunction(h), o = this.colorFunction(h), r = this.sizeFunction(h), s = this.lifeTimeFunction(h), t = Math.floor(Math.random() * s), q = -1;q <= 1;q += 2) {
        for(var u = -1;u <= 1;u += 2) {
          this.attribute.initPos.push(parseFloat(j[0]) + u, parseFloat(j[1]) + q, parseFloat(j[2])), this.attribute.initAcc.push(p[0][0], p[0][1], p[0][2]), this.attribute.endAcc.push(p[1][0], p[1][1], p[1][2]), this.attribute.initVel.push(m[0], m[1], m[2]), this.attribute.initColor.push(o[0][0], o[0][1], o[0][2], o[0][3]), this.attribute.endColor.push(o[1][0], o[1][1], o[1][2], o[1][3]), this.attribute.sizeAndOffset.push(r[0], r[1], t, s)
        }
      }
    }
    for(h = 0;h < g;h += 4) {
      this.faces.push(0 + h, 1 + h, 2 + h), this.faces.push(1 + h, 2 + h, 3 + h)
    }
    this.facesGL = e.createBuffer();
    e.bindBuffer(e.ELEMENT_ARRAY_BUFFER, this.facesGL);
    e.bufferData(e.ELEMENT_ARRAY_BUFFER, new Uint16Array(this.faces), e.STATIC_DRAW);
    this.facesGL.num = this.faces.length;
    this.attribute.initPosGL = this.createBuffer(e, this.attribute.initPos);
    this.attribute.initAccGL = this.createBuffer(e, this.attribute.initAcc);
    this.attribute.endAccGL = this.createBuffer(e, this.attribute.endAcc);
    this.attribute.initVelGL = this.createBuffer(e, this.attribute.initVel);
    this.attribute.initColorGL = this.createBuffer(e, this.attribute.initColor);
    this.attribute.endColorGL = this.createBuffer(e, this.attribute.endColor);
    this.attribute.sizeAndOffsetGL = this.createBuffer(e, this.attribute.sizeAndOffset)
  };
  e.ParticleSystem.prototype.setLoop = function(e) {
    this.loop = e
  };
  e.ParticleSystem.prototype.reset = function() {
    this.startTime = (new Date).getTime()
  };
  e.ParticleSystem.prototype.generateProgram = function(f) {
    frgShader = "#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D texture;varying vec2 UV;varying vec4 color;void main(){gl_FragColor=texture2D(texture,UV)*color;}";
    var g = f.createShader(f.VERTEX_SHADER), h = f.createShader(f.FRAGMENT_SHADER);
    f.shaderSource(g, "attribute vec3 position;attribute vec3 initVel;attribute vec3 initAcc;attribute vec3 endAcc;attribute vec4 initColor;attribute vec4 endColor;attribute vec4 sizeTimeLife;uniform float time;uniform bool loop;uniform mat4 mvMatrix;uniform mat4 pMatrix;varying vec2 UV;varying vec4 color;void main(){UV = (position.xy+1.0)/2.0;if((time>sizeTimeLife[2] && (time-sizeTimeLife[2])<sizeTimeLife[3]) || loop){float localTime = mod((time - sizeTimeLife[2]), sizeTimeLife[3]);color = (endColor-initColor)/sizeTimeLife[3]*localTime+initColor;float size = (sizeTimeLife[1]-sizeTimeLife[0])/sizeTimeLife[3]*localTime+sizeTimeLife[0];vec3 pos = (endAcc-initAcc)*(localTime*log(localTime)-localTime)+0.5*initAcc*localTime*localTime+initVel*localTime;pos = (mvMatrix*vec4(pos,1.0)).xyz;vec3 positions = pos+(position*size);gl_Position = pMatrix*vec4(positions,1.0);}else{gl_Position = vec4(0.0,0.0,0.0,1.0);}}");
    f.compileShader(g);
    f.getShaderParameter(g, f.COMPILE_STATUS) ? (f.shaderSource(h, frgShader), f.compileShader(h), f.getShaderParameter(h, f.COMPILE_STATUS) ? (this.program && f.deleteProgram(this.Program), this.program = f.createProgram(), f.attachShader(this.program, g), f.attachShader(this.program, h), f.linkProgram(this.program)) : e.error(f.getShaderInfoLog(h))) : e.error(f.getShaderInfoLog(g))
  };
  e.ParticleSystem.prototype.createBuffer = function(e, g) {
    var h = e.createBuffer();
    e.bindBuffer(e.ARRAY_BUFFER, h);
    e.bufferData(e.ARRAY_BUFFER, new Float32Array(g), e.STATIC_DRAW);
    return h
  };
  e.ParticleSystem.prototype.setUniforms = function(f) {
    var g = this.program;
    if(!g.glarrays) {
      g.glarrays = {}
    }
    var h = f.scene.camera.getViewMatrix(), j = this.getPosition(), h = e.mulMat4(h, [1, 0, 0, j.x, 0, 1, 0, j.y, 0, 0, 1, j.z, 0, 0, 0, 1]), j = e.getUniformLocation(f, g, "mvMatrix");
    g.glarrays.mvMatrix ? e.mat4gl(h, g.glarrays.mvMatrix) : g.glarrays.mvMatrix = new Float32Array(h);
    f.uniformMatrix4fv(j, !0, g.glarrays.mvMatrix);
    h = e.getUniformLocation(f, g, "pMatrix");
    g.glarrays.pMatrix ? e.mat4gl(f.scene.camera.getProjectionMatrix(), g.glarrays.pMatrix) : g.glarrays.pMatrix = new Float32Array(f.scene.camera.getProjectionMatrix());
    f.uniformMatrix4fv(h, !0, g.glarrays.pMatrix);
    f.uniform1f(e.getUniformLocation(f, g, "time"), (new Date).getTime() - this.startTime);
    f.uniform1i(e.getUniformLocation(f, g, "loop"), this.loop);
    f.activeTexture(f.TEXTURE0);
    if(!this.glTexture) {
      this.glTexture = f.createTexture()
    }
    if(this.texture.state == 1) {
      f.bindTexture(f.TEXTURE_2D, this.glTexture), f.texImage2D(f.TEXTURE_2D, 0, f.RGBA, f.RGBA, f.UNSIGNED_BYTE, this.texture.image), f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 1), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_MAG_FILTER, f.LINEAR), f.texParameteri(f.TEXTURE_2D, f.TEXTURE_MIN_FILTER, f.LINEAR_MIPMAP_LINEAR), f.generateMipmap(f.TEXTURE_2D), f.bindTexture(f.TEXTURE_2D, null), this.texture.state = 2, g.texture = !0
    }
    f.bindTexture(f.TEXTURE_2D, this.glTexture);
    g.texture && f.uniform1i(e.getUniformLocation(f, g, "texture"), 0)
  };
  e.ParticleSystem.prototype.setImage = function(f) {
    var g = this.texture;
    g.image = new Image;
    g.image.onload = function() {
      g.state = 1
    };
    e.loadImage(g.image, f)
  };
  e.ParticleSystem.prototype.setAttributes = function(f) {
    for(var g = 0;g < 8;g++) {
      f.disableVertexAttribArray(g)
    }
    g = e.getAttribLocation(f, this.program, "position");
    g > -1 && (f.bindBuffer(f.ARRAY_BUFFER, this.attribute.initPosGL), f.enableVertexAttribArray(g), f.vertexAttribPointer(g, 3, f.FLOAT, !1, 0, 0));
    g = e.getAttribLocation(f, this.program, "initAcc");
    g > -1 && (f.bindBuffer(f.ARRAY_BUFFER, this.attribute.initAccGL), f.enableVertexAttribArray(g), f.vertexAttribPointer(g, 3, f.FLOAT, !1, 0, 0));
    g = e.getAttribLocation(f, this.program, "endAcc");
    g > -1 && (f.bindBuffer(f.ARRAY_BUFFER, this.attribute.endAccGL), f.enableVertexAttribArray(g), f.vertexAttribPointer(g, 3, f.FLOAT, !1, 0, 0));
    g = e.getAttribLocation(f, this.program, "initColor");
    g > -1 && (f.bindBuffer(f.ARRAY_BUFFER, this.attribute.initColorGL), f.enableVertexAttribArray(g), f.vertexAttribPointer(g, 4, f.FLOAT, !1, 0, 0));
    g = e.getAttribLocation(f, this.program, "endColor");
    g > -1 && (f.bindBuffer(f.ARRAY_BUFFER, this.attribute.endColorGL), f.enableVertexAttribArray(g), f.vertexAttribPointer(g, 4, f.FLOAT, !1, 0, 0));
    g = e.getAttribLocation(f, this.program, "sizeTimeLife");
    g > -1 && (f.bindBuffer(f.ARRAY_BUFFER, this.attribute.sizeAndOffsetGL), f.enableVertexAttribArray(g), f.vertexAttribPointer(g, 4, f.FLOAT, !1, 0, 0));
    g = e.getAttribLocation(f, this.program, "initVel");
    g > -1 && (f.bindBuffer(f.ARRAY_BUFFER, this.attribute.initVelGL), f.enableVertexAttribArray(g), f.vertexAttribPointer(g, 3, f.FLOAT, !1, 0, 0))
  };
  e.ParticleSystem.prototype.GLRender = function(e) {
    this.attribute || this.generateParticles(e);
    this.program || this.generateProgram(e);
    e.useProgram(this.program);
    this.setAttributes(e);
    this.setUniforms(e);
    e.colorMask(0, 0, 0, 0);
    e.disable(e.BLEND);
    e.enable(e.STENCIL_TEST);
    e.stencilFunc(e.ALWAYS, 1, 1);
    e.stencilOp(e.KEEP, e.KEEP, e.REPLACE);
    e.bindBuffer(e.ELEMENT_ARRAY_BUFFER, this.facesGL);
    e.drawElements(e.TRIANGLES, this.facesGL.num, e.UNSIGNED_SHORT, 0);
    e.stencilFunc(e.EQUAL, 1, 1);
    e.stencilOp(e.KEEP, e.KEEP, e.KEEP);
    e.colorMask(1, 1, 1, 1);
    e.disable(e.DEPTH_TEST);
    e.enable(e.BLEND);
    e.bindBuffer(e.ELEMENT_ARRAY_BUFFER, this.facesGL);
    e.drawElements(e.TRIANGLES, this.facesGL.num, e.UNSIGNED_SHORT, 0);
    e.stencilOp(e.REPLACE, e.REPLACE, e.REPLACE);
    e.stencilFunc(e.ALWAYS, 0, 0);
    e.enable(e.DEPTH_TEST);
    e.scene.lastMaterial = null
  };
  e.Scene.prototype.addParticleSystem = e.Scene.prototype.addGroup;
  e.Group.prototype.addParticleSystem = e.Group.prototype.addGroup
})(GLGE);
if(!GLGE) {
  var GLGE = {}
}
(function(e) {
  e.HeightMap = function(f, g, h, j, m, p, o, r, s) {
    this.canvas = document.createElement("canvas");
    this.context = this.canvas.getContext("2d");
    this.canvas.width = g;
    this.canvas.height = h;
    this.minX = j;
    this.maxX = m;
    this.minY = p;
    this.maxY = o;
    this.minZ = r;
    this.maxZ = s;
    g = new Image;
    g.heightmap = this;
    g.onload = function() {
      this.heightmap.context.drawImage(this, 0, 0);
      this.heightmap.data = this.heightmap.context.getImageData(0, 0, this.heightmap.canvas.width, this.heightmap.canvas.height).data;
      this.heightmap.minImgValue = this.heightmap.data[0];
      this.heightmap.maxImgValue = this.heightmap.data[0];
      for(i = 0;i < this.heightmap.data.length;i += 4) {
        if(this.heightmap.data[i] < this.heightmap.minImgValue) {
          this.heightmap.minImgValue = this.heightmap.data[i]
        }
        if(this.heightmap.data[i] > this.heightmap.maxImgValue) {
          this.heightmap.maxImgValue = this.heightmap.data[i]
        }
      }
    };
    e.loadImage(g, f)
  };
  e.HeightMap.prototype.canvas = null;
  e.HeightMap.prototype.context = null;
  e.HeightMap.prototype.minZ = null;
  e.HeightMap.prototype.maxZ = null;
  e.HeightMap.prototype.minY = null;
  e.HeightMap.prototype.maxY = null;
  e.HeightMap.prototype.minX = null;
  e.HeightMap.prototype.maxX = null;
  e.HeightMap.prototype.data = null;
  e.HeightMap.prototype.getPixelAt = function(e, g) {
    return this.data ? (this.data[(this.canvas.width * g + e) * 4] - this.minImgValue) / (this.maxImgValue - this.minImgValue) * (this.maxZ - this.minZ) + this.minZ : 0
  };
  e.HeightMap.prototype.getHeightAt = function(e, g) {
    var h;
    this.lastx != void 0 && e == this.lastx && g == this.lasty ? h = this.lastValue : this.lastValue = h = this.getPixelAt(Math.round((e - this.minX) / (this.maxX - this.minX) * this.canvas.width), Math.round((g - this.minY) / (this.maxY - this.minY) * this.canvas.height));
    this.lastx = e;
    this.lasty = g;
    return h
  };
  e.KeyInput = function() {
    if(!document.keyStates) {
      document.keyStates = []
    }
    document.addEventListener("keydown", this.onKeyDown, !1);
    document.addEventListener("keyup", this.onKeyUp, !1)
  };
  e.KeyInput.prototype.isKeyPressed = function(e) {
    return document.keyStates[e] ? !0 : !1
  };
  e.KeyInput.prototype.onKeyDown = function(e) {
    document.keyStates[e.keyCode] = !0
  };
  e.KeyInput.prototype.onKeyUp = function(e) {
    document.keyStates[e.keyCode] = !1
  };
  e.MouseInput = function(e) {
    this.element = e;
    this.element.mouseX = 0;
    this.element.mouseY = 0;
    if(!this.element.buttonState) {
      this.element.buttonState = []
    }
    e.addEventListener("mousemove", this.onMouseMove, !1);
    e.addEventListener("mousedown", this.onMouseDown, !1);
    e.addEventListener("mouseup", this.onMouseUp, !1)
  };
  e.MouseInput.prototype.element = null;
  e.MouseInput.prototype.onMouseMove = function(e) {
    this.mouseX = e.clientX;
    this.mouseY = e.clientY
  };
  e.MouseInput.prototype.onMouseDown = function(e) {
    this.buttonState[e.button] = !0
  };
  e.MouseInput.prototype.onMouseUp = function(e) {
    this.buttonState[e.button] = !1
  };
  e.MouseInput.prototype.isButtonDown = function(e) {
    return this.element.buttonState[e] ? !0 : !1
  };
  e.MouseInput.prototype.getMousePosition = function() {
    return{x:this.element.mouseX, y:this.element.mouseY}
  };
  e.MI_LEFT = 0;
  e.MI_MIDDLE = 1;
  e.MI_RIGHT = 2;
  e.KI_BACKSPACE = 8;
  e.KI_TAB = 9;
  e.KI_ENTER = 13;
  e.KI_SHIFT = 16;
  e.KI_CTRL = 17;
  e.KI_ALT = 18;
  e.KI_PAUSE_BREAK = 19;
  e.KI_CAPS_LOCK = 20;
  e.KI_ESCAPE = 27;
  e.KI_PAGE_UP = 33;
  e.KI_PAGE_DOWN = 34;
  e.KI_END = 35;
  e.KI_HOME = 36;
  e.KI_LEFT_ARROW = 37;
  e.KI_UP_ARROW = 38;
  e.KI_RIGHT_ARROW = 39;
  e.KI_DOWN_ARROW = 40;
  e.KI_INSERT = 45;
  e.KI_DELETE = 46;
  e.KI_0 = 48;
  e.KI_1 = 49;
  e.KI_2 = 50;
  e.KI_3 = 51;
  e.KI_4 = 52;
  e.KI_5 = 53;
  e.KI_6 = 54;
  e.KI_7 = 55;
  e.KI_8 = 56;
  e.KI_9 = 57;
  e.KI_A = 65;
  e.KI_B = 66;
  e.KI_C = 67;
  e.KI_D = 68;
  e.KI_E = 69;
  e.KI_F = 70;
  e.KI_G = 71;
  e.KI_H = 72;
  e.KI_I = 73;
  e.KI_J = 74;
  e.KI_K = 75;
  e.KI_L = 76;
  e.KI_M = 77;
  e.KI_N = 78;
  e.KI_O = 79;
  e.KI_P = 80;
  e.KI_Q = 81;
  e.KI_R = 82;
  e.KI_S = 83;
  e.KI_T = 84;
  e.KI_U = 85;
  e.KI_V = 86;
  e.KI_W = 87;
  e.KI_X = 88;
  e.KI_Y = 89;
  e.KI_Z = 90;
  e.KI_LEFT_WINDOW_KEY = 91;
  e.KI_RIGHT_WINDOW_KEY = 92;
  e.KI_SELECT_KEY = 93;
  e.KI_NUMPAD_0 = 96;
  e.KI_NUMPAD_1 = 97;
  e.KI_NUMPAD_2 = 98;
  e.KI_NUMPAD_3 = 99;
  e.KI_NUMPAD_4 = 100;
  e.KI_NUMPAD_5 = 101;
  e.KI_NUMPAD_6 = 102;
  e.KI_NUMPAD_7 = 103;
  e.KI_NUMPAD_8 = 104;
  e.KI_NUMPAD_9 = 105;
  e.KI_MULTIPLY = 106;
  e.KI_ADD = 107;
  e.KI_SUBTRACT = 109;
  e.KI_DECIMAL_POINT = 110;
  e.KI_DIVIDE = 111;
  e.KI_F1 = 112;
  e.KI_F2 = 113;
  e.KI_F3 = 114;
  e.KI_F4 = 115;
  e.KI_F5 = 116;
  e.KI_F6 = 117;
  e.KI_F7 = 118;
  e.KI_F8 = 119;
  e.KI_F9 = 120;
  e.KI_F10 = 121;
  e.KI_F11 = 122;
  e.KI_F12 = 123;
  e.KI_NUM_LOCK = 144;
  e.KI_SCROLL_LOCK = 145;
  e.KI_SEMI_COLON = 186;
  e.KI_EQUAL_SIGN = 187;
  e.KI_COMMA = 188;
  e.KI_DASH = 189;
  e.KI_PERIOD = 190;
  e.KI_FORWARD_SLASH = 191;
  e.KI_GRAVE_ACCENT = 192;
  e.KI_OPEN_BRACKET = 219;
  e.KI_BACK_SLASH = 220;
  e.KI_CLOSE_BRAKET = 221;
  e.KI_SINGLE_QUOTE = 222;
  e.KI_SPACE = 32;
  if(!window.requestAnimationFrame) {
    window.requestAnimationFrame = function() {
      return window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(e) {
        window.setTimeout(e, 1E3 / 60)
      }
    }()
  }
})(GLGE);
window.GLGE || (window.GLGE = {});
(function(e) {
  e.FILTER_POST = 0;
  e.FILTER_SKY = 1;
  e.Filter2d = function() {
  };
  e.Filter2d.prototype.renderDepth = !1;
  e.Filter2d.prototype.renderNormal = !1;
  e.Filter2d.prototype.renderEmit = !1;
  e.Filter2d.prototype.passes = null;
  e.Filter2d.prototype.textures = null;
  e.Filter2d.prototype.uniforms = null;
  e.Filter2d.prototype.buffers = null;
  e.Filter2d.prototype.filterType = e.FILTER_POST;
  e.Filter2d.prototype.depthBufferWidth = null;
  e.Filter2d.prototype.depthBufferHeight = null;
  e.Filter2d.prototype.emitBufferWidth = null;
  e.Filter2d.prototype.emitBufferHeight = null;
  e.Filter2d.prototype.normalBufferWidth = null;
  e.Filter2d.prototype.normalBufferHeight = null;
  e.Filter2d.prototype.setFilterType = function(e) {
    this.filterType = e;
    return this
  };
  e.Filter2d.prototype.getFilterType = function() {
    return this.filterType
  };
  e.Filter2d.prototype.addTexture = function(e) {
    if(!this.textures) {
      this.textures = []
    }
    this.textures.push(e)
  };
  e.Filter2d.prototype.removeTexture = function(e) {
    e = this.textures.indexOf(e);
    e > -1 && this.textures.splice(e, 1)
  };
  e.Filter2d.prototype.createBuffer = function(e, f, j) {
    if(!f) {
      f = e.canvas.width
    }
    if(!j) {
      j = e.canvas.height
    }
    var m = e.createFramebuffer(), p = e.createRenderbuffer(), o = e.createTexture();
    e.bindTexture(e.TEXTURE_2D, o);
    var r = new Uint8Array(f * j * 4);
    e.texImage2D(e.TEXTURE_2D, 0, e.RGBA, f, j, 0, e.RGBA, e.UNSIGNED_BYTE, r);
    e.bindFramebuffer(e.FRAMEBUFFER, m);
    e.bindRenderbuffer(e.RENDERBUFFER, p);
    e.renderbufferStorage(e.RENDERBUFFER, e.DEPTH_COMPONENT16, f, j);
    e.framebufferRenderbuffer(e.FRAMEBUFFER, e.DEPTH_ATTACHMENT, e.RENDERBUFFER, p);
    e.framebufferTexture2D(e.FRAMEBUFFER, e.COLOR_ATTACHMENT0, e.TEXTURE_2D, o, 0);
    e.bindRenderbuffer(e.RENDERBUFFER, null);
    e.bindFramebuffer(e.FRAMEBUFFER, null);
    e.bindTexture(e.TEXTURE_2D, null);
    return[m, p, o]
  };
  e.Filter2d.prototype.getFrameBuffer = function(e) {
    if(!this.passes) {
      return null
    }
    if(!this.gl) {
      this.gl = e
    }
    if(!this.buffers) {
      this.buffers = this.createBuffer(e)
    }
    return this.buffers[0]
  };
  e.Filter2d.prototype.getEmitBuffer = function(e) {
    if(!this.passes) {
      return null
    }
    if(!this.gl) {
      this.gl = e
    }
    if(!this.emitBuffers) {
      this.emitBuffers = this.createBuffer(e, this.getEmitBufferWidth(), this.getEmitBufferHeight())
    }
    return this.emitBuffers[0]
  };
  e.Filter2d.prototype.setEmitBufferWidth = function(e) {
    this.emitBufferWidth = e;
    this.emitBuffers = null
  };
  e.Filter2d.prototype.getEmitBufferWidth = function() {
    return this.emitBufferWidth ? this.emitBufferWidth : this.gl.canvas.width
  };
  e.Filter2d.prototype.setEmitBufferHeight = function(e) {
    this.emitBufferHeight = e;
    this.emitBuffers = null
  };
  e.Filter2d.prototype.getEmitBufferHeight = function() {
    return this.emitBufferHeight ? this.emitBufferHeight : this.gl.canvas.height
  };
  e.Filter2d.prototype.getDepthBuffer = function(e) {
    if(!this.passes) {
      return null
    }
    if(!this.gl) {
      this.gl = e
    }
    if(!this.depthBuffers) {
      this.depthBuffers = this.createBuffer(e, this.getDepthBufferWidth(), this.getDepthBufferHeight())
    }
    return this.depthBuffers[0]
  };
  e.Filter2d.prototype.setDepthBufferWidth = function(e) {
    this.depthBufferWidth = e;
    this.depthBuffers = null
  };
  e.Filter2d.prototype.getDepthBufferWidth = function() {
    return this.depthBufferWidth ? this.depthBufferWidth : this.gl.canvas.width
  };
  e.Filter2d.prototype.setDepthBufferHeight = function(e) {
    this.depthBufferHeight = e;
    this.depthBuffers = null
  };
  e.Filter2d.prototype.getDepthBufferHeight = function() {
    return this.depthBufferHeight ? this.depthBufferHeight : this.gl.canvas.height
  };
  e.Filter2d.prototype.setNormalBufferWidth = function(e) {
    this.normalBufferWidth = e;
    this.normalBuffers = null
  };
  e.Filter2d.prototype.getNormalBufferWidth = function() {
    return this.normalBufferWidth ? this.normalBufferWidth : this.gl.canvas.width
  };
  e.Filter2d.prototype.setNormalBufferHeight = function(e) {
    this.normalBufferHeight = e;
    this.normalBuffers = null
  };
  e.Filter2d.prototype.getNormalBufferHeight = function() {
    return this.normalBufferHeight ? this.normalBufferHeight : this.gl.canvas.height
  };
  e.Filter2d.prototype.getNormalBuffer = function(e) {
    if(!this.gl) {
      this.gl = e
    }
    if(!this.normalBuffers) {
      this.normalBuffers = this.createBuffer(e, this.getNormalBufferWidth(), this.getNormalBufferHeight())
    }
    return this.normalBuffers[0]
  };
  e.Filter2d.prototype.setUniform = function(e, f, j) {
    if(!this.uniforms) {
      this.uniforms = {}
    }
    this.uniforms[f] = {type:e, value:j}
  };
  e.Filter2d.prototype.getUniform = function(e) {
    if(!this.uniforms) {
      this.uniforms = {}
    }
    return this.uniforms[e].value
  };
  e.Filter2d.prototype.getUniformType = function(e) {
    if(!this.uniforms) {
      this.uniforms = {}
    }
    return this.uniforms[e].type
  };
  e.Filter2d.prototype.addPassFile = function(f) {
    var h = new e.XMLHttpRequest;
    h && (h.open("GET", f, !1), h.send(""), this.addPass(h.responseText))
  };
  e.Filter2d.prototype.addPass = function(e, f, j) {
    if(!this.passes) {
      this.passes = []
    }
    this.passes.push({GLSL:e, height:j, width:f})
  };
  e.Filter2d.prototype.GLRender = function(f, h) {
    f.disable(f.BLEND);
    h || (h = null);
    if(this.passes) {
      for(var j = 0;j < this.passes.length;j++) {
        if(this.passes.length - 1 == j) {
          f.bindFramebuffer(f.FRAMEBUFFER, h)
        }else {
          if(!this.passes[j].buffer) {
            this.passes[j].buffer = this.createBuffer(f, this.passes[j].width, this.passes[j].height)
          }
          f.bindFramebuffer(f.FRAMEBUFFER, this.passes[j].buffer[0])
        }
        f.viewport(0, 0, this.passes[j].width ? this.passes[j].width : f.canvas.width, this.passes[j].height ? this.passes[j].height : f.canvas.height);
        f.clearDepth(1);
        f.depthFunc(f.LEQUAL);
        f.clearColor(0, 0, 0, 0);
        f.clear(f.COLOR_BUFFER_BIT | f.DEPTH_BUFFER_BIT);
        if(!this.passes[j].program) {
          this.passes[j].program = this.GLCreateShader(f, this.passes[j].GLSL)
        }
        f.useProgram(this.passes[j].program);
        f.program = this.passes[j].program;
        for(var m = 0;m < 8;m++) {
          f.disableVertexAttribArray(m)
        }
        attribslot = e.getAttribLocation(f, this.passes[j].program, "position");
        this.posBuffer || this.createPlane(f);
        f.bindBuffer(f.ARRAY_BUFFER, this.posBuffer);
        f.enableVertexAttribArray(attribslot);
        f.vertexAttribPointer(attribslot, this.posBuffer.itemSize, f.FLOAT, !1, 0, 0);
        this.GLSetUniforms(f, j);
        f.bindBuffer(f.ELEMENT_ARRAY_BUFFER, this.GLfaces);
        f.drawElements(f.TRIANGLES, this.GLfaces.numItems, f.UNSIGNED_SHORT, 0)
      }
    }
  };
  var f = new Float32Array(16);
  e.Filter2d.prototype.GLSetUniforms = function(g, h) {
    if(this.filterType == e.FILTER_SKY) {
      var j = e.transposeMat4(e.mulMat4(e.inverseMat4(g.scene.camera.matrix), e.inverseMat4(g.scene.camera.pMatrix)));
      e.mat4gl(j, f);
      e.setUniformMatrix(g, "Matrix4fv", e.getUniformLocation(g, this.passes[h].program, "invViewProj"), !1, f)
    }
    for(key in this.uniforms) {
      j = this.uniforms[key], j.type == "Matrix4fv" ? e.setUniformMatrix(g, "Matrix4fv", e.getUniformLocation(g, this.passes[h].program, key), !1, j.value) : e.setUniform(g, j.type, e.getUniformLocation(g, this.passes[h].program, key), j.value)
    }
    j = 0;
    if(this.buffers) {
      h == 0 && (g.activeTexture(g["TEXTURE" + j]), g.bindTexture(g.TEXTURE_2D, this.buffers[2]), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_MAG_FILTER, g.LINEAR), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_MIN_FILTER, g.LINEAR), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_WRAP_S, g.CLAMP_TO_EDGE), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_WRAP_T, g.CLAMP_TO_EDGE));
      e.setUniform(g, "1i", e.getUniformLocation(g, this.passes[h].program, "GLGE_RENDER"), j);
      j++;
      this.renderDepth && (h == 0 && (g.activeTexture(g["TEXTURE" + j]), g.bindTexture(g.TEXTURE_2D, this.depthBuffers[2]), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_MAG_FILTER, g.LINEAR), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_MIN_FILTER, g.LINEAR), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_WRAP_S, g.CLAMP_TO_EDGE), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_WRAP_T, g.CLAMP_TO_EDGE)), e.setUniform(g, "1i", e.getUniformLocation(g, this.passes[h].program, "GLGE_DEPTH"), j), j++);
      this.renderEmit && (h == 0 && (g.activeTexture(g["TEXTURE" + j]), g.bindTexture(g.TEXTURE_2D, this.emitBuffers[2]), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_MAG_FILTER, g.LINEAR), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_MIN_FILTER, g.LINEAR), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_WRAP_S, g.CLAMP_TO_EDGE), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_WRAP_T, g.CLAMP_TO_EDGE)), e.setUniform(g, "1i", e.getUniformLocation(g, this.passes[h].program, "GLGE_EMIT"), j), j++);
      this.renderNormal && (h == 0 && (g.activeTexture(g["TEXTURE" + j]), g.bindTexture(g.TEXTURE_2D, this.normalBuffers[2]), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_MAG_FILTER, g.LINEAR), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_MIN_FILTER, g.LINEAR), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_WRAP_S, g.CLAMP_TO_EDGE), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_WRAP_T, g.CLAMP_TO_EDGE)), e.setUniform(g, "1i", e.getUniformLocation(g, this.passes[h].program, "GLGE_NORMAL"), j), j++);
      for(var m = 0;m < this.passes.length;m++) {
        this.passes[m].buffer && (g.activeTexture(g["TEXTURE" + j]), g.bindTexture(g.TEXTURE_2D, this.passes[m].buffer[2]), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_MAG_FILTER, g.LINEAR), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_MIN_FILTER, g.LINEAR), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_WRAP_S, g.CLAMP_TO_EDGE), g.texParameteri(g.TEXTURE_2D, g.TEXTURE_WRAP_T, g.CLAMP_TO_EDGE)), e.setUniform(g, "1i", e.getUniformLocation(g, this.passes[h].program, "GLGE_PASS" + m), j), j++
      }
    }
    if(!this.textures) {
      this.textures = []
    }
    for(m = 0;m < this.textures.length;m++) {
      g.activeTexture(g["TEXTURE" + (m + j)]), this.textures[m].doTexture(g, null), e.setUniform(g, "1i", e.getUniformLocation(g, this.passes[h].program, "TEXTURE" + m), m + j)
    }
  };
  e.Filter2d.prototype.createPlane = function(e) {
    if(!this.posBuffer) {
      this.posBuffer = e.createBuffer()
    }
    e.bindBuffer(e.ARRAY_BUFFER, this.posBuffer);
    e.bufferData(e.ARRAY_BUFFER, new Float32Array([1, 1, 0.5, -1, 1, 0.5, -1, -1, 0.5, 1, -1, 0.5]), e.STATIC_DRAW);
    this.posBuffer.itemSize = 3;
    this.posBuffer.numItems = 4;
    if(!this.GLfaces) {
      this.GLfaces = e.createBuffer()
    }
    e.bindBuffer(e.ELEMENT_ARRAY_BUFFER, this.GLfaces);
    e.bufferData(e.ELEMENT_ARRAY_BUFFER, new Uint16Array([0, 1, 2, 2, 3, 0]), e.STATIC_DRAW);
    this.GLfaces.itemSize = 1;
    this.GLfaces.numItems = 6
  };
  e.Filter2d.prototype.GLCreateShader = function(f, h) {
    var j = [];
    j.push("uniform mat4 invViewProj;\n");
    j.push("attribute vec3 position;\n");
    j.push("varying vec2 texCoord;\n");
    j.push("varying vec3 rayCoord;\n");
    j.push("void main(void){\n");
    j.push("vec4 near=invViewProj * vec4(position.xy,-1.0,1.0);\n");
    j.push("near/=near.w;\n");
    j.push("vec4 far=invViewProj * vec4(position.xy,1.0,1.0);\n");
    j.push("far/=far.w;\n");
    j.push("rayCoord=normalize(far.xyz-near.xyz);\n");
    j.push("texCoord=(position.xy+vec2(1.0,1.0))/2.0;\n");
    j.push("gl_Position = vec4(position.xyz,1.0);\n");
    j.push("}\n");
    var j = e.getGLShader(f, f.VERTEX_SHADER, j.join("")), m = e.getGLShader(f, f.FRAGMENT_SHADER, h);
    return e.getGLProgram(f, j, m)
  }
})(GLGE);
typeof GLGE == "undefined" && (GLGE = {});
(function(e) {
  function f(e, g) {
    var h = null;
    if(e.getAttribute("id") == g) {
      return e
    }
    for(var j = 0;j < e.childNodes.length;j++) {
      if(e.childNodes[j].nodeType == 1 && (h = f(e.childNodes[j], g), h != null)) {
        break
      }
    }
    return h
  }
  e.ColladaDocuments = [];
  e.Collada = function(f) {
    e.Assets.registerAsset(this, f);
    e.Group.call(this);
    this.children = [];
    this.actions = {};
    this.actionsIdx = this.boneIdx = 0
  };
  e.augment(e.Group, e.Collada);
  e.Collada.prototype.type = e.G_NODE;
  e.Collada.prototype.useLights = !1;
  e.Collada.prototype.useCamera = !1;
  e.Collada.prototype.getAbsolutePath = function(e, f) {
    if(e.substr(0, 7) == "http://" || e.substr(0, 7) == "file://" || e.substr(0, 7) == "https://") {
      return e
    }else {
      if(!f) {
        f = window.location.href
      }
      if(f.indexOf("://") == -1) {
        return f.slice(0, f.lastIndexOf("/")) + "/" + e
      }
      for(var g = f.split("/"), h = g[2], j = g[0], m = [], u = 3;u < g.length - 1;u++) {
        m.push(g[u])
      }
      e.substr(0, 1) == "/" && (m = []);
      g = e.split("/");
      for(u = 0;u < g.length;u++) {
        g[u] == ".." ? m.pop() : g[u] != "" && m.push(g[u])
      }
      return j + "//" + h + "/" + m.join("/")
    }
  };
  e.Collada.prototype.getElementById = function(e) {
    if(!this.idcache) {
      var f = this.getElementsByTagName("*"), g;
      this.idcache = {};
      for(var h = 0;h < f.length;h++) {
        g = f[h].getAttribute("id"), g != "" && (this.idcache[g] = f[h])
      }
    }
    return this.idcache[e]
  };
  e.Collada.prototype.parseArray = function(e) {
    for(var e = e.firstChild, f = "", g = [], h, j;e;) {
      h = (f + e.nodeValue).replace(/\s+/g, " ").replace(/^\s+/g, "").split(" ");
      e = e.nextSibling;
      h[0] == "" && h.unshift();
      e && (f = h.pop());
      for(j = 0;j < h.length;j++) {
        h[j] != "" && g.push(h[j])
      }
    }
    return g
  };
  e.Collada.prototype.isSketchupFile = function() {
    var e = this.xml.getElementsByTagName("asset");
    if(!e || e.length == 0) {
      return!1
    }
    for(var f = 0;f < e.length;++f) {
      var g = e[f].getElementsByTagName("contributor");
      if(!g || g.length == 0) {
        break
      }
      for(var h = 0;h < g.length;++h) {
        var j = g[h].getElementsByTagName("authoring_tool");
        if(!j || j.length == 0) {
          return!1
        }
        for(var m = 0;m < j.length;++m) {
          if(j[m].firstChild.nodeValue.indexOf("Google") == 0) {
            return!0
          }
        }
      }
    }
    return!1
  };
  e.Collada.prototype.setUseCamera = function(e) {
    this.useCamera = e;
    return this
  };
  e.Collada.prototype.getUseCamera = function() {
    return this.useCamera
  };
  e.Collada.prototype.setUseLights = function(e) {
    this.useLights = e;
    return this
  };
  e.Collada.prototype.getUseLights = function() {
    return this.useLights
  };
  e.Collada.prototype.setDocument = function(f, g, h) {
    this.url = f;
    this.loadedCallback = h;
    if(f.indexOf("#") != -1) {
      this.rootId = f.substr(f.indexOf("#") + 1), f = f.substr(0, f.indexOf("#"))
    }
    g && (f = this.getAbsolutePath(f, g));
    this.docURL = f;
    if(e.ColladaDocuments[f]) {
      this.xml = e.ColladaDocuments[f]
    }else {
      if(g = new e.XMLHttpRequest) {
        g.overrideMimeType("text/xml");
        var j = f, m = this;
        g.onreadystatechange = function() {
          if(this.readyState == 4) {
            this.status == 200 || this.status == 0 ? (this.responseXML.getElementById = m.getElementById, m.loaded(j, this.responseXML)) : e.error("Error loading Document: " + j + " status " + this.status)
          }
        };
        g.open("GET", f, !0);
        g.send("")
      }
    }
  };
  e.Collada.prototype.getSource = function(e) {
    e = this.xml.getElementById(e);
    if(!e) {
      return[]
    }
    if(!e.jsArray || this.badAccessor) {
      var f;
      if(e.tagName == "vertices") {
        f = [];
        for(var g = e.getElementsByTagName("input"), h = 0;h < g.length;h++) {
          f[h] = this.getSource(g[h].getAttribute("source").substr(1)), f[h].block = g[h].getAttribute("semantic")
        }
      }else {
        h = e.getElementsByTagName("technique_common")[0].getElementsByTagName("accessor")[0];
        f = this.xml.getElementById(h.getAttribute("source").substr(1));
        g = f.tagName;
        f = this.parseArray(f);
        stride = parseInt(h.getAttribute("stride"));
        (offset = parseInt(h.getAttribute("offset"))) || (offset = 0);
        stride || (stride = 1);
        count = parseInt(h.getAttribute("count"));
        for(var j = h.getElementsByTagName("param"), m = [], h = 0;h < j.length;h++) {
          j[h].hasAttribute("name") || this.exceptions.badAccessor || this.badAccessor ? m.push({type:j[h].getAttribute("type"), name:j[h].getAttribute("name")}) : m.push(!1)
        }
        f = {array:f, stride:stride, offset:offset, count:count, pmask:m, type:g}
      }
      e.jsArray = f
    }
    return e.jsArray
  };
  var g = {};
  e.Collada.prototype.getMeshes = function(f, h) {
    g[this.url] || (g[this.url] = []);
    if(g[this.url][f]) {
      return g[this.url][f]
    }
    var j, m, t, q, u, v, w, B, A;
    j = this.xml.getElementById(f);
    if(!j) {
      return e.error("Collada.getMeshes returning [], id: " + f), []
    }
    j = j.getElementsByTagName("mesh");
    if(!j) {
      return e.error("Collada.getMeshes returning [], id: " + f), []
    }
    meshNode = null;
    j.length ? meshNode = j[0] : e.error("Collada.getMeshes returning [], id: " + f);
    var D = [];
    if(!meshNode) {
      return D
    }
    u = meshNode.getElementsByTagName("polylist");
    for(j = 0;j < u.length;j++) {
      t = this.parseArray(u[j].getElementsByTagName("p")[0]);
      vcount = this.parseArray(u[j].getElementsByTagName("vcount")[0]);
      A = u[j].getElementsByTagName("input");
      var C = 0;
      for(m = 0;m < A.length;m++) {
        C = Math.max(C, A[m].getAttribute("offset"))
      }
      v = [];
      for(m = q = 0;m < vcount.length;m++) {
        for(A = 0;A < vcount[m] - 2;A++) {
          for(k = 0;k <= C;k++) {
            v.push(t[q + k])
          }
          for(k = 0;k <= C;k++) {
            v.push(t[q + (C + 1) * (A + 1) + k])
          }
          for(k = 0;k <= C;k++) {
            v.push(t[q + (C + 1) * (A + 2) + k])
          }
        }
        q += (C + 1) * vcount[m]
      }
      u[j].getElementsByTagName("p")[0].data = v
    }
    w = meshNode.getElementsByTagName("polygons");
    for(j = 0;j < w.length;j++) {
      var G = w[j].getElementsByTagName("p");
      v = [];
      for(var E = 0;E < G.length;E++) {
        t = this.parseArray(G[E]);
        A = w[j].getElementsByTagName("input");
        for(m = C = 0;m < A.length;m++) {
          C = Math.max(C, A[m].getAttribute("offset"))
        }
        for(A = q = 0;A < t.length / (C + 1) - 2;A++) {
          for(k = 0;k <= C;k++) {
            v.push(t[q + k])
          }
          for(k = 0;k <= C;k++) {
            v.push(t[q + (C + 1) * (A + 1) + k])
          }
          for(k = 0;k <= C;k++) {
            v.push(t[q + (C + 1) * (A + 2) + k])
          }
        }
        q += (C + 1) * (t.length / (C + 1))
      }
      if(G.length > 0) {
        w[j].getElementsByTagName("p")[0].data = v
      }
    }
    G = [];
    v = meshNode.getElementsByTagName("triangles");
    for(j = 0;j < u.length;j++) {
      G.push(u[j])
    }
    for(j = 0;j < w.length;j++) {
      w[j].getElementsByTagName("p").length > 0 && G.push(w[j])
    }
    for(j = 0;j < v.length;j++) {
      G.push(v[j])
    }
    for(j = 0;j < G.length;j++) {
      t = G[j].getElementsByTagName("input");
      u = [];
      v = [];
      q = [];
      w = {};
      for(m = 0;m < t.length;m++) {
        t[m].data = this.getSource(t[m].getAttribute("source").substr(1));
        B = t[m].getAttribute("semantic");
        B == "TEXCOORD" && ((A = t[m].getAttribute("set")) || (A = 0), B += A);
        if(B == "VERTEX") {
          for(E = 0;E < t[m].data.length;E++) {
            w[t[m].data[E].block] = []
          }
        }
        t[m].block = B;
        t[m].offset = parseInt(t[m].getAttribute("offset"));
        w[B] = [];
        q.push(t[m])
      }
      t = G[j].getElementsByTagName("p")[0].data ? G[j].getElementsByTagName("p")[0].data : this.parseArray(G[j].getElementsByTagName("p")[0]);
      for(m = 0;m < q.length;m++) {
        if(q[m].block != "VERTEX") {
          q[m].data = [q[m].data], q[m].data[0].block = q[m].block
        }
      }
      for(m = C = 0;m < q.length;m++) {
        C = Math.max(q[m].offset + 1, C)
      }
      for(A = 0;A < t.length;A += C) {
        for(m = 0;m < q.length;m++) {
          for(E = 0;E < q[m].data.length;E++) {
            B = q[m].data[E].block;
            var J = q[m].data[E].stride;
            for(k = 0;k < q[m].data[E].stride;k++) {
              q[m].data[E].pmask[k] && w[B].push(q[m].data[E].array[t[A + q[m].offset] * q[m].data[E].stride + k + q[m].data[E].offset])
            }
            if(h && B == "POSITION") {
              for(k = 0;k < h.count;k++) {
                u.push(h.vertexJoints[t[A + q[m].offset] * h.count + k]), v.push(h.vertexWeight[t[A + q[m].offset] * h.count + k])
              }
            }
            B == "POSITION" && J == 1 && (w[B].push(0), w[B].push(0));
            B == "POSITION" && J == 2 && w[B].push(0);
            B == "TEXCOORD0" && J == 3 && w[B].pop();
            B == "TEXCOORD1" && J == 3 && w[B].pop()
          }
        }
      }
      t = [];
      A = e.Mesh.WINDING_ORDER_CLOCKWISE;
      if(w.NORMAL) {
        A = e.Mesh.WINDING_ORDER_CLOCKWISE;
        if(!w.POSITION) {
          w.POSITION = w.VERTEX
        }
        for(m = 0;m < w.POSITION.length;m += 9) {
          E = e.subVec3([w.POSITION[m], w.POSITION[m + 1], w.POSITION[m + 2]], [w.POSITION[m + 3], w.POSITION[m + 4], w.POSITION[m + 5]]);
          C = e.subVec3([w.POSITION[m + 6], w.POSITION[m + 7], w.POSITION[m + 8]], [w.POSITION[m], w.POSITION[m + 1], w.POSITION[m + 2]]);
          q = e.crossVec3(C, E);
          for(C = E = 0;C < 9;C += 3) {
            q[0] * w.NORMAL[m + C] + q[1] * w.NORMAL[m + C + 1] + q[2] * w.NORMAL[m + C + 2] < 0 ? E -= 1 : E += 1
          }
          E < 0 ? (E = w.POSITION.length / 3, t.push(m / 3), t.push(m / 3 + 2), t.push(m / 3 + 1)) : (t.push(m / 3), t.push(m / 3 + 1), t.push(m / 3 + 2))
        }
      }else {
        console.log("Autogenerating normals, do not know facings");
        w.NORMAL = [];
        if(!w.POSITION) {
          w.POSITION = w.VERTEX
        }
        for(m = 0;m < w.POSITION.length;m += 9) {
          E = e.subVec3([w.POSITION[m], w.POSITION[m + 1], w.POSITION[m + 2]], [w.POSITION[m + 3], w.POSITION[m + 4], w.POSITION[m + 5]]), C = e.subVec3([w.POSITION[m + 6], w.POSITION[m + 7], w.POSITION[m + 8]], [w.POSITION[m], w.POSITION[m + 1], w.POSITION[m + 2]]), q = e.toUnitVec3(e.crossVec3(e.toUnitVec3(C), e.toUnitVec3(E))), w.NORMAL.push(q[0]), w.NORMAL.push(q[1]), w.NORMAL.push(q[2]), w.NORMAL.push(q[0]), w.NORMAL.push(q[1]), w.NORMAL.push(q[2]), w.NORMAL.push(q[0]), w.NORMAL.push(q[1]),
          w.NORMAL.push(q[2])
        }
        E = w.POSITION.length / 3;
        for(m = 0;m < E;m++) {
          t.push(m)
        }
      }
      if(!this.isSketchupFile()) {
        A = e.Mesh.WINDING_ORDER_UNKNOWN
      }
      m = 21843;
      m *= 3;
      E = (t.length - t.length % m) / m + (t.length % m ? 1 : 0);
      C = [];
      for(q = 0;q < E;++q) {
        C.push(new e.Mesh(void 0, A)), C[q].setPositions(w.POSITION.slice(m * q * 3, m * 3 * (q + 1) > w.POSITION.length ? w.POSITION.length : m * 3 * (q + 1))), C[q].setNormals(w.NORMAL.slice(m * q * 3, m * (q + 1) * 3 > w.POSITION.length ? w.POSITION.length : m * (q + 1) * 3)), w.TEXCOORD0 && C[q].setUV(w.TEXCOORD0.slice(m * q * 2, m * (q + 1) * 2 > w.TEXCOORD0.length ? w.TEXCOORD0.length : m * (q + 1) * 2)), !w.TEXCOORD0 && w.TEXCOORD1 && C[q].setUV(w.TEXCOORD1.slice(m * q * 2, m * (q + 1) * 2 >
        w.TEXCOORD1.length ? w.TEXCOORD1.length : m * (q + 1) * 2)), w.TEXCOORD1 && C[q].setUV2(w.TEXCOORD1.slice(m * q * 2, m * (q + 1) * 2 > w.TEXCOORD1.length ? w.TEXCOORD1.length : m * (q + 1) * 2))
      }
      if(h) {
        if(h.count > 8) {
          w = [];
          q = [];
          for(A = 0;A < v.length;A += h.count) {
            B = [];
            for(k = 0;k < h.count;k++) {
              B.push({weight:v[A + k], joint:u[A + k]})
            }
            B.sort(function(e, f) {
              return parseFloat(f.weight) - parseFloat(e.weight)
            });
            for(k = 0;k < 8;k++) {
              w.push(B[k].joint), q.push(B[k].weight)
            }
          }
          u = w;
          v = q;
          h.count = 8
        }
        for(q = 0;q < E;++q) {
          this.xml.getElementsByTagName("animation").length != 0 && (C[q].setJoints(h.joints), C[q].setInvBindMatrix(h.inverseBindMatrix), w = m * (q + 1) * h.count > u.length ? u.length : m * (q + 1) * h.count, A = m * q * h.count, C[q].setVertexJoints(u.slice(A, w), h.count), C[q].setVertexWeights(v.slice(A, w), h.count))
        }
      }
      for(q = 0;q < E;++q) {
        C[q].setFaces(t.slice(0, (m * (q + 1) > t.length ? t.length : m * (q + 1)) - m * q)), C[q].matName = G[j].getAttribute("material"), D.push(C[q])
      }
    }
    return g[this.url][f] = D
  };
  e.Collada.prototype.getFloat4 = function(e, f) {
    for(var g = e.getElementsByTagName("newparam"), h = 0;h < g.length;h++) {
      if(g[h].getAttribute("sid") == f) {
        return g[h].getElementsByTagName("float4")[0].firstChild.nodeValue
      }
    }
    return null
  };
  e.Collada.prototype.getFloat = function(e, f) {
    for(var g = e.getElementsByTagName("newparam"), h = 0;h < g.length;h++) {
      if(g[h].getAttribute("sid") == f) {
        return g[h].getElementsByTagName("float")[0].firstChild.nodeValue
      }
    }
    return null
  };
  e.Collada.prototype.getSampler = function(e, f) {
    for(var g = e.getElementsByTagName("newparam"), h = 0;h < g.length;h++) {
      if(g[h].getAttribute("sid") == f) {
        return g[h].getElementsByTagName("sampler2D")[0].getElementsByTagName("source")[0].firstChild.nodeValue
      }
    }
    return null
  };
  e.Collada.prototype.getSurface = function(e, f) {
    for(var g = e.getElementsByTagName("newparam"), h = 0;h < g.length;h++) {
      if(g[h].getAttribute("sid") == f) {
        return g[h].getElementsByTagName("surface")[0].getElementsByTagName("init_from")[0].firstChild.nodeValue
      }
    }
    return null
  };
  e.Collada.prototype.getImage = function(e) {
    if(e = this.xml.getElementById(e)) {
      return this.getAbsolutePath(e.getElementsByTagName("init_from")[0].firstChild.nodeValue, this.docURL)
    }
  };
  e.Collada.prototype.createMaterialLayer = function(f, g, h, j, m) {
    var q;
    (h = this.getSurface(h, this.getSampler(h, f.getAttribute("texture")))) || (h = f.getAttribute("texture"));
    q = this.getImage(h);
    h = new e.Texture;
    h.setSrc(q);
    g.addTexture(h);
    q = new e.MaterialLayer;
    q.setTexture(h);
    q.setMapto(j);
    f.hasAttribute("texcoord") && m[f.getAttribute("texcoord")] ? m[f.getAttribute("texcoord")] == 1 ? q.setMapinput(e.UV2) : (m[f.getAttribute("texcoord")] != 0 && e.error("GLGE only supports 2 texture sets\n"), q.setMapinput(e.UV1)) : (e.error("Collada material does not specify texture coordinates, but it may have them: defaulting to set 0\n"), q.setMapinput(e.UV1));
    f.getElementsByTagName("blend_mode")[0] && f.getElementsByTagName("blend_mode")[0].firstChild.nodeValue == "MULTIPLY" && q.setBlendMode(e.BL_MUL);
    g.addMaterialLayer(q)
  };
  var h = {};
  e.Collada.prototype.getMaterial = function(g, j) {
    if(h[this.url]) {
      if(h[this.url][g]) {
        return h[this.url][g]
      }
    }else {
      h[this.url] = {}
    }
    var m = this.xml.getElementsByTagName("library_materials")[0], m = f(m, g);
    if(!m) {
      return m = new e.Material, h[this.url][g] = m
    }
    var s = this.xml.getElementById(m.getElementsByTagName("instance_effect")[0].getAttribute("url").substr(1)).getElementsByTagName("profile_COMMON")[0], t = s.getElementsByTagName("technique")[0], m = new e.Material;
    m.setSpecular(0);
    h[this.url][g] = m;
    var q, u;
    q = t.getElementsByTagName("ambient");
    if(q.length > 0) {
      q = q[0].firstChild;
      do {
        switch(q.tagName) {
          case "color":
            u = q.firstChild.nodeValue.replace(/\s+/g, " ").split(" ");
            m.setAmbient({r:u[0], g:u[1], b:u[2]});
            break;
          case "param":
            u = this.getFloat4(s, q.getAttribute("ref")).replace(/\s+/g, " ").split(" ");
            m.setAmbient({r:u[0], g:u[1], b:u[2]});
            break;
          case "texture":
            this.createMaterialLayer(q, m, s, e.M_AMBIENT, j)
        }
      }while(q = q.nextSibling)
    }
    q = t.getElementsByTagName("diffuse");
    if(q.length > 0) {
      q = q[0].firstChild;
      do {
        switch(q.tagName) {
          case "color":
            u = q.firstChild.nodeValue.replace(/\s+/g, " ").split(" ");
            m.setColor({r:u[0], g:u[1], b:u[2]});
            break;
          case "param":
            u = this.getFloat4(s, q.getAttribute("ref")).replace(/\s+/g, " ").split(" ");
            m.setColor({r:u[0], g:u[1], b:u[2]});
            break;
          case "texture":
            this.createMaterialLayer(q, m, s, e.M_COLOR, j)
        }
      }while(q = q.nextSibling)
    }
    q = t.getElementsByTagName("bump");
    if(q.length > 0) {
      q = q[0].firstChild;
      do {
        switch(q.tagName) {
          case "texture":
            this.createMaterialLayer(q, m, s, e.M_NOR, j)
        }
      }while(q = q.nextSibling)
    }
    if(t.getElementsByTagName("shininess").length > 0) {
      m.setSpecular(1);
      q = t.getElementsByTagName("shininess")[0].firstChild;
      do {
        switch(q.tagName) {
          case "float":
            parseFloat(q.firstChild.nodeValue) > 1 ? m.setShininess(parseFloat(q.firstChild.nodeValue)) : m.setShininess(parseFloat(q.firstChild.nodeValue) * 128);
            break;
          case "param":
            u = parseFloat(this.getFloat(s, q.getAttribute("ref")));
            u > 1 ? m.setShininess(u) : m.setShininess(u * 128);
            break;
          case "texture":
            this.createMaterialLayer(q, m, s, e.M_SHINE, j)
        }
      }while(q = q.nextSibling)
    }
    q = t.getElementsByTagName("specular");
    if(q.length > 0) {
      m.setSpecular(1);
      q = q[0].firstChild;
      do {
        switch(q.tagName) {
          case "color":
            u = q.firstChild.nodeValue.replace(/\s+/g, " ").split(" ");
            m.setSpecularColor({r:u[0], g:u[1], b:u[2]});
            break;
          case "param":
            u = this.getFloat4(s, q.getAttribute("ref")).replace(/\s+/g, " ").split(" ");
            m.setSpecularColor({r:u[0], g:u[1], b:u[2]});
            break;
          case "texture":
            this.createMaterialLayer(q, m, s, e.M_SPECCOLOR, j)
        }
      }while(q = q.nextSibling)
    }
    q = t.getElementsByTagName("emission");
    if(q.length > 0) {
      q = q[0].firstChild;
      do {
        switch(q.tagName) {
          case "color":
            u = q.firstChild.nodeValue.split(" ");
            m.setEmit({r:u[0], g:u[1], b:u[2]});
            break;
          case "param":
            u = this.getFloat4(s, q.getAttribute("ref")).split(" ");
            m.setEmit(u[0]);
            break;
          case "texture":
            this.createMaterialLayer(q, m, s, e.M_EMIT, j)
        }
      }while(q = q.nextSibling)
    }
    q = t.getElementsByTagName("reflective");
    if(q.length > 0) {
      q = q[0].firstChild;
      do {
        switch(q.tagName) {
          case "color":
            q.firstChild.nodeValue.replace(/\s+/g, " ").split(" ");
            break;
          case "param":
            this.getFloat4(s, q.getAttribute("ref")).replace(/\s+/g, " ").split(" ");
            break;
          case "texture":
            this.createMaterialLayer(q, m, s, e.M_REFLECT, j)
        }
      }while(q = q.nextSibling)
    }
    q = t.getElementsByTagName("transparency");
    if(q.length > 0) {
      q = q[0].firstChild;
      do {
      }while(q = q.nextSibling)
    }
    q = t.getElementsByTagName("transparent");
    if(q.length > 0) {
      (t = q[0].getAttribute("opaque")) || (t = "A_ONE");
      q = q[0].firstChild;
      do {
        switch(q.tagName) {
          case "float":
            u = parseFloat(q.firstChild.nodeValue);
            if(u < 1) {
              m.setAlpha(parseFloat(q.firstChild.nodeValue)), m.trans = !0
            }
            break;
          case "color":
            u = q.firstChild.nodeValue.replace(/\s+/g, " ").split(" ");
            u = this.getMaterialAlpha(u, t, 1);
            if(u < 1) {
              m.setAlpha(u), m.trans = !0
            }
            break;
          case "param":
            u = this.getFloat4(s, q.getAttribute("ref")).replace(/\s+/g, " ").split(" ");
            u = this.getMaterialAlpha(u, t, 1);
            if(u < 1) {
              m.setAlpha(u), m.trans = !0
            }
            break;
          case "texture":
            this.createMaterialLayer(q, m, s, e.M_ALPHA, j), m.trans = !0
        }
      }while(q = q.nextSibling)
    }
    return m
  };
  e.Collada.prototype.getMaterialAlpha = function(e, f, g) {
    var h;
    switch(f) {
      case "A_ONE":
        h = parseFloat(e[3]) * g;
        break;
      case "A_ZERO":
        h = 1 - parseFloat(e[3]) * g;
        break;
      case "RGB_ONE":
        e = parseFloat(e[0]) * 0.212671 + parseFloat(e[1]) * 0.71516 + parseFloat(e[2]) * 0.072169;
        h = e * g;
        break;
      case "RGB_ZERO":
        e = parseFloat(e[0]) * 0.212671 + parseFloat(e[1]) * 0.71516 + parseFloat(e[2]) * 0.072169, h = 1 - e * g
    }
    return h
  };
  e.Collada.prototype.setMaterialOntoMesh = function(f, g) {
    for(var h = g.getElementsByTagName("instance_material"), j = {}, m = 0;m < h.length;m++) {
      for(var q = h[m].getElementsByTagName("bind_vertex_input"), u = {}, v = 0;v < q.length;v++) {
        q[v].hasAttribute("input_set") ? u[q[v].getAttribute("semantic")] = q[v].getAttribute("input_set") : u[q[v].getAttribute("semantic")] = function(e) {
          for(var f = "", g = e.length - 1;g >= 0;--g) {
            e[g] >= "0" && e[g] <= "9" && (f = e[g] + f)
          }
          if(f.length == 0) {
            return"0"
          }
          return f
        }(q[v].getAttribute("semantic"))
      }
      mat = this.getMaterial(h[m].getAttribute("target").substr(1), u);
      j[h[m].getAttribute("symbol")] = mat
    }
    h = new e.Object;
    for(m = 0;m < f.length;m++) {
      j[f[m].matName] && j[f[m].matName].trans && (h.setZtransparent(!0), h.setPickable(!1)), q = new e.MultiMaterial, q.setMesh(f[m]), j[f[m].matName] || (j[f[m].matName] = new e.Material, j[f[m].matName].setColor("lightgrey")), q.setMaterial(j[f[m].matName]), h.addMultiMaterial(q)
    }
    h.setSkeleton(this);
    g.GLGEObj = h
  };
  e.Collada.prototype.getInstanceGeometry = function(e) {
    var f = e.getAttribute("url").substr(1);
    this.setMaterialOntoMesh(this.getMeshes(f), e);
    e.GLGEObj.id = f;
    return e.GLGEObj
  };
  e.Collada.prototype.getAnimationSampler = function(f, g) {
    for(var h = this.xml.getElementById(f).getElementsByTagName("input"), j = {}, m = [], q, u, v = 0;v < h.length;v++) {
      q = this.getSource(h[v].getAttribute("source").substr(1)), u = h[v].getAttribute("semantic"), m.push({block:u, data:q})
    }
    for(n = 0;n < m.length;n++) {
      u = m[n].block;
      j[u] = {};
      j[u].data = [];
      j[u].names = [];
      for(k = 0;k < m[n].data.array.length;k += m[n].data.stride) {
        for(v = q = 0;v < m[n].data.pmask.length;v++) {
          if(m[n].data.pmask[v]) {
            if(j[u].names.push(m[n].data.pmask[v].name), m[n].data.pmask[v].type == "float4x4") {
              j[u].stride = 16;
              for(h = 0;h < 16;h++) {
                j[u].data.push(m[n].data.array[h + k + m[n].data.offset + v])
              }
            }else {
              q++, j[u].stride = q, j[u].data.push(m[n].data.array[k + m[n].data.offset + v])
            }
          }
        }
      }
    }
    u = [];
    for(v = 0;v < j.OUTPUT.stride;v++) {
      u.push(new e.AnimationCurve)
    }
    for(v = 0;v < j.INPUT.data.length;v++) {
      for(h = 0;h < j.OUTPUT.stride;h++) {
        u[h].name = j.OUTPUT.names[h];
        j.INTERPOLATION && j.INTERPOLATION.data[v] == "BEZIER" && !j.IN_TANGENT && (j.INTERPOLATION.data[v] = "LINEAR");
        if(!j.INTERPOLATION || j.INTERPOLATION.data[v] == "LINEAR") {
          m = new e.LinearPoint, m.setX(j.INPUT.data[v] * 30), q = parseFloat(j.OUTPUT.data[v * j.OUTPUT.stride + h]), q == -180 && (q = -179.9), q == 180 && (q = 179.9), this.exceptions.flipangle && g && u[h].lastval && (Math.abs(u[h].lastval - (360 + q)) < Math.abs(u[h].lastval - q) ? q = 360 + q : Math.abs(u[h].lastval - (q - 360)) < Math.abs(u[h].lastval - q) && (q -= 360)), m.setY(q), u[h].lastval = q, u[h].addPoint(m)
        }
        j.INTERPOLATION && j.INTERPOLATION.data[v] == "BEZIER" && (m = new e.BezTriple, m.setX1(j.IN_TANGENT.data[(v * j.OUTPUT.stride + h) * 2] * 30), m.setY1(j.IN_TANGENT.data[(v * j.OUTPUT.stride + h) * 2 + 1]), m.setX2(Math.round(j.INPUT.data[v] * 30)), m.setY2(j.OUTPUT.data[v * j.OUTPUT.stride + h]), m.setX3(j.OUT_TANGENT.data[(v * j.OUTPUT.stride + h) * 2] * 30), m.setY3(j.OUT_TANGENT.data[(v * j.OUTPUT.stride + h) * 2 + 1]), u[h].addPoint(m))
      }
    }
    return u
  };
  e.Collada.prototype.getAnimationVector = function(f) {
    var g = 0, h = this.xml.getElementById(f[0].target[0]).firstChild, j = [], m = {};
    do {
      switch(h.tagName) {
        case "matrix":
        ;
        case "translate":
        ;
        case "rotate":
        ;
        case "scale":
          def = {type:h.tagName, data:this.parseArray(h), animations:[]}, h.hasAttribute("sid") && (m[h.getAttribute("sid")] = def), j.push(def)
      }
      h = h.nextSibling
    }while(h);
    for(h = 0;h < f.length;h++) {
      for(var q = f[h].target, u = this.getAnimationSampler(f[h].source, /ANGLE/i.test(q)), v = 0;v < u.length;v++) {
        g = Math.max(g, u[v].keyFrames[u[v].keyFrames.length - 1].x)
      }
      if(q[1].indexOf(".") != -1) {
        switch(q = q[1].split("."), q[1]) {
          case "X":
            m[q[0]].animations[0] = u[0];
            break;
          case "Y":
            m[q[0]].animations[1] = u[0];
            break;
          case "Z":
            m[q[0]].animations[2] = u[0];
            break;
          case "ANGLE":
            m[q[0]].animations[3] = u[0]
        }
      }else {
        if(q[1].indexOf("(") != -1) {
          q = q[1].split("("), sidtarget = q.shift(), q = q.length > 1 ? parseInt(q[0]) + 4 * parseInt(q[1]) : parseInt(q[0]), m[sidtarget].animations[q] = u[0]
        }else {
          for(var v = 0;v < u.length;v++) {
            switch(u[v].name) {
              case "X":
                m[q[1]].animations[0] = u[v];
                break;
              case "Y":
                m[q[1]].animations[1] = u[v];
                break;
              case "Z":
                m[q[1]].animations[2] = u[v];
                break;
              case "ANGLE":
                m[q[1]].animations[3] = u[v];
                break;
              default:
                m[q[1]].animations[v] = u[v]
            }
          }
        }
      }
    }
    f = new e.AnimationVector;
    g == 0 && (g = 1);
    f.setFrames(g);
    m = new e.AnimationCurve;
    m.setChannel("QuatX");
    u = new e.AnimationCurve;
    u.setChannel("QuatY");
    q = new e.AnimationCurve;
    q.setChannel("QuatZ");
    v = new e.AnimationCurve;
    v.setChannel("QuatW");
    var w = new e.AnimationCurve;
    w.setChannel("LocX");
    var B = new e.AnimationCurve;
    B.setChannel("LocY");
    var A = new e.AnimationCurve;
    A.setChannel("LocZ");
    var D = new e.AnimationCurve;
    D.setChannel("ScaleX");
    var C = new e.AnimationCurve;
    C.setChannel("ScaleY");
    var G = new e.AnimationCurve;
    G.setChannel("ScaleZ");
    f.addAnimationCurve(m);
    f.addAnimationCurve(u);
    f.addAnimationCurve(q);
    f.addAnimationCurve(v);
    f.addAnimationCurve(w);
    f.addAnimationCurve(B);
    f.addAnimationCurve(A);
    f.addAnimationCurve(D);
    f.addAnimationCurve(C);
    f.addAnimationCurve(G);
    for(var E = null, J = [], F = 0;F < g;F++) {
      for(var H = e.identMatrix(), h = 0;h < j.length;h++) {
        switch(j[h].type) {
          case "matrix":
            var I = [j[h].animations[0] ? j[h].animations[0].getValue(F) : j[h].data[0], j[h].animations[1] ? j[h].animations[1].getValue(F) : j[h].data[1], j[h].animations[2] ? j[h].animations[2].getValue(F) : j[h].data[2], j[h].animations[3] ? j[h].animations[3].getValue(F) : j[h].data[3], j[h].animations[4] ? j[h].animations[4].getValue(F) : j[h].data[4], j[h].animations[5] ? j[h].animations[5].getValue(F) : j[h].data[5], j[h].animations[6] ? j[h].animations[6].getValue(F) : j[h].data[6], j[h].animations[7] ?
            j[h].animations[7].getValue(F) : j[h].data[7], j[h].animations[8] ? j[h].animations[8].getValue(F) : j[h].data[8], j[h].animations[9] ? j[h].animations[9].getValue(F) : j[h].data[9], j[h].animations[10] ? j[h].animations[10].getValue(F) : j[h].data[10], j[h].animations[11] ? j[h].animations[11].getValue(F) : j[h].data[11], j[h].animations[12] ? j[h].animations[12].getValue(F) : j[h].data[12], j[h].animations[13] ? j[h].animations[13].getValue(F) : j[h].data[13], j[h].animations[14] ?
            j[h].animations[14].getValue(F) : j[h].data[14], j[h].animations[15] ? j[h].animations[15].getValue(F) : j[h].data[15]], H = e.mulMat4(H, e.Mat4(I));
            break;
          case "rotate":
            I = [j[h].animations[0] ? j[h].animations[0].getValue(F) : j[h].data[0], j[h].animations[1] ? j[h].animations[1].getValue(F) : j[h].data[1], j[h].animations[2] ? j[h].animations[2].getValue(F) : j[h].data[2], j[h].animations[3] ? J[h] = j[h].animations[3].getValue(F, J[h], !0) : j[h].data[3]];
            H = e.mulMat4(H, e.angleAxis(I[3] * 0.017453278, [I[0], I[1], I[2]]));
            break;
          case "translate":
            I = [j[h].animations[0] ? j[h].animations[0].getValue(F) : j[h].data[0], j[h].animations[1] ? j[h].animations[1].getValue(F) : j[h].data[1], j[h].animations[2] ? j[h].animations[2].getValue(F) : j[h].data[2]];
            H = e.mulMat4(H, e.translateMatrix(I[0], I[1], I[2]));
            break;
          case "scale":
            I = [j[h].animations[0] ? j[h].animations[0].getValue(F) : j[h].data[0], j[h].animations[1] ? j[h].animations[1].getValue(F) : j[h].data[1], j[h].animations[2] ? j[h].animations[2].getValue(F) : j[h].data[2]], H = e.mulMat4(H, e.scaleMatrix(I[0], I[1], I[2]))
        }
      }
      scale = e.matrix2Scale(H);
      H = e.mulMat4(H, e.scaleMatrix(1 / scale[0], 1 / scale[1], 1 / scale[2]));
      quat = e.rotationMatrix2Quat(H);
      E && E[0] * quat[0] + E[1] * quat[1] + E[2] * quat[2] + E[3] * quat[3] < 0 && (quat[0] *= -1, quat[1] *= -1, quat[2] *= -1, quat[3] *= -1);
      E = quat;
      point = new e.LinearPoint;
      point.setX(F);
      point.setY(quat[0]);
      m.addPoint(point);
      point = new e.LinearPoint;
      point.setX(F);
      point.setY(quat[1]);
      u.addPoint(point);
      point = new e.LinearPoint;
      point.setX(F);
      point.setY(quat[2]);
      q.addPoint(point);
      point = new e.LinearPoint;
      point.setX(F);
      point.setY(quat[3]);
      v.addPoint(point);
      point = new e.LinearPoint;
      point.setX(F);
      point.setY(H[3]);
      w.addPoint(point);
      point = new e.LinearPoint;
      point.setX(F);
      point.setY(H[7]);
      B.addPoint(point);
      point = new e.LinearPoint;
      point.setX(F);
      point.setY(H[11]);
      A.addPoint(point);
      point = new e.LinearPoint;
      point.setX(F);
      point.setY(scale[0].toFixed(4));
      D.addPoint(point);
      point = new e.LinearPoint;
      point.setX(F);
      point.setY(scale[1].toFixed(4));
      C.addPoint(point);
      point = new e.LinearPoint;
      point.setX(F);
      point.setY(scale[2].toFixed(4));
      G.addPoint(point)
    }
    return f
  };
  var j = {};
  e.Collada.prototype.getAnimations = function() {
    if(j[this.url]) {
      this.actions = j[this.url]
    }else {
      var f = this.xml.getElementsByTagName("animation_clip"), g = this.xml.getElementsByTagName("animation");
      if(f.length == 0) {
        g.name = "default";
        var h = [g]
      }else {
        for(var h = [], m = 0;m < f.length;m++) {
          for(var g = [], t = f[m].getElementsByTagName("instance_animation"), q = 0;q < t.length;q++) {
            g.push(this.xml.getElementById(t[q].getAttribute("url").substr(1)))
          }
          g.name = f[m].getAttribute("id");
          h.push(g)
        }
      }
      for(f = 0;f < h.length;f++) {
        for(var g = h[f], u, v, w, t = {}, m = 0;m < g.length;m++) {
          u = g[m].getElementsByTagName("channel");
          for(q = 0;q < u.length;q++) {
            v = u[q].getAttribute("target").split("/"), w = u[q].getAttribute("source").substr(1), t[v[0]] || (t[v[0]] = []), t[v[0]].push({source:w, target:v})
          }
        }
        q = new e.Action;
        for(v in t) {
          u = this.getAnimationVector(t[v]);
          w = this.xml.getElementById(v);
          for(m = 0;m < w.GLGEObjects.length;m++) {
            var B = new e.ActionChannel, A = w.GLGEObjects[m].getName();
            B.setTarget(A);
            B.setAnimation(u);
            q.addActionChannel(B)
          }
        }
        this.addColladaAction({name:g.name, action:q})
      }
    }
    j[this.url] = this.actions;
    for(n in this.actions) {
      this.setAction(this.actions[n], 0, !0);
      break
    }
  };
  e.Collada.prototype.addColladaAction = function(e) {
    this.actions[e.name] = e.action
  };
  e.Collada.prototype.getColladaActions = function() {
    return this.actions
  };
  e.Collada.prototype.getInstanceController = function(f) {
    new e.Object;
    var g = this.xml.getElementById(f.getAttribute("url").substr(1)), h = f.getElementsByTagName("skeleton"), j = g.getElementsByTagName("joints")[0], m = j.getElementsByTagName("input"), q;
    q = g.getElementsByTagName("bind_shape_matrix").length > 0 ? this.parseArray(g.getElementsByTagName("bind_shape_matrix")[0]) : e.identMatrix();
    var u = [q], j = new e.Group;
    this.addGroup(j);
    for(var j = [j], v, w = 0;w < m.length;w++) {
      if(m[w].getAttribute("semantic") == "JOINT") {
        var B = this.getSource(m[w].getAttribute("source").substr(1));
        if(B.type == "IDREF_array") {
          v = B.array.length != 0;
          for(var A = 0;A < B.array.length;A += B.stride) {
            var D = this.getNode(this.xml.getElementById(B.array[A]), !0).getName();
            this.xml.getElementById(B.array[A]) ? v = !1 : (e.error("Bone is not specified " + B.array[A]), u = [q = e.identMatrix()]);
            j.push(D)
          }
          v && (u = [q = e.identMatrix()])
        }else {
          if(B.type == "Name_array") {
            var C = {};
            if(h.length == 0) {
              for(var G = this.xml.getElementsByTagName("node"), A = 0;A < G.length;A++) {
                (D = G[A].getAttribute("sid")) && (C[D] = G[A]), (D = G[A].getAttribute("name")) && !C[D] && (C[D] = G[A])
              }
            }else {
              for(v = 0;v < h.length;v++) {
                A = this.xml.getElementById(h[v].firstChild.nodeValue.substr(1));
                (D = A.getAttribute("sid")) && (C[D] = A);
                G = A.getElementsByTagName("*");
                for(A = 0;A < G.length;A++) {
                  (D = G[A].getAttribute("sid")) && (C[D] = G[A]), (D = G[A].getAttribute("name")) && !C[D] && (C[D] = G[A])
                }
              }
            }
            for(A = 0;A < B.array.length;A += B.stride) {
              B.array[A] != "" && (D = this.getNode(C[B.array[A]], !0).getName(), j.push(D))
            }
          }
        }
      }
    }
    for(w = 0;w < m.length;w++) {
      if(m[w].getAttribute("semantic") == "INV_BIND_MATRIX") {
        h = this.getSource(m[w].getAttribute("source").substr(1));
        for(A = 0;A < h.array.length;A += h.stride) {
          v = h.array.slice(A, A + 16), u.push(e.mulMat4(e.Mat4(v), e.Mat4(q.slice(0, 16))))
        }
      }
    }
    w = g.getElementsByTagName("vertex_weights")[0];
    m = w.getElementsByTagName("input");
    q = [];
    h = {};
    for(v = 0;v < m.length;v++) {
      B = m[v].getAttribute("semantic"), m[v].data = this.getSource(m[v].getAttribute("source").substr(1)), m[v].block = B, h[B] = [], A = m[v].getAttribute("offset"), q[A] || (q[A] = []), q[A].push(m[v])
    }
    m = this.parseArray(w.getElementsByTagName("vcount")[0]);
    C = this.parseArray(w.getElementsByTagName("v")[0]);
    for(w = D = 0;w < m.length;w++) {
      m[w] && (D = Math.max(D, parseInt(m[w])))
    }
    for(w = vPointer = 0;w < m.length;w++) {
      for(G = 0;G < m[w];G++) {
        for(A = 0;A < q.length;A++) {
          for(var E = 0;E < q[A].length;++E) {
            B = q[A][E].block;
            for(v = 0;v < q[A][E].data.stride;v++) {
              q[A][E].data.pmask[v] && (B != "JOINT" ? h[B].push(q[A][E].data.array[parseInt(C[vPointer]) + parseInt(q[A][E].data.offset)]) : h[B].push(parseInt(C[vPointer])), vPointer++)
            }
          }
        }
      }
      for(;G < D;G++) {
        for(A = 0;A < q.length;A++) {
          for(E = 0;E < q[A].length;++E) {
            B = q[A][E].block, h[B].push(0)
          }
        }
      }
    }
    if(!this.badAccessor && h.JOINT.length == 0) {
      return this.badAccessor = !0, this.getInstanceController(f)
    }
    for(w = 0;w < h.JOINT.length;w++) {
      h.JOINT[w]++
    }
    if(this.exceptions.negjoints) {
      for(w = 0;w < h.JOINT.length;w++) {
        h.JOINT[w] == 0 && (h.WEIGHT[w] = 0)
      }
    }
    u = {vertexJoints:h.JOINT, vertexWeight:h.WEIGHT, joints:j, inverseBindMatrix:u, count:D};
    this.setMaterialOntoMesh(this.getMeshes(g.getElementsByTagName("skin")[0].getAttribute("source").substr(1), u), f);
    return f.GLGEObj
  };
  e.Collada.prototype.getInstanceLight = function(f) {
    var g = f.getElementsByTagName("technique_common")[0].getElementsByTagName("*")[0], f = new e.Light, h = g.getElementsByTagName("color");
    h.length > 0 && (h = h[0].firstChild.nodeValue.split(" "), f.setColor("rgb(" + (h[0] * 255 | 0) + "," + (h[1] * 255 | 0) + "," + (h[2] * 255 | 0) + ")"));
    switch(g.tagName) {
      case "point":
        f.setType(e.L_POINT);
      case "spot":
        h = g.getElementsByTagName("constant_attenuation");
        h.length > 0 && f.setAttenuationConstant(parseFloat(h[0].firstChild.nodeValue));
        h = g.getElementsByTagName("linear_attenuation");
        h.length > 0 && f.setAttenuationLinear(parseFloat(h[0].firstChild.nodeValue));
        h = g.getElementsByTagName("quadratic_attenuation");
        h.length > 0 && f.setAttenuationQuadratic(parseFloat(h[0].firstChild.nodeValue));
        if(g.tagName == "spot") {
          f.setType(e.L_SPOT)
        }else {
          break
        }
        h = g.getElementsByTagName("falloff_exponent");
        h.length > 0 && (h = parseFloat(h[0].firstChild.nodeValue), h < 1.0001 && (h *= 128), f.setSpotExponent(h));
        g = g.getElementsByTagName("falloff_angle");
        g.length > 0 && f.setSpotCosCutOff(Math.cos(parseFloat(g[0].firstChild.nodeValue) / 180 * Math.PI))
    }
    return f
  };
  e.Collada.prototype.addColladaCamera = function(e) {
    e.matrix = null;
    e.parent = this;
    this.children.push(e);
    this.hasCamera = !0;
    return this
  };
  e.Collada.prototype.getNode = function(f, g) {
    if(!g && f.GLGEObject) {
      return h = f.GLGEObject, delete this.GLGEObject, h
    }
    if(g && f && f.GLGEObjects) {
      return f.GLGEObjects[0]
    }
    var h = new e.Group, j = "bone" + ++this.boneIdx;
    h.setName(j);
    if(!f) {
      return h
    }
    if(!f.GLGEObjects) {
      f.GLGEObjects = []
    }
    f.GLGEObjects.push(h);
    var j = f.firstChild, m = e.identMatrix(), q;
    if(j) {
      do {
        switch(j.tagName) {
          case "node":
            h.addGroup(this.getNode(j));
            break;
          case "instance_node":
            h.addGroup(this.getNode(this.xml.getElementById(j.getAttribute("url").substr(1))));
            break;
          case "instance_visual_scene":
            h.addGroup(this.getNode(this.xml.getElementById(j.getAttribute("url").substr(1))));
            break;
          case "instance_light":
            this.useLights && h.addLight(this.getInstanceLight(this.xml.getElementById(j.getAttribute("url").substr(1))));
            break;
          case "instance_geometry":
            h.addObject(this.getInstanceGeometry(j));
            break;
          case "instance_controller":
            h.addObject(this.getInstanceController(j));
            break;
          case "instance_camera":
            if(!this.useCamera) {
              break
            }
            h.addColladaCamera(this.getNode(this.xml.getElementById(j.getAttribute("url").substr(1))));
            break;
          case "optics":
            if(!this.useCamera) {
              break
            }
            if((q = j.getElementsByTagName("technique_common")) && q.length > 0) {
              if((q = q[0].getElementsByTagName("perspective")) && q.length > 0) {
                var u = q[0].getElementsByTagName("yfov");
                if(u && u.length > 0) {
                  h.yFov = parseFloat(u[0].textContent)
                }
                if((u = q[0].getElementsByTagName("znear")) && u.length > 0) {
                  h.zNear = parseFloat(u[0].textContent)
                }
                if((q = q[0].getElementsByTagName("zfar")) && q.length > 0) {
                  h.zFar = parseFloat(q[0].textContent)
                }
              }
            }
            break;
          case "matrix":
            m = this.parseArray(j);
            break;
          case "translate":
            q = this.parseArray(j);
            m = e.mulMat4(m, e.translateMatrix(q[0], q[1], q[2]));
            break;
          case "rotate":
            q = this.parseArray(j);
            m = e.mulMat4(m, e.angleAxis(q[3] * 0.017453278, [q[0], q[1], q[2]]));
            break;
          case "scale":
            q = this.parseArray(j), m = e.mulMat4(m, e.scaleMatrix(q[0], q[1], q[2]))
        }
      }while(j = j.nextSibling)
    }
    h.setLoc(m[3], m[7], m[11]);
    j = e.Mat4([m[0], m[1], m[2], 0, m[4], m[5], m[6], 0, m[8], m[9], m[10], 0, 0, 0, 0, 1]);
    h.setRotMatrix(j);
    if(g) {
      f.GLGEObject = h
    }
    return h
  };
  e.Collada.prototype.initVisualScene = function() {
    var f = this.xml.getElementsByTagName("asset"), h = "Z_UP";
    if(f.length && (f = f[0].getElementsByTagName("up_axis"), f.length)) {
      f = f[0], f = f.firstChild.nodeValue, f.length && (h = f)
    }
    f = this;
    h[0] != "Y" && h[0] != "y" && (f = new e.Group, this.addChild(f), h[0] != "Z" && h[0] != "z" ? this.setRotMatrix(e.Mat4([0, -1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1])) : this.setRotMatrix(e.Mat4([1, 0, 0, 0, 0, 0, 1, 0, 0, -1, 0, 0, 0, 0, 0, 1])));
    this.rootId ? (h = this.xml.getElementById(this.rootId)) ? f.addGroup(this.getNode(h)) : e.error("Asset " + this.rootId + " not found in document" + this.url) : (h = this.xml.getElementsByTagName("scene"), h.length > 0 ? f.addGroup(this.getNode(h[0])) : e.error("Please indicate the asset to render in Collada Document" + this.url));
    if(this.useCamera) {
      var g, j = function(e) {
        if(e.hasCamera) {
          g = e
        }else {
          if(e.children) {
            for(var f = 0;f < e.children.length && !g;f++) {
              j(e.children[f])
            }
          }
        }
      };
      j(f);
      if(g) {
        pp = f.parent.parent;
        pp.camera.locX = g.locX;
        pp.camera.locY = g.locY;
        pp.camera.locZ = g.locZ;
        if(g.children && g.children.length > 0) {
          h = g.children[0];
          if(h.yFov) {
            pp.camera.fovy = h.yFov, pp.camera.pMatrix = null
          }
          if(h.zNear) {
            pp.camera.near = h.zNear
          }
          if(h.zFar) {
            pp.camera.far = h.zFar
          }
        }
        pp.camera.matrix = null;
        pp.camera.rotmatrix = g.rotmatrix;
        pp.camera.lookAt = null
      }
    }
  };
  var m = {"default":{}, "COLLADA Mixamo exporter":{badAccessor:!0}, "FBX COLLADA exporter":{badAccessor:!0}, "Blender2.5":{flipangle:!0, negjoints:!0}};
  e.Collada.prototype.getExceptions = function() {
    if(this.xml.getElementsByTagName("authoring_tool").length > 0 && this.xml.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue == "COLLADA Mixamo exporter") {
      return m["COLLADA Mixamo exporter"]
    }
    if(this.xml.getElementsByTagName("authoring_tool").length > 0 && this.xml.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue == "FBX COLLADA exporter") {
      return m["FBX COLLADA exporter"]
    }
    if(this.xml.getElementsByTagName("authoring_tool").length > 0 && /Blender 2.5/.test(this.xml.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue)) {
      return m["Blender2.5"]
    }
  };
  e.Collada.prototype.loaded = function(e, f) {
    this.xml = f;
    if(f.getElementsByTagName("authoring_tool").length > 0) {
      this.exceptions = m[f.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue]
    }
    this.exceptions = this.getExceptions();
    if(!this.exceptions) {
      this.exceptions = m["default"]
    }
    this.initVisualScene();
    this.getAnimations();
    this.loadedCallback && this.loadedCallback(this);
    var h = this;
    setTimeout(function() {
      h.fireEvent("loaded", {url:this.url});
      h.isComplete() && h.fireEvent("downloadComplete", {})
    }, 1)
  };
  e.Scene.prototype.addCollada = e.Scene.prototype.addGroup;
  e.Group.prototype.addCollada = e.Group.prototype.addGroup;
  if(e.Document) {
    e.Document.prototype.getCollada = function(f) {
      if(!f.object) {
        f.object = new (e[this.classString(f.tagName)]), f.object.setDocument(f.getAttribute("document"), this.getAbsolutePath(this.rootURL, null)), f.removeAttribute("document"), this.setProperties(f)
      }
      return f.object
    }
  }
})(GLGE);
(function(e) {
  e.FilterScanlines = function() {
  };
  e.augment(e.Filter2d, e.FilterScanlines);
  e.FilterScanlines.prototype.intensity = 0.95;
  e.FilterScanlines.prototype.setIntensity = function(e) {
    this.intensity = e;
    this.createPasses();
    return this
  };
  e.FilterScanlines.prototype.GLRender = function(f, g) {
    if(!this.gl) {
      this.gl = f, this.createPasses()
    }
    return e.Filter2d.prototype.GLRender.call(this, f, g)
  };
  e.FilterScanlines.prototype.createPasses = function() {
    if(this.gl) {
      var e = this.gl.canvas.height, g = [];
      g.push("precision highp float;");
      g.push("uniform sampler2D GLGE_RENDER;");
      g.push("varying vec2 texCoord;");
      g.push("void main(void){");
      g.push("vec4 color=texture2D(GLGE_RENDER, texCoord.xy);");
      g.push("if(mod(texCoord.y," + 2 / e + ")>" + 1 / e + ") color.rgb*=" + this.intensity + ";");
      g.push("color.rgb*=pow(1.0-length(texCoord.xy-0.5),1.3);");
      g.push("color.rgb*=vec3(0.93,1.0,0.93);");
      g.push("gl_FragColor = vec4(color.rgb,1.0);");
      g.push("}");
      this.passes = [];
      this.addPass(g.join(""))
    }
  }
})(GLGE);
(function(e) {
  e.FilterGlow = function() {
    this.setEmitBufferWidth(256);
    this.setEmitBufferHeight(256)
  };
  e.augment(e.Filter2d, e.FilterGlow);
  e.FilterGlow.prototype.renderEmit = !0;
  e.FilterGlow.prototype.blur = 1.2;
  e.FilterGlow.prototype.intensity = 3;
  e.FilterGlow.prototype.setEmitBufferWidth = function(f) {
    e.Filter2d.prototype.setEmitBufferWidth.call(this, f);
    this.createPasses();
    return this
  };
  e.FilterGlow.prototype.setEmitBufferHeight = function(f) {
    e.Filter2d.prototype.setEmitBufferHeight.call(this, f);
    this.createPasses();
    return this
  };
  e.FilterGlow.prototype.setBlur = function(e) {
    this.blur = e;
    this.createPasses();
    return this
  };
  e.FilterGlow.prototype.setIntensity = function(e) {
    this.intensity = e;
    this.createPasses();
    return this
  };
  e.FilterGlow.prototype.createPasses = function() {
    var e = [];
    e.push("precision highp float;");
    e.push("uniform sampler2D GLGE_EMIT;");
    e.push("varying vec2 texCoord;");
    e.push("float blurSize=" + (1 / this.emitBufferWidth * this.blur).toFixed(10) + ";");
    e.push("float rand(vec2 co){;");
    e.push("return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);");
    e.push("}");
    e.push("void main(void){");
    e.push("vec4 color=vec4(0.0,0.0,0.0,0.0);");
    e.push("float rnd=1.0-rand(texCoord.xy)*4.0*blurSize;");
    e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x - 4.0*blurSize, texCoord.y)) * 0.05 * rnd;");
    e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x - 3.0*blurSize, texCoord.y)) * 0.09 * rnd;");
    e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x - 2.0*blurSize, texCoord.y)) * 0.12 * rnd;");
    e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x - blurSize, texCoord.y)) * 0.15 * rnd;");
    e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x, texCoord.y)) * 0.18 * rnd;");
    e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x + blurSize, texCoord.y)) * 0.15 * rnd;");
    e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x + 2.0*blurSize, texCoord.y)) * 0.12 * rnd;");
    e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x + 3.0*blurSize, texCoord.y)) * 0.09 * rnd;");
    e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x + 4.0*blurSize, texCoord.y)) * 0.05 * rnd;");
    e.push("gl_FragColor = vec4(color.rgb,1.0);");
    e.push("}");
    var g = [];
    g.push("precision highp float;");
    g.push("uniform sampler2D GLGE_PASS0;");
    g.push("uniform sampler2D GLGE_RENDER;");
    g.push("uniform sampler2D GLGE_EMIT;");
    g.push("varying vec2 texCoord;");
    g.push("float blurSize=" + (1 / this.emitBufferHeight * this.blur).toFixed(10) + ";");
    g.push("float rand(vec2 co){;");
    g.push("return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);");
    g.push("}");
    g.push("void main(void){");
    g.push("vec4 color=vec4(0.0,0.0,0.0,0.0);");
    g.push("float rnd=1.0-rand(texCoord.xy)*4.0*blurSize;");
    g.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y - 4.0*blurSize)) * 0.05 * rnd;");
    g.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y - 3.0*blurSize)) * 0.09 * rnd;");
    g.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y - 2.0*blurSize)) * 0.12 * rnd;");
    g.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y - blurSize)) * 0.15 * rnd;");
    g.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y)) * 0.18 * rnd;");
    g.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y + blurSize)) * 0.15 * rnd;");
    g.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y + 2.0*blurSize)) * 0.12 * rnd;");
    g.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y + 3.0*blurSize)) * 0.09 * rnd;");
    g.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y + 4.0*blurSize)) * 0.05 * rnd;");
    g.push("gl_FragColor = vec4(color.rgb*" + this.intensity.toFixed(5) + "+texture2D(GLGE_RENDER,texCoord).rgb,1.0);");
    g.push("}");
    this.passes = [];
    this.addPass(e.join(""));
    this.addPass(g.join(""))
  }
})(GLGE);
(function(e) {
  e.FilterAO = function() {
    this.setUniform("1f", "cavitygamma", 1 / 3);
    this.setUniform("1f", "whiteMul", 2);
    this.setUniform("1f", "aogamma", 1 / 3);
    this.setUniform("1f", "maxDist", 0.025);
    this.passes = []
  };
  e.augment(e.Filter2d, e.FilterAO);
  e.FilterAO.prototype.renderNormal = !0;
  e.FilterAO.prototype.quality = 1;
  e.FilterAO.prototype.range = 80;
  e.FilterAO.prototype.samples = 16;
  e.FilterAO.prototype.useRender = !0;
  e.FilterAO.prototype.getNormalBufferHeight = function() {
    return this.normalBufferHeight ? this.normalBufferHeight : this.gl.canvas.height * this.quality | 0
  };
  e.FilterAO.prototype.getNormalBufferWidth = function() {
    return this.normalBufferWidth ? this.normalBufferWidth : this.gl.canvas.width * this.quality | 0
  };
  e.FilterAO.prototype.setUseRender = function(e) {
    this.useRender = e;
    this.normalBuffers = null;
    this.passes = [];
    return this
  };
  e.FilterAO.prototype.setSamples = function(e) {
    this.samples = e;
    this.normalBuffers = null;
    this.passes = [];
    return this
  };
  e.FilterAO.prototype.setQuality = function(e) {
    this.quality = e;
    this.normalBuffers = null;
    this.passes = [];
    return this
  };
  e.FilterAO.prototype.setRange = function(e) {
    this.range = e;
    this.gl && (this.setUniform("1f", "blurX", this.range / this.getNormalBufferWidth() * this.quality / this.samples), this.setUniform("1f", "blurY", this.range / this.getNormalBufferHeight() / this.samples));
    return this
  };
  e.FilterAO.prototype.setCavityGamma = function(e) {
    this.setUniform("1f", "cavitygamma", 1 / e);
    return this
  };
  e.FilterAO.prototype.setAmbientMultiplier = function(e) {
    this.setUniform("1f", "whiteMul", e);
    return this
  };
  e.FilterAO.prototype.setAmbientGamma = function(e) {
    this.setUniform("1f", "aogamma", 1 / e);
    return this
  };
  e.FilterAO.prototype.setMaximumDistance = function(e) {
    this.setUniform("1f", "maxDist", e);
    return this
  };
  e.FilterAO.prototype.GLRender = function(f, g) {
    this.gl = f;
    this.passes.length == 0 && this.createPasses();
    return e.Filter2d.prototype.GLRender.call(this, f, g)
  };
  e.FilterAO.prototype.createPasses = function() {
    if(this.gl) {
      for(var e = this.getNormalBufferWidth(), g = this.getNormalBufferHeight(), h = this.samples / 4 | 0, j = [], m = -h, p = 0;m <= h;m++, p++) {
        j[p] = (h - Math.abs(m) + 1) / (h * h + h)
      }
      j[h] = 0;
      this.setUniform("1f", "blurX", this.range / e * this.quality / this.samples);
      this.setUniform("1f", "blurY", this.range / g / this.samples);
      var o = [];
      o.push("precision highp float;");
      o.push("uniform sampler2D GLGE_NORMAL;");
      o.push("uniform float maxDist;");
      o.push("varying vec2 texCoord;");
      o.push("uniform float blurX;");
      o.push("float rand(vec2 co){");
      o.push("return (fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453)-0.5)*2.0;");
      o.push("}");
      o.push("void main(void){");
      o.push("vec4 n=texture2D(GLGE_NORMAL,texCoord.xy).rgba;");
      o.push("vec4 color=vec4(0.0,0.0,0.0,n.a);");
      o.push("float blurSize=blurX/(n.a*n.a+1.0);");
      o.push("float offset=rand(texCoord.xy)*blurSize+texCoord.x;");
      o.push("vec3 samp;");
      o.push("float delta;");
      m = -h;
      for(p = 0;m <= h;m++, p++) {
        m != 0 && (o.push("samp = texture2D(GLGE_NORMAL, vec2(" + m + ".0*blurSize+offset, texCoord.y)).rga;"), o.push("delta=abs(n.a-samp.b);"), o.push("if(delta<maxDist){"), o.push("delta/=maxDist;"), o.push("color.b -= (samp.r-0.5) * " + j[p] + " * " + (2 * m / Math.abs(m) | 0) + ".0;"), o.push("color.rg += samp.rg * " + j[p] + " * (1.0-delta);"), o.push("color.rg += n.rg  * " + j[p] + " * delta;"), o.push("}else{"), o.push("color.rg +=n.rg * " + j[p] + ";"), o.push("}"))
      }
      o.push("color.b = (color.b+1.0)*0.5;");
      o.push("gl_FragColor = color;");
      o.push("}");
      var r = [];
      r.push("precision highp float;");
      r.push("uniform sampler2D GLGE_PASS0;");
      r.push("uniform sampler2D GLGE_RENDER;");
      r.push("uniform sampler2D GLGE_NORMAL;");
      r.push("varying vec2 texCoord;");
      r.push("uniform float blurY;");
      r.push("uniform float cavitygamma;");
      r.push("uniform float whiteMul;");
      r.push("uniform float aogamma;");
      r.push("uniform float maxDist;");
      r.push("float rand(vec2 co){");
      r.push("return (fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453)-0.5)*2.0;");
      r.push("}");
      r.push("void main(void){");
      r.push("vec4 color=vec4(0.0,0.0,0.0,1.0);");
      r.push("vec4 samp=vec4(0.0);");
      r.push("float random=rand(texCoord.xy);");
      this.quality < 1 ? (r.push("vec2 displace=vec2(" + 0.5 / e + "," + 0.5 / g + ")*random;"), r.push("vec4 n=texture2D(GLGE_PASS0, texCoord.xy+displace);")) : r.push("vec4 n=texture2D(GLGE_PASS0, texCoord.xy);");
      r.push("float delta;");
      r.push("float blurSize=blurY/(n.a*n.a+1.0);");
      r.push("float offset=random*blurSize+texCoord.y;");
      m = -h;
      for(p = 0;m <= h;m++, p++) {
        m != 0 && (this.quality < 1 ? r.push("samp = texture2D(GLGE_PASS0, vec2(texCoord.x, " + m + ".0*blurSize + offset)+displace);") : r.push("samp = texture2D(GLGE_PASS0, vec2(texCoord.x, " + m + ".0*blurSize + offset));"), r.push("delta=abs(n.a-samp.a);"), r.push("if(delta<maxDist){"), r.push("delta/=maxDist;"), r.push("color.a -= (samp.g-0.5) * " + j[p] + " * " + (m * 2 / Math.abs(m) | 0) + ".0;"), r.push("color.rg += samp.rg  * " + j[p] + " * (1.0-delta);"), r.push("color.rg += n.rg * " +
        j[p] + " * delta;"), r.push("}else{"), r.push("color.rg += n.rg * " + j[p] + ";"), r.push("}"))
      }
      r.push("color.a = (color.a+1.0)*n.b;");
      r.push("color.a = pow(color.a,cavitygamma);");
      this.quality < 1 ? (r.push("float dif =  length(color.rg-texture2D(GLGE_NORMAL, texCoord.xy+displace).rg);"), r.push("samp =  texture2D(GLGE_NORMAL, texCoord.xy+displace+" + 1 / this.gl.canvas.height + ").rgba;"), r.push("if(abs(n.a-samp.a)<maxDist) dif =  max(length(color.rg-samp.rg),dif);"), r.push("samp =  texture2D(GLGE_NORMAL, texCoord.xy+displace-" + 1 / this.gl.canvas.height + ").rgba;"), r.push("if(abs(n.a-samp.a)<maxDist) dif =  max(length(color.rg-samp.rg),dif);")) : r.push("float dif =  length(color.rg-texture2D(GLGE_NORMAL, texCoord.xy).rg);");
      r.push("float result = 1.0-((dif*(color.a-0.5)*2.0)+1.0)*0.5;");
      r.push("result = pow(min(result*whiteMul,1.0),aogamma);");
      r.push("gl_FragColor = vec4(vec3(result),1.0);");
      this.useRender && r.push("gl_FragColor = vec4(texture2D(GLGE_RENDER, texCoord.xy).rgb*gl_FragColor.r,1.0);");
      r.push("}");
      this.passes = [];
      this.addPass(o.join(""), e, g);
      this.addPass(r.join(""))
    }
  }
})(GLGE);
var PROTO = {};
PROTO.IsArray = function() {
  return typeof Uint8Array != "undefined" ? function(e) {
    return e instanceof Array || e instanceof Uint8Array
  } : function(e) {
    return e instanceof Array
  }
}();
PROTO.DefineProperty = function() {
  var e;
  typeof Object.defineProperty != "undefined" ? e = function(e, f, h, g) {
    Object.defineProperty(e, f, {get:h, set:g, enumerable:!0, configurable:!1})
  } : Object.prototype.__defineGetter__ && Object.prototype.__defineSetter__ && (e = function(e, f, h, g) {
    typeof h !== "undefined" && e.__defineGetter__(f, h);
    typeof g !== "undefined" && e.__defineSetter__(f, g)
  });
  if(e) {
    try {
      var f = function() {
      };
      e(f.prototype, "x", function() {
        return this.xval * 2
      }, function(e) {
        this.xval = e
      });
      var g = new f;
      g.x = 5;
      g.x != 10 && (PROTO.warn("DefineProperty test gave the wrong result " + g.x), e = void 0)
    }catch(h) {
      PROTO.warn("DefineProperty should be supported, but threw " + h), e = void 0
    }
  }
  return e
}();
PROTO.cloneType = function(e) {
  var f = {}, g;
  for(g in e) {
    f[g] = e[g]
  }
  return f
};
PROTO.wiretypes = {varint:0, fixed64:1, lengthdelim:2, fixed32:5};
PROTO.optional = "optional";
PROTO.repeated = "repeated";
PROTO.required = "required";
PROTO.warn = function(e) {
  typeof self.console != "undefined" && self.console.log && self.console.log(e)
};
PROTO.I64 = function(e, f, g) {
  this.msw = e;
  this.lsw = f;
  if(typeof f === void 0) {
    throw PROTO.warn("Too few arguments passed to I64 constructor: perhaps you meant PROTO.I64.fromNumber()"), "Too few arguments passed to I64 constructor: perhaps you meant PROTO.I64.fromNumber()";
  }
  g === !0 && (g = -1);
  g || (g = 1);
  this.sign = g
};
PROTO.I64.prototype = {toNumber:function() {
  return(this.msw * 4294967296 + this.lsw) * this.sign
}, toString:function() {
  function e(e) {
    for(var f = "", g = 0;g < e;++g) {
      f += "0"
    }
    return f
  }
  var f = this.msw.toString(16), g = this.lsw.toString(16);
  return(this.sign == -1 ? "-" : "") + "0x" + e(8 - f.length) + f + e(8 - g.length) + g
}, equals:function(e) {
  return this.sign == e.sign && this.msw == e.msw && this.lsw == e.lsw
}, hash:function() {
  return this.sign * this.msw + "_" + this.lsw
}, convertToUnsigned:function() {
  var e;
  e = this.lsw;
  var f;
  this.sign < 0 ? (f = 2147483647 - this.msw, f += 2147483647, f += 1, e = 2147483647 - this.lsw, e += 2147483647, e += 2, e == 4294967296 && (e = 0, f += 1)) : f = this.msw;
  return new PROTO.I64(f, e, 1)
}, convertFromUnsigned:function() {
  if(this.msw >= 2147483648) {
    var e = 4294967295 - this.msw, f = 4294967295 - this.lsw + 1;
    f > 4294967295 && (f -= 4294967296, e += 1);
    return new PROTO.I64(e, f, -1)
  }
  return new PROTO.I64(this.msw, this.lsw, this.sign)
}, convertToZigzag:function() {
  var e;
  e = this.sign < 0 ? this.lsw * 2 - 1 : this.lsw * 2;
  var f = this.msw * 2;
  e > 4294967295 && (f += 1, e -= 4294967296);
  e < 0 && (f -= 1, e += 4294967296);
  return new PROTO.I64(f, e, 1)
}, convertFromZigzag:function() {
  var e;
  e = this.msw & 1 ? new PROTO.I64(this.msw >>> 1, 2147483648 + (this.lsw >>> 1), this.lsw & 1 ? -1 : 1) : new PROTO.I64(this.msw >>> 1, this.lsw >>> 1, this.lsw & 1 ? -1 : 1);
  e.sign == -1 && (e.lsw += 1, e.lsw > 4294967295 && (e.msw += 1, e.lsw -= 4294967296));
  return e
}, serializeToLEBase256:function() {
  for(var e = Array(8), f = this.lsw, g = 0;g < 4;g++) {
    e[g] = f & 255, f >>= 8
  }
  f = this.msw;
  for(g = 4;g < 8;g++) {
    e[g] = f & 255, f >>= 8
  }
  return e
}, serializeToLEVar128:function() {
  for(var e = Array(1), f = this.lsw, g = 0;g < 4;g++) {
    e[g] = f & 127;
    f >>>= 7;
    if(f == 0 && this.msw == 0) {
      return e
    }
    e[g] += 128
  }
  e[4] = f & 15 | (this.msw & 7) << 4;
  f = this.msw >>> 3;
  if(f == 0) {
    return e
  }
  e[4] += 128;
  for(g = 5;g < 10;g++) {
    e[g] = f & 127;
    f >>>= 7;
    if(f == 0) {
      break
    }
    e[g] += 128
  }
  return e
}, unsigned_add:function(e) {
  var f = this.lsw + e.lsw, e = this.msw + e.msw, g = f % 4294967296;
  f -= g;
  e += Math.floor(f / 4294967296);
  return new PROTO.I64(e, g, this.sign)
}, sub:function(e) {
  if(e.sign != this.sign) {
    return this.unsigned_add(e)
  }
  if(e.msw > this.msw || e.msw == this.msw && e.lsw > this.lsw) {
    var f = e.sub(this);
    f.sign = -this.sign;
    return f
  }
  f = this.lsw - e.lsw;
  e = this.msw - e.msw;
  f < 0 && (f += 4294967296, e -= 1);
  return new PROTO.I64(e, f, this.sign)
}, less:function(e) {
  if(e.sign != this.sign) {
    return this.sign < 0
  }
  var f = this, g = e;
  this.sign < 0 && (g = this, f = e);
  if(f.msw == g.msw) {
    return f.lsw < g.lsw
  }
  if(f.msw < g.msw) {
    return!0
  }
  return!1
}, unsigned_less:function(e) {
  if(this.msw == e.msw) {
    return this.lsw < e.lsw
  }
  if(this.msw < e.msw) {
    return!0
  }
  return!1
}, add:function(e) {
  if(e.sign < 0 && this.sign >= 0) {
    return this.sub(new PROTO.I64(e.msw, e.lsw, -e.sign))
  }
  if(e.sign >= 0 && this.sign < 0) {
    return e.sub(new PROTO.I64(this.msw, this.lsw, -this.sign))
  }
  return this.unsigned_add(e)
}};
PROTO.I64.fromNumber = function(e) {
  var f = e < 0 ? -1 : 1;
  e *= f;
  var g = e % 4294967296;
  return new PROTO.I64(Math.floor((e - g) / 4294967296), g, f)
};
PROTO.I64.from32pair = function(e, f, g) {
  return new PROTO.I64(e, f, g)
};
PROTO.I64.parseLEVar128 = function(e, f) {
  for(var g = f || new PROTO.I64(0, 0, 1), h = 0, j = !1, m = 1, p = 0;!j && p < 5;p++) {
    var o = e.readByte();
    o >= 128 ? o -= 128 : j = !0;
    h += m * o;
    m *= 128
  }
  for(var r = h % 4294967296, h = Math.floor((h - r) / 4294967296), m = 8, p = 0;!j && p < 5;p++) {
    o = e.readByte(), o >= 128 ? o -= 128 : j = !0, h += m * o, m *= 128
  }
  g.msw = h % 4294967296;
  g.lsw = r;
  g.sign = 1;
  return g
};
PROTO.I64.parseLEBase256 = function(e, f) {
  for(var g = f || new PROTO.I64(0, 0, 1), h = 0, j = 1, m = 0;m < 4;m++) {
    var p = e.readByte();
    h += j * p;
    j *= 256
  }
  for(var o = 0, j = 1, m = 0;m < 4;m++) {
    p = e.readByte(), o += j * p, j *= 256
  }
  g.msw = o;
  g.lsw = h;
  g.sign = 1;
  return g
};
PROTO.I64.ONE = new PROTO.I64.fromNumber(1);
PROTO.I64.ZERO = new PROTO.I64.fromNumber(0);
PROTO.BinaryParser = function(e, f) {
  this.bigEndian = e;
  this.allowExceptions = f
};
PROTO.BinaryParser.prototype.encodeFloat = function(e, f, g) {
  var h, j = Math.pow(2, g - 1) - 1, m = -j + 1, p = m - f, o = isNaN(h = parseFloat(e)) || h == -Infinity || h == Infinity ? h : 0, r = 0, s = 2 * j + 1 + f + 3, t = Array(s), q = (h = o !== 0 ? 0 : h) < 0;
  h = Math.abs(h);
  for(var u = Math.floor(h), v = h - u, w, e = s;e;t[--e] = 0) {
  }
  for(e = j + 2;u && e;t[--e] = u % 2, u = Math.floor(u / 2)) {
  }
  for(e = j + 1;v > 0 && e;(t[++e] = ((v *= 2) >= 1) - 0) && --v) {
  }
  for(e = -1;++e < s && !t[e];) {
  }
  if(t[(h = f - 1 + (e = (r = j + 1 - e) >= m && r <= j ? e + 1 : j + 1 - (r = m - 1))) + 1]) {
    if(!(w = t[h])) {
      for(v = h + 2;!w && v < s;w = t[v++]) {
      }
    }
    for(v = h + 1;w && --v >= 0;(t[v] = !t[v] - 0) && (w = 0)) {
    }
  }
  for(e = e - 2 < 0 ? -1 : e - 3;++e < s && !t[e];) {
  }
  (r = j + 1 - e) >= m && r <= j ? ++e : r < m && (r != j + 1 - s && r < p && this.warn("encodeFloat::float underflow"), e = j + 1 - (r = m - 1));
  (u || o !== 0) && (this.warn(u ? "encodeFloat::float overflow" : "encodeFloat::" + o), r = j + 1, e = j + 2, o == -Infinity ? q = 1 : isNaN(o) && (t[e] = 1));
  h = Math.abs(r + j);
  v = g + 1;
  for(g = "";--v;g = h % 2 + g, h = h >>= 1) {
  }
  v = h = 0;
  e = (g = (q ? "1" : "0") + g + t.slice(e, e + f).join("")).length;
  for(f = [];e;h += (1 << v) * g.charAt(--e), v == 7 && (f[f.length] = h, h = 0), v = (v + 1) % 8) {
  }
  return this.bigEndian ? f.reverse() : f
};
PROTO.BinaryParser.prototype.encodeInt = function(e, f) {
  var g = Math.pow(2, f), h = [];
  (e >= g || e < -(g >> 1)) && this.warn("encodeInt::overflow") && (e = 0);
  for(e < 0 && (e += g);e;h[h.length] = e % 256, e = Math.floor(e / 256)) {
  }
  for(f = -(-f >> 3) - h.length;f--;) {
  }
  return this.bigEndian ? h.reverse() : h
};
(function() {
  var e = new ArrayBuffer(8), f = new ArrayBuffer(4), g = new DataView(e, 0, 8), h = new DataView(f, 0, 4), j = new Uint8Array(e), m = new Uint8Array(f);
  PROTO.BinaryParser.prototype.encodeFloat32 = function(e) {
    h.setFloat32(0, e, !0);
    return m
  };
  PROTO.BinaryParser.prototype.encodeFloat64 = function(e) {
    g.setFloat64(0, e, !0);
    return j
  };
  PROTO.BinaryParser.prototype.decodeFloat32 = function(e) {
    var f = e.length;
    f > 4 && (f = 4);
    for(var g = 0;g < f;++g) {
      m[g] = e[g]
    }
    return h.getFloat32(0, !0)
  };
  PROTO.BinaryParser.prototype.decodeFloat64 = function(e) {
    var f = e.length;
    f > 8 && (f = 8);
    for(var h = 0;h < f;++h) {
      j[h] = e[h]
    }
    return g.getFloat64(0, !0)
  }
})();
PROTO.BinaryParser.prototype.decodeFloat = function(e, f, g) {
  e = new this.Buffer(this.bigEndian, e);
  PROTO.BinaryParser.prototype.checkBuffer.call(e, f + g + 1);
  var h = Math.pow(2, g - 1) - 1, j = PROTO.BinaryParser.prototype.readBits.call(e, f + g, 1), g = PROTO.BinaryParser.prototype.readBits.call(e, f, g), m = 0, p = 2, o = e.buffer.length + (-f >> 3) - 1, r, s, t;
  do {
    r = e.buffer[++o];
    s = f % 8 || 8;
    for(t = 1 << s;t >>= 1;r & t && (m += 1 / p), p *= 2) {
    }
  }while(f -= s);
  return g == (h << 1) + 1 ? m ? NaN : j ? -Infinity : Infinity : (1 + j * -2) * (g || m ? !g ? Math.pow(2, -h + 1) * m : Math.pow(2, g - h) * (1 + m) : 0)
};
PROTO.BinaryParser.prototype.decodeInt = function(e, f, g) {
  e = (new this.Buffer(this.bigEndian, e)).readBits(0, f);
  f = Math.pow(2, f);
  return g && e >= f / 2 ? e - f : e
};
PROTO.BinaryParser.prototype.Buffer = function(e, f) {
  this.bigEndian = e || 0;
  this.buffer = [];
  PROTO.BinaryParser.prototype.setBuffer.call(this, f)
};
PROTO.BinaryParser.prototype.readBits = function(e, f) {
  function g(e, f) {
    for(++f;--f;e = ((e %= 2147483648) & 1073741824) == 1073741824 ? e * 2 : (e - 1073741824) * 2 + 2147483648) {
    }
    return e
  }
  if(e < 0 || f <= 0) {
    return 0
  }
  PROTO.BinaryParser.prototype.checkBuffer.call(this, e + f);
  for(var h, j = e % 8, m = this.buffer.length - (e >> 3) - 1, p = this.buffer.length + (-(e + f) >> 3), o = m - p, m = (this.buffer[m] >> j & (1 << (o ? 8 - j : f)) - 1) + (o && (h = (e + f) % 8) ? (this.buffer[p++] & (1 << h) - 1) << (o-- << 3) - j : 0);o;m += g(this.buffer[p++], (o-- << 3) - j)) {
  }
  return m
};
PROTO.BinaryParser.prototype.setBuffer = function(e) {
  if(e) {
    for(var f, g = f = e.length, h = this.buffer = Array(f);g;h[f - g] = e[--g]) {
    }
    this.bigEndian && h.reverse()
  }
};
PROTO.BinaryParser.prototype.hasNeededBits = function(e) {
  return this.buffer.length >= -(-e >> 3)
};
PROTO.BinaryParser.prototype.checkBuffer = function(e) {
  if(!PROTO.BinaryParser.prototype.hasNeededBits.call(this, e)) {
    throw Error("checkBuffer::missing bytes");
  }
};
PROTO.BinaryParser.prototype.warn = function(e) {
  if(this.allowExceptions) {
    throw Error(e);
  }
  return 1
};
PROTO.BinaryParser.prototype.toSmall = function(e) {
  return this.decodeInt(e, 8, !0)
};
PROTO.BinaryParser.prototype.fromSmall = function(e) {
  return this.encodeInt(e, 8, !0)
};
PROTO.BinaryParser.prototype.toByte = function(e) {
  return this.decodeInt(e, 8, !1)
};
PROTO.BinaryParser.prototype.fromByte = function(e) {
  return this.encodeInt(e, 8, !1)
};
PROTO.BinaryParser.prototype.toShort = function(e) {
  return this.decodeInt(e, 16, !0)
};
PROTO.BinaryParser.prototype.fromShort = function(e) {
  return this.encodeInt(e, 16, !0)
};
PROTO.BinaryParser.prototype.toWord = function(e) {
  return this.decodeInt(e, 16, !1)
};
PROTO.BinaryParser.prototype.fromWord = function(e) {
  return this.encodeInt(e, 16, !1)
};
PROTO.BinaryParser.prototype.toInt = function(e) {
  return this.decodeInt(e, 32, !0)
};
PROTO.BinaryParser.prototype.fromInt = function(e) {
  return this.encodeInt(e, 32, !0)
};
PROTO.BinaryParser.prototype.toDWord = function(e) {
  return this.decodeInt(e, 32, !1)
};
PROTO.BinaryParser.prototype.fromDWord = function(e) {
  return this.encodeInt(e, 32, !1)
};
PROTO.BinaryParser.prototype.toFloat = typeof Float32Array != "undefined" ? PROTO.BinaryParser.prototype.decodeFloat32 : function(e) {
  return this.decodeFloat(e, 23, 8)
};
PROTO.BinaryParser.prototype.fromFloat = typeof Float32Array != "undefined" ? PROTO.BinaryParser.prototype.encodeFloat32 : function(e) {
  return this.encodeFloat(e, 23, 8)
};
PROTO.BinaryParser.prototype.toDouble = typeof Float64Array != "undefined" ? PROTO.BinaryParser.prototype.decodeFloat64 : function(e) {
  return this.decodeFloat(e, 52, 11)
};
PROTO.BinaryParser.prototype.fromDouble = typeof Float64Array != "undefined" ? PROTO.BinaryParser.prototype.encodeFloat64 : function(e) {
  return this.encodeFloat(e, 52, 11)
};
PROTO.binaryParser = new PROTO.BinaryParser(!1, !1);
PROTO.encodeUTF8 = function(e) {
  for(var f = e.length, g = [], h, j, m, p, o = 0;o < f;o++) {
    h = e.charCodeAt(o), (h & 65408) == 0 ? g.push(h) : ((h & 64512) == 55296 && (j = e.charCodeAt(o + 1), (j & 64512) == 56320 ? (h = ((h & 1023) << 10 | j & 1023) + 65536, o++) : PROTO.warn("Error decoding surrogate pair: " + h + "; " + j)), j = h & 255, m = h & 65280, p = h & 16711680, h <= 2047 ? (g.push(192 | m >> 6 | j >> 6), g.push(128 | j & 63)) : h <= 65535 ? (g.push(224 | m >> 12), g.push(128 | m >> 6 & 63 | j >> 6), g.push(128 | j & 63)) : h <= 1114111 ? (g.push(240 | p >> 18), g.push(128 |
    p >> 12 & 63 | m >> 12), g.push(128 | m >> 6 & 63 | j >> 6), g.push(128 | j & 63)) : (PROTO.warn("Error encoding to utf8: " + h + " is greater than U+10ffff"), g.push("?".charCodeAt(0))))
  }
  return g
};
PROTO.decodeUTF8 = function(e) {
  for(var f = e.length, g = "", h, j, m, p, o = 0;o < f;o++) {
    h = e[o];
    if((h & 128) != 0) {
      if((h & 248) == 240) {
        if(j = e[o + 1], m = e[o + 2], p = e[o + 3], (j & 192) == 128 && (m & 192) == 128 && (p & 192) == 128) {
          h = (h & 7) << 18 | (j & 63) << 12 | (m & 63) << 6 | p & 63, o += 3
        }else {
          PROTO.warn("Error decoding from utf8: " + h + "," + j + "," + m + "," + p);
          continue
        }
      }else {
        if((h & 240) == 224) {
          if(j = e[o + 1], m = e[o + 2], (j & 192) == 128 && (m & 192) == 128) {
            h = (h & 15) << 12 | (j & 63) << 6 | m & 63, o += 2
          }else {
            PROTO.warn("Error decoding from utf8: " + h + "," + j + "," + m);
            continue
          }
        }else {
          if((h & 224) == 192) {
            if(j = e[o + 1], (j & 192) == 128) {
              h = (h & 31) << 6 | j & 63, o += 1
            }else {
              PROTO.warn("Error decoding from utf8: " + h + "," + j);
              continue
            }
          }else {
            PROTO.warn("Error decoding from utf8: " + h + " encountered not in multi-byte sequence");
            continue
          }
        }
      }
    }
    h <= 65535 ? g += String.fromCharCode(h) : h > 65535 && h <= 1114111 ? (h -= 65536, g += String.fromCharCode(55296 | h >> 10) + String.fromCharCode(56320 | h & 1023)) : PROTO.warn("Error encoding surrogate pair: " + h + " is greater than U+10ffff")
  }
  return g
};
PROTO.Stream = function() {
  this.read_pos_ = this.write_pos_ = 0
};
PROTO.Stream.prototype = {read:function(e) {
  for(var f = [], g = 0;g < e;++g) {
    var h = this.readByte();
    if(h === null) {
      break
    }
    f.push(h)
  }
  return f
}, write:function(e) {
  for(var f = 0;f < e.length;f++) {
    this.writeByte(e[f])
  }
}, readByte:function() {
  return null
}, writeByte:function() {
  this.write_pos_ += 1
}, readPosition:function() {
  return this.read_pos_
}, setReadPosition:function(e) {
  this.read_pos_ = e
}, writePosition:function() {
  return this.write_pos_
}, valid:function() {
  return!1
}};
PROTO.ByteArrayStream = function(e) {
  this.array_ = e || [];
  this.read_pos_ = 0;
  this.write_pos_ = this.array_.length
};
PROTO.ByteArrayStream.prototype = new PROTO.Stream;
PROTO.ByteArrayStream.prototype.read = function(e) {
  if(this.read_pos_ + e > this.array_.length) {
    return null
  }
  var f = this.array_.slice(this.read_pos_, this.read_pos_ + e);
  this.read_pos_ += e;
  return f
};
PROTO.ByteArrayStream.prototype.write = function(e) {
  Array.prototype.push.apply(this.array_, e);
  this.write_pos_ = this.array_.length
};
PROTO.ByteArrayStream.prototype.readByte = function() {
  return this.array_[this.read_pos_++]
};
PROTO.ByteArrayStream.prototype.writeByte = function(e) {
  this.array_.push(e);
  this.write_pos_ = this.array_.length
};
PROTO.ByteArrayStream.prototype.valid = function() {
  return this.read_pos_ < this.array_.length
};
PROTO.ByteArrayStream.prototype.getArray = function() {
  return this.array_
};
PROTO.Uint8ArrayStream = function(e) {
  this.array_ = e || new Uint8Array(4096);
  this.write_pos_ = this.read_pos_ = 0
};
PROTO.Uint8ArrayStream.prototype._realloc = function(e) {
  this.array_ = new Uint8Array(Math.max(e, this.array_.length) + this.array_.length)
};
PROTO.Uint8ArrayStream.prototype.read = function(e) {
  if(this.read_pos_ + e > this.array_.length) {
    return null
  }
  var f = this.array_.subarray(this.read_pos_, this.read_pos_ + e);
  this.read_pos_ += e;
  return f
};
PROTO.Uint8ArrayStream.prototype.write = function(e) {
  this.write_pos_ + e.length > this.array_.length && this._realloc(this.write_pos_ + e.length);
  this.array_.set(e, this.write_pos_);
  this.write_pos_ += e.length
};
PROTO.Uint8ArrayStream.prototype.readByte = function() {
  return this.array_[this.read_pos_++]
};
PROTO.Uint8ArrayStream.prototype.writeByte = function(e) {
  this.write_pos_ >= this.array_.length && this._realloc(this.write_pos_ + 1);
  this.array_[this.write_pos_++] = e
};
PROTO.Uint8ArrayStream.prototype.valid = function() {
  return this.read_pos_ < this.array_.length
};
PROTO.Uint8ArrayStream.prototype.getArray = function() {
  return this.array_.subarray(0, this.write_pos_)
};
PROTO.CreateArrayStream = function(e) {
  return e instanceof Array ? new PROTO.ByteArrayStream(e) : new PROTO.Uint8ArrayStream(e)
};
(function() {
  var e = [62, -1, 62, -1, 63, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, -1, -1, -1, -1, -1, -1, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, -1, -1, -1, -1, 63, -1, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51], f = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z", "a", "b", "c", "d", "e", "f", "g", "h", "i",
  "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "+", "/"], g = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "-", "_"];
  PROTO.Base64Stream = function(e) {
    this.alphabet = f;
    this.string_ = e || "";
    this.read_incomplete_value_ = this.read_pos_ = 0;
    this.read_needed_bits_ = 8;
    this.write_incomplete_value_ = this.write_extra_bits_ = 0;
    this.fixString()
  };
  PROTO.Base64Stream.prototype = new PROTO.Stream;
  PROTO.Base64Stream.prototype.setURLSafe = function() {
    this.alphabet = g
  };
  PROTO.Base64Stream.prototype.fixString = function() {
    var f = this.string_.length;
    if(this.string_[f - 1] == "=") {
      var g = 4, m = 2;
      this.string_[f - m] == "=" && (g = 2, m = 3);
      this.write_extra_bits_ = g;
      this.write_incomplete_value_ = e[this.string_.charCodeAt(f - m) - 43];
      this.write_incomplete_value_ >>= 6 - g;
      this.string_ = this.string_.substring(0, f - m)
    }
  };
  PROTO.Base64Stream.prototype.readByte = function() {
    for(var f, g = this.read_needed_bits_;f === void 0 || f == -1;) {
      if(this.read_pos_ >= this.string_.length) {
        if(this.valid()) {
          f = this.write_incomplete_value_ << 6 - g;
          this.read_pos_++;
          break
        }else {
          return null
        }
      }
      f = e[this.string_.charCodeAt(this.read_pos_++) - 43]
    }
    if(g == 8) {
      return this.read_incomplete_value_ = f, this.read_needed_bits_ = 2, this.readByte()
    }
    var m = this.read_incomplete_value_ << g;
    m |= f >> 6 - g;
    this.read_incomplete_value_ = f & (1 << 6 - g) - 1;
    this.read_needed_bits_ += 2;
    return m
  };
  PROTO.Base64Stream.prototype.writeByte = function(e) {
    this.write_extra_bits_ += 2;
    var f = this.write_extra_bits_;
    this.string_ += this.alphabet[e >> f | this.write_incomplete_value_ << 8 - f];
    this.write_incomplete_value_ = e & (1 << f) - 1;
    if(f == 6) {
      this.string_ += this.alphabet[this.write_incomplete_value_], this.write_incomplete_value_ = this.write_extra_bits_ = 0
    }
    this.string_.length % 77 == 76 && (this.string_ += "\n")
  };
  PROTO.Base64Stream.prototype.getString = function() {
    var e = this.string_, f = this.write_extra_bits_;
    f > 0 && (e += this.alphabet[this.write_incomplete_value_ << 6 - f], f == 2 ? e += "==" : f == 4 && (e += "="));
    return e
  };
  PROTO.Base64Stream.prototype.valid = function() {
    return this.read_pos_ < this.string_.length || this.read_pos_ == this.string_.length && this.write_extra_bits_
  }
})();
if(typeof ArrayBuffer !== "undefined" && typeof Uint8Array !== "undefined") {
  PROTO.ArrayBufferStream = function(e, f) {
    this.array_buffer_ = e || new ArrayBuffer(1024);
    this.length_ = f || 0;
    this.array_ = new Uint8Array(this.array_buffer_);
    this.read_pos = 0
  }, PROTO.ArrayBufferStream.prototype = new PROTO.Stream, PROTO.ArrayBufferStream.prototype._realloc = function(e) {
    var f = this.array_, g = this.length_;
    this.array_buffer_ = new ArrayBuffer(f.length + e);
    for(var e = new Uint8Array(this.array_buffer_), h = 0;h < g;h++) {
      e[h] = f[h]
    }
    this.array_ = e
  }, PROTO.ArrayBufferStream.prototype.read = function(e) {
    if(this.read_pos_ + e > this.length_) {
      return null
    }
    var f = this.array_.subarray(this.read_pos_, this.read_pos_ + e);
    this.read_pos_ += e;
    for(var g = Array(e), h = 0;h < e;h++) {
      g[h] = f[h]
    }
    return g
  }, PROTO.ArrayBufferStream.prototype.write = function(e) {
    var f = 0, g = this.length_;
    this.length_ + e.length > this.array_.length && this._realloc(this.length_ + e.length);
    this.length_ += e.length;
    for(var h = this.array_, j = e.length;f < j;f++, g++) {
      h[g] = e[f]
    }
  }, PROTO.ArrayBufferStream.prototype.readByte = function() {
    return this.array_[this.read_pos_++]
  }, PROTO.ArrayBufferStream.prototype.writeByte = function(e) {
    this.length_ == this.array_.length && this._realloc(this.length_ + 1);
    this.array_[this.length_++] = e
  }, PROTO.ArrayBufferStream.prototype.valid = function() {
    return this.read_pos_ < this.length_
  }, PROTO.ArrayBufferStream.prototype.getArrayBuffer = function() {
    return this.array_buffer_
  }, PROTO.ArrayBufferStream.prototype.length = function() {
    return this.length_
  }, function() {
    var e = !1, f = null, g = "slice", h;
    try {
      h = new self.Blob([new DataView(new ArrayBuffer(1))]), e = !0
    }catch(j) {
      f = self.BlobBuilder || self.WebKitBlobBuilder || self.MozBlobBuilder || self.MSBlobBuilder;
      try {
        h = (new f).getBlob()
      }catch(m) {
      }
    }
    if(h && (e || f)) {
      h.webkitSlice && !h.slice ? g = "webkitSlice" : h.mozSlice && !h.slice && (g = "mozSlice"), PROTO.ArrayBufferStream.prototype.getBlob = function() {
        var h;
        e ? h = new self.Blob([new DataView(this.array_buffer_)]) : (h = new f, h.append(this.array_buffer_), h = h.getBlob());
        return h[g](0, this.length_)
      }
    }
  }(), PROTO.ArrayBufferStream.prototype.getUint8Array = function() {
    return new Uint8Array(this.array_buffer_, 0, this.length_)
  }
}
PROTO.array = function() {
  function e(e, g) {
    this.datatype_ = e.type();
    this.length = 0;
    if(PROTO.IsArray(g)) {
      for(var h = 0;h < g.length;++h) {
        this.push(g[h])
      }
    }
  }
  e.IsInitialized = function(e) {
    return e.length > 0
  };
  e.prototype = {};
  e.prototype.push = function() {
    if(arguments.length === 0) {
      if(this.datatype_.composite) {
        var e = new this.datatype_;
        return this[this.length++] = e
      }else {
        throw"Called add(undefined) for a non-composite";
      }
    }else {
      for(var g = 0;g < arguments.length;g++) {
        e = this.datatype_.Convert(arguments[g]), this.datatype_.FromProto && (e = this.datatype_.FromProto(e)), this[this.length++] = e
      }
    }
    return arguments[0]
  };
  e.prototype.set = function(e, g) {
    g = this.datatype_.Convert(g);
    this.datatype_.FromProto && (g = this.datatype_.FromProto(g));
    if(e < this.length && e >= 0) {
      this[e] = g
    }else {
      if(e == this.length) {
        this[this.length++] = g
      }else {
        throw"Called ProtoArray.set with index " + e + " higher than length " + this.length;
      }
    }
    return g
  };
  e.prototype.clear = function() {
    this.length = 0
  };
  return e
}();
PROTO.string = {Convert:function(e) {
  return"" + e
}, wiretype:PROTO.wiretypes.lengthdelim, SerializeToStream:function(e, f) {
  var g = PROTO.encodeUTF8(e);
  return PROTO.bytes.SerializeToStream(g, f)
}, ParseFromStream:function(e) {
  e = PROTO.bytes.ParseFromStream(e);
  return PROTO.decodeUTF8(e)
}, toString:function(e) {
  return e
}};
PROTO.bytes = {Convert:function(e) {
  if(PROTO.IsArray(e)) {
    return e
  }else {
    if(e instanceof PROTO.ByteArrayStream) {
      return e.getArray()
    }else {
      if(e.SerializeToStream) {
        var f = new PROTO.ByteArrayStream;
        e.SerializeToStream(f);
        return f.getArray()
      }else {
        throw"Not a Byte Array: " + e;
      }
    }
  }
}, wiretype:PROTO.wiretypes.lengthdelim, SerializeToStream:function(e, f) {
  PROTO.int32.SerializeToStream(e.length, f);
  f.write(e)
}, ParseFromStream:function(e) {
  var f = PROTO.int32.ParseFromStream(e);
  return e.read(f)
}, toString:function(e) {
  return"[" + e + "]"
}};
(function() {
  function e(e, f, g) {
    return{Convert:e, wiretype:0, SerializeToStream:f, ParseFromStream:g, toString:function(e) {
      return"" + e
    }}
  }
  function f(e) {
    if(e == NaN) {
      throw"not a number: " + e;
    }
    e = Math.round(e);
    if(e < 0) {
      throw"uint32/fixed32 does not allow negative: " + e;
    }
    if(e > 4294967295) {
      throw"uint32/fixed32 out of bounds: " + e;
    }
    return e
  }
  function g(e) {
    if(e == NaN) {
      throw"not a number: " + e;
    }
    e = Math.round(e);
    if(e > 2147483647 || e < -2147483648) {
      throw"sfixed32/[s]int32 out of bounds: " + e;
    }
    return e
  }
  function h(e, f) {
    e < 0 && (e += 4294967296);
    for(var g = Array(4), h = 0;h < 4;h++) {
      g[h] = e % 256, e >>>= 8
    }
    f.write(g)
  }
  function j(e) {
    for(var f = 0, g = 1, h = 0;h < 4;h++) {
      f += g * e.readByte(), g *= 256
    }
    return f
  }
  function m(e, f) {
    if(e < 0) {
      r(PROTO.I64.fromNumber(e), f)
    }else {
      for(var g = 0;g == 0 || e && g < 5;g++) {
        var h = e % 128;
        e >>>= 7;
        e && (h += 128);
        f.writeByte(h)
      }
    }
  }
  function p(e) {
    for(var f = 0, g = !1, h = 1, j = 0;!g && j < 5;j++) {
      var m = e.readByte();
      if(m === void 0) {
        PROTO.warn("read undefined byte from stream: n is " + f);
        break
      }
      m < 128 && (g = !0);
      f += h * (m & (j == 4 ? 15 : 127));
      h *= 128
    }
    return f
  }
  function o(e) {
    if(e instanceof PROTO.I64) {
      return e
    }
    throw"64-bit integers must be PROTO.I64 objects!";
  }
  function r(e, f) {
    f.write(e.convertToUnsigned().serializeToLEVar128())
  }
  function s(e) {
    var f = parseFloat(e);
    if(f == NaN) {
      throw"not a number: " + e;
    }
    return f
  }
  var t = new PROTO.I64(0, 0, 1);
  PROTO.sfixed32 = e(g, h, function(e) {
    e = j(e);
    e > 2147483647 && (e -= 4294967296);
    return e
  });
  PROTO.fixed32 = e(f, h, j);
  PROTO.sfixed32.wiretype = PROTO.wiretypes.fixed32;
  PROTO.fixed32.wiretype = PROTO.wiretypes.fixed32;
  PROTO.int32 = e(g, m, function(e) {
    e = PROTO.I64.parseLEVar128(e, t).lsw;
    e > 2147483647 && (e -= 2147483647, e -= 2147483647, e -= 2);
    return e
  });
  PROTO.sint32 = e(g, function(e, f) {
    e < 0 ? e = -e * 2 - 1 : e *= 2;
    m(e, f)
  }, function(e) {
    e = p(e);
    if(e & 1) {
      return(e + 1) / -2
    }
    return e / 2
  });
  PROTO.uint32 = e(f, m, p);
  PROTO.sfixed64 = e(o, function(e, f) {
    f.write(e.convertToUnsigned().serializeToLEBase256())
  }, function(e) {
    return PROTO.I64.parseLEBase256(e, t).convertFromUnsigned()
  });
  PROTO.fixed64 = e(o, function(e, f) {
    f.write(e.serializeToLEBase256())
  }, function(e) {
    return PROTO.I64.parseLEBase256(e)
  });
  PROTO.sfixed64.wiretype = PROTO.wiretypes.fixed64;
  PROTO.fixed64.wiretype = PROTO.wiretypes.fixed64;
  PROTO.int64 = e(o, r, function(e) {
    return PROTO.I64.parseLEVar128(e, t).convertFromUnsigned()
  });
  PROTO.sint64 = e(o, function(e, f) {
    f.write(e.convertFromUnsigned().convertToZigzag().serializeToLEVar128())
  }, function(e) {
    return PROTO.I64.parseLEVar128(e, t).convertFromZigzag()
  });
  PROTO.uint64 = e(o, function(e, f) {
    f.write(e.convertToUnsigned().serializeToLEVar128())
  }, function(e) {
    return PROTO.I64.parseLEVar128(e)
  });
  PROTO.bool = e(function(e) {
    return e ? !0 : !1
  }, m, p);
  PROTO.Float = e(s, function(e, f) {
    f.write(PROTO.binaryParser.fromFloat(e))
  }, function(e) {
    e = e.read(4);
    return PROTO.binaryParser.toFloat(e)
  });
  PROTO.Double = e(s, function(e, f) {
    f.write(PROTO.binaryParser.fromDouble(e))
  }, function(e) {
    e = e.read(8);
    return PROTO.binaryParser.toDouble(e)
  });
  PROTO.Float.wiretype = PROTO.wiretypes.fixed32;
  PROTO.Double.wiretype = PROTO.wiretypes.fixed64
})();
PROTO.mergeProperties = function(e, f, g) {
  var h = {}, j;
  for(j in e) {
    h[e[j].id] = j
  }
  for(var m, p, o, r, s, t = {};f.valid();) {
    m = PROTO.int32.ParseFromStream(f);
    p = m % 8;
    m >>>= 3;
    o = (j = (s = h[m]) && e[s]) && j.type();
    r = void 0;
    switch(p) {
      case PROTO.wiretypes.varint:
        j && o.wiretype == PROTO.wiretypes.varint ? r = o.ParseFromStream(f) : PROTO.int64.ParseFromStream(f);
        break;
      case PROTO.wiretypes.fixed64:
        j && o.wiretype == PROTO.wiretypes.fixed64 ? r = o.ParseFromStream(f) : PROTO.fixed64.ParseFromStream(f);
        break;
      case PROTO.wiretypes.lengthdelim:
        if(j) {
          if(o.wiretype != PROTO.wiretypes.lengthdelim) {
            var q;
            o.cardinality > 1 && (t[s] === void 0 && (t[s] = []), q = t[s]);
            m = PROTO.bytes.ParseFromStream(f);
            p = PROTO.CreateArrayStream(m);
            for(var u = 0;u < m.length && p.valid();u++) {
              var v = o.ParseFromStream(p);
              o.cardinality > 1 ? (q.push(v), q.length == o.cardinality && (j.multiplicity == PROTO.repeated ? g[s].push(q) : g[s] = o.Convert(q), t[s] = [], q = t[s])) : g[s].push(v)
            }
          }else {
            if(r = o.ParseFromStream(f), r == null) {
              return!1
            }
          }
        }else {
          PROTO.bytes.ParseFromStream(f)
        }
        break;
      case PROTO.wiretypes.fixed32:
        j && o.wiretype == PROTO.wiretypes.fixed32 ? r = o.ParseFromStream(f) : PROTO.fixed32.ParseFromStream(f);
        break;
      default:
        PROTO.warn("ERROR: Unknown type " + p + " for " + m)
    }
    r !== void 0 && (g[s] === void 0 && o.cardinality > 1 && (g[s] = {}), o.cardinality > 1 ? (t[s] === void 0 && (t[s] = [], q = t[s]), q.push(r), q.length == o.cardinality && (j.multiplicity == PROTO.repeated ? g[s].push(q) : (q = o.Convert(q), !PROTO.DefineProperty && o.FromProto && (q = o.FromProto(q)), g[s] = q), t[s] = void 0)) : j.multiplicity === PROTO.repeated ? g[s].push(r) : (r = o.Convert(r), !PROTO.DefineProperty && o.FromProto && (r = o.FromProto(r)), g[s] = r))
  }
  return!0
};
PROTO.serializeTupleProperty = function(e, f, g) {
  var h = e.id, j = e.type().wiretype, m = h * 8 + j;
  if(j != PROTO.wiretypes.lengthdelim && e.options.packed) {
    j = [];
    m = new PROTO.ByteArrayStream(j);
    if(e.multiplicity == PROTO.repeated) {
      for(var p = 0;p < g.length;p++) {
        for(var o = e.type().Convert(g[p]), r = 0;r < e.type().cardinality;++r) {
          e.type().SerializeToStream(o[r], m)
        }
      }
    }else {
      o = e.type().Convert(g);
      for(r = 0;r < e.type().cardinality;++r) {
        e.type().SerializeToStream(o[r], m)
      }
    }
    m = h * 8 + PROTO.wiretypes.lengthdelim;
    PROTO.int32.SerializeToStream(m, f);
    PROTO.bytes.SerializeToStream(j, f)
  }else {
    if(e.multiplicity == PROTO.repeated) {
      for(p = 0;p < g.length;p++) {
        o = e.type().Convert(g[p]);
        for(r = 0;r < e.type().cardinality;++r) {
          PROTO.int32.SerializeToStream(m, f), e.type().SerializeToStream(o[r], f)
        }
      }
    }else {
      o = e.type().Convert(g);
      for(r = 0;r < e.type().cardinality;++r) {
        PROTO.int32.SerializeToStream(m, f), e.type().SerializeToStream(o[r], f)
      }
    }
  }
};
PROTO.serializeProperty = function(e, f, g) {
  var h = e.id;
  if(e.type()) {
    if(e.type().cardinality > 1) {
      PROTO.serializeTupleProperty(e, f, g)
    }else {
      var j = e.type().wiretype, m = h * 8 + j;
      if(e.multiplicity == PROTO.repeated) {
        if(j != PROTO.wiretypes.lengthdelim && e.options.packed) {
          for(var j = [], m = new PROTO.ByteArrayStream(j), p = 0;p < g.length;p++) {
            var o = e.type().Convert(g[p]);
            e.type().SerializeToStream(o, m)
          }
          m = h * 8 + PROTO.wiretypes.lengthdelim;
          PROTO.int32.SerializeToStream(m, f);
          PROTO.bytes.SerializeToStream(j, f)
        }else {
          for(p = 0;p < g.length;p++) {
            PROTO.int32.SerializeToStream(m, f), o = e.type().Convert(g[p]), e.type().SerializeToStream(o, f)
          }
        }
      }else {
        PROTO.int32.SerializeToStream(m, f), o = e.type().Convert(g), e.type().SerializeToStream(o, f)
      }
    }
  }
};
PROTO.Message = function(e, f) {
  var g = function() {
    this.properties_ = g.properties_;
    this.values_ = PROTO.DefineProperty ? {} : this;
    this.Clear();
    this.message_type_ = e
  };
  g.properties_ = {};
  for(var h in f) {
    f[h].isType ? g[h] = f[h] : g.properties_[h] = f[h]
  }
  g.isType = !0;
  g.composite = !0;
  g.wiretype = PROTO.wiretypes.lengthdelim;
  g.IsInitialized = function(e) {
    return e && e.IsInitialized()
  };
  g.Convert = function(e) {
    e instanceof g || PROTO.warn("Unknown Error: Value not instanceof Composite: " + typeof e + " : " + e + " instanceof " + (e instanceof g));
    return e
  };
  g.SerializeToStream = function(e, f) {
    var g = [], h = new PROTO.ByteArrayStream(g);
    e.SerializeToStream(h);
    return PROTO.bytes.SerializeToStream(g, f)
  };
  g.ParseFromStream = function(e) {
    var e = PROTO.bytes.ParseFromStream(e), e = PROTO.CreateArrayStream(e), f = new g;
    f.ParseFromStream(e);
    return f
  };
  g.prototype = {computeHasFields:function() {
    var e = {}, f;
    for(f in this.properties_) {
      this.HasField(f) && (e[f] = !0)
    }
    return e
  }, Clear:function() {
    for(var e in this.properties_) {
      this.ClearField(e)
    }
  }, IsInitialized:function() {
    var e = !1, f;
    for(f in this.properties_) {
      if(e = !0, this.values_[f] !== void 0) {
        var g = this.properties_[f];
        if(g.type()) {
          if(g.multiplicity == PROTO.repeated) {
            if(PROTO.array.IsInitialized(this.values_[f])) {
              return!0
            }
          }else {
            if(!g.type().IsInitialized || g.type().IsInitialized(this.values_[f])) {
              return!0
            }
          }
        }
      }
    }
    if(!e) {
      return!0
    }
    return!1
  }, ParseFromStream:function(e) {
    this.Clear();
    return this.MergeFromStream(e)
  }, MergeFromStream:function(e) {
    return PROTO.mergeProperties(this.properties_, e, this.values_)
  }, SerializeToStream:function(e) {
    var f = this.computeHasFields(), g;
    for(g in f) {
      PROTO.serializeProperty(this.properties_[g], e, this.values_[g])
    }
  }, SerializeToArray:function(e) {
    e = new PROTO.ByteArrayStream(e);
    this.SerializeToStream(e);
    return e.getArray()
  }, MergeFromArray:function(e) {
    return this.MergeFromStream(PROTO.CreateArrayStream(e))
  }, ParseFromArray:function(e) {
    this.Clear();
    return this.MergeFromArray(e)
  }, ClearField:function(e) {
    var f = this.properties_[e];
    f.multiplicity == PROTO.repeated ? this.values_[e] = new PROTO.array(f) : (f.type(), delete this.values_[e])
  }, ListFields:function() {
    var e = [], f = this.computeHasFields(), g;
    for(g in f) {
      e.push(g)
    }
    return e
  }, GetField:function(e) {
    var f = this.values_[e], e = this.properties_[e].type();
    if(f && e.FromProto) {
      return e.FromProto(f)
    }
    return f
  }, SetField:function(e, f) {
    if(f === void 0 || f === null) {
      this.ClearField(e)
    }else {
      var g = this.properties_[e];
      if(g.multiplicity == PROTO.repeated) {
        this.ClearField(e);
        for(var h = 0;h < f.length;h++) {
          this.values_[e].push(g.type().Convert(f[h]))
        }
      }else {
        this.values_[e] = g.type().Convert(f)
      }
    }
  }, HasField:function(e) {
    if(this.values_[e] !== void 0) {
      var f = this.properties_[e];
      if(!f.type()) {
        return!1
      }
      if(f.multiplicity == PROTO.repeated) {
        return PROTO.array.IsInitialized(this.values_[e])
      }else {
        if(!f.type().IsInitialized || f.type().IsInitialized(this.values_[e])) {
          return!0
        }
      }
    }
    return!1
  }, HasProperty:function(e) {
    return this.properties_[e] !== void 0
  }, GetProperty:function(e) {
    return this.properties_[e]
  }, formatValue:function(e, f, g, h) {
    f += g;
    g = this.properties_[g].type();
    g.composite ? f += " " + h.toString(e + 1) : typeof h == "string" ? (e = h.replace('"', '\\"').replace("\n", "\\n").replace("\r", "\\r"), f += ': "' + e + '"\n') : (g.FromProto && (h = g.FromProto(h)), g.toString ? (e = g.toString(h), f += ": " + e + "\n") : f += ": " + h + "\n");
    return f
  }, toString:function(e) {
    var f = "", g = "";
    if(e) {
      for(var g = "{\n", h = 0;h < e * 2;h++) {
        f += " "
      }
    }else {
      e = 0
    }
    for(var j in this.properties_) {
      if(this.properties_[j].type() && this.HasField(j)) {
        if(this.properties_[j].multiplicity == PROTO.repeated) {
          for(var t = this.values_[j], h = 0;h < t.length;h++) {
            g += this.formatValue(e, f, j, t[h])
          }
        }else {
          g += this.formatValue(e, f, j, this.values_[j])
        }
      }
    }
    e && (g += "}\n");
    return g
  }};
  if(PROTO.DefineProperty !== void 0) {
    for(var j in g.properties_) {
      (function(e) {
        PROTO.DefineProperty(g.prototype, e, function() {
          return this.GetField(e)
        }, function(f) {
          this.SetField(e, f)
        })
      })(j)
    }
  }
  return PROTO.Message._registeredMessages[e] = g
};
PROTO.Message.Create = function(e) {
  if(PROTO.Message._registeredMessages[e]) {
    return new PROTO.Message._registeredMessages[e]
  }
};
PROTO.Message._registeredMessages = {};
PROTO.Enum = function(e, f, g) {
  g || (g = 32);
  var h = {}, g = {isType:!0}, j;
  for(j in f) {
    h[f[j]] = j, g[j] = f[j], g[f[j]] = j
  }
  g.values = f;
  g.reverseValues = h;
  g.Convert = function(g) {
    if(typeof g == "number") {
      return g
    }
    if(f[g] !== void 0) {
      return f[g]
    }
    throw"Not a valid " + e + " enumeration value: " + g;
  };
  g.toString = function(e) {
    if(h[e]) {
      return h[e]
    }
    return"" + e
  };
  g.ParseFromStream = function(e, f) {
    return PROTO.int32.ParseFromStream(e, f)
  };
  g.SerializeToStream = function(e, f) {
    return PROTO.int32.SerializeToStream(e, f)
  };
  g.wiretype = PROTO.wiretypes.varint;
  return g
};
PROTO.Flags = function(e, f, g) {
  return PROTO.Enum(f, g, e)
};
PROTO.Extend = function(e, f) {
  for(var g in f) {
    e.properties_[g] = f[g]
  }
  return e
};
if(typeof self.console == "undefined") {
  self.console = {}
}
if(typeof self.console.log == "undefined") {
  self.console.log = function(e) {
    document && document.body && document.body.appendChild(document.createTextNode(e + "..."))
  }
}
;var PBJ = {};
function vectorGenerator(e, f, g) {
  g || (g = !1);
  f = {Convert:function(f) {
    if(f && f.length == e) {
      for(var j = [], m = 0;m < e;++m) {
        j.push(f[m])
      }
      return j
    }else {
      if(f && g && f.length == e + 1) {
        j = [];
        for(m = 0;m < e;++m) {
          j.push(f[m])
        }
        f[e] < 0 && (j[0] += 3);
        return j
      }else {
        return typeof self.console != "undefined" && self.console.error && self.console.error("Vector_in_invalid_format: " + f + "; expect " + e + " elements."), Array(e)
      }
    }
  }, toString:function(f) {
    for(var j = "<" + f[0], m = 1;m < e + (g ? 1 : 0);m++) {
      j += ", " + f[m]
    }
    j += ">";
    return j
  }, wiretype:f.wiretype, SerializeToStream:f.SerializeToStream, ParseFromStream:f.ParseFromStream, cardinality:e};
  if(g) {
    if(e == 2) {
      f.FromProto = function(e) {
        var f = e[0], e = e[1], g = f > 1.5 || e > 1.5 ? -1 : 1;
        f > 1.5 && (f -= 3);
        e > 1.5 && (e -= 3);
        return[f, e, g * Math.sqrt(1 - f * f - e * e)]
      }
    }else {
      if(e == 3) {
        f.FromProto = function(e) {
          var f = e[0], g = e[1], e = e[2], p = f > 1.5 || g > 1.5 || e > 1.5 ? -1 : 1;
          f > 1.5 && (f -= 3);
          g > 1.5 && (g -= 3);
          e > 1.5 && (e -= 3);
          return[f, g, e, p * Math.sqrt(1 - f * f - g * g - e * e)]
        }
      }
    }
  }
  return f
}
PBJ.uint8 = PROTO.uint32;
PBJ.uint16 = PROTO.uint32;
PBJ.int8 = PROTO.int32;
PBJ.int16 = PROTO.int32;
PBJ.sint8 = PROTO.sint32;
PBJ.sint16 = PROTO.sint32;
PBJ.vector2d = vectorGenerator(2, PROTO.Double);
PBJ.vector2f = vectorGenerator(2, PROTO.Float);
PBJ.vector3d = vectorGenerator(3, PROTO.Double);
PBJ.vector3f = vectorGenerator(3, PROTO.Float);
PBJ.vector4d = vectorGenerator(4, PROTO.Double);
PBJ.vector4f = vectorGenerator(4, PROTO.Float);
PBJ.normal = vectorGenerator(2, PROTO.Float, !0);
PBJ.unitquaternion = vectorGenerator(3, PROTO.Float, !0);
PBJ.quaternion = vectorGenerator(4, PROTO.Float);
PBJ.duration = PROTO.cloneType(PROTO.sfixed64);
PBJ.duration.Convert = function(e) {
  return e instanceof PROTO.I64 ? e : PROTO.I64.fromNumber(e * 1E3)
};
PBJ.duration.FromProto = function(e) {
  return e.toNumber() / 1E3
};
PBJ.time = PROTO.cloneType(PROTO.fixed64);
PBJ.time.Convert = function(e) {
  if(e instanceof Date) {
    e = e.getTime() * 1E3
  }else {
    if(e instanceof PROTO.I64) {
      return e
    }
  }
  return PROTO.I64.fromNumber(e)
};
PBJ.time.toString = function(e) {
  var f;
  if(e instanceof PROTO.I64) {
    var g = e.toNumber();
    f = Math.floor(g / 1E3);
    g = Math.floor(g / 1E6);
    e = e.sub(PROTO.I64.fromNumber(g * 1E6)).toNumber()
  }else {
    f = e, g = Math.floor(f / 1E3), e = e * 1E3 - g * 1E6
  }
  e < 0 && (e += 1E6);
  return"[" + (new Date(f)).toUTCString() + "]." + (1E6 + e).toString().substr(1)
};
PBJ.time.FromProto = function(e) {
  return e.toNumber() / 1E3
};
(function() {
  function e(e) {
    if(e >= g && e < g + 10) {
      return e - g
    }else {
      if(e >= h && e < h + 6) {
        return 10 + (e - h)
      }else {
        if(e >= j && e < j + 6) {
          return 10 + (e - j)
        }
      }
    }
    return 0
  }
  function f(f, g) {
    for(var h = Array(g), j = f.length, t = 0, q = 0;t < j || q < g;t += 2, q++) {
      var u, v = f.charCodeAt(t);
      v == m && (t++, v = f.charCodeAt(t));
      u = f.charCodeAt(t + 1);
      h[q] = e(v) * 16 + e(u)
    }
    return h
  }
  var g = "0".charCodeAt(0), h = "a".charCodeAt(0), j = "A".charCodeAt(0), m = "-".charCodeAt(0);
  PBJ.sha256 = PROTO.cloneType(PROTO.bytes);
  PBJ.sha256.Convert = function(e) {
    if(PROTO.IsArray(e)) {
      return PROTO.bytes.Convert(e)
    }
    return f(e, 32)
  };
  PBJ.sha256.toString = function(e) {
    if(typeof e == "string") {
      return e
    }
    for(var f = "", g = 0;g < e.length && g < 32;g++) {
      f += (256 + e[g]).toString(16).substr(1)
    }
    for(;f.length < 64;) {
      f += "0"
    }
    return f
  };
  PBJ.sha256.FromProto = PBJ.sha256.toString;
  PBJ.uuid = PROTO.cloneType(PROTO.bytes);
  PBJ.uuid.Convert = function(e) {
    if(PROTO.IsArray(e)) {
      return PROTO.bytes.Convert(e)
    }
    return f(e, 16)
  };
  PBJ.uuid.toString = function(e) {
    if(typeof e == "string") {
      return e
    }
    for(var f = "", g = 0;g < 16;g++) {
      if(g == 4 || g == 6 || g == 8 || g == 10) {
        f += "-"
      }
      f += g >= e.length ? "00" : (256 + e[g]).toString(16).substr(1)
    }
    return f
  };
  PBJ.uuid.FromProto = PBJ.uuid.toString
})();
PBJ.angle = PROTO.Float;
PBJ.boundingsphere3f = vectorGenerator(4, PROTO.Float);
PBJ.boundingsphere3d = vectorGenerator(4, PROTO.Double);
PBJ.boundingbox3f3f = vectorGenerator(6, PROTO.Float);
PBJ.boundingbox3d3f = vectorGenerator(6, PROTO.Double);
typeof WebGLUnsignedByteArray === "undefined" && typeof Uint8Array !== "undefined" && (window.WebGLUnsignedByteArray = Uint8Array);
typeof WebGLByteArray === "undefined" && typeof Int8Array !== "undefined" && (window.WebGLByteArray = Int8Array);
typeof WebGLUnsignedShortArray === "undefined" && typeof Uint16Array !== "undefined" && (window.WebGLUnsignedShortArray = Uint16Array);
typeof WebGLShortArray === "undefined" && typeof Int16Array !== "undefined" && (window.WebGLShortArray = Int16Array);
typeof WebGLUnsignedIntArray === "undefined" && typeof Uint32Array !== "undefined" && (window.WebGLUnsignedIntArray = Uint32Array);
typeof WebGLIntArray === "undefined" && typeof Int32Array !== "undefined" && (window.WebGLIntArray = Int32Array);
typeof WebGLFloatArray === "undefined" && typeof Float32Array !== "undefined" && (window.WebGLFloatArray = Float32Array);
!1 in window && typeof Float64Array !== "undefined" && (window.WebGLDoubleArray = Float64Array);
var GLGEGraphics = function(e, f) {
  this.mCurTime = new Date;
  this.callback = e;
  this.doubleBuffer = 3;
  this.mAnimatingObjects = {};
  this.canvasVisible = this.windowVisible = !0;
  this.mDoCaptureCanvas = 0;
  var g = this, h, j;
  h = document.createElement("canvas");
  GLGEGraphics.GLOBAL_KEYBOARD_GRAB || h.setAttribute("tabindex", "0");
  if(h) {
    try {
      j = h.getContext("experimental-webgl", {preserveDrawingBuffer:!0})
    }catch(m) {
      typeof globalNoWebGLError != "undefined" && globalNoWebGLError()
    }
  }
  (!h || !j) && typeof globalNoWebGLError != "undefined" && globalNoWebGLError();
  h.style.width = "100%";
  h.style.height = "100%";
  f.appendChild(h);
  h ? (h.focus(), j = function() {
    var e = Math.max(1, h.clientWidth), f = Math.max(1, h.clientHeight);
    h.width = e;
    h.height = f;
    GLGEGraphics.canvasAspect = e / f;
    g.mCamera && g.mCamera.setAspect(GLGEGraphics.canvasAspect);
    h.sizeInitialized_ = !0;
    g.displayInfo = {width:h.width, height:h.height};
    g.newEvent();
    for(var j in g.mSpaceRoots) {
      g.reloadBackground(g.mSpaceRoots[j])
    }
  }, this.renderer = new GLGE.Renderer(h), this.renderer.cullFaces = !0, window.addEventListener("resize", j, !1), setTimeout(j, 0)) : this.webGlCanvasError(f, "HTMLCanvas");
  this.mClientElement = h;
  this.mCurTime = new Date;
  this.mObjectUpdates = {};
  this.mSpaceRoots = {};
  this.mRenderTargets = {};
  this.mUnsetParents = {};
  this.mObjects = {};
  this._keyDownMap = {};
  this._enabledEvents = {};
  this._lastMouseDown = null;
  this._mouseMoveSinceLastRender = !1;
  setInterval(function() {
    g.render()
  }, 16);
  GLGEGraphics.GLOBAL_KEYBOARD_GRAB && document.addEventListener("keydown", function(e) {
    g._keyDown(e)
  }, !0);
  document.addEventListener("keyup", function(e) {
    g._keyUp(e)
  }, !0);
  h.addEventListener("keydown", function(e) {
    g._keyDown(e)
  }, !0);
  window.addEventListener("focus", function() {
    g.windowVisible = !0
  }, !1);
  window.addEventListener("blur", function() {
    g.windowVisible = !1
  }, !1);
  h.addEventListener("focus", function() {
    g.canvasVisible = !0
  }, !1);
  h.addEventListener("blur", function() {
    g.canvasVisible = !1
  }, !1);
  h.addEventListener("mousedown", function(e) {
    g._mouseDown(e)
  }, !0);
  h.addEventListener("mouseup", function(e) {
    g._mouseUp(e)
  }, !0);
  h.addEventListener("mousemove", function(e) {
    g._mouseMove(e)
  }, !0);
  h.addEventListener("mousewheel", function(e) {
    g._scrollWheel(e)
  }, !0);
  h.addEventListener("DOMMouseScroll", function(e) {
    g._scrollWheel(e)
  }, !0);
  h.addEventListener("click", function() {
    g.mClientElement.focus()
  }, !0);
  h.addEventListener("contextmenu", function(e) {
    e.preventDefault ? e.preventDefault() : e.returnValue = !1;
    return!1
  }, !0)
};
Kata.require(["katajs/oh/GraphicsSimulation.js", ["katajs/gfx/WebGLCompat.js", "katajs/gfx/layer0.js", "katajs/gfx/layer1.js", "katajs/gfx/layer2.js", "katajs/gfx/layer2_no_sunbeams.js", "externals/GLGE/src/core/glge.js", "externals/GLGE/src/core/glge_event.js", "externals/GLGE/src/core/glge_animatable.js", "externals/GLGE/src/core/glge_document.js", "externals/GLGE/src/core/glge_math.js", "externals/GLGE/src/core/glge_messages.js", "externals/GLGE/src/core/glge_placeable.js", "externals/GLGE/src/core/glge_quicknote.js",
"externals/GLGE/src/core/glge_jsonloader.js", "externals/GLGE/src/core/glge_group.js", "externals/GLGE/src/scene/glge_scene.js", "externals/GLGE/src/scene/glge_light.js", "externals/GLGE/src/scene/glge_camera.js", "externals/GLGE/src/renderable/glge_object.js", "externals/GLGE/src/renders/glge_renderer.js", "externals/GLGE/src/extra/glge_input.js", "externals/GLGE/src/extra/glge_particles.js", "externals/GLGE/src/extra/glge_filter2d.js", "externals/GLGE/src/extra/glge_xmlparser.js", "externals/GLGE/src/extra/glge_wavefront.js",
"externals/GLGE/src/extra/glge_collada.js", "externals/GLGE/src/geometry/glge_mesh.js", "externals/GLGE/src/material/glge_texturecube.js", "externals/GLGE/src/material/glge_texture.js", "externals/GLGE/src/material/glge_texturevideo.js", "externals/GLGE/src/material/glge_texturecanvas.js", "externals/GLGE/src/material/glge_material.js", "externals/GLGE/src/material/glge_texturecamera.js", "externals/GLGE/src/material/glge_multimaterial.js", "externals/GLGE/src/material/glge_materiallayer.js", "externals/GLGE/src/renderable/glge_text.js",
"externals/GLGE/src/renderable/glge_lod.js", "externals/GLGE/src/animation/glge_actionchannel.js", "externals/GLGE/src/animation/glge_animationvector.js", "externals/GLGE/src/animation/glge_animationcurve.js", "externals/GLGE/src/animation/glge_animationpoints.js", "externals/GLGE/src/animation/glge_action.js"]], function() {
  function e(e) {
    var f = e.indexOf(":");
    if(f != -1) {
      return e.substr(0, f)
    }
    return""
  }
  function f(e) {
    var f = e.indexOf("//");
    if(f == -1) {
      return e
    }
    f = e.indexOf("/", f + 2);
    if(f == -1) {
      return"/"
    }
    return e.substr(f)
  }
  function g(g, h) {
    var j = new XMLHttpRequest, m = e(g), o = q[m], m = f(g);
    j.open("GET", o + "/dns" + m, !0);
    j.onreadystatechange = function() {
      if(j.readyState == 4) {
        if(j.status == 200) {
          var e = JSON.parse(j.response).Hash, e = o + "/download/" + e;
          Kata.log("CDN: " + g + " => " + e);
          h(e, null)
        }else {
          h(null, j.status)
        }
      }
    };
    j.send(null)
  }
  function h(e, f, g) {
    this.mGraphicsSystem = e;
    this.mCanvas = f;
    this.mTextureCanvas = g;
    this.mOriginalMaterials = this.mSpaceRoot = this.mCamera = this.mTextureCamera = null
  }
  function j(e, f) {
    function g(e, f) {
      return GLGE.Vec3(e[0] * f[0] + e[1] * f[1] + e[2] * f[2] + e[3], e[4] * f[0] + e[5] * f[1] + e[6] * f[2] + e[7], e[8] * f[0] + e[9] * f[1] + e[10] * f[2] + e[11])
    }
    for(var h, j, m, o, p, r, q = 0;q < e.buffers.length;q++) {
      if(e.buffers[q].name == "position") {
        var s = e.buffers[q].data;
        if(f) {
          if(s.length >= 3) {
            var t = g(f, s.slice(0, 3));
            h = j = t[0];
            m = o = t[1];
            p = r = t[2]
          }else {
            h = m = p = j = o = r = 0
          }
          for(var u = 3;u + 2 < s.length;u += 3) {
            t = g(f, s.slice(u, u + 3)), h = Math.min(h, t[0]), j = Math.max(j, t[0]), m = Math.min(m, t[1]), o = Math.max(o, t[1]), p = Math.min(p, t[2]), r = Math.max(r, t[2])
          }
        }else {
          s.length >= 3 ? (h = j = s[0], m = o = s[1], p = r = s[2]) : h = m = p = j = o = r = 0;
          for(u = 3;u + 3 < s.length;q = u + 3) {
            h = Math.min(h, s[q]), j = Math.max(j, s[q]), m = Math.min(m, s[q + 1]), o = Math.max(o, s[q + 1]), p = Math.min(p, s[q + 2]), r = Math.max(r, s[q + 2])
          }
        }
      }
    }
    return new GLGE.BoundingVolume(h, j, m, o, p, r)
  }
  function m(e, f) {
    switch(e.getBoundingVolume) {
      case GLGE.Group.prototype.getBoundingVolume:
        var g = e.getLocalMatrix();
        f && (g = GLGE.mulMat4(f, g));
        for(var h = null, o = 0;o < e.children.length;o++) {
          h ? h.addBoundingVolume(m(e.children[o], g)) : h = m(e.children[o], g)
        }
        h || (h = new GLGE.BoundingVolume(0, 0, 0, 0, 0, 0));
        return h;
      case GLGE.Mesh.prototype.getBoundingVolume:
        return j(e, f);
      default:
        g = e.getLocalMatrix();
        f && (g = GLGE.mulMat4(f, g));
        e.getModelMatrix();
        for(var h = e.multimaterials, o = null, p = 0;p < h.length;p++) {
          h[p].lods[0].mesh && (o ? o.addBoundingVolume(j(h[p].lods[0].mesh, g)) : o = j(h[p].lods[0].mesh, g))
        }
        o || (o = new GLGE.BoundingVolume(0, 0, 0, 0, 0, 0));
        return o
    }
  }
  function p(e, f, g, h) {
    this.mID = e;
    this.mSpaceID = g;
    this.mNode = new GLGE.Group(e);
    this.mMesh = null;
    this.mBounds = [0, 0, 0, 1];
    this.mLabel = null;
    this.mCurLocation = Kata.LocationIdentity(new Date(0));
    this.mPrevLocation = Kata.LocationIdentity(new Date(0));
    this.mNode.mKataObject = this;
    this.update = this.updateTransformation;
    this.mParent = null;
    h.mScene.addChild(this.mNode);
    this.mLoaded = !1
  }
  function o(e, f, g) {
    this.mElement = f;
    u || (u = g);
    this.mScene = u == g ? t.getElement("mainscene") : new GLGE.Scene(g);
    this.mScene.mSpaceID = g;
    this.mDefaultRenderView = new h(e, f, null)
  }
  function r(e) {
    var f = {}, g;
    for(g in e) {
      if(g != "charCode" && g.toUpperCase() != g && (typeof e[g] == "number" || typeof e[g] == "string")) {
        f[g] = e[g]
      }
    }
    return f
  }
  function s(e, f) {
    for(var g = [];f != null;) {
      g.push([f.mPrevLocation, f.mPrevLocation]), f = f.mParent
    }
    return g
  }
  var t, q = {meerkat:"http://open3dhub.com"};
  GLGE.XMLHttpRequest = function() {
    var f = new XMLHttpRequest;
    f.Kata_open = f.open;
    f.Kata_send = f.send;
    f.open = function(g, h, j) {
      this.Kata_openurl = null;
      if(e(h) != "meerkat") {
        return f.Kata_open(g, h, j)
      }
      if(j !== !0 || g != "GET") {
        throw"Kata XHR must be asynchronous GET!";
      }
      this.Kata_openurl = h
    };
    f.send = function(e) {
      this.Kata_openurl ? g(this.Kata_openurl, function(e, g) {
        e ? (f.Kata_open("GET", e, !0), f.Kata_send(null)) : (f.status = g, f.readyState = 4, f.onreadystatechange())
      }) : this.Kata_send(e)
    };
    return f
  };
  GLGE.loadImage = function(f, h) {
    f.crossOrigin = "anonymous";
    e(h) != "meerkat" ? f.src = h : g(h, function(e) {
      e ? f.src = e : (e = document.createEvent("UIEvents"), e.initEvent("error", !1, !0, f, h), f.dispatchEvent(e))
    })
  };
  GLGEGraphics.prototype.newEvent = function() {
    this.doubleBuffer = 3
  };
  GLGEGraphics.prototype.render = function() {
    this._mouseMoveSinceLastRender = !1;
    this.mCurTime = new Date;
    parseInt(this.mCurTime.getTime());
    var e = !1, f;
    for(f in this.mObjectUpdates) {
      this.mObjectUpdates[f].update(this), this.newEvent(), e = !0
    }
    f = !1;
    if(!this.doubleBuffer) {
      for(var g in this.mAnimatingObjects) {
        this.windowVisible && this.newEvent();
        break
      }
    }
    this.doubleBuffer > 0 && (this.doubleBuffer -= 1, this.renderer.render(), f = !0);
    if(f && (f = this.renderer.getScene())) {
      if(g = f.getFilter2d()) {
        for(var h = f.getLights(), j = [0, 0, 0, 1], m = 0;m < h.length;++m) {
          if(m == 0 || h[m].getCastShadows()) {
            j = GLGE.mulMat4Vec4(h[m].getModelMatrix(), GLGE.Vec4(0, 0, 0, 1))
          }
        }
        h = GLGE.mulMat4Vec4(f.camera.getProjectionMatrix(), GLGE.mulMat4Vec4(f.camera.getViewMatrix(), j));
        h = [(h[0] / h[3] + 1) / 2, (h[1] / h[3] + 1) / 2, (h[2] / h[3] + 1) / 2];
        g.setUniform("3fv", "lightpos", new Float32Array(h));
        f = GLGE.mulMat4(GLGE.inverseMat4(f.camera.getViewMatrix()), GLGE.inverseMat4(f.camera.getProjectionMatrix()));
        g.setUniform("Matrix4fv", "invProjView", new Float32Array(GLGE.transposeMat4(f)))
      }
    }
    Kata.userRenderCallback && Kata.userRenderCallback(this.mCurTime);
    this.mDoCaptureCanvas && !e && (this.methodTable.CaptureCanvas.call(this, {}), this.mDoCaptureCanvas -= 1)
  };
  GLGEGraphics.initialize = function(e, f) {
    t = new GLGE.Document;
    t.onLoad = f;
    t.load(e)
  };
  h.prototype.attachScene = function(e, f) {
    this.mSpaceRoot = e;
    this.mTextureCamera == null ? (this.mGraphicsSystem.renderer.setScene(e.mScene), e.mScene.setCamera(f)) : console.log("Do not know how to deal with texture camera")
  };
  h.prototype.detachScene = function() {
    this.mTextureCamera == null ? (this.mSpaceRoot.mScene.setCamera(null), this.mGraphicsSystem.setScene(null)) : console.log("Do not know how to deal with texture camera");
    this.mSpaceRoot = null
  };
  p.prototype.getMeshAspectRatio = function() {
    if(!this.bv) {
      return[0, 0, 0]
    }
    var e = [this.bv.limits[1] - this.bv.limits[0], this.bv.limits[3] - this.bv.limits[2], this.bv.limits[5] - this.bv.limits[4]];
    e[0] /= this.bv.radius * 2;
    e[1] /= this.bv.radius * 2;
    e[2] /= this.bv.radius * 2;
    return e
  };
  p.prototype.queryMeshAspectRatio = function(e) {
    e._inputCb({msg:"MeshAspectRatio", id:this.mID, aspect:this.getMeshAspectRatio()})
  };
  p.prototype.destroyMesh = function() {
    this.mNode.removeChild(this.mMesh);
    this.mMesh = null
  };
  p.prototype.createMesh = function(e, f, g, h) {
    this.destroyMesh();
    if(f == null) {
      throw"loadScene with null path";
    }
    f.lastIndexOf(".dae") == -1 && (f += ".dae");
    this.mMeshURI = f;
    var j = this, o = new GLGE.Collada;
    this.mLoading = !0;
    this.mID in e.mAnimatingObjects && delete e.mAnimatingObjects[j.mID];
    var p;
    p = function() {
      function f(e) {
        if(e.getAnimation()) {
          return!0
        }
        var g, h;
        if(e.children) {
          for(h = 0;h < e.children.length;++h) {
            if(g = e.children[h], f(g)) {
              return!0
            }
          }
        }
        return!1
      }
      o.setScaleX(1);
      o.setScaleY(1);
      o.setScaleZ(1);
      var g = m(o), h = g.radius, r = 1 / h;
      o.setScaleX(h ? j.mBounds[3] * r : 1);
      o.setScaleY(h ? j.mBounds[3] * r : 1);
      o.setScaleZ(h ? j.mBounds[3] * r : 1);
      o.setLocX(j.mBounds[0] - g.center[0] * r * j.mBounds[3]);
      o.setLocY(j.mBounds[1] - g.center[1] * r * j.mBounds[3]);
      o.setLocZ(j.mBounds[2] - g.center[2] * r * j.mBounds[3]);
      e._inputCb({msg:"loaded", id:j.mID});
      o.removeEventListener("loaded", p);
      j.mLoaded = !0;
      e.newEvent();
      if(j.mCurAnimation) {
        h = j.mCurAnimation, j.mCurAnimation = "", j.animate(h)
      }
      if(j.mMesh == o) {
        j.bv = g;
        delete j.mLoading;
        j.updateTransformation(e);
        if(f(o)) {
          e.mAnimatingObjects[j.mID] = j.mNode, setTimeout(function() {
            e.newEvent()
          }, 8E3), setTimeout(function() {
            e.newEvent()
          }, 4E3)
        }
        if(j.mQueryAspectCount) {
          for(g = 0;g < j.mQueryAspectCount;++g) {
            j.queryMeshAspectRatio(e)
          }
          delete j.mQueryAspectCount
        }
      }else {
        j.mQueryAspectCount && j.mQueryAspectCount > 1 && (j.queryMeshAspectRatio(e), j.mQueryAspectCount--)
      }
    };
    var r = function() {
      e.newEvent();
      e._inputCb({msg:"downloadComplete", id:j.mID});
      o.removeEventListener("downloadComplete", r)
    };
    o.addEventListener("loaded", p);
    o.addEventListener("downloadComplete", r);
    o.setDocument(this.mMeshURI);
    o.setScaleX(h[3]);
    o.setScaleY(h[3]);
    o.setScaleZ(h[3]);
    o.setLocX(h[0]);
    o.setLocY(h[1]);
    o.setLocZ(h[2]);
    this.mBounds = h;
    this.mNode.addCollada(o);
    this.mMesh = o;
    this.updateTransformation(e);
    return o
  };
  p.prototype.createCamera = function(e, f, g) {
    this.mFOV = e;
    this.mCamera = new GLGE.Camera(this.mID + "C");
    this.mCamera.setFovY(e * GLGEGraphics.canvasAspect);
    this.mCamera.setNear(f);
    this.mCamera.setFar(g);
    GLGEGraphics.canvasAspect && this.mCamera.setAspect(GLGEGraphics.canvasAspect);
    this.mNode.addChild(this.mCamera);
    this.update = this.updateCamera
  };
  p.prototype.destroyCamera = function() {
    this.detachRenderTarget();
    delete this.mFOV;
    this.mNode.removeChild(this.mCamera);
    delete this.mCamera;
    this.update = this.updateTransformation
  };
  p.prototype.attachRenderTarget = function(e, f) {
    e.mCamera && e.mCamera.detachRenderTarget();
    this.detachRenderTarget();
    this.mRenderTarg = e;
    e.mCamera = this;
    e.attachScene(f, this.mCamera);
    this.update(e.mGraphicsSystem)
  };
  p.prototype.detachRenderTarget = function() {
    if(this.mRenderTarg) {
      var e = this.mRenderTarg.mO3DGraphics;
      this.mRenderTarg.detatchScene();
      this.mRenderTarg.mCamera = null;
      this.mRenderTarg.mSpaceRoot = null;
      delete this.mRenderTarg;
      this.update(e)
    }
  };
  p.prototype.stationary = function(e) {
    var f = this.mCurLocation.vel, g = this.mCurLocation.rotvel;
    return f[0] == 0 && f[1] == 0 && f[2] == 0 && g == 0 && e - this.mCurLocation.scaleTime >= 0 && e - this.mCurLocation.posTime >= 0 && e - this.mCurLocation.orientTime >= 0
  };
  p.prototype.updateTransformation = function(e) {
    var f = Kata.LocationExtrapolate(this.mCurLocation, e.mCurTime);
    this.mNode.setLoc(f.pos[0], f.pos[1], f.pos[2]);
    var g = this.bv ? 1 / this.bv.radius : 1;
    if(this.mMesh) {
      if(this.bv) {
        this.mMesh.setScale(f.scale[3] * g, f.scale[3] * g, f.scale[3] * g);
        var h = f.scale[1] - this.bv.center[1] * g * f.scale[3], j = f.scale[2] - this.bv.center[2] * g * f.scale[3];
        this.mMesh.setLocX(f.scale[0] - this.bv.center[0] * g * f.scale[3]);
        this.mMesh.setLocY(h);
        this.mMesh.setLocZ(j)
      }else {
        this.mMesh.setScale(f.scale[3], f.scale[3], f.scale[3]), this.mMesh.setLocX(f.scale[0]), this.mMesh.setLocY(f.scale[1]), this.mMesh.setLocZ(f.scale[2])
      }
    }
    this.mBounds = f.scale;
    this.mNode.setQuat(f.orient[0], f.orient[1], f.orient[2], f.orient[3]);
    this.stationary(e.mCurTime) && e.removeObjectUpdate(this);
    return f
  };
  p.prototype.updateCamera = function(e) {
    this.updateTransformation(e, !0)
  };
  p.prototype.animate = function(e) {
    var f = this.mMesh;
    if(f) {
      if(e != this.mCurAnimation) {
        var g = {};
        f && (g = f.getColladaActions());
        if(g = g[e]) {
          this.mCurAnimation = e, f.setAction(g, 400, !0)
        }else {
          if(!this.mLoaded) {
            this.mCurAnimation = e
          }
        }
      }
    }else {
      Kata.warn("Couldn't handle animate request.")
    }
  };
  p.prototype.label = function(e, f, g) {
    var h = this.mLabel;
    if(h === null) {
      this.mLabel = h = new GLGE.Text;
      h.multimaterials = [new GLGE.MultiMaterial];
      var j = new GLGE.Material;
      h.multimaterials[0].setMaterial(j);
      this.mNode.addChild(h)
    }
    f === void 0 && (f = [0, 0, 0]);
    h.setScaleX(0.1);
    h.setScaleY(0.1);
    h.setScaleZ(0.1);
    h.setQuatX(0);
    h.setQuatY(0);
    h.setQuatZ(0);
    h.setQuatW(1);
    h.setLocX(f[0]);
    h.setLocY(f[1]);
    h.setLocZ(f[2]);
    g === void 0 ? h.setColor("black") : (h.setColorR(g[0]), h.setColorG(g[1]), h.setColorB(g[2]));
    h.setSize(200);
    h.setText(e)
  };
  p.prototype.setHighlight = function(e) {
    function f(e, g) {
      var h = e.multimaterials;
      if(h) {
        for(var j = 0;j < h.length;j++) {
          g(h[j])
        }
      }
      if(h = e.children) {
        for(j = 0;j < h.length;j++) {
          f(h[j], g)
        }
      }
    }
    if(e) {
      var g = !1;
      if(!this.mOriginalMaterials) {
        this.mOriginalMaterials = g = !0
      }
      f(this.mMesh, function(e) {
        var f;
        g ? (f = function() {
        }, f.prototype = e.getMaterial(), f = new f, f.mOriginalMaterial = e.getMaterial()) : f = e.getMaterial();
        f.setEmit(0.5);
        e.setMaterial(f)
      })
    }else {
      if(this.mOriginalMaterials) {
        this.mOriginalMaterials = !1, f(this.mMesh, function(e) {
          var f = e.getMaterial().mOriginalMaterial;
          f && e.setMaterial(f)
        })
      }
    }
  };
  var u;
  GLGEGraphics.prototype.methodTable = {};
  GLGEGraphics.prototype.addObjectUpdate = function(e) {
    this.mObjectUpdates[e.mID] = e
  };
  GLGEGraphics.prototype.removeObjectUpdate = function(e) {
    delete this.mObjectUpdates[e.mID]
  };
  GLGEGraphics.prototype.send = function(e) {
    e.msg != "Custom" && e.__type == Kata.ScriptProtocol.FromScript.Types.GraphicsMessage && (this.methodTable[e.msg].call(this, e), this.newEvent())
  };
  GLGEGraphics.prototype.setInputCallback = function(e) {
    this._inputCb = e
  };
  GLGEGraphics.prototype.methodTable.ProjectPoint = function(e) {
    var f = this.renderer && this.renderer.getScene(), g = e.pos, h = e.pos.length;
    h || (g = [g], h = 1);
    f = GLGE.mulMat4(f.camera.pMatrix, f.camera.matrix);
    e.projected = [];
    for(var j = 0;j < h;j++) {
      var m = GLGE.mulMat4Vec4(f, [g[j][0], g[j][1], g[j][2], 1]);
      e.projected[j] = [m[0] / m[3], m[1] / m[3], m[2] / m[3]]
    }
    e.msg = "Projected";
    this._inputCb(e)
  };
  GLGEGraphics.prototype._extractMouseEventInfo = function(e, f) {
    var g = {msg:f || e.type, event:r(e), shiftKey:e.shiftKey, altKey:e.altKey, ctrlKey:e.ctrlKey, button:e.button, x:e.clientX, y:e.clientY, camerapos:null, cameradir:null, dir:null, spaceid:null, clientX:e.clientX, clientY:e.clientY, width:0, height:0}, h = this.mClientElement;
    g.width = h.width;
    for(g.height = h.height;h != null;) {
      g.x += h.scrollLeft || 0, g.y += h.scrollTop || 0, g.x -= h.offsetLeft || 0, g.y -= h.offsetTop || 0, h = h == document.body && !h.offsetParent ? document.documentElement : h.offsetParent
    }
    if(h = this.renderer && this.renderer.getScene()) {
      var j = h.makeRay(g.x, g.y);
      if(j) {
        g.camerapos = j.origin, g.dir = j.coord
      }
      if(h.camera && h.camera.matrix && h.camera.pMatrix) {
        var m = GLGE.mulMat4(GLGE.inverseMat4(h.camera.matrix), GLGE.inverseMat4(h.camera.pMatrix)), j = GLGE.mulMat4Vec4(m, [0, 0, -1, 1]), j = [j[0] / j[3], j[1] / j[3], j[2] / j[3]], m = GLGE.mulMat4Vec4(m, [0, 0, 1, 1]), m = [-(m[0] / m[3] - j[0]), -(m[1] / m[3] - j[1]), -(m[2] / m[3] - j[2])], m = GLGE.toUnitVec3(m);
        g.cameradir = m
      }
      g.spaceid = h.mSpaceID
    }
    return g
  };
  GLGEGraphics.prototype._rayTrace = function(e, f, g) {
    for(var h = this.renderer.getScene(), f = (e = h.ray(e, f)) && e.object;f && !f.mKataObject;) {
      f = f.parent
    }
    (f = f && f.mKataObject && f.mKataObject.mID) || (f = null);
    g.spaceid = h.mSpaceID;
    g.id = f;
    g.pos = e && e.coord;
    g.normal = e && e.normal;
    return g.id && !0 || !1
  };
  GLGEGraphics.prototype._mouseDown = function(e) {
    var f = this._extractMouseEventInfo(e);
    this._buttonState |= 1 << f.button;
    this._lastMouseDown = f;
    if(f.button == 2) {
      document.body.style.cursor = "crosshair"
    }
    this._inputCb(f);
    var g = this, h = function(e) {
      g._mouseMove(e)
    }, j = function(e) {
      g._mouseUp(e);
      document.removeEventListener("mouseup", j, !0);
      document.removeEventListener("mousemove", h, !0)
    };
    document.addEventListener("mouseup", j, !0);
    document.addEventListener("mousemove", h, !0);
    window.focus();
    e.target.focus();
    e.preventDefault && e.preventDefault();
    if(this._enabledEvents.pick) {
      f = this._extractMouseEventInfo(e, "pick"), this._rayTrace(f.camerapos, f.dir, f), this._inputCb(f), this.doubleBuffer = 2
    }
  };
  var v = Kata.GraphicsSimulation.DRAG_THRESHOLD;
  GLGEGraphics.prototype._mouseUp = function(e) {
    var f = this._extractMouseEventInfo(e);
    this._buttonState &= ~(1 << f.button);
    if(f.button == 2) {
      document.body.style.cursor = "default"
    }
    this._inputCb(f);
    var g = this._lastMouseDown;
    if(g) {
      var h = f.x - g.x, j = f.y - g.y;
      g.dragging || h < -v || h > v || j < -v || j > v ? (f = this._extractMouseEventInfo(e, "drop"), f.dx = h, f.dy = j) : f = this._extractMouseEventInfo(e, "click");
      this._inputCb(f)
    }
  };
  GLGEGraphics.prototype._mouseMove = function(e) {
    var f = this._extractMouseEventInfo(e);
    if(!this._mouseMoveSinceLastRender && (this._mouseMoveSinceLastRender = !0, this._enabledEvents.mousemove && this._inputCb(f), this._buttonState)) {
      var g = this._lastMouseDown;
      if(g) {
        var h = f.x - g.x, j = f.y - g.y;
        if(g.dragging || h < -v || h > v || j < -v || j > v) {
          if(g.dragging = !0, this._enabledEvents.drag) {
            f = this._extractMouseEventInfo(e, "drag"), f.dx = h, f.dy = j, f.button = g.button, this._inputCb(f)
          }
        }
      }
    }
  };
  GLGEGraphics.prototype._keyDown = function(e) {
    if(!Kata.suppressCanvasKeyInput) {
      var f = {msg:"keydown", event:r(e), repeat:!!this._keyDownMap[e.keyCode], keyCode:e.keyCode, shiftKey:e.shiftKey, altKey:e.altKey, ctrlKey:e.ctrlKey};
      this._keyDownMap[e.keyCode] = -1;
      this._inputCb(f);
      e.keyCode != 9 && !GLGEGraphics.GLOBAL_KEYBOARD_GRAB && e.preventDefault && e.preventDefault()
    }
  };
  GLGEGraphics.prototype._keyUp = function(e) {
    if(this._keyDownMap[e.keyCode]) {
      var f = {msg:"keyup", event:r(e), keyCode:e.keyCode, shiftKey:e.shiftKey, altKey:e.altKey, ctrlKey:e.ctrlKey}, g = this;
      this._keyDownMap[e.keyCode] = 1;
      setTimeout(function() {
        g._keyDownMap[e.keyCode] == 1 && (g._keyDownMap[e.keyCode] = 0, g._inputCb(f))
      }, 50)
    }
  };
  GLGEGraphics.prototype._scrollWheel = function(e) {
    if(this.canvasVisible) {
      var f = {msg:"wheel", event:r(e), shiftKey:e.shiftKey, altKey:e.altKey, ctrlKey:e.ctrlKey, dy:0, dx:0};
      if(e.wheelDeltaX || e.wheelDeltaY) {
        f.dy = e.wheelDeltaY || 0, f.dx = -e.wheelDeltaX || 0
      }else {
        if(e.wheelDelta) {
          f.dy = e.wheelDelta
        }else {
          if(e.detail) {
            e.axis == 1 ? f.dx = e.detail * 40 : f.dy = e.detail * -40
          }
        }
      }
      this._inputCb(f);
      e.preventDefault()
    }
  };
  GLGEGraphics.prototype.createOrReturnSpaceRoot = function(e) {
    e || (e = "");
    if(!(e in this.mSpaceRoots)) {
      var f = new o(this, this.mClientElement, e);
      this.mSpaceRoots[e] = f;
      for(var g in this.mSpaceRoots) {
        break
      }
    }
    return this.mSpaceRoots[e]
  };
  GLGEGraphics.prototype.methodTable.Create = function(e) {
    var f = this.createOrReturnSpaceRoot(e.spaceid), g;
    e.id in this.mObjects ? g = this.mObjects[e.id] : this.mObjects[e.id] = g = new p(e.id, e.time, e.spaceid, f);
    this.moveTo(g, e);
    g.updateTransformation(this);
    if(e.id in this.mUnsetParents) {
      var f = this.mUnsetParents[e.id], h;
      for(h in f) {
        g.mNode.addChild(f[h].mNode), delete f[h].mUnsetParent
      }
      delete this.mUnsetParents[e.id]
    }
  };
  GLGEGraphics.prototype.moveTo = function(e, f) {
    if(!f.time) {
      f.time = (new Date).getTime()
    }
    var g = e.mParent, h = null, j = null, m = null, h = g == null ? this.mSpaceRoots[e.mSpaceID].mScene : g.mNode;
    if(f.parent !== void 0) {
      e.mUnsetParent && (delete this.mUnsetParents[e.mUnsetParent][f.id], delete e.mUnsetParent);
      if(f.parent) {
        if(f.parent in this.mObjects) {
          var o = this.mObjects[f.parent], p = o.mNode;
          if(o != e.mParent) {
            h.removeChild(e.mNode), e.mParent = o, p.addChild(e.mNode), j = o, m = p
          }
        }else {
          f.parent in this.mUnsetParents || (this.mUnsetParents[f.parent] = {});
          this.mUnsetParents[f.parent][f.id] = e;
          e.mUnsetParent = f.parent;
          j = this.mSpaceRoots[e.mSpaceID];
          if(e.mParent) {
            e.mParent.mNode.removeChild(e.mNode), j.mScene.addChild(e.mNode), e.mParent = null
          }
          j = null;
          m = this.mSpaceRoots[e.mSpaceID].mScene
        }
      }else {
        if(e.mParent) {
          h.removeChild(e.mNode), j = null, m = this.mSpaceRoots[e.mSpaceID].mScene, m.addChild(e.mNode), e.mParent = null
        }
      }
      s(this, g);
      s(this, j);
      e.mPrevLocation = Kata.LocationReparent(e.mPrevLocation, h, m);
      e.mCurLocation = Kata.LocationReparent(e.mCurLocation, h, m)
    }
    g = Kata.LocationUpdate(f, e.mCurLocation, e.mPrevLocation, f.time || this.mCurTime);
    e.mPrevLocation = e.mCurLocation;
    e.mCurLocation = g;
    e.stationary(this.mCurTime) || this.addObjectUpdate(e)
  };
  GLGEGraphics.prototype.methodTable.Move = function(e) {
    var f = this.mObjects[e.id];
    f ? (this.moveTo(f, e), f.update(this)) : this.methodTable.Create.call(this, e)
  };
  GLGEGraphics.prototype.methodTable.Animate = function(e) {
    this.mObjects[e.id].animate(e.animation)
  };
  GLGEGraphics.prototype.methodTable.Label = function(e) {
    var f = this.mObjects[e.id];
    f && f.label(e.label, e.offset, e.color)
  };
  GLGEGraphics.prototype.methodTable.Destroy = function(e) {
    e.id in this.mAnimatingObjects && delete this.mAnimatingObjects[e.id];
    if(e.id in this.mObjects) {
      for(var f = this.mObjects[e.id], g = f.mNode.getChildren(), h = 0;h < g.length;++h) {
        e.id in this.mUnsetParents || (this.mUnsetParents[e.id] = {});
        var j = g[h].mKataObject;
        if(j) {
          this.mUnsetParents[e.id][j.mID] = j;
          j.mUnsetParent = e.id;
          j.mParent = null;
          var m = this.mSpaceRoots[g[h].mKataObject.mSpaceId], o = s(this, f), p = s(this, null);
          j.mPrevLocation = Kata.LocationReparent(j.mPrevLocation, o, p);
          j.mCurLocation = Kata.LocationReparent(j.mCurLocation, o, p);
          f.mNode.removeChild(g[h]);
          m.mScene.addChild(g[h])
        }
      }
      f.mNode.parent.removeChild(f.mNode);
      delete this.mObjects[e.id]
    }
  };
  GLGEGraphics.prototype.methodTable.MeshShaderUniform = function() {
  };
  GLGEGraphics.prototype.methodTable.Mesh = function(e) {
    if(e.mesh && e.id in this.mObjects) {
      var f = this.mObjects[e.id];
      f.createMesh(this, e.mesh, e.anim, e.scale);
      f.update(this)
    }
  };
  GLGEGraphics.prototype.methodTable.QueryMeshAspectRatio = function(e) {
    e = this.mObjects[e.id];
    e.mLoading ? e.mQueryAspectCount ? e.mQueryAspectCount++ : e.mQueryAspectCount = 1 : e.queryMeshAspectRatio(this)
  };
  GLGEGraphics.prototype.methodTable.DestroyMesh = function(e) {
    e.id in this.mObjects && this.mObjects[e.id].destroyMesh()
  };
  GLGEGraphics.prototype.methodTable.Light = function() {
  };
  GLGEGraphics.prototype.methodTable.DestroyLight = function() {
  };
  GLGEGraphics.prototype.methodTable.Camera = function(e) {
    if(e.id in this.mObjects) {
      e = this.mObjects[e.id], e.createCamera(Kata.GraphicsSimulation.YFOV_DEGREES, Kata.GraphicsSimulation.CAMERA_NEAR, Kata.GraphicsSimulation.CAMERA_FAR), this.mCamera = e.mCamera
    }
  };
  GLGEGraphics.prototype.methodTable.AttachCamera = function(e) {
    var f;
    if(e.id in this.mObjects && e.target !== void 0) {
      var g = this.mObjects[e.id], j;
      g.mSpaceID in this.mSpaceRoots ? j = this.mSpaceRoots[g.mSpaceID] : (j = new o(this, this.mClientElement), this.mSpaceRoots[g.mSpaceID] = j);
      f = this.mRenderTargets[e.target];
      f || (f = new h(this, this.mClientElement, null), this.mRenderTargets[e.target] = f);
      g.mCamera && g.attachRenderTarget(f, j)
    }
  };
  GLGEGraphics.prototype.reloadBackground = function(e) {
    var f = e.mFilter, g = e.mFilterTextures, h = e.mFilterTextureNames, g = e.mFilterTextures, h = e.mFilterTextureNames, f = new GLGE.Filter2d;
    e.mScene.setFilter2d(f);
    e.mSunBeams ? (f.addPass(layer0_glsl, 1024, 1024), f.addPass(layer1_glsl, 1024, 1024), f.addPass(layer2_glsl)) : (f.addPass(layer0_glsl, 1024, 1024), f.addPass(layer2_no_sunbeams_glsl));
    var j;
    for(j = 0;j < h.length;++j) {
      f.addTexture(g[j])
    }
    e.mFilter ? (e.mFilter = f, e.mScene.setBackgroundColor("#f0f")) : (e.mFilter = null, e.mScene.setFilter2d(null), e.mScene.setBackgroundColor("#222"))
  };
  GLGEGraphics.prototype.methodTable.Background = function(e) {
    var f = this.createOrReturnSpaceRoot(e.spaceid), g = f.mFilter, h = f.mFilterTextures, j = f.mFilterTextureNames;
    if(!g || f.mSunBeams != e.sunbeams) {
      f.mSunBeams = e.sunbeams, h = f.mFilterTextures = [], j = f.mFilterTextureNames = [], g = new GLGE.Filter2d, f.mScene.setFilter2d(g), e.sunbeams ? (g.addPass(layer0_glsl, 1024, 1024), g.addPass(layer1_glsl, 1024, 1024), g.addPass(layer2_glsl)) : (g.addPass(layer0_glsl, 1024, 1024), g.addPass(layer2_no_sunbeams_glsl))
    }
    var m = j.length == e.curtextures.length * 2;
    j.length = e.curtextures.length * 2;
    for(var o = 0;o < e.curtextures.length * 2;++o) {
      var p = e.curtextures[o >> 1];
      e.prevtextures && o % 2 != 0 && (p = e.prevTextures[o >> 1]);
      j[o] != p && (m = !1, j[o] = p)
    }
    if(!m) {
      for(o = 0;o < h.length;++o) {
        g.removeTexture(h[o])
      }
      h.length = 0;
      m = {};
      for(o = 0;o < j.length;++o) {
        j[o] in m ? h[o] = m[j[o]] : (h[o] = new GLGE.Texture, h[o].setSrc(j[o]), m[j[o]] = h[o], g.addTexture(h[o]))
      }
    }
    (!e.curtextures || e.curtextures && e.curtextures.length == 0) && (!e.prevtextures || e.prevtextures.length == 0) ? (f.mFilter = null, f.mScene.setFilter2d(null), f.mScene.setBackgroundColor("#222")) : (f.mScene.setBackgroundColor("#f0f"), f.mFilter = g)
  };
  GLGEGraphics.prototype.methodTable.DetachCamera = function(e) {
    e.id in this.mObjects && this.mObjects[e.id].detachRenderTarget(this.mCurTime)
  };
  GLGEGraphics.prototype.methodTable.DestroyCamera = function(e) {
    e.id in this.mObjects && this.mObjects[e.id].destroyCamera()
  };
  GLGEGraphics.prototype.methodTable.Enable = function(e) {
    e.type && (this._enabledEvents[e.type] = !0)
  };
  GLGEGraphics.prototype.methodTable.Disable = function(e) {
    this._enabledEvents[e.type] && delete this._enabledEvents[e.type]
  };
  GLGEGraphics.prototype.methodTable.Highlight = function(e) {
    var f = this.mObjects[e.id];
    f && (e.enable ? f.setHighlight(!0) : f.setHighlight(!1))
  };
  GLGEGraphics.prototype.methodTable.Shadows = function(e) {
    if(this.mObjects[e.id]) {
      var f = this.createOrReturnSpaceRoot(e.spaceid).mScene.getLights(), g = 0;
      if(e.index !== void 0) {
        g = e.index, e.index < 0 && (g += f.length)
      }
      if(f.length) {
        if(e.enable) {
          for(e = 0;e < f.length;++e) {
            var h = f[(e + g) % f.length];
            h.id.indexOf("shadowlight") != -1 && h.enableLight();
            if(h.id.indexOf("mainlight") != -1) {
              h.disableLight()
            }else {
              if(h.getType() == GLGE.L_SPOT) {
                h.setCastShadows(!0);
                break
              }
            }
          }
        }else {
          for(var j = 0;j < f.length;++j) {
            h = f[j], h.id.indexOf("shadowlight") != -1 && h.disableLight(), h.id.indexOf("mainlight") != -1 && h.enableLight()
          }
          if(e.index !== void 0) {
            f[g % f.length].setCastShadows(!1)
          }else {
            for(j = 0;j < f.length;++j) {
              f[j].setCastShadows(!1)
            }
          }
        }
      }
    }
  };
  GLGEGraphics.prototype.methodTable.IFrame = function() {
  };
  GLGEGraphics.prototype.methodTable.DestroyIFrame = function() {
  };
  GLGEGraphics.prototype.methodTable.CaptureCanvas = function(e) {
    if(e.still) {
      this.mDoCaptureCanvas += 1
    }else {
      try {
        e = {msg:"canvasCapture", img:this.mClientElement.toDataURL()}
      }catch(f) {
        e = {msg:"canvasCapture", img:""}
      }
      this._inputCb(e)
    }
  };
  Kata.GraphicsSimulation.registerDriver("GLGE", GLGEGraphics)
}, "katajs/gfx/glgegfx.js");
var TextGraphics = function(e, f) {
  var g = this;
  this.callback = e;
  this.parent = f;
  this.methodTable = {};
  var h = function(e) {
    if(document.getElementById) {
      var f = document.getElementById(e)
    }else {
      document.all ? f = document.all[e] : document.layers && (f = document.layers[e])
    }
    return f
  };
  this.methodTable.Create = function(e) {
    var j = document.createElement("div");
    j.style.padding = "0.0em";
    j.style.position = "absolute";
    j.style.border = "solid 10px #10107c";
    j.style.backgroundColor = "#000008";
    j.style.width = "300px";
    j.style.height = "300px";
    j.style.color = "#ffffff";
    j.style.left = "0px";
    j.style.top = "0px";
    j.style.zIndex = "1";
    j.id = e.id;
    if(e.parent) {
      var m = h(e.parent);
      m ? m.appendChild(j) : f.appendChild(j)
    }else {
      f.appendChild(j)
    }
    j.innerHTML = '<p class="alignleft">Object Properties</p>';
    g.methodTable.Move(e)
  };
  this.methodTable.Move = function(e) {
    var f = h(e.id);
    if(e.pos && e.pos.length == 3) {
      f.style.left = e.pos[0] * 10 + "px", f.style.top = e.pos[1] * 10 + "px", f.style.zIndex = e.pos[2], f.style.borderColor = "rgb(" + e.pos[2] * 10 + "," + e.pos[2] * 10 + ",124)"
    }
    if(e.scale) {
      var g = Math.sqrt(e.scale[0] * e.scale[0] + e.scale[2] * e.scale[2]);
      f.style.width = 300 * Math.sqrt(e.scale[0] * e.scale[0] + e.scale[1] * e.scale[1]) + "px";
      f.style.height = 300 * g + "px"
    }
  };
  this.methodTable.Destroy = function(e) {
    (e = h(e.id)) && e.parentNode.removeChild(e)
  };
  var j = function(e) {
    var f = h(e);
    if(!f) {
      f = document.createElement("p"), f.id = e
    }
    return f
  };
  this.methodTable.MeshShaderUniform = function(e) {
    var f = h(e.id);
    if(f) {
      var g = j("Uniform" + e.name + e.id);
      g.innerHTML = "Uniform " + e.name + "=" + e.value;
      f.appendChild(g)
    }
  };
  this.methodTable.Mesh = function(e) {
    var f = h(e.id);
    if(f) {
      var g = j("Mesh" + e.id);
      g.innerHTML = "Mesh " + e.mesh;
      f.appendChild(g)
    }
  };
  var m = function(e, f) {
    var g = h(e.id);
    if(g) {
      var j = h(f + e.id);
      j && g.removeChild(j)
    }
  };
  this.methodTable.DestroyMesh = function(e) {
    m(e, "Mesh")
  };
  this.methodTable.Light = function(e) {
    var f = h(e.id);
    if(f) {
      var g = j("Light" + e.id);
      g.innerHTML = "Light " + e.type;
      f.appendChild(g)
    }
  };
  this.methodTable.DestroyLight = function(e) {
    m(e, "Light")
  };
  this.methodTable.Camera = function(e) {
    var f = h(e.id);
    if(f) {
      var g = j("Camera" + e.id);
      g.innerHTML = "Camera " + e.primary;
      f.appendChild(g)
    }
  };
  this.methodTable.AttachCamera = function(e) {
    if(e.id) {
      var f = h(e.id);
      if(f) {
        var g = j(e.texname + "CameraAttachment" + e.id);
        g.innerHTML = "Camera " + e.camid + " attached to texture " + e.texname;
        f.appendChild(g)
      }
    }else {
      m(e, e.texname + "CameraAttachment")
    }
  };
  this.methodTable.DestroyCamera = function(e) {
    m(e, "Camera")
  };
  this.methodTable.IFrame = function(e) {
    var f = h(e.id);
    if(f) {
      var g = h("IFrame" + e.id);
      if(!g) {
        g = document.createElement("iframe"), g.id = "IFrame" + e.id
      }
      g.setAttribute("src", e.uri);
      f.appendChild(g)
    }
  };
  this.methodTable.DestroyIFrame = function(e) {
    m(e, "IFrame")
  };
  this._testInputCounter = 0;
  this.send = function(e) {
    (e.msg == "Create" || e.msg == "Camera" || e.msg == "AttachCamera") && console.log("ENVJSTEST:", e.msg, e.id);
    e.msg == "Move" && console.log("ENVJSTEST:", e.msg, e.id, e.pos, e.orient, e.vel, e.scale);
    e.msg == "Mesh" && console.log("ENVJSTEST:", e.msg, e.id, e.mesh);
    console.log("TextGraphics.send:", e.msg, e.id, e, "--------------------");
    console.show && console.show(e, "TextGraphics.send:");
    var f;
    this._testInputCounter++ == 4 && (f = {msg:"keydown", event:{keyCode:65, shiftKey:!1}}, this._inputCb && this._inputCb(f));
    this._testInputCounter == 8 && (f = {msg:"mousemove", event:{x:180, y:100}}, this._inputCb && this._inputCb(f));
    this._testInputCounter == 10 && (f = {msg:"mousedown", event:{which:0}}, this._inputCb && this._inputCb(f));
    return this.methodTable[e.msg](e)
  };
  this.setInputCallback = function(e) {
    this._inputCb = e
  };
  this.destroy = function() {
  }
};
Kata.require(["katajs/oh/GraphicsSimulation.js"], function() {
  Kata.GraphicsSimulation.registerDriver("text", TextGraphics)
}, "katajs/gfx/TextGraphics.js");
var layer0_glsl = "#version 100\n\nprecision highp float;\n\nuniform sampler2D GLGE_RENDER;\nvarying vec2 texCoord;\n\nvoid main(void){\n\tvec4 color = texture2D(GLGE_RENDER, texCoord);\n\n\tfloat intensity = 0.0;\n\tif(color.r==1.0 && color.g==0.0 && color.b==1.0) intensity=1.0;\n\tgl_FragColor = vec4(vec3(intensity),1.0);\n}\n";
var layer1_glsl = "#version 100\n\nprecision highp float;\n\nuniform sampler2D GLGE_RENDER;\nuniform sampler2D GLGE_PASS0;\nuniform vec3 lightpos;\nvarying vec2 texCoord;\n\nvoid main(void){\n\tfloat intensity=0.0;\n\tvec2 lightvec=texCoord-lightpos.xy;\n\tlightvec=lightvec*(1.0-clamp(length(lightvec),0.0,1.0));\n\tif((lightpos.z)>0.0){\n\t\tfor(int i=1;i<30;i++){\n\t\t\tintensity+=texture2D(GLGE_PASS0, texCoord-lightvec*0.045*float(i)).r*pow(length(lightvec),2.5);\n\t\t}\n\t}\n\tintensity+=texture2D(GLGE_PASS0, texCoord).r;\n\tgl_FragColor = vec4(vec3(intensity),1.0);\n}\n";
var layer2_glsl = "#version 100\n\nprecision highp float;\n\nuniform sampler2D GLGE_RENDER;\nuniform sampler2D GLGE_PASS1;\nuniform sampler2D TEXTURE0;\nuniform vec3 lightpos;\nuniform mat4 invProjView;\n\nvarying vec2 texCoord;\n\nvec3 result=vec3(0.0,0.0,0.0);\nvec3 suncolor=vec3(0.9,0.9,0.8);\n\nvoid main(void){\n\tvec2 lightvec=texCoord-lightpos.xy;\n\tfloat lightdist=length(lightvec*vec2(1.0,0.444));\n\tvec3 suncolor=(1.0-pow(lightdist,0.1))*suncolor;\n\tif(lightdist<0.005) suncolor=suncolor*pow((0.005-lightdist)/0.005+1.0,2.0);\n\tif(lightpos.z<0.0) suncolor=vec3(0.0);\n\tfloat intensity=texture2D(GLGE_PASS1,texCoord).r;\n\tvec3 col=texture2D(GLGE_RENDER,texCoord).rgb+vec3(0.1,0.1,0.1);\n\tif(col.r==1.1 && col.b==1.1 && col.g==0.1) intensity=1.0;\n\tvec4 skycoord=invProjView*vec4(vec3((texCoord-0.5)*2.0,0.0),1.0);\n\tskycoord=invProjView*vec4(vec3((texCoord-0.5)*2.0,1.0),1.0);\n\tskycoord.xyz=normalize(skycoord.xyz/skycoord.w);\n    skycoord.xyz=skycoord.xzy;\n    skycoord.y=-skycoord.y;\n\t//result=max(suncolor,0.0)/0.4;\n\tresult=max(suncolor,0.0)/0.4+texture2D(TEXTURE0,(skycoord.xy/(1.4+skycoord.z)+1.0)/2.0).rgb*intensity+texture2D(GLGE_RENDER,texCoord).rgb*(1.0-intensity);\n\tif(intensity<1.0) result=suncolor*intensity*5.5+vec3(pow(col.r,2.0),pow(col.g,2.0),pow(col.b,2.0));\t\n\tgl_FragColor = vec4(result,1.0);\t\n}\t\n";
var layer2_no_sunbeams_glsl = "#version 100\n\nprecision highp float;\n\nuniform sampler2D GLGE_RENDER;\nuniform sampler2D GLGE_PASS0;\nuniform sampler2D TEXTURE0;\nuniform vec3 lightpos;\nuniform mat4 invProjView;\n\nvarying vec2 texCoord;\n\nvec3 result=vec3(0.0,0.0,0.0);\nvec3 suncolor=vec3(0.9,0.9,0.8);\n\nvoid main(void){\n\tvec2 lightvec=texCoord-lightpos.xy;\n\tfloat lightdist=length(lightvec*vec2(1.0,0.444));\n\tvec3 suncolor=(1.0-pow(lightdist,0.1))*suncolor;\n\tif(lightdist<0.005) suncolor=suncolor*pow((0.005-lightdist)/0.005+1.0,2.0);\n\tif(lightpos.z<0.0) suncolor=vec3(0.0);\n\tfloat intensity=texture2D(GLGE_PASS0,texCoord).r;\n\tvec3 col=texture2D(GLGE_RENDER,texCoord).rgb+vec3(0.1,0.1,0.1);\n\tif(col.r==1.1 && col.b==1.1 && col.g==0.1) intensity=1.0;\n\tvec4 skycoord=invProjView*vec4(vec3((texCoord-0.5)*2.0,0.0),1.0);\n\tskycoord=invProjView*vec4(vec3((texCoord-0.5)*2.0,1.0),1.0);\n\tskycoord.xyz=normalize(skycoord.xyz/skycoord.w);\n    skycoord.xyz=skycoord.xzy;\n    skycoord.y=-skycoord.y;\n\t//result=max(suncolor,0.0)/0.4;\n\tresult=max(suncolor,0.0)/0.4+texture2D(TEXTURE0,(skycoord.xy/(1.4+skycoord.z)+1.0)/2.0).rgb*intensity+texture2D(GLGE_RENDER,texCoord).rgb*(1.0-intensity);\n\tif(intensity<1.0) result=suncolor*intensity*5.5+vec3(pow(col.r,2.0),pow(col.g,2.0),pow(col.b,2.0));\t\n\tgl_FragColor = vec4(result,1.0);\t\n}\t\n";
Kata.require([], function() {
  Kata.Channel = function() {
  };
  Kata.Channel.prototype.registerListener = function(e) {
    if(!e.call) {
      throw network_debug && Kata.log("Listener call type is " + typeof e), network_debug && Kata.log("Listener constructor type is " + e.constructor), "Error in registerListener: not a function";
    }
    this.mListener ? this.mListener instanceof Array ? this.mListener.push(e) : this.mListener = [this.mListener, e] : this.mListener = e
  };
  Kata.Channel.prototype.unregisterListener = function(e) {
    if(e == this.mListener) {
      return delete this.mListener, !0
    }
    if(this.mListener instanceof Array) {
      for(var f = 0;f < this.mListener.length;++f) {
        if(this.mListener[f] == e) {
          for(e = f;e + 1 < this.mListener.length;++e) {
            this.mListener[e] = this.mListener[e + 1]
          }
          this.mListener.pop();
          return!0
        }
      }
    }
    return!1
  };
  Kata.Channel.prototype.callListeners = function(e) {
    if(!Kata.debugMessage(this, e)) {
      if(this.mListener) {
        if(this.mListener.call) {
          this.mListener(this, e)
        }else {
          for(var f = 0;f < this.mListener.length;f++) {
            this.mListener[f](this, e)
          }
        }
      }else {
        Kata.error("Kata.Channel mListener not set")
      }
    }
  };
  Kata.Channel.prototype.sendMessage = null
}, "katajs/core/Channel.js");
(function() {
  Kata.Deque = function() {
    this.mHead = this.mSize = 0;
    this.mArray = Array(8)
  };
  Kata.Deque.prototype.expand = function() {
    var e = this.mArray.length;
    this.mArray.length = Math.round(e * 1.5);
    for(var f = this.mSize + this.mHead - e, g = 0;g < f;g++) {
      this.mArray[(g + e) % this.mArray.length] = this.mArray[g]
    }
  };
  Kata.Deque.prototype.push_back = function(e) {
    this.mSize >= this.mArray.length && this.expand();
    var f = this.mHead + this.mSize;
    f >= this.mArray.length && (f -= this.mArray.length);
    this.mSize++;
    this.mArray[f] = e
  };
  Kata.Deque.prototype.push_front = function(e) {
    this.mSize >= this.mArray.length && this.expand();
    var f = this.mHead;
    if(f == 0) {
      f = this.mArray.length
    }
    f--;
    this.mHead = f;
    this.mSize++;
    this.mArray[f] = e
  };
  Kata.Deque.prototype.index = function(e) {
    e = this.mHead + e;
    e >= this.mArray.length && (e -= this.mArray.length);
    return this.mArray[e]
  };
  Kata.Deque.prototype.back = function() {
    var e = this.mHead + this.mSize - 1;
    e >= this.mArray.length && (e -= this.mArray.length);
    return this.mArray[e]
  };
  Kata.Deque.prototype.pop_back = function() {
    if(this.mSize != 0) {
      var e = this.mHead + this.mSize - 1;
      e >= this.mArray.length && (e -= this.mArray.length);
      var f = this.mArray[e];
      this.mArray[e] = null;
      this.mSize--;
      return f
    }
  };
  Kata.Deque.prototype.pop_front = function() {
    if(this.mSize != 0) {
      var e = this.mArray[this.mHead];
      this.mArray[this.mHead] = null;
      this.mHead++;
      this.mSize -= 1;
      this.mHead >= this.mArray.length && (this.mHead -= this.mArray.length);
      return e
    }
  };
  Kata.Deque.prototype.front = function() {
    return this.mArray[this.mHead]
  };
  Kata.Deque.prototype.empty = function() {
    return this.mSize == 0
  };
  Kata.Deque.prototype.size = function() {
    return this.mSize
  };
  Kata.Deque.prototype.clear = function() {
    Kata.Deque.call(this)
  };
  Kata.Deque.prototype.erase = function(e) {
    for(e = this.mHead + e;e + 1 < this.mSize;++e) {
      this.mArray[e] = this.mArray[e + 1]
    }
    this.pop_back()
  }
})();
Kata.require(["katajs/core/Channel.js"], function() {
  Kata.FilterChannel = function(e, g) {
    this._channel = e;
    this._filter = g;
    this._channel.registerListener(Kata.bind(this._filterMessage, this))
  };
  var e = Kata.Channel.prototype;
  Kata.extend(Kata.FilterChannel, e);
  Kata.FilterChannel.prototype.callListeners = function(f) {
    this._filter(this, f) || e.callListeners.apply(this, [f])
  };
  Kata.FilterChannel.prototype.sendMessage = function(e) {
    this._channel.sendMessage(e)
  };
  Kata.FilterChannel.prototype._filterMessage = function(e, g) {
    this.callListeners(g)
  }
}, "katajs/core/FilterChannel.js");
var Kata_Vector, Kata_Location, Kata_LocationMsg, Kata_Date;
Kata.require([], function() {
  Kata.LocationIdentityNow = function() {
    return Kata.LocationIdentity(Date.now())
  };
  Kata.LocationIdentity = function(e) {
    return{scale:[0, 0, 0, 1], scaleTime:e, pos:[0, 0, 0], posTime:e, orient:[0, 0, 0, 1], orientTime:e, vel:[0, 0, 0], rotaxis:[0, 0, 1], rotvel:0}
  };
  Kata.deltaTime = function(e, f) {
    return(e - f) * 0.001
  };
  Kata._helperLocationExtrapolate3vec = function(e, f, g) {
    return[e[0] + f[0] * g, e[1] + f[1] * g, e[2] + f[2] * g]
  };
  Kata._helperQuatFromAxisAngle = function(e, f) {
    var g = Math.sin(f / 2);
    return[g * e[0], g * e[1], g * e[2], Math.cos(f / 2)]
  };
  Kata.extrapolateQuaternion = function(e, f, g, h) {
    var j = Kata._helperQuatFromAxisAngle(g, f * h), f = e[0], g = e[1], h = e[2], e = e[3], m = j[0], p = j[1], o = j[2], j = j[3];
    return[e * m + f * j + g * o - h * p, e * p + g * j + h * m - f * o, e * o + h * j + f * p - g * m, e * j - f * m - g * p - h * o]
  };
  Kata._helperLocationInterpolate3vec = function(e, f, g, h, j, m, p) {
    p = Kata.deltaTime(p, g);
    if(p > 0) {
      return Kata._helperLocationExtrapolate3vec(e, f, p)
    }
    g = Kata.deltaTime(g, m);
    if(g == 0) {
      return Kata._helperLocationExtrapolate3vec(e, f, p)
    }
    p += g;
    if(p < 0) {
      return h
    }
    h = Kata._helperLocationExtrapolate3vec(h, j, p);
    f = p / g;
    j = 1 - f;
    return[f * e[0] + j * h[0], f * e[1] + j * h[1], f * e[2] + j * h[2]]
  };
  Kata._helperLocationInterpolateNoVel4vec = function(e, f, g, h, j) {
    j = Kata.deltaTime(j, f);
    if(j > 0) {
      return e
    }
    f = Kata.deltaTime(f, h);
    if(f == 0) {
      return e
    }
    j += f;
    if(j < 0) {
      return g
    }
    f = j / f;
    h = 1 - f;
    return[f * e[0] + h * g[0], f * e[1] + h * g[1], f * e[2] + h * g[2], f * e[3] + h * g[3]]
  };
  Kata._helperLocationInterpolateQuaternion = function(e, f, g, h, j, m, p, o, r) {
    r = Kata.deltaTime(r, h);
    if(r > 0) {
      return Kata.extrapolateQuaternion(e, f, g, r)
    }
    h = Kata.deltaTime(h, o);
    if(h == 0) {
      return Kata.extrapolateQuaternion(e, f, g, r)
    }
    r += h;
    if(r < 0) {
      return j
    }
    j = Kata.extrapolateQuaternion(j, m, p, r);
    p = r / h;
    h = 1 - p;
    f = p * e[0] + h * j[0];
    g = p * e[1] + h * j[1];
    m = p * e[2] + h * j[2];
    e = p * e[3] + h * j[3];
    j = Math.sqrt(e * e + f * f + g * g + m * m);
    if(j < 1.0E-20) {
      return[f, g, m, e]
    }
    return[f / j, g / j, m / j, e / j]
  };
  Kata.LocationInterpolate = function(e, f, g) {
    return{scale:Kata._helperLocationInterpolateNoVel4vec(e.scale, e.scaleTime, f.scale, f.scaleTime, g), scaleTime:g, pos:Kata._helperLocationInterpolate3vec(e.pos, e.vel, e.posTime, f.pos, f.vel, f.posTime, g), posTime:g, orient:Kata._helperLocationInterpolateQuaternion(e.orient, e.rotvel, e.rotaxis, e.orientTime, f.orient, f.rotvel, f.rotaxis, f.orientTime, g), orientTime:g, rotvel:e.rotvel, rotaxis:e.rotaxis, vel:e.vel}
  };
  Kata.LocationTriTimeInterpolate = function(e, f, g, h, j) {
    return{scale:Kata._helperLocationInterpolateNoVel4vec(e.scale, e.scaleTime, f.scale, f.scaleTime, j), scaleTime:j, pos:Kata._helperLocationInterpolate3vec(e.pos, e.vel, e.posTime, f.pos, f.vel, f.posTime, g), posTime:g, orient:Kata._helperLocationInterpolateQuaternion(e.orient, e.rotvel, e.rotaxis, e.orientTime, f.orient, f.rotvel, f.rotaxis, f.orientTime, h), orientTime:h, rotvel:e.rotvel, rotaxis:e.rotaxis, vel:e.vel}
  };
  Kata.LocationExtrapolate = function(e, f) {
    return{scale:e.scale, scaleTime:f, pos:Kata._helperLocationExtrapolate3vec(e.pos, e.vel, Kata.deltaTime(f, e.posTime)), posTime:f, orient:Kata.extrapolateQuaternion(e.orient, e.rotvel, e.rotaxis, Kata.deltaTime(f, e.orientTime)), orientTime:f, rotvel:e.rotvel, rotaxis:e.rotaxis, vel:e.vel}
  };
  Kata.LocationCopyUnifyTime = function(e, f) {
    if(e.time !== void 0) {
      f.time = e.time;
      if(e.scale !== void 0) {
        f.scale = Kata.Vec4Dup(e.scale)
      }
      if(e.pos !== void 0) {
        f.pos = Kata.Vec3Dup(e.pos)
      }
      if(e.orient !== void 0) {
        f.orient = new Kata.Quaternion(e.orient)
      }
      if(e.rotvel !== void 0 && e.rotaxis !== void 0) {
        f.rotvel = e.rotvel, f.rotaxis = Kata.Vec3Dup(e.rotaxis)
      }
      if(e.vel !== void 0) {
        f.vel = Kata.Vec3Dup(e.vel)
      }
    }else {
      var g = e.scaleTime;
      if(g === void 0 || e.posTime >= g) {
        g = e.posTime
      }
      if(g === void 0 || e.orientTime >= g) {
        g = e.orientTime
      }
      if(e.scale !== void 0) {
        f.scale = Kata.Vec4Dup(e.scale)
      }
      if(e.pos !== void 0) {
        f.pos = e.vel && e.posTime ? Kata._helperLocationExtrapolate3vec(e.pos, e.vel, Kata.deltaTime(g, e.posTime)) : Kata.Vec3Dup(e.pos)
      }
      if(e.orient !== void 0) {
        f.orient = e.rotvel !== void 0 && e.rotaxis !== void 0 && e.orientTime !== void 0 ? Kata.extrapolateQuaternion(e.orient, e.rotvel, e.rotaxis, Kata.deltaTime(g, e.orientTime)) : new Kata.Quaternion(e.orient)
      }
      if(e.rotvel !== void 0 && e.rotaxis !== void 0) {
        f.rotvel = e.rotvel, f.rotaxis = Kata.Vec3Dup(e.rotaxis)
      }
      if(e.vel !== void 0) {
        f.vel = Kata.Vec3Dup(e.vel)
      }
      f.time = g
    }
  };
  Kata.LocationSet = function(e) {
    if(e.time == void 0) {
      e.time = Date.now()
    }
    if(e.scale == void 0) {
      e.scale = [0, 0, 0, 1]
    }
    if(e.vel == void 0) {
      e.vel = [0, 0, 0]
    }
    if(e.rotaxis == void 0) {
      e.rotaxis = [0, 0, 1]
    }
    if(e.rotvel == void 0) {
      e.rotvel = 0
    }
    if(e.orient == void 0) {
      e.orient = [0, 0, 0, 1]
    }
    return{scale:e.scale, scaleTime:e.time, pos:e.pos, posTime:e.time, orient:e.orient, orientTime:e.time, vel:e.vel, rotaxis:e.rotaxis, rotvel:e.rotvel}
  };
  Kata.LocationUpdate = function(e, f, g) {
    g || (g = f);
    var h = {scale:f.scale, scaleTime:f.scaleTime, pos:f.pos, posTime:f.posTime, orient:f.orient, orientTime:f.orientTime, vel:f.vel, rotaxis:f.rotaxis, rotvel:f.rotvel};
    if(e.pos && e.time && e.time >= f.posTime) {
      h.pos = e.pos, h.posTime = e.time
    }else {
      if(e.vel && e.time && e.time >= f.posTime) {
        h.pos = Kata._helperLocationExtrapolate3vec(f.pos, f.vel, Kata.deltaTime(e.time, f.posTime)), h.posTime = e.time
      }
    }
    e.vel && e.time && e.time >= f.posTime ? h.vel = e.vel : f.vel = g.vel;
    if(e.orient && e.time && e.time >= f.orientTime) {
      h.orient = e.orient, h.orientTime = e.time
    }else {
      if(e.rotvel !== void 0 && e.rotaxis !== void 0) {
        h.orient = Kata.extrapolateQuaternion(f.orient, f.rotvel, f.rotaxis, Kata.deltaTime(e.time, f.orientTime)), h.orientTime = e.time
      }
    }
    e.rotvel !== void 0 && e.rotaxis !== void 0 && e.time !== void 0 && e.time >= f.orientTime ? (h.rotaxis = e.rotaxis, h.rotvel = e.rotvel) : (h.rotaxis = f.rotaxis, h.rotvel = f.rotvel);
    e.scale && e.time && e.time >= f.scaleTime ? (h.scale = e.scale, h.scaleTime = e.time) : (h.scale = f.scale, h.scaleTime = f.scaleTime);
    return h
  };
  Kata.LocationReset = function(e, f) {
    if(e.scale !== void 0) {
      f.scale = e.scale, f.scaleTime = e.time
    }
    if(e.pos !== void 0) {
      f.pos = e.pos, f.posTime = e.time
    }
    if(e.vel !== void 0) {
      f.vel = e.vel
    }
    if(e.rotvel !== void 0 && e.rotaxis !== void 0) {
      f.rotaxis = e.rotaxis
    }
    if(e.orient !== void 0) {
      f.orient = e.orient, f.orientTime = e.time
    }
  };
  Kata.QuaternionMulQuaternion = function(e, f) {
    var g = e[0], h = e[1], j = e[2], m = e[3], p = f[0], o = f[1], r = f[2], s = f[3];
    return[m * p + g * s + h * r - j * o, m * o + h * s + j * p - g * r, m * r + j * s + g * o - h * p, m * s - g * p - h * o - j * r]
  };
  Kata.QuaternionToRotation = function(e) {
    var f = e[0], g = e[1], h = e[2], j = e[3], e = j * j, m = j * f, p = j * g;
    j *= h;
    var o = f * f, r = f * g;
    f *= h;
    var s = g * g;
    g *= h;
    h *= h;
    var t = e + o + s + h;
    return[[(e + o - s - h) / t, 2 * (j + r) / t, 2 * (f - p) / t, 0], [2 * (r - j) / t, (e - o + s - h) / t, 2 * (m + g) / t, 0], [2 * (p + f) / t, 2 * (g - m) / t, (e - o - s + h) / t, 0], [0, 0, 0, 1]]
  };
  Kata.Vec3Dup = function(e) {
    return[e[0], e[1], e[2]]
  };
  Kata.Vec4Dup = function(e) {
    return[e[0], e[1], e[2], e[3]]
  };
  Kata.Vec3Cross = function(e, f) {
    return[e[1] * f[2] - e[2] * f[1], e[2] * f[0] - e[0] * f[2], e[0] * f[1] - e[1] * f[0]]
  };
  Kata.Vec3Add = function(e, f) {
    return[e[0] + f[0], e[1] + f[1], e[2] + f[2]]
  };
  Kata.Vec3Sub = function(e, f) {
    return[e[0] - f[0], e[1] - f[1], e[2] - f[2]]
  };
  Kata.Vec3Scale = function(e, f) {
    return[e[0] * f, e[1] * f, e[2] * f]
  };
  Kata.Vec4Scale = function(e, f) {
    return[e[0] * f, e[1] * f, e[2] * f, e[3] * f]
  };
  Kata.Vec3Rotate = function(e, f, g, h) {
    return[e[0] * f[0] + e[1] * g[0] + e[2] * h[0], e[0] * f[1] + e[1] * g[1] + e[2] * h[1], e[0] * f[2] + e[1] * g[2] + e[2] * h[2]]
  };
  Kata.LocationCompose = function(e, f, g) {
    var f = Kata.LocationTriTimeInterpolate(g, f, e.posTime, e.orientTime, e.scaleTime), h = Kata.QuaternionToRotation(f.orient), g = Kata.Vec3Add(Kata.Vec3Add(Kata.Vec3Scale(Kata.Vec3Cross(f.rotaxis, Kata.Vec3Add(Kata.Vec3Scale(e.pos, f.scale[3]), f.scale)), f.rotvel), f.vel), Kata.Vec3Rotate(e.vel, h[0], h[1], h[2])), j = Kata.Vec3Rotate(e.rotaxis, h[0], h[1], h[2]), h = Kata.Vec3Add(Kata.Vec3Rotate(e.pos, h[0], h[1], h[2]), f.pos), m = Kata.QuaternionMulQuaternion(f.orient, e.orient);
    return{pos:h, orient:m, scale:[e.scale[0], e.scale[1], e.scale[2], e.scale[3] * f.scale[3]], rotaxis:j, rotvel:e.rotvel, vel:g, posTime:e.posTime, orientTime:e.orientTime, scaleTime:e.scaleTime}
  };
  Kata.QuaternionInverse = function(e) {
    var f = e[0], g = e[1], h = e[2], e = e[3], j = 1 / (f * f + g * g + h * h + e * e);
    return[-f * j, -g * j, -h * j, e * j]
  };
  Kata.LocationInverseCompose = function(e, f, g) {
    var h = Kata.LocationTriTimeInterpolate(g, f, e.posTime, e.orientTime, e.scaleTime), j = Kata.QuaternionInverse(h.orient), m = Kata.QuaternionToRotation(j), f = Kata.Vec3Rotate(Kata.Vec3Add(Kata.Vec3Sub(Kata.Vec3Scale(Kata.Vec3Cross(h.rotaxis, e.pos), -h.rotvel), h.vel), e.vel), m[0], m[1], m[2]), g = Kata.Vec3Rotate(e.rotaxis, m[0], m[1], m[2]), m = Kata.Vec3Rotate(Kata.Vec3Sub(e.pos, h.pos), m[0], m[1], m[2]), f = Kata.Vec3Scale(f, h.scale[3]), m = Kata.Vec3Scale(Kata.Vec3Sub(m, h.scale), 1 /
    h.scale[3]), j = Kata.QuaternionMulQuaternion(e.orient, j), h = Kata.Vec4Scale(e.scale, 1 / h.scale[3]);
    return{pos:m, orient:j, scale:h, rotaxis:g, rotvel:e.rotvel, vel:f, posTime:e.posTime, orientTime:e.orientTime, scaleTime:e.scaleTime}
  };
  Kata.LocationReparent = function(e, f, g) {
    var h, j = f.length;
    for(h = 0;h < j;h++) {
      e = Kata.LocationCompose(e, f[h][0], f[h][1])
    }
    for(h = g.length - 1;h >= 0;h--) {
      e = Kata.LocationInverseCompose(e, g[h][0], g[h][1])
    }
    return e
  }
}, "katajs/core/Location.js");
Math.uuid = function() {
  var e = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
  return function(f, g) {
    var h = [], g = g || e.length;
    if(f) {
      for(var j = 0;j < f;j++) {
        h[j] = e[0 | Math.random() * g]
      }
    }else {
      var m;
      h[8] = h[13] = h[18] = h[23] = "-";
      h[14] = "4";
      for(j = 0;j < 36;j++) {
        h[j] || (m = 0 | Math.random() * 16, h[j] = e[j == 19 ? m & 3 | 8 : m])
      }
    }
    return h.join("")
  }
}();
Math.uuidV4Bytes = function() {
  for(var e = Array(16), f = 0;f < 16;f++) {
    var g = 0 | Math.random() * 256;
    f == 7 ? g = g & 15 | 64 : f == 9 && (g = g & 243 | 8);
    e[f] = g
  }
  return e
};
Math.uuid2 = function() {
  return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(e) {
    var f = Math.random() * 16 | 0;
    return(e == "x" ? f : f & 3 | 8).toString(16)
  }).toUpperCase()
};
Kata.require([], function() {
  Kata.MessageDispatcher = function(e) {
    this._handlers = e
  };
  Kata.MessageDispatcher.prototype.add = function(e, f) {
    this._handlers[e] = f
  };
  Kata.MessageDispatcher.prototype.dispatch = function(e, f) {
    var g = f.__type;
    if(!this._handlers[g]) {
      return!1
    }
    this._handlers[g](e, f);
    return!0
  }
}, "katajs/core/MessageDispatcher.js");
Kata.require(["katajs/core/Math.uuid.js"], function() {
  Kata.ObjectID = {};
  Kata.ObjectID.nil = function() {
    return"00000000-0000-0000-0000-000000000000"
  };
  Kata.ObjectID.random = function() {
    return Math.uuid()
  };
  Kata.ObjectID.any = function() {
    return"ffffffff-ffff-ffff-ffff-ffffffffffff"
  }
}, "katajs/core/ObjectID.js");
Kata.require(["katajs/core/SpaceID.js", "katajs/core/ObjectID.js"], function() {
  Kata.PresenceID = function() {
    if(arguments.length == 1) {
      if(arguments[0].mSpace && arguments[0].mObject) {
        this.mSpace = arguments[0].mSpace, this.mObject = arguments[0].mObject
      }else {
        throw"Invalid PresenceID constructor arguments.";
      }
    }else {
      if(arguments.length == 2 && arguments[0] && arguments[1]) {
        this.mSpace = arguments[0], this.mObject = arguments[1]
      }else {
        throw"Invalid PresenceID constructor arguments.";
      }
    }
  };
  Kata.PresenceID.prototype.space = function() {
    return this.mSpace
  };
  Kata.PresenceID.prototype.object = function() {
    return this.mObject
  };
  Kata.PresenceID.prototype.toString = function() {
    return"PresenceID(" + this.mSpace.toString() + ":" + this.mObject.toString() + ")"
  };
  Kata.PresenceID.nil = function() {
    return new Kata.PresenceID(Kata.SpaceID.nil(), Kata.ObjectID.nil())
  };
  Kata.PresenceID.any = function() {
    return new Kata.PresenceID(Kata.SpaceID.any(), Kata.ObjectID.any())
  }
}, "katajs/core/PresenceID.js");
Kata.require([], function() {
  Kata.Quaternion = function() {
    this.length = 4;
    if(arguments.length == 0) {
      this[0] = 0, this[1] = 0, this[2] = 0, this[3] = 1
    }else {
      if(arguments.length == 1) {
        this[0] = arguments[0][0], this[1] = arguments[0][1], this[2] = arguments[0][2], this[3] = arguments[0][3]
      }else {
        if(arguments.length == 4) {
          this[0] = arguments[0], this[1] = arguments[1], this[2] = arguments[2], this[3] = arguments[3]
        }else {
          throw"Invalid Quaternion constructor arguments.";
        }
      }
    }
  };
  Kata.extend(Kata.Quaternion, Array.prototype);
  Kata.Quaternion.fromAxisAngle = function(e, f) {
    var g = Math.sin(f * 0.5);
    return new Kata.Quaternion(g * e[0], g * e[1], g * e[2], Math.cos(f * 0.5))
  };
  Kata.Quaternion.fromLocationAngularVelocity = function(e) {
    return Kata.Quaternion.fromAxisAngle(e.rotaxis, e.rotvel)
  };
  Kata.Quaternion.identity = function() {
    return new Kata.Quaternion
  };
  Kata.Quaternion.zero = function() {
    return new Kata.Quaternion(0, 0, 0, 0)
  };
  Kata.Quaternion.prototype.array = function() {
    return[this[0], this[1], this[2], this[3]]
  };
  Kata.Quaternion.prototype.toAngleAxis = function() {
    var e = this[0] * this[0] + this[1] * this[1] + this[2] * this[2], f = this[3];
    f > 1 && f < 1.000001 && (f = 1);
    f < -1 && f > -1.000001 && (f = -1);
    e > 1.0E-8 && f <= 1 && f >= -1 ? (f = 2 * Math.acos(f), e = Math.sqrt(e), e = [this[0] / e, this[1] / e, this[2] / e]) : (f = 0, e = [1, 0, 0]);
    return{angle:f, axis:e}
  };
  Kata.Quaternion.prototype.dot = function(e) {
    return this[0] * e[0] + this[1] * e[1] + this[2] * e[2] + this[3] * e[3]
  };
  Kata.Quaternion.prototype.sizeSquared = function() {
    return this.dot(this)
  };
  Kata.Quaternion.prototype.size = function() {
    return Math.sqrt(this.sizeSquared)
  };
  Kata.Quaternion.prototype.normal = function() {
    var e = this.size();
    if(e > 1.0E-8) {
      return this.scale(1 / e)
    }
    return new Kata.Quaternion(this)
  };
  Kata.Quaternion.prototype.scale = function(e) {
    if(typeof e == "number") {
      return new Kata.Quaternion(this[0] * e, this[1] * e, this[2] * e, this[3] * e)
    }else {
      throw"Don't know how to multiply Quaternion by given object.";
    }
  };
  Kata.Quaternion.prototype.add = function(e) {
    if(typeof e == "number") {
      return new Kata.Quaternion(this[0] + e, this[1] + e, this[2] + e, this[3] + e)
    }else {
      if(e && typeof e.length !== "undefined" && e.length == 4) {
        return new Kata.Quaternion(this[0] + e[0], this[1] + e[1], this[2] + e[2], this[3] + e[3])
      }else {
        throw"Don't know how to multiply Quaternion by given object.";
      }
    }
  };
  Kata.Quaternion.prototype.negate = function() {
    return new Kata.Quaternion(-this[0], -this[1], -this[2], -this[3])
  };
  Kata.Quaternion._vec3_cross = function(e, f) {
    return[e[1] * f[2] - e[2] * f[1], e[2] * f[0] - e[0] * f[2], e[0] * f[1] - e[1] * f[0]]
  };
  Kata.Quaternion.prototype.multiply = function(e) {
    if(e.prototype === Kata.Quaternion) {
      return new Kata.Quaternion(this[3] * e[0] + this[0] * e[3] + this[1] * e[2] - this[2] * e[1], this[3] * e[1] + this[1] * e[3] + this[2] * e[0] - this[0] * e[2], this[3] * e[2] + this[2] * e[3] + this[0] * e[1] - this[1] * e[0], this[3] * e[3] - this[0] * e[0] - this[1] * e[1] - this[2] * e[2])
    }else {
      if(typeof e.length !== "undefined" && e.length === 3) {
        var f = [this[0], this[1], this[2]], g = Kata.Quaternion._vec3_cross(f, e), f = Kata.Quaternion._vec3_cross(f, g), g = [g[0] * 2 * this[3], g[1] * 2 * this[3], g[2] * 2 * this[3]], f = [f[0] * 2, f[1] * 2, f[2] * 2];
        return[e[0] + g[0] + f[0], e[1] + g[1] + f[1], e[2] + g[2] + f[2]]
      }else {
        throw"Don't know how to multiply given type by quaternion.";
      }
    }
  };
  Kata.Quaternion.prototype.inverse = function() {
    var e = this[0], f = this[1], g = this[2], h = this[3], j = e * e + f * f + g * g + h * h, j = j ? 1 / j : 0;
    return new Kata.Quaternion(e * j, -f * j, -g * j, h * j)
  };
  Kata.Quaternion.prototype.exp = function(e) {
    var f = this.toAngleAxis();
    return Kata.Quaternion.fromAxisAngle(f.axis, f.angle * e)
  }
}, "katajs/core/Quaternion.js");
Kata.require(["katajs/core/Channel.js"], function() {
  var e = Kata.Channel.prototype;
  Kata.SimpleChannel = function(f) {
    e.constructor.call(this);
    f && this.pair(f)
  };
  Kata.extend(Kata.SimpleChannel, e);
  Kata.SimpleChannel.prototype.pair = function(e) {
    if(!(e instanceof Kata.SimpleChannel)) {
      throw console.error("otherChannel " + e + " is not instance of SimpleChannel"), "Error in SimpleChannel.pair";
    }
    e.mPartner = this;
    this.mPartner = e
  };
  Kata.SimpleChannel.prototype.sendMessage = function(e) {
    Kata.FAKE_WEB_WORKERS_DEBUG && (e = JSON.parse(JSON.stringify(e), function(e, f) {
      var j;
      if(typeof f === "object" && f && f.length !== void 0 && f.byteLength !== void 0 && f.byteOffset !== void 0 && f.buffer && f.buffer.byteLength !== void 0) {
        j = [];
        for(var m = f.length, p = 0;p < m;++p) {
          j.push(f[p])
        }
        return j
      }
      if(typeof f === "string" && (j = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(f))) {
        return new Date(Date.UTC(+j[1], +j[2] - 1, +j[3], +j[4], +j[5], +j[6]))
      }
      return f
    }));
    this.mPartner.callListeners(e)
  }
}, "katajs/core/SimpleChannel.js");
Kata.require([], function() {
  Kata.SpaceID = {};
  Kata.SpaceID.nil = function() {
    return""
  };
  Kata.SpaceID.any = function() {
    return"*"
  }
}, "katajs/core/SpaceID.js");
typeof Kata == "undefined" && (Kata = {});
typeof console == "undefined" ? (console = {}, debug_console = !1) : debug_console = !0;
Kata.require([], function() {
  var e = Date.now(), f = !1;
  Kata.scheduleNowUpdates = function(e) {
    function h() {
      setTimeout(h, e);
      Kata.updateNow()
    }
    h();
    f = !0
  };
  Kata.now = function() {
    return f ? e : Kata.updateNow()
  };
  Kata.updateNow = function(f) {
    return e = f === void 0 ? Date.now() : f
  }
}, "katajs/core/Time.js");
Kata.require([], function() {
  Kata.URL = function(e) {
    return e
  };
  Kata.URL.protocol = function(e) {
    var f = e.indexOf("://");
    f == -1 && Kata.error("Invalid URL: " + e);
    return e.substr(0, f)
  };
  Kata.URL._hostAndPort = function(e) {
    var f = e.indexOf("://");
    f == -1 ? (Kata.error("Invalid URL: " + e), f = 0) : f += 3;
    var g = e.indexOf("/", f);
    return g != -1 ? e.substr(f, g - f) : e.substr(f)
  };
  Kata.URL.host = function(e) {
    var e = Kata.URL._hostAndPort(e), f = e.indexOf(":");
    if(f == -1) {
      return e
    }
    return e.substr(0, f)
  };
  Kata.URL.port = function(e) {
    var e = Kata.URL._hostAndPort(e), f = e.indexOf(":");
    if(f != -1) {
      return e = e.substr(f + 1), parseInt(e)
    }
  };
  Kata.URL.resource = function(e) {
    var f = e.indexOf("://");
    f == -1 && Kata.error("Invalid URL: " + e);
    f = e.indexOf("/", f + 3);
    if(f == -1) {
      return""
    }
    return e.substr(f)
  };
  Kata.URL.equals = function(e, f) {
    return e == f
  }
}, "katajs/core/URL.js");
Kata.require(["katajs/core/SimpleChannel.js"], function() {
  function e(e) {
    return function(f) {
      e.callListeners(f.data)
    }
  }
  function f(e) {
    return function(f) {
      e.gotError(f.message, f.filename, f.lineno)
    }
  }
  if(self.Kata_WEB_WORKERS_ENABLED === void 0) {
    if(Kata.WEB_WORKERS_ENABLED === void 0) {
      Kata.WEB_WORKERS_ENABLED = !0
    }
  }else {
    Kata.WEB_WORKERS_ENABLED = self.Kata_WEB_WORKERS_ENABLED
  }
  if(self.Kata_FAKE_WEB_WORKERS_DEBUG === void 0) {
    if(Kata.FAKE_WEB_WORKERS_DEBUG === void 0) {
      Kata.FAKE_WEB_WORKERS_DEBUG = Kata.WEB_WORKERS_ENABLED
    }
  }else {
    Kata.FAKE_WEB_WORKERS_DEBUG = self.Kata_FAKE_WEB_WORKERS_DEBUG
  }
  if(self.Kata_WEB_WORKERS_BOOTSTRAP_SCRIPT === void 0) {
    if(Kata.WEB_WORKERS_BOOTSTRAP_SCRIPT === void 0) {
      Kata.WEB_WORKERS_BOOTSTRAP_SCRIPT = !1
    }
  }else {
    Kata.WEB_WORKERS_BOOTSTRAP_SCRIPT = self.Kata_WEB_WORKERS_BOOTSTRAP_SCRIPT
  }
  if(self.Kata_bootstrapWorker !== void 0) {
    Kata.bootstrapWorker = self.Kata_bootstrapWorker
  }
  Kata.FakeWebWorker = function(e, f, g) {
    this.mChannel = new Kata.SimpleChannel;
    this.mArgs = g;
    this.mClassName = f;
    this.mJSFile = e;
    network_debug && console.log("new webworker")
  };
  Kata.FakeWebWorker.prototype.go = function() {
    var e = new Kata.SimpleChannel(this.mChannel);
    if(!this.mClassName || !this.mArgs) {
      Kata.error("WebWorker.go() called twice")
    }else {
      var f = this.mArgs, g = this.mClassName, p = g.split(".");
      delete this.mClassName;
      delete this.mArgs;
      Kata.require([this.mJSFile], function() {
        for(var o = self, r = 0;o && r < p.length;r++) {
          o = o[p[r]]
        }
        o || Kata.error(g + " is undefined:" + this.mJSFile);
        network_debug && console.log("going!");
        new o(e, f)
      })
    }
  };
  Kata.FakeWebWorker.prototype.getChannel = function() {
    return this.mChannel
  };
  Kata.FakeWebWorker.prototype.gotError = function(e, f, g) {
    Kata.error("ERROR at " + f + ":" + g + ": " + e)
  };
  var g = Kata.Channel.prototype;
  Kata.FakeWebWorker.Channel = function(f) {
    g.constructor.call(this);
    this.mMessagePort = f;
    this.mMessagePort.onmessage = e(this)
  };
  Kata.extend(Kata.FakeWebWorker.Channel, g);
  Kata.FakeWebWorker.Channel.prototype.sendMessage = function(e) {
    this.mMessagePort.postMessage(e)
  };
  Kata.WEB_WORKERS_ENABLED && typeof Worker != "undefined" ? (Kata.WebWorker = function(e, g, m) {
    this.mWorker = Kata.bootstrapWorker === void 0 ? new Worker(Kata.scriptRoot + "katajs/core/GenericWorker.js" + Kata.queryString) : new Worker(Kata.bootstrapWorker);
    this.mWorker.onerror = f(this);
    this.mInitialMessage = [Kata.scriptRoot, Kata.bootstrapWorker === void 0 ? void 0 : Kata.bootstrapWorker, e, g, m, Kata.queryString];
    this.mChannel = new Kata.WebWorker.Channel(this.mWorker)
  }, Kata.WebWorker.prototype.go = function() {
    var e = this.mInitialMessage;
    delete this.mInitialMessage;
    Kata.bootstrapWorker !== void 0 && this.mWorker.postMessage(Kata.scriptRoot + "katajs/core/GenericWorker.js" + Kata.queryString);
    this.mWorker.postMessage(e)
  }, Kata.WebWorker.prototype.getChannel = Kata.FakeWebWorker.prototype.getChannel, Kata.WebWorker.prototype.gotError = Kata.FakeWebWorker.prototype.gotError, Kata.WebWorker.Channel = Kata.FakeWebWorker.Channel) : Kata.WebWorker = Kata.FakeWebWorker
}, "katajs/core/WebWorker.js");
Kata.require(["katajs/core/Channel.js", "katajs/core/Math.uuid.js"], function() {
  function e(e, f) {
    return function(g) {
      e._onMessage(f, g.data)
    }
  }
  function f(e, f) {
    return function() {
      e._onOpen(f)
    }
  }
  function g(e, f) {
    return function() {
      e._onClose(f)
    }
  }
  function h(e, f) {
    return function() {
      e._onError(f)
    }
  }
  if(typeof WebSocket != "undefined") {
    Kata.TCPSST = function(e, f, g) {
      g || (g = 1);
      this.mUUID = Math.uuid();
      this.mURI = "ws://" + e + ":" + f + "/" + this.mUUID;
      this.mSockets = Array(g);
      this.mConnected = [];
      this.mMessageQueue = [];
      for(e = 0;e < g;e++) {
        this._connectSocket(e)
      }
      this.mNextSubstream = 1;
      this.mSubstreams = {}
    };
    Kata.TCPSST.prototype._connectSocket = function(j) {
      this.mSockets[j] && this.mSockets[j].readyState == WebSocket.CONNECTED && this.mConnected--;
      var p = new WebSocket(this.mURI);
      p.binaryType = "arraybuffer";
      p.onopen = f(this, j);
      p.onclose = g(this, j);
      p.onmessage = e(this, j);
      p.onerror = h(this, j);
      p._timeout = setTimeout(Kata.bind(this._onError, this, j), 1E4);
      this.mSockets[j] = p
    };
    Kata.TCPSST.prototype._onClose = function(e) {
      network_debug && console.log("Closed socket " + e);
      e = this.mConnected.indexOf(e);
      e != -1 && this.mConnected.splice(e, 1);
      for(var f in this.mSubstreams) {
        this.mSubstreams[f].callListeners(null)
      }
    };
    Kata.TCPSST.prototype._onOpen = function(e) {
      network_debug && console.log("Opened socket " + e);
      clearTimeout(this.mSockets[e]._timeout);
      delete this.mSockets[e]._timeout;
      this.mConnected.push(e);
      for(var f = 0;f < this.mMessageQueue.length;f++) {
        this.mSockets[e].send(this.mMessageQueue[f])
      }
      this.mMessageQueue = []
    };
    Kata.TCPSST.prototype._onError = function(e) {
      delete this.mSockets[e];
      for(var f in this.mSubstreams) {
        this.mSubstreams[f].callListeners(null)
      }
    };
    Kata.TCPSST.prototype._onMessage = function(e, f) {
      var g = new Uint8Array(f, 0, f.length < 5 ? f.length : 5), h;
      a: {
        var j = h = 0, t;
        for(h = 0;h < g.length;h++) {
          if(t = g[h], j |= (t & 127) << 7 * h, !(t & 128)) {
            h = [h + 1, j];
            break a
          }
        }
        h = void 0
      }
      h ? (g = h[0], h = h[1], this.mSubstreams[h] || (j = new Kata.TCPSST.Substream(this, h), this.mSubstreams[h] = j), this.mSubstreams[h].callListeners(new Uint8Array(f, g))) : Kata.log("Error: Failed to parse stream ID!")
    };
    var j = new Uint8Array(5);
    Kata.TCPSST.prototype.send = function(e, f) {
      var g;
      g = e;
      var h, s = 0;
      do {
        h = g & 127, g >>>= 7, g != 0 && (h += 128), j[s++] = h
      }while(g != 0);
      g = s;
      h = new ArrayBuffer(g + f.length);
      for(var s = new Uint8Array(h), t = 0;t < g;t++) {
        s[t] = j[t]
      }
      s.set(f, g);
      this.mConnected.length == 0 ? this.mMessageQueue.push(h) : this.mSockets[this.mConnected[Math.floor(Math.random() * this.mConnected.length)]].send(h)
    };
    Kata.TCPSST.prototype._getNewSubstreamID = function() {
      var e = this.mNextSubstream;
      this.mNextSubstream += 2;
      return e
    };
    Kata.TCPSST.prototype.clone = function() {
      var e = this._getNewSubstreamID(), f = new Kata.TCPSST.Substream(this, e);
      return this.mSubstreams[e] = f
    };
    Kata.TCPSST.prototype.close = function() {
      for(var e = this.mSockets.length, f = 0;f < e;++f) {
        this.mSockets[f].close()
      }
    };
    Kata.TCPSST.Substream = function(e, f) {
      this.mOwner = e;
      this.mWhich = f;
      Kata.Channel.call(this)
    };
    Kata.extend(Kata.TCPSST.Substream, Kata.Channel.prototype);
    Kata.TCPSST.Substream.prototype.sendMessage = function(e) {
      this.mOwner.send(this.mWhich, e)
    };
    Kata.TCPSST.Substream.prototype.getTopLevelStream = function() {
      return this.mOwner
    };
    Kata.TCPSST.Substream.prototype.close = function() {
    }
  }else {
    Kata.warn("WebSockets not available.")
  }
}, "katajs/network/TCPSST.js");
Kata.require(["externals/protojs/protobuf.js"], function() {
  if(typeof Kata.Behavior == "undefined") {
    Kata.Behavior = {}
  }
  Kata.Behavior.NamedObject = function(e, f) {
    this.mName = e;
    this.mParent = f;
    this.mParent.addBehavior(this);
    this.mPorts = {}
  };
  Kata.Behavior.NamedObject.prototype.ProtocolPort = 10;
  Kata.Behavior.NamedObject.prototype._getPort = function(e) {
    var f = e;
    e.presenceID && (f = e.presenceID());
    var g = this.mPorts[f];
    !g && e.bindODPPort && (g = e.bindODPPort(this.ProtocolPort), g.receive(Kata.bind(this.handleResponse, this)), this.mPorts[f] = g);
    return g
  };
  Kata.Behavior.NamedObject.prototype.newPresence = function(e) {
    this._getPort(e).receive(Kata.bind(this._handleMessage, this))
  };
  Kata.Behavior.NamedObject.prototype.presenceInvalidated = function(e) {
    var f = this._getPort(e);
    f && (f.close(), delete this.mPorts[e.presenceID()])
  };
  Kata.Behavior.NamedObject.prototype._handleMessage = function(e, f) {
    this._getPort(f.presenceID()).send(e, PROTO.encodeUTF8(this.mName))
  };
  Kata.Behavior.NamedObjectObserver = function(e, f, g) {
    this.SUPER.constructor.call(this, e, f);
    this.mCB = g;
    this.mQueriedObjects = {}
  };
  Kata.extend(Kata.Behavior.NamedObjectObserver, Kata.Behavior.NamedObject.prototype);
  Kata.Behavior.NamedObjectObserver.prototype.remotePresence = function(e, f, g) {
    if(g) {
      this._getPort(e).send(f.endpoint(this.ProtocolPort), "");
      var h = this, j = {remote:f}, e = setTimeout(function() {
        h._requestTimeout(j)
      }, 1E3);
      j.timer = e;
      this.mQueriedObjects[f.presenceID()] = j
    }else {
      this.mCB && this.mCB(f, g)
    }
  };
  Kata.Behavior.NamedObjectObserver.prototype._handleReply = function(e, f) {
    e.remote.name = f === null ? null : PROTO.decodeUTF8(f);
    this.mCB && this.mCB(e.remote, !0);
    clearTimeout(e.timer);
    delete this.mQueriedObjects[e.remote.presenceID()]
  };
  Kata.Behavior.NamedObjectObserver.prototype._handleMessage = function(e, f, g) {
    var h = this.mQueriedObjects[e.presenceID()];
    h && g && g.length > 0 ? this._handleReply(h, g) : this.SUPER._handleMessage.call(this, e, f, g)
  };
  Kata.Behavior.NamedObjectObserver.prototype._requestTimeout = function(e) {
    this._handleReply(e, null)
  }
}, "katajs/oh/behavior/NamedObject.js");
Kata.require(["katajs/oh/Script.js", "katajs/oh/impl/ScriptProtocol.js"], function() {
  var e = Kata.Script.prototype;
  Kata.GraphicsScript = function(f, g, h) {
    e.constructor.call(this, f, g);
    this.mRenderableRemotePresences = [];
    this.mRenderableRemotePresenceIndex = 0;
    this.mGraphicsTimer = null;
    this.mNumGraphicsSystems = 0;
    this._camPos = [0, 0, 0];
    this._camPosTarget = [0, 0, 0];
    this._camOrient = [0, 0, 0, 1];
    this._camOrientTarget = [0, 0, 0, 1];
    this._camLag = 0.9;
    this.mMessageDispatcher.add(Kata.ScriptProtocol.ToScript.Types.GUIMessage, Kata.bind(this._handleGUIMessage, this));
    this.mUpdateHook = h
  };
  Kata.extend(Kata.GraphicsScript, e);
  Kata.GraphicsScript.prototype._handleGUIMessage = function(e, g) {
    g.msg == "loaded" && this.cameraPeriodicUpdate(!0)
  };
  Kata.GraphicsScript.prototype.queryMeshAspectRatio = function(e, g) {
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.GFXQueryMeshAspectRatio(e.space(), e.id(), g))
  };
  Kata.GraphicsScript.prototype.queryMeshAspectRatio = function(e, g) {
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.GFXQueryMeshAspectRatio(e.space(), e.id(), g))
  };
  Kata.GraphicsScript.prototype.projectPoint = function(e, g, h) {
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.GFXProjectPoint(e.space(), e.id(), g, h))
  };
  Kata.GraphicsScript.prototype.connect = function(f, g, h) {
    e.connect.call(this, f, g, h, !0)
  };
  Kata.GraphicsScript.prototype.enableGraphicsViewport = function(e, g, h) {
    this._enableGraphics(e, g, void 0, void 0, void 0, h)
  };
  Kata.GraphicsScript.prototype.enableGraphicsTexture = function(e, g, h, j) {
    j === void 0 && (j = e.space());
    this._enableGraphics(e, void 0, j, g, h)
  };
  Kata.GraphicsScript.prototype.renderRemotePresence = function(e, g, h) {
    e = new Kata.ScriptProtocol.FromScript.GFXCreateNode(e.space(), e.id(), g);
    Kata.LocationCopyUnifyTime(e, g.mLocation);
    this._sendHostedObjectMessage(e);
    if(h) {
      g.noMesh = !0
    }
    g.inGFXSceneGraph = !0;
    this.updateGFX(g)
  };
  Kata.GraphicsScript.prototype.unrenderRemotePresence = function(e, g) {
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.GFXDestroyNode(e.space(), e.id(), g));
    delete g.inGFXSceneGraph
  };
  Kata.GraphicsScript.prototype._enableGraphics = function(e, g, h, j, m, p) {
    var o = e.space();
    this.mRemotePresences[Kata.Script.remotePresenceKey(e.space(), e.id())] = e;
    for(var r in this.mRemotePresences) {
      var s = this.mRemotePresences[r];
      s.space() == o && (this.mRenderableRemotePresences[this.mRenderableRemotePresences.length] = r, this.shouldRender(e, s) && !s.inGFXSceneGraph && this.renderRemotePresence(e, s))
    }
    o = new Kata.ScriptProtocol.FromScript.RegisterGUIMessage(e.space(), e.id(), e.id());
    this._sendHostedObjectMessage(o);
    o = new Kata.ScriptProtocol.FromScript.GFXEnableEvent(e.space(), "drag");
    this._sendHostedObjectMessage(o);
    o = new Kata.ScriptProtocol.FromScript.GFXEnableEvent(e.space(), "pick");
    this._sendHostedObjectMessage(o);
    p ? (o = new Kata.ScriptProtocol.FromScript.GFXAttachCamera(e.space(), e.id(), e.id(), g, h, j, m), o.msg = "Camera", this._sendHostedObjectMessage(o), o = new Kata.ScriptProtocol.FromScript.GFXAttachCamera(e.space(), e.id(), e.id(), g, h, j, m), this._sendHostedObjectMessage(o)) : (Kata.BlessedCameraID = Kata.ObjectID.random(), o = new Kata.ScriptProtocol.FromScript.GFXCreateNode(e.space(), e.id(), e), o.id = Kata.BlessedCameraID, Kata.BlessedCameraSpace = o.space, Kata.BlessedCameraSpaceid =
    o.spaceid, this._sendHostedObjectMessage(o), o = new Kata.ScriptProtocol.FromScript.GFXAttachCamera(e.space(), e.id(), e.id(), g, h, j, m), o.id = Kata.BlessedCameraID, o.msg = "Camera", this._sendHostedObjectMessage(o), o = new Kata.ScriptProtocol.FromScript.GFXAttachCamera(e.space(), e.id(), e.id(), g, h, j, m), o.id = Kata.BlessedCameraID, this._sendHostedObjectMessage(o), setInterval(Kata.bind(this.cameraPeriodicUpdate, this), 20));
    if(this.mNumGraphicsSystems++ == 0) {
      e = new Date(0), e.setSeconds(2), this.mGraphicsTimer = this.timer(e, Kata.bind(this.processRenderables, this), !0)
    }
  };
  Kata.GraphicsScript.prototype.setCameraPosOrient = function(e, g, h) {
    h == null && (h = 0.9);
    this._camLag = h;
    if(e) {
      if(h == 0) {
        this._camPos = e
      }
      this._camPosTarget = e
    }
    if(g) {
      if(h == 0) {
        this._camOrient = g
      }
      this._camOrientTarget = g
    }
  };
  Kata.GraphicsScript.prototype.cameraPeriodicUpdate = function(e) {
    function g(e, f) {
      for(var g = 0;g < 3;++g) {
        if(!(Math.abs(e[g] - f[g]) < 0.001)) {
          return!1
        }
      }
      return!0
    }
    function h(e, f) {
      for(var g = 0;g < 4;++g) {
        if(!(Math.abs(e[g] - f[g]) < 1.0E-4)) {
          return!1
        }
      }
      return!0
    }
    var j, m = [];
    for(j = 0;j < 3;++j) {
      m[j] = this._camPos[j], this._camPos[j] = this._camPos[j] * this._camLag + this._camPosTarget[j] * (1 - this._camLag)
    }
    var p = [];
    for(j = 0;j < 4;++j) {
      p[j] = this._camOrient[j], this._camOrient[j] = this._camOrient[j] * this._camLag + this._camOrientTarget[j] * (1 - this._camLag)
    }
    if(e || !g(m, this._camPosTarget) || !h(p, this._camOrientTarget)) {
      e = {}, e.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage, e.msg = "Move", e.space = Kata.BlessedCameraSpace, e.id = Kata.BlessedCameraID, e.spaceid = Kata.BlessedCameraSpaceid, e.pos = this._camPos, e.orient = new Kata.Quaternion(this._camOrient), e.orient = e.orient.normal(), this._sendHostedObjectMessage(e)
    }
  };
  Kata.GraphicsScript.prototype.processRenderables = function() {
    var e = this.mRenderableRemotePresences.length;
    if(e) {
      this.mRenderableRemotePresenceIndex %= e;
      var g = this.mRemotePresences[this.mRenderableRemotePresences[this.mRenderableRemotePresenceIndex]];
      g ? (e = this.mPresences[g.space()], this.shouldRender(e, g) ? g.inGFXSceneGraph || this.renderRemotePresence(e, g) : g.inGFXSceneGraph && this.unrenderRemotePresence(e, g), this.mRenderableRemotePresenceIndex++) : (this.mRemotePresences[this.mRenderableRemotePresenceIndex] = this.mRemotePresences[e], --this.mRemotePresences.length)
    }
  };
  Kata.GraphicsScript.prototype.disableGraphics = function(e) {
    var g = new Kata.ScriptProtocol.FromScript.GFXDetachCamera(e.space(), e.id(), e.id());
    this._sendHostedObjectMessage(g);
    var h = e.space(), j = this.mRenderableRemotePresences.length, g = this.unrenderRemotePresence(e, e);
    this._sendHostedObjectMessage(g);
    delete this.mRemotePresences[Kata.Script.remotePresenceKey(e.space(), e.id())];
    for(g = 0;g < j;) {
      var m = this.mRemotePresences[this.mRenderableRemotePresences[g]];
      m && m.space() == h ? (m.inGFXSceneGraph && this.unrenderRemotePresence(e, m), this.mRenderableRemotePresences[g] = this.mRenderableRemotePresences[j], j = --this.mRenderableRemotePresences.length) : ++g
    }
    if(--this.mNumGraphicsSystems == 0) {
      this.mGraphicsTimer.disable(), this.mGraphicsTimer = null
    }
    g = new Kata.ScriptProtocol.FromScript.UnregisterGUIMessage(e.space(), e.id(), e.id());
    this._sendHostedObjectMessage(g)
  };
  Kata.GraphicsScript.prototype._handleQueryEventDelegate = function(e, g) {
    if(e) {
      var h = this.mPresences[g.space];
      h.inGFXSceneGraph && (g.entered ? (this.mRenderableRemotePresences.push(e), this.shouldRender(h, e) && this.renderRemotePresence(h, e)) : e.inGFXSceneGraph && this.unrenderRemotePresence(h, e))
    }
    this.processRenderables();
    return e
  };
  Kata.GraphicsScript.prototype.updateGFX = function(e) {
    var g = this.mPresences[e.space()];
    if(g && g.inGFXSceneGraph) {
      this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.GFXMoveNode(g.space(), g.id(), e, {loc:e.predictedLocation()}));
      if(e.lastGFXVisual != e.visual()) {
        if(!e.noMesh) {
          for(var h = Kata.ScriptProtocol.FromScript.generateGFXUpdateVisualMessages(g.space(), g.id(), e, e.lastGFXVisual), j = h.length, m = 0;m < j;++m) {
            this._sendHostedObjectMessage(h[m])
          }
        }
        e.lastGFXVisual = e.visual()
      }
      this.mUpdateHook && this.mUpdateHook(g, e)
    }
  };
  Kata.GraphicsScript.prototype._handlePresenceLocUpdate = function(f, g) {
    var h = e._handlePresenceLocUpdate.call(this, f, g);
    h && this.updateGFX(h);
    return h
  };
  Kata.GraphicsScript.prototype.shouldRender = function() {
    return!0
  };
  Kata.GraphicsScript.prototype.animate = function(e, g, h) {
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.GFXAnimate(e.space(), e.id(), g, h))
  };
  Kata.GraphicsScript.prototype.setLabel = function(e, g, h, j, m) {
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.GFXLabel(e.space(), e.id(), g.object(), h, j, m))
  }
}, "katajs/oh/GraphicsScript.js");
Kata.require(["katajs/oh/Simulation.js"], function() {
  var e = Kata.Simulation.prototype;
  Kata.GraphicsSimulation = function(f, g, h) {
    e.constructor.call(this, g);
    this.mElement = h;
    g = this.constructor;
    g._drivers == void 0 && Kata.error("No graphics drivers available.");
    g = g._drivers[f];
    g == void 0 && Kata.error('No graphics driver called "' + f + '" available.');
    this.mGFX = new g(function() {
    }, h);
    this.mGFX.setInputCallback(Kata.bind(this._handleInputMessage, this))
  };
  Kata.GraphicsSimulation.YFOV_DEGREES = 23.3;
  Kata.GraphicsSimulation.CAMERA_NEAR = 0.1;
  Kata.GraphicsSimulation.CAMERA_FAR = 2E3;
  Kata.GraphicsSimulation.DRAG_THRESHOLD = 5;
  Kata.extend(Kata.GraphicsSimulation, e);
  Kata.GraphicsSimulation.requestAnimFrame = Kata.bind(function() {
    return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(e) {
      window.setTimeout(e, 1E3 / 60)
    }
  }(), window);
  Kata.GraphicsSimulation.prototype.receivedMessage = function(f, g) {
    g.__gui || (g = Kata.ScriptProtocol.FromScript.reconstitute(g), e.receivedMessage.apply(this, arguments), this.mGFX.send(g))
  };
  Kata.GraphicsSimulation.registerDriver = function(e, g) {
    if(this._drivers == void 0) {
      this._drivers = {}
    }
    this._drivers[e] = g
  };
  Kata.GraphicsSimulation.initializeDriver = function(e) {
    if(!this._drivers || !this._drivers[e]) {
      Kata.error("Couldn't find graphics driver: " + e)
    }else {
      for(var g = this._drivers[e], h = Array(arguments.length - 1), j = 1;j < arguments.length;j++) {
        h[j - 1] = arguments[j]
      }
      g.initialize.apply(void 0, h)
    }
  };
  Kata.GraphicsSimulation.prototype._handleInputMessage = function(e) {
    this.mChannel.sendMessage(new Kata.ScriptProtocol.ToScript.GUIMessage(e))
  }
}, "katajs/oh/GraphicsSimulation.js");
Kata.require(["katajs/oh/Simulation.js"], function() {
  var e = Kata.Simulation.prototype;
  Kata.GUISimulation = function(f) {
    e.constructor.call(this, f)
  };
  Kata.extend(Kata.GUISimulation, e);
  Kata.GUISimulation.prototype.receivedMessage = function(e, g) {
    g.__gui && this.handleGUIMessage(g.__gui)
  };
  Kata.GUISimulation.prototype.handleGUIMessage = function() {
  }
}, "katajs/oh/GUISimulation.js");
Kata.require(["katajs/oh/impl/ScriptProtocol.js", "katajs/core/MessageDispatcher.js"], function() {
  Kata.HostedObject = function(e, f) {
    this.mObjectHost = e;
    this.mID = f;
    this.mScriptChannel = null;
    var g = {}, h = Kata.ScriptProtocol.FromScript.Types;
    g[h.Connect] = Kata.bind(this._handleConnect, this);
    g[h.Disconnect] = Kata.bind(this._handleDisconnect, this);
    g[h.SendODPMessage] = Kata.bind(this._handleSendODPMessage, this);
    g[h.Query] = Kata.bind(this._handleQuery, this);
    g[h.Location] = Kata.bind(this._handleLocUpdateRequest, this);
    g[h.QueryUpdate] = Kata.bind(this._handleQueryUpdate, this);
    g[h.QueryRemoval] = Kata.bind(this._handleQueryRemoval, this);
    g[h.Subscription] = Kata.bind(this._handleSubscriptionRequest, this);
    g[h.Physics] = Kata.bind(this._handlePhysicsRequest, this);
    g[h.CreateObject] = Kata.bind(this._handleCreateObject, this);
    g[h.GraphicsMessage] = Kata.bind(this._handleGraphicsMessage, this);
    g[h.DisableGUIMessage] = Kata.bind(e.unregisterSimulationCallback, e, "graphics", this);
    g[h.EnableGUIMessage] = Kata.bind(e.registerSimulationCallback, e, "graphics", this);
    g[h.GUIMessage] = Kata.bind(this._handleGUIMessage, this);
    this.mScriptMessageDispatcher = new Kata.MessageDispatcher(g)
  };
  Kata.HostedObject.prototype.getObjectHost = function() {
    return this.mObjectHost
  };
  Kata.HostedObject.prototype.getID = function() {
    return this.mID
  };
  Kata.HostedObject.prototype.sendScriptMessage = function(e) {
    this.mScriptChannel ? this.mScriptChannel.sendMessage(e) : Kata.warn("Couldn't send script message: no script.")
  };
  Kata.HostedObject.prototype.messageFromScript = function(e, f) {
    f = Kata.ScriptProtocol.FromScript.reconstitute(f);
    this.mScriptMessageDispatcher.dispatch(e, f)
  };
  Kata.HostedObject.prototype._handleConnect = function(e, f) {
    this.mObjectHost.connect(this, f, f.auth)
  };
  Kata.HostedObject.prototype.connectionResponse = function(e, f, g) {
    var h = null, h = e ? new Kata.ScriptProtocol.ToScript.Connected(f.space, f.object, g.loc, void 0, g.vis) : new Kata.ScriptProtocol.ToScript.ConnectionFailed(f.space, f.object, g.msg);
    this.sendScriptMessage(h)
  };
  Kata.HostedObject.prototype.disconnected = function(e) {
    this.sendScriptMessage(new Kata.ScriptProtocol.ToScript.Disconnected(e))
  };
  Kata.HostedObject.prototype._handleDisconnect = function(e, f) {
    this.mObjectHost.disconnect(this, f)
  };
  Kata.HostedObject.prototype._handleSendODPMessage = function(e, f) {
    this.mObjectHost.sendODPMessage(f.space, f.source_object, f.source_port, f.dest_object, f.dest_port, f.payload)
  };
  Kata.HostedObject.prototype.receiveODPMessage = function(e, f, g, h, j, m) {
    this.sendScriptMessage(new Kata.ScriptProtocol.ToScript.ReceiveODPMessage(e, f, g, h, j, m))
  };
  Kata.HostedObject.prototype._handleQuery = function(e, f) {
    this.mObjectHost.registerProxQuery(f.space, f.id, f.sa)
  };
  Kata.HostedObject.prototype._handleQueryUpdate = function(e, f) {
    this.mObjectHost.requestQueryUpdate(f.space, f.id, f.sa)
  };
  Kata.HostedObject.prototype._handleQueryRemoval = function(e, f) {
    this.mObjectHost.requestQueryRemoval(f.space, f.id)
  };
  Kata.HostedObject.prototype._handlePhysicsRequest = function(e, f) {
    this.mObjectHost.setPhysics(f.space, f.id, f.data)
  };
  Kata.HostedObject.prototype.proxEvent = function(e, f, g, h) {
    this.sendScriptMessage(typeof h !== "undefined" ? new Kata.ScriptProtocol.ToScript.QueryEvent(e, f, g, h.loc, h.visual) : new Kata.ScriptProtocol.ToScript.QueryEvent(e, f, g))
  };
  Kata.HostedObject.prototype._handleCreateObject = function(e, f) {
    this.mObjectHost.createObject(f.script, f.constructor, f.args)
  };
  Kata.HostedObject.prototype._handleLocUpdateRequest = function(e, f) {
    var g = {};
    Kata.LocationCopyUnifyTime(f, g);
    this.mObjectHost.locUpdateRequest(f.space, f.id, g, f.visual)
  };
  Kata.HostedObject.prototype.presenceLocUpdate = function(e, f, g, h, j) {
    this.sendScriptMessage(new Kata.ScriptProtocol.ToScript.PresenceLocUpdate(e, f, g, h, j))
  };
  Kata.HostedObject.prototype.handleMessageFromSimulation = function(e, f, g) {
    this.sendScriptMessage(g)
  };
  Kata.HostedObject.prototype._handleGraphicsMessage = function(e, f) {
    this.mObjectHost.sendToSimulation(f)
  };
  Kata.HostedObject.prototype._handleGUIMessage = function(e, f) {
    this.mObjectHost.sendToSimulation({__gui:f})
  };
  Kata.HostedObject.prototype._handleSubscriptionRequest = function(e, f) {
    f.enable ? this.mObjectHost.subscribe(f.space, f.id, f.observed) : this.mObjectHost.unsubscribe(f.space, f.id, f.observed)
  };
  Kata.HostedObject.prototype.messageFromSimulation = function() {
  };
  Kata.HostedObject.prototype.createScript = function(e, f, g) {
    e = new Kata.WebWorker("katajs/oh/impl/BootstrapScript.js", "Kata.BootstrapScript", {realScript:e, realClass:f, realArgs:g});
    this.mScriptChannel = e.getChannel();
    this.mScriptChannel.registerListener(Kata.bind(this.messageFromScript, this));
    e.go()
  };
  Kata.HostedObject.prototype.createMainThreadScript = function(e, f, g, h) {
    this.mScriptChannel = h;
    this.mScriptChannel.registerListener(Kata.bind(this.messageFromScript, this));
    this.mScriptChannel.sendMessage(new Kata.ScriptProtocol.FromScript.InstantiateObjectScript("katajs/oh/impl/BootstrapScript.js", "Kata.BootstrapScript", {realScript:e, realClass:f, realArgs:g}))
  }
}, "katajs/oh/HostedObject.js");
Kata.require(["katajs/core/FilterChannel.js", "katajs/core/MessageDispatcher.js", "katajs/core/URL.js", "katajs/oh/impl/ScriptProtocol.js"], function() {
  self.Kata = Kata;
  Kata.BootstrapScript = Kata.BootstrapScript = function(e, f) {
    this.mChannel = e;
    this.mLoadingListener = Kata.bind(this.receiveMessage, this);
    e.registerListener(this.mLoadingListener);
    this.mPendingScriptLoad = [];
    this.mScriptLoading = !0;
    var g = this;
    Kata.require([f.realScript], function() {
      g._onFinishedLoading(e, f)
    })
  };
  Kata.BootstrapScript.prototype._onFinishedLoading = function(e, f) {
    this.mScriptLoading = !1;
    for(var g = f.realClass.split("."), h = self, j = 0;h && j < g.length;j++) {
      h = h[g[j]]
    }
    if(h) {
      this.mScript = new h(e, f.realArgs);
      for(j = 0;j < this.mPendingScriptLoad.length;j++) {
        this.mScript._handleHostedObjectMessage(this.mPendingScriptLoad[j][0], this.mPendingScriptLoad[j][1])
      }
      this.mChannel.unregisterListener(this.mLoadingListener) || console.log("failed to unload listener: " + this.mLoadingListener);
      delete this.mLoadingListener
    }else {
      Kata.error("Class " + f.realClass + " from file " + f.realScript + " could not be found!")
    }
  };
  Kata.BootstrapScript.prototype.receiveMessage = function(e, f) {
    this.mScriptLoading && this.mPendingScriptLoad.push([e, f])
  }
}, "katajs/oh/impl/BootstrapScript.js");
Kata.require(["katajs/core/URL.js", "katajs/core/Location.js", "katajs/core/Time.js"], function() {
  Kata.ScriptProtocol = {commonReconstitute:function(e) {
    if(typeof e.space != "undefined") {
      e.space = Kata.URL(e.space)
    }
    if(typeof e.spaceid != "undefined") {
      e.spaceid = Kata.URL(e.spaceid)
    }
    return e
  }, FromScript:{Types:{Connect:"fcon", Disconnect:"fdis", SendODPMessage:"fodp", Location:"floc", Visual:"fvis", Query:"fque", QueryUpdate:"fqup", QueryRemoval:"fqrm", Physics:"fphys", Subscription:"fsub", CreateObject:"fcre", InstantiateObjectScript:"fscr", GraphicsMessage:"fgfm", EnableGUIMessage:"feui", DisableGUIMessage:"fdui", GUIMessage:"fgui"}, BackgroundTypes:{Dome:"skydome", Box:"skybox"}, reconstitute:function(e) {
    return e = Kata.ScriptProtocol.commonReconstitute(e)
  }, Connect:function(e, f, g, h, j) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.Connect;
    this.space = e;
    this.auth = f;
    g && Kata.LocationCopyUnifyTime(g, this);
    if(h) {
      this.visual = h
    }
    if(j) {
      this.query = j
    }
  }, RegisterGUIMessage:function(e) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.EnableGUIMessage;
    this.event = e
  }, InstantiateObjectScript:function(e, f, g) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.InstantiateObjectScript;
    this.script = e;
    this.method = f;
    this.args = g
  }, UnregisterGUIMessage:function(e) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.DisableGUIMessage;
    this.event = e
  }, GUIMessage:function(e, f) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.GUIMessage;
    this.msg = e;
    this.event = f
  }, QueryUpdate:function(e, f, g) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.QueryUpdate;
    this.space = e;
    this.id = f;
    this.solidAngle = g
  }, QueryRemoval:function(e, f) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.QueryRemoval;
    this.space = e;
    this.id = f
  }, Disconnect:function(e, f) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.Disconnect;
    this.space = e;
    this.id = f
  }, SendODPMessage:function(e, f, g, h, j, m) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.SendODPMessage;
    this.space = e;
    this.source_object = f;
    this.source_port = g;
    this.dest_object = h;
    this.dest_port = j;
    this.payload = m
  }, Location:function(e, f, g, h) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.Location;
    this.space = e;
    this.id = f;
    g && Kata.LocationCopyUnifyTime(g, this);
    if(h) {
      this.vis = h
    }
  }, Visual:function(e, f, g) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.Visual;
    this.space = e;
    this.id = f;
    this.vis = g
  }, Query:function(e, f, g) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.Query;
    this.space = e;
    this.id = f;
    this.sa = g
  }, Subscription:function(e, f, g, h) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.Subscription;
    this.space = e;
    this.id = f;
    this.observed = g;
    this.enable = h
  }, Physics:function(e, f, g) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.Physics;
    this.space = e;
    this.id = f;
    if(!(g instanceof Array)) {
      throw"ScriptProtocol.Physics: data must be serialized array of bytes";
    }
    this.data = g
  }, CreateObject:function(e, f, g) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.CreateObject;
    this.script = e;
    this.constructor = f;
    this.args = g
  }, GFXCreateNode:function(e, f, g) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage;
    this.msg = "Create";
    this.space = e + f;
    this.id = g.id();
    this.spaceid = this.space;
    Kata.LocationCopyUnifyTime(g.mLocation, this)
  }, GFXQueryMeshAspectRatio:function(e, f, g) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage;
    this.msg = "QueryMeshAspectRatio";
    this.spaceid = this.space = e + f;
    this.id = g.id()
  }, GFXProjectPoint:function(e, f, g, h) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage;
    this.msg = "ProjectPoint";
    this.spaceid = this.space = e + f;
    this.id = f;
    this.pos = g;
    this.data = h
  }, GFXCustom:function(e, f, g) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage;
    this.msg = "Custom";
    this.data = g;
    this.spaceid = this.space = e + f
  }, GFXMoveNode:function(e, f, g, h) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage;
    this.msg = "Move";
    this.space = e + f;
    this.id = g.id();
    this.spaceid = this.space;
    h && Kata.LocationCopyUnifyTime(h.loc, this)
  }, GFXAnimate:function(e, f, g, h) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage;
    this.msg = "Animate";
    this.space = e + f;
    this.id = g.id();
    this.spaceid = this.space;
    this.animation = h
  }, GFXLabel:function(e, f, g, h, j, m) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage;
    this.msg = "Label";
    this.space = e + f;
    this.id = g;
    this.spaceid = this.space;
    this.label = h;
    this.offset = j;
    this.color = m
  }, GFXDestroyNode:function(e, f, g) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage;
    this.space = e + f;
    this.msg = "Destroy";
    this.id = g.id()
  }, generateGFXUpdateVisualMessages:function(e, f, g, h) {
    var j = [];
    g.rMesh ? j.push(new Kata.ScriptProtocol.FromScript.GFXUpdateVisualMesh(e, f, g.id(), g.rMesh, g.rAnim, g.rUpAxis, g.scale())) : h && j.push(new Kata.ScriptProtocol.FromScript.GFXUpdateVisualMesh(e, f, g.id(), null));
    return j
  }, GraphicsMessage:function(e, f, g) {
    this.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage;
    this.spaceid = this.space = e + f;
    this.id = g
  }, GFXUpdateVisualMesh:function(e, f, g, h, j, m, p) {
    Kata.ScriptProtocol.FromScript.GraphicsMessage.call(this, e, f, g);
    h == null ? this.msg = "DestroyMesh" : (this.msg = "Mesh", this.mesh = h, this.anim = j, this.up_axis = m, this.scale = p)
  }, GFXAttachCamera:function(e, f, g, h) {
    Kata.ScriptProtocol.FromScript.GraphicsMessage.call(this, e, f, g);
    this.msg = "AttachCamera";
    this.target = h
  }, GFXShadows:function(e, f, g, h, j) {
    Kata.ScriptProtocol.FromScript.GraphicsMessage.call(this, e, f, g);
    this.msg = "Shadows";
    this.enable = h;
    this.index = j
  }, GFXBackground:function(e, f, g, h, j, m, p, o) {
    Kata.ScriptProtocol.FromScript.GraphicsMessage.call(this, e, f, g);
    this.msg = "Background";
    this.type = h;
    this.sunbeams = j;
    o === void 0 && (o = 1);
    this.curweight = o;
    if(p) {
      this.prevtextures = p
    }
    this.curtextures = m
  }, GFXAttachCameraTexture:function(e, f, g, h, j, m) {
    Kata.ScriptProtocol.FromScript.GraphicsMessage.call(this, e, f, g);
    this.msg = "AttachCameraTexture";
    this.space = e + f;
    this.id = g;
    this.texobjid = j;
    this.texobjspace = h;
    this.texname = m
  }, GFXDetachCamera:function(e, f, g) {
    Kata.ScriptProtocol.FromScript.GraphicsMessage.call(this, e, f, g);
    this.msg = "DetachCamera";
    this.space = e + f;
    this.id = g
  }, GFXEnableEvent:function(e, f) {
    this.msg = "Enable";
    this.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage;
    this.space = e;
    this.type = f
  }, GFXDisableEvent:function(e, f) {
    this.msg = "Disable";
    this.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage;
    this.space = e;
    this.type = f
  }, GFXRaytrace:function(e, f, g, h, j, m) {
    this.msg = "Raytrace";
    this.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage;
    this.space = e;
    this.requestid = f;
    this.pos = g;
    this.dir = h;
    this.multiple = j;
    this.infinite = m
  }, GFXHighlight:function(e, f, g) {
    this.msg = "Highlight";
    this.__type = Kata.ScriptProtocol.FromScript.Types.GraphicsMessage;
    this.space = e;
    this.id = f;
    this.enable = g
  }}, ToScript:{Types:{Connected:"tcon", ConnectionFailed:"tfyl", Disconnected:"tdis", ReceiveODPMessage:"todp", QueryEvent:"tque", PresenceLocUpdate:"tloc", GUIMessage:"tgui"}, reconstitute:function(e) {
    return e = Kata.ScriptProtocol.commonReconstitute(e)
  }, Connected:function(e, f, g, h, j) {
    this.__type = Kata.ScriptProtocol.ToScript.Types.Connected;
    this.space = e;
    this.id = f;
    this.loc = g;
    this.bounds = h;
    this.visual = j
  }, ConnectionFailed:function(e, f, g) {
    this.__type = Kata.ScriptProtocol.ToScript.Types.ConnectionFailed;
    this.space = e;
    this.object = f;
    this.reason = g
  }, Disconnected:function(e) {
    this.__type = Kata.ScriptProtocol.ToScript.Types.Disconnected;
    this.space = e
  }, GUIMessage:function(e) {
    for(var f in e) {
      this[f] = e[f]
    }
    this.__type = Kata.ScriptProtocol.ToScript.Types.GUIMessage
  }, ReceiveODPMessage:function(e, f, g, h, j, m) {
    this.__type = Kata.ScriptProtocol.ToScript.Types.ReceiveODPMessage;
    this.space = e;
    this.source_object = f;
    this.source_port = g;
    this.dest_object = h;
    this.dest_port = j;
    this.payload = m
  }, QueryEvent:function(e, f, g, h, j) {
    this.__type = Kata.ScriptProtocol.ToScript.Types.QueryEvent;
    this.space = e;
    this.observed = f;
    this.entered = g;
    this.loc = h;
    this.visual = j
  }, PresenceLocUpdate:function(e, f, g, h, j) {
    this.__type = Kata.ScriptProtocol.ToScript.Types.PresenceLocUpdate;
    this.space = e;
    this.observed = f;
    this.loc = g;
    this.visual = h;
    this.physics = j
  }}}
}, "katajs/oh/impl/ScriptProtocol.js");
Kata.require(["katajs/core/Channel.js", "katajs/core/WebWorker.js"], function() {
  Kata.MainThread = function(e, f, g) {
    this.mObjectHostWorker = new Kata.WebWorker("katajs/oh/ObjectHostWorker.js", "Kata.ObjectHostWorker", {script:e, method:f, args:g});
    this.mObjectHostChannel = this.mObjectHostWorker.getChannel();
    this.mObjectHostChannel.registerListener(Kata.bind(this.receivedMessage, this));
    this.mObjectHostWorker.go()
  };
  Kata.MainThread.prototype.getChannel = function() {
    return this.mObjectHostChannel
  };
  Kata.MainThread.prototype.receivedMessage = function(e, f) {
    if(f.__type == Kata.ScriptProtocol.FromScript.Types.InstantiateObjectScript) {
      var g = f.args, h = f.method, j = h.split(".");
      Kata.require([f.script], function() {
        for(var f = self, p = 0;f && p < j.length;p++) {
          f = f[j[p]]
        }
        f || Kata.error(h + " is undefined:" + this.mJSFile);
        network_debug && console.log("going!");
        new f(e, g)
      })
    }
  }
}, "katajs/oh/MainThread.js");
Kata.require(["katajs/oh/HostedObject.js", "katajs/oh/SessionManager.js", "katajs/core/URL.js"], function() {
  Kata.ObjectHost = function(e, f, g, h) {
    this.mSimulations = [];
    this.mSimulationsByName = {};
    this.mSimulationCallbacksByName = {};
    this.mObjects = {};
    this.mSessionManager = new Kata.SessionManager;
    h ? this.createMainThreadObject(e, f, g, h) : this.createObject(e, f, g);
    network_debug && console.log("ObjectHosted!")
  };
  Kata.ObjectHost.prototype.registerSimulation = function(e, f) {
    this.mSimulations.push(e);
    this.mSimulationsByName[f] = e;
    e.registerListener(Kata.bind(this.receivedSimulationMessage, this, f))
  };
  Kata.ObjectHost.prototype.sendToSimulation = function(e, f) {
    if(f) {
      this.mSimulationsByName[f].sendMessage(e)
    }else {
      for(f in this.mSimulationsByName) {
        this.mSimulationsByName[f].sendMessage(e)
      }
    }
  };
  Kata.ObjectHost.prototype.registerSimulationCallback = function(e, f) {
    e in this.mSimulationCallbacksByName ? this.mSimulationCallbacksByName[e].push(f) : this.mSimulationCallbacksByName[e] = [f]
  };
  Kata.ObjectHost.prototype.unregisterSimulationCallback = function(e, f) {
    var g = this.mSimulationCallbacksByName[e];
    if(g.length == 1) {
      delete this.mSimulationCallbacksByName[e]
    }else {
      for(var h = 0;h < g.length;++h) {
        if(g[h] == f) {
          g[h] = g[g.length - 1];
          g.pop();
          break
        }
      }
    }
  };
  Kata.ObjectHost.prototype.receivedSimulationMessage = function(e, f, g) {
    var h = this.mSimulationCallbacksByName[e];
    if(h) {
      for(var j = 0;j < h.length;++j) {
        h[j].handleMessageFromSimulation(e, f, g)
      }
    }
  };
  Kata.ObjectHost.prototype.privateIdGenerator = function() {
    var e = 0;
    return function() {
      e += 1;
      return"" + e
    }
  }();
  Kata.ObjectHost.prototype.createObject = function(e, f, g) {
    var h = this.generateObject(this.privateIdGenerator());
    e && f && g && h.createScript(e, f, g)
  };
  Kata.ObjectHost.prototype.createMainThreadObject = function(e, f, g, h) {
    var j = this.generateObject(this.privateIdGenerator());
    e && f && g && j.createMainThreadScript(e, f, g, h)
  };
  Kata.ObjectHost.prototype.generateObject = function(e) {
    network_debug && console.log("Creating Object " + e);
    this.mObjects[e] = new Kata.HostedObject(this, e);
    return this.mObjects[e]
  };
  Kata.ObjectHost.prototype.connect = function(e, f, g) {
    if(f.scale.length == 3) {
      Kata.warn("outdated bounds: " + f.scale), f.scale = [0, 0, 0, f.scale[0]]
    }
    this.mSessionManager.connect(e, f, g)
  };
  Kata.ObjectHost.prototype.disconnect = function(e, f) {
    this.mSessionManager.disconnect(e, f)
  };
  Kata.ObjectHost.prototype.sendODPMessage = function(e, f, g, h, j, m) {
    this.mSessionManager.sendODPMessage(e, f, g, h, j, m)
  };
  Kata.ObjectHost.prototype.registerProxQuery = function(e, f, g) {
    this.mSessionManager.registerProxQuery(e, f, g)
  };
  Kata.ObjectHost.prototype.locUpdateRequest = function(e, f, g, h) {
    this.mSessionManager.locUpdateRequest(e, f, g, h)
  };
  Kata.ObjectHost.prototype.requestQueryRemoval = function(e, f) {
    this.mSessionManager.requestQueryRemoval(e, f)
  };
  Kata.ObjectHost.prototype.requestQueryUpdate = function(e, f, g) {
    this.mSessionManager.requestQueryRemoval(e, f, g)
  };
  Kata.ObjectHost.prototype.setPhysics = function(e, f, g) {
    this.mSessionManager.setPhysics(e, f, g)
  };
  Kata.ObjectHost.prototype.subscribe = function(e, f, g) {
    this.mSessionManager.subscribe(e, f, g)
  };
  Kata.ObjectHost.prototype.unsubscribe = function(e, f, g) {
    this.mSessionManager.unsubscribe(e, f, g)
  }
}, "katajs/oh/ObjectHost.js");
Kata.require(["katajs/space/loop/Space.js", "katajs/oh/ObjectHost.js", "katajs/oh/plugins/sirikata/SirikataSpaceConnection.js", "katajs/oh/plugins/loop/LoopbackSpaceConnection.js"], function() {
  self.Kata = Kata;
  Kata.ObjectHostWorker = Kata.ObjectHostWorker = function(e, f) {
    this.mObjectHost = new Kata.ObjectHost(f.script, f.method, f.args, f.args.main_thread ? e : !1);
    f.args.disable_simulation || this.mObjectHost.registerSimulation(e, "graphics")
  }
}, "katajs/oh/ObjectHostWorker.js");
Kata.require(["katajs/core/SpaceID.js", "katajs/core/ObjectID.js", "katajs/core/PresenceID.js", "katajs/oh/odp/PortID.js"], function() {
  if(typeof Kata.ODP == "undefined") {
    Kata.ODP = {}
  }
  Kata.ODP.Endpoint = function() {
    if(arguments.length == 2) {
      this.mSpace = arguments[0].space(), this.mObject = arguments[0].object(), this.mPort = arguments[1]
    }else {
      if(arguments.length == 3) {
        this.mSpace = arguments[0], this.mObject = arguments[1], this.mPort = arguments[2]
      }else {
        throw"Invalid endpoint constructor argument list";
      }
    }
  };
  Kata.ODP.Endpoint.prototype.space = function() {
    return this.mSpace
  };
  Kata.ODP.Endpoint.prototype.object = function() {
    return this.mObject
  };
  Kata.ODP.Endpoint.prototype.port = function() {
    return this.mPort
  };
  Kata.ODP.Endpoint.prototype.presenceID = function() {
    return new Kata.PresenceID(this.mSpace, this.mObject)
  };
  Kata.ODP.Endpoint.any = function() {
    return new Kata.ODP.Endpoint(Kata.SpaceID.any(), Kata.ObjectID.any(), Kata.ODP.PortID.any())
  };
  Kata.ODP.Endpoint.prototype.toConciseString = function() {
    return this.mSpace.toString() + ":" + this.mObject.toString() + ":" + this.mPort.toString()
  };
  Kata.ODP.Endpoint.prototype.toString = function() {
    return"ODP.Endpoint(" + this.toConciseString() + ")"
  }
}, "katajs/oh/odp/Endpoint.js");
Kata.require([], function() {
  if(typeof Kata.ODP == "undefined") {
    Kata.ODP = {}
  }
  Kata.ODP.PortID = {};
  Kata.ODP.PortID.nil = function() {
    return 0
  };
  Kata.ODP.PortID.any = function() {
    return 16777215
  }
}, "katajs/oh/odp/PortID.js");
Kata.require(["katajs/oh/odp/Endpoint.js"], function() {
  if(typeof Kata.ODP == "undefined") {
    Kata.ODP = {}
  }
  Kata.ODP.Port = function(e, f, g) {
    this.mEndpoint = e;
    this.mSendFunc = f;
    this.mReleaseFunc = g;
    this.mReceiveHandlers = []
  };
  Kata.ODP.Port.prototype.send = function(e, f) {
    this.mSendFunc(this.mEndpoint, e, f)
  };
  Kata.ODP.Port.prototype.receive = function(e) {
    this.receiveFrom(Kata.ODP.Endpoint.any(), e)
  };
  Kata.ODP.Port.prototype.receiveFrom = function(e, f) {
    this.mReceiveHandlers[e] = f
  };
  Kata.ODP.Port.prototype.deliver = function(e, f) {
    if(this._tryDeliver(e, e, f)) {
      return!0
    }
    if(this._tryDeliver(new Kata.ODP.Endpoint(e.space(), Kata.ObjectID.any(), e.port()), e, f)) {
      return!0
    }
    if(this._tryDeliver(new Kata.ODP.Endpoint(Kata.SpaceID.any(), Kata.ObjectID.any(), e.port()), e, f)) {
      return!0
    }
    if(this._tryDeliver(new Kata.ODP.Endpoint(e.space(), e.object(), Kata.ODP.PortID.any()), e, f)) {
      return!0
    }
    if(this._tryDeliver(new Kata.ODP.Endpoint(e.space(), Kata.ObjectID.any(), Kata.ODP.PortID.any()), e, f)) {
      return!0
    }
    if(this._tryDeliver(new Kata.ODP.Endpoint(Kata.SpaceID.any(), Kata.ObjectID.any(), Kata.ODP.PortID.any()), e, f)) {
      return!0
    }
    return!1
  };
  Kata.ODP.Port.prototype._tryDeliver = function(e, f, g) {
    if(e in this.mReceiveHandlers) {
      return(0,this.mReceiveHandlers[e])(f, this.mEndpoint, g), !0
    }
    return!1
  };
  Kata.ODP.Port.prototype.toString = function() {
    return"ODP.Port(" + this.mEndpoint.toConciseString() + ")"
  };
  Kata.ODP.Port.prototype.close = function() {
    var e = this.mReleaseFunc, f = this.mEndpoint;
    delete this.mEndpoint;
    delete this.mSendFunc;
    delete this.mReleaseFunc;
    e(f)
  }
}, "katajs/oh/odp/Port.js");
Kata.require(["katajs/oh/odp/Port.js"], function() {
  if(typeof Kata.ODP == "undefined") {
    Kata.ODP = {}
  }
  Kata.ODP.Service = function(e) {
    this.mODPServiceSendFunc = e;
    this.mODPServiceBoundPorts = {}
  };
  Kata.ODP.Service.prototype.bindODPPort = function(e, f, g) {
    e = new Kata.ODP.Endpoint(e, f, g);
    f = this.mODPServiceBoundPorts[e];
    if(typeof f != "undefined") {
      throw"Tried to bind previously bound port.";
    }
    f = new Kata.ODP.Port(e, this.mODPServiceSendFunc, Kata.bind(this._handleODPServiceReleasePort, this));
    return this.mODPServiceBoundPorts[e] = f
  };
  Kata.ODP.Service.prototype._handleODPServiceReleasePort = function(e) {
    typeof this.mODPServiceBoundPorts[e] == "undefined" && Kata.error("Got ODP port release for unallocated port.");
    delete this.mODPServiceBoundPorts[e]
  };
  Kata.ODP.Service.prototype._deliverODPMessage = function(e, f, g) {
    f = this.mODPServiceBoundPorts[f];
    typeof f != "undefined" && f.deliver(e, g)
  }
}, "katajs/oh/odp/Service.js");
Kata.require(["katajs/oh/SpaceConnection.js", "katajs/oh/SessionManager.js", "katajs/space/loop/Space.js"], function() {
  var e = Kata.SpaceConnection.prototype;
  Kata.LoopbackSpaceConnection = function(f, g) {
    e.constructor.call(this, f);
    this.mSpace = Kata.LoopbackSpace.spaces[Kata.URL.host(g)];
    this.mSpaceURL = g;
    this.mSpace || Kata.error("Couldn't find loopback space: " + g.toString());
    this.mObjectID = {};
    this.mLocalID = {}
  };
  Kata.extend(Kata.LoopbackSpaceConnection, Kata.SpaceConnection.prototype);
  Kata.LoopbackSpaceConnection.prototype.connectObject = function(e, g, h, j) {
    var g = Kata.LocationIdentity(new Date), m;
    for(m in h) {
      g[m] = h[m]
    }
    this.mSpace.connectObject(e, {connected:Kata.bind(this.connectResponse, this), message:Kata.bind(this.receiveODPMessage, this), prox:Kata.bind(this.proxEvent, this), presenceLocUpdate:Kata.bind(this.presenceLocUpdate, this), scale:h.scale, visual:j}, g)
  };
  Kata.LoopbackSpaceConnection.prototype.connectResponse = function(e, g, h, j) {
    this.mObjectID[e] = g;
    this.mLocalID[g] = e;
    g ? this.mParent.connectionResponse(e, !0, {space:this.mSpaceURL, object:g}, {loc:h, visual:j}) : this.mParent.connectionResponse(e, !1)
  };
  Kata.LoopbackSpaceConnection.prototype.disconnectObject = function(e) {
    this.mSpace.disconnectObject(e)
  };
  Kata.LoopbackSpaceConnection.prototype.sendODPMessage = function(e, g, h, j, m) {
    this.mSpace.sendODPMessage(e, g, h, j, m)
  };
  Kata.LoopbackSpaceConnection.prototype.receiveODPMessage = function(e, g, h, j, m) {
    this.mParent.receiveODPMessage(this.mSpaceURL, e, g, h, j, m)
  };
  Kata.LoopbackSpaceConnection.prototype.registerProxQuery = function(e, g) {
    this.mSpace.registerProxQuery(e, g)
  };
  Kata.LoopbackSpaceConnection.prototype.proxEvent = function(e, g, h, j) {
    this.mParent.proxEvent(this.mSpaceURL, e, g, h, j)
  };
  Kata.LoopbackSpaceConnection.prototype.locUpdateRequest = function(e, g, h) {
    this.mSpace.locUpdateRequest(e, g, h)
  };
  Kata.LoopbackSpaceConnection.prototype.requestQueryRemoval = function(e) {
    this.mSpace.requestQueryRemoval(e)
  };
  Kata.LoopbackSpaceConnection.prototype.requestQueryUpdate = function(e, g) {
    this.mSpace.requestQueryUpdate(e, g)
  };
  Kata.LoopbackSpaceConnection.prototype.subscribe = function(e, g) {
    this.mSpace.subscriptionRequest(e, g, !0)
  };
  Kata.LoopbackSpaceConnection.prototype.unsubscribe = function(e, g) {
    this.mSpace.subscriptionRequest(e, g, !1)
  };
  Kata.LoopbackSpaceConnection.prototype.presenceLocUpdate = function(e, g, h, j) {
    this.mParent.presenceLocUpdate(this.mSpaceURL, e, g, h, j)
  };
  Kata.SessionManager.registerProtocolHandler("loop", Kata.LoopbackSpaceConnection);
  new Kata.LoopbackSpace(Kata.URL("loop://localhost"))
}, "katajs/oh/plugins/loop/LoopbackSpaceConnection.js");
(function() {
  Kata.Frame = {};
  Kata.Frame.parse = function(e) {
    if(e.length < 4) {
      return null
    }
    var f = e[0] * 16777216 + e[1] * 65536 + e[2] * 256 + e[3];
    if(e.length < 4 + f) {
      return null
    }
    e.splice(0, 4);
    return e.splice(0, f)
  }
})();
var Sirikata;
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
Sirikata.Protocol._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.AggregateBoundingInfo = PROTO.Message("Sirikata.Protocol.AggregateBoundingInfo", {center_offset:{options:{packed:!0}, multiplicity:PROTO.optional, type:function() {
  return PBJ.vector3f
}, id:1}, center_bounds_radius:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.Float
}, id:2}, max_object_size:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.Float
}, id:3}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
Sirikata.Protocol._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.AggregateBoundingInfo = PROTO.Message("Sirikata.Protocol.AggregateBoundingInfo", {center_offset:{options:{packed:!0}, multiplicity:PROTO.optional, type:function() {
  return PBJ.vector3f
}, id:1}, center_bounds_radius:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.Float
}, id:2}, max_object_size:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.Float
}, id:3}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
Sirikata.Protocol._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.Empty = PROTO.Message("Sirikata.Protocol.Empty", {});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
Sirikata.Protocol._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.Frame = PROTO.Message("Sirikata.Protocol.Frame", {payload:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.bytes
}, id:1}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
if(typeof Sirikata.Protocol.Loc == "undefined") {
  Sirikata.Protocol.Loc = {}
}
Sirikata.Protocol.Loc._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.Loc.LocationUpdate = PROTO.Message("Sirikata.Protocol.Loc.LocationUpdate", {object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:1}, seqno:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:6}, epoch:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:8}, location:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionVector
}, id:2}, orientation:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionQuaternion
}, id:3}, aggregate_bounds:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.AggregateBoundingInfo
}, id:10}, mesh:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:5}, physics:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:7}, parent:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PBJ.uuid
}, id:9}, index_id:{options:{packed:!0}, multiplicity:PROTO.repeated, type:function() {
  return PROTO.uint32
}, id:11}});
Sirikata.Protocol.Loc.BulkLocationUpdate = PROTO.Message("Sirikata.Protocol.Loc.BulkLocationUpdate", {update:{options:{}, multiplicity:PROTO.repeated, type:function() {
  return Sirikata.Protocol.Loc.LocationUpdate
}, id:1}});
Sirikata.Protocol.Loc.LocationUpdateRequest = PROTO.Message("Sirikata.Protocol.Loc.LocationUpdateRequest", {location:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionVector
}, id:1}, orientation:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionQuaternion
}, id:2}, bounds:{options:{packed:!0}, multiplicity:PROTO.optional, type:function() {
  return PBJ.boundingsphere3f
}, id:3}, mesh:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:4}, physics:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:5}, epoch:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:6}});
Sirikata.Protocol.Loc.Container = PROTO.Message("Sirikata.Protocol.Loc.Container", {update_request:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Loc.LocationUpdateRequest
}, id:1}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
if(typeof Sirikata.Protocol.Object == "undefined") {
  Sirikata.Protocol.Object = {}
}
Sirikata.Protocol.Object._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.Object.ObjectMessage = PROTO.Message("Sirikata.Protocol.Object.ObjectMessage", {source_object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:1}, source_port:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint32
}, id:2}, dest_object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:3}, dest_port:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint32
}, id:4}, unique:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint64
}, id:5}, payload:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:6}});
Sirikata.Protocol.Object.Noise = PROTO.Message("Sirikata.Protocol.Object.Noise", {payload:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.bytes
}, id:1}});
Sirikata.Protocol.Object.Ping = PROTO.Message("Sirikata.Protocol.Object.Ping", {ping:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.time
}, id:7}, distance:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.Double
}, id:8}, id:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:9}, payload:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:10}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
if(typeof Sirikata.Protocol.Prox == "undefined") {
  Sirikata.Protocol.Prox = {}
}
Sirikata.Protocol.Prox._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.Prox.QueryRequest = PROTO.Message("Sirikata.Protocol.Prox.QueryRequest", {query_angle:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.Float
}, id:1}, query_max_count:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:2}, query_parameters:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:3}});
Sirikata.Protocol.Prox.IndexProperties = PROTO.Message("Sirikata.Protocol.Prox.IndexProperties", {id:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint32
}, id:1}, index_id:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:2}, DynamicClassification:PROTO.Enum("Sirikata.Protocol.Prox.IndexProperties.DynamicClassification", {Static:1, Dynamic:2}), dynamic_classification:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Prox.IndexProperties.DynamicClassification
}, id:3}});
Sirikata.Protocol.Prox.ObjectAddition = PROTO.Message("Sirikata.Protocol.Prox.ObjectAddition", {object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:1}, location:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.TimedMotionVector
}, id:2}, orientation:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.TimedMotionQuaternion
}, id:3}, aggregate_bounds:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.AggregateBoundingInfo
}, id:10}, seqno:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint64
}, id:5}, mesh:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:6}, physics:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:7}, parent:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PBJ.uuid
}, id:8}, ObjectType:PROTO.Enum("Sirikata.Protocol.Prox.ObjectAddition.ObjectType", {Object:1, Aggregate:2}), type:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Prox.ObjectAddition.ObjectType
}, id:9}});
Sirikata.Protocol.Prox.ObjectRemoval = PROTO.Message("Sirikata.Protocol.Prox.ObjectRemoval", {RemovalType:PROTO.Enum("Sirikata.Protocol.Prox.ObjectRemoval.RemovalType", {Transient:1, Permanent:2}), object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:1}, seqno:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint64
}, id:2}, type:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Prox.ObjectRemoval.RemovalType
}, id:3}});
Sirikata.Protocol.Prox.ProximityUpdate = PROTO.Message("Sirikata.Protocol.Prox.ProximityUpdate", {addition:{options:{}, multiplicity:PROTO.repeated, type:function() {
  return Sirikata.Protocol.Prox.ObjectAddition
}, id:1}, removal:{options:{}, multiplicity:PROTO.repeated, type:function() {
  return Sirikata.Protocol.Prox.ObjectRemoval
}, id:2}, index_properties:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Prox.IndexProperties
}, id:3}});
Sirikata.Protocol.Prox.ProximityResults = PROTO.Message("Sirikata.Protocol.Prox.ProximityResults", {t:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.time
}, id:1}, update:{options:{}, multiplicity:PROTO.repeated, type:function() {
  return Sirikata.Protocol.Prox.ProximityUpdate
}, id:2}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
if(typeof Sirikata.Protocol.Session == "undefined") {
  Sirikata.Protocol.Session = {}
}
Sirikata.Protocol.Session._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.Session.VersionInfo = PROTO.Message("Sirikata.Protocol.Session.VersionInfo", {name:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:1}, version:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:2}, major:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:3}, minor:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:4}, revision:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:5}, vcs_version:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:6}});
Sirikata.Protocol.Session.Connect = PROTO.Message("Sirikata.Protocol.Session.Connect", {ConnectionType:PROTO.Enum("Sirikata.Protocol.Session.Connect.ConnectionType", {Fresh:1, Migration:2}), version:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.VersionInfo
}, id:11}, type:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.Session.Connect.ConnectionType
}, id:1}, object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:2}, auth:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:8}, loc:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionVector
}, id:3}, orientation:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionQuaternion
}, id:4}, bounds:{options:{packed:!0}, multiplicity:PROTO.optional, type:function() {
  return PBJ.boundingsphere3f
}, id:5}, query_angle:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.Float
}, id:6}, query_max_count:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:10}, query_parameters:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:12}, mesh:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:7}, physics:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:9}, oh_name:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:13}, zernike:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:14}});
Sirikata.Protocol.Session.ConnectResponse = PROTO.Message("Sirikata.Protocol.Session.ConnectResponse", {Response:PROTO.Enum("Sirikata.Protocol.Session.ConnectResponse.Response", {Success:1, Redirect:2, Error:3}), version:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.VersionInfo
}, id:8}, response:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.Session.ConnectResponse.Response
}, id:1}, redirect:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:2}, loc:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionVector
}, id:3}, orientation:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionQuaternion
}, id:4}, bounds:{options:{packed:!0}, multiplicity:PROTO.optional, type:function() {
  return PBJ.boundingsphere3f
}, id:5}, mesh:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:6}, physics:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:7}});
Sirikata.Protocol.Session.ConnectAck = PROTO.Message("Sirikata.Protocol.Session.ConnectAck", {});
Sirikata.Protocol.Session.InitiateMigration = PROTO.Message("Sirikata.Protocol.Session.InitiateMigration", {new_server:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint64
}, id:1}});
Sirikata.Protocol.Session.Disconnect = PROTO.Message("Sirikata.Protocol.Session.Disconnect", {object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:1}, reason:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:2}});
Sirikata.Protocol.Session.Coordinate = PROTO.Message("Sirikata.Protocol.Session.Coordinate", {CoordinationType:PROTO.Enum("Sirikata.Protocol.Session.Coordinate.CoordinationType", {Add:1, Remove:2, MigrateTo:3, MigrateFrom:4, MigrateReq:5, Ready:6, Ack:7}), type:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.Session.Coordinate.CoordinationType
}, id:1}, object:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PBJ.uuid
}, id:2}, entity:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PBJ.uuid
}, id:3}, oh_name:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:4}, migrate_capacity:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:5}, migrate_threshold:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:6}});
Sirikata.Protocol.Session.OHMigration = PROTO.Message("Sirikata.Protocol.Session.OHMigration", {MigrationType:PROTO.Enum("Sirikata.Protocol.Session.OHMigration.MigrationType", {Object:1, Entity:2, Ack:3}), type:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.Session.OHMigration.MigrationType
}, id:1}, id:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:2}, oh_name:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:3}, password:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:4}, reason:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:5}, objects:{options:{}, multiplicity:PROTO.repeated, type:function() {
  return PBJ.uuid
}, id:6}});
Sirikata.Protocol.Session.Container = PROTO.Message("Sirikata.Protocol.Session.Container", {seqno:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:8}, connect:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.Connect
}, id:1}, connect_response:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.ConnectResponse
}, id:2}, connect_ack:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.ConnectAck
}, id:3}, init_migration:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.InitiateMigration
}, id:4}, disconnect:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.Disconnect
}, id:5}, coordinate:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.Coordinate
}, id:6}, oh_migration:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.OHMigration
}, id:7}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
if(typeof Sirikata.Protocol.SST == "undefined") {
  Sirikata.Protocol.SST = {}
}
Sirikata.Protocol.SST._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.SST.SSTChannelHeader = PROTO.Message("Sirikata.Protocol.SST.SSTChannelHeader", {channel_id:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uint8
}, id:1}, transmit_sequence_number:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint64
}, id:2}, ack_count:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uint8
}, id:3}, ack_sequence_number:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint64
}, id:4}, payload:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:5}});
Sirikata.Protocol.SST.SSTStreamHeader = PROTO.Message("Sirikata.Protocol.SST.SSTStreamHeader", {StreamPacketType:PROTO.Enum("Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType", {INIT:1, REPLY:2, DATA:3, ACK:4, DATAGRAM:5}), Flags:PROTO.Flags(123456, "Sirikata.Protocol.SST.SSTStreamHeader.Flags", {CONTINUES:1}), lsid:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint32
}, id:1}, type:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uint8
}, id:2}, flags:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.SST.SSTStreamHeader.Flags
}, id:3}, window:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uint8
}, id:4}, src_port:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint32
}, id:5}, dest_port:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint32
}, id:6}, psid:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint32
}, id:7}, rsid:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint32
}, id:8}, bsn:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:9}, payload:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:10}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
Sirikata.Protocol._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.TimedMotionQuaternion = PROTO.Message("Sirikata.Protocol.TimedMotionQuaternion", {t:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.time
}, id:1}, position:{options:{packed:!0}, multiplicity:PROTO.required, type:function() {
  return PBJ.quaternion
}, id:2}, velocity:{options:{packed:!0}, multiplicity:PROTO.required, type:function() {
  return PBJ.quaternion
}, id:3}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
Sirikata.Protocol._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.TimedMotionVector = PROTO.Message("Sirikata.Protocol.TimedMotionVector", {t:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.time
}, id:1}, position:{options:{packed:!0}, multiplicity:PROTO.required, type:function() {
  return PBJ.vector3f
}, id:2}, velocity:{options:{packed:!0}, multiplicity:PROTO.required, type:function() {
  return PBJ.vector3f
}, id:3}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
Sirikata.Protocol._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.TimeSync = PROTO.Message("Sirikata.Protocol.TimeSync", {seqno:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PBJ.uint8
}, id:1}, t:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PBJ.time
}, id:2}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
Sirikata.Protocol._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.Empty = PROTO.Message("Sirikata.Protocol.Empty", {});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
Sirikata.Protocol._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.Frame = PROTO.Message("Sirikata.Protocol.Frame", {payload:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.bytes
}, id:1}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
if(typeof Sirikata.Protocol.Loc == "undefined") {
  Sirikata.Protocol.Loc = {}
}
Sirikata.Protocol.Loc._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.Loc.LocationUpdate = PROTO.Message("Sirikata.Protocol.Loc.LocationUpdate", {object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:1}, seqno:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:6}, epoch:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:8}, location:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionVector
}, id:2}, orientation:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionQuaternion
}, id:3}, aggregate_bounds:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.AggregateBoundingInfo
}, id:10}, mesh:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:5}, physics:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:7}, parent:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PBJ.uuid
}, id:9}, index_id:{options:{packed:!0}, multiplicity:PROTO.repeated, type:function() {
  return PROTO.uint32
}, id:11}});
Sirikata.Protocol.Loc.BulkLocationUpdate = PROTO.Message("Sirikata.Protocol.Loc.BulkLocationUpdate", {update:{options:{}, multiplicity:PROTO.repeated, type:function() {
  return Sirikata.Protocol.Loc.LocationUpdate
}, id:1}});
Sirikata.Protocol.Loc.LocationUpdateRequest = PROTO.Message("Sirikata.Protocol.Loc.LocationUpdateRequest", {location:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionVector
}, id:1}, orientation:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionQuaternion
}, id:2}, bounds:{options:{packed:!0}, multiplicity:PROTO.optional, type:function() {
  return PBJ.boundingsphere3f
}, id:3}, mesh:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:4}, physics:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:5}, epoch:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:6}});
Sirikata.Protocol.Loc.Container = PROTO.Message("Sirikata.Protocol.Loc.Container", {update_request:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Loc.LocationUpdateRequest
}, id:1}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
if(typeof Sirikata.Protocol.Object == "undefined") {
  Sirikata.Protocol.Object = {}
}
Sirikata.Protocol.Object._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.Object.ObjectMessage = PROTO.Message("Sirikata.Protocol.Object.ObjectMessage", {source_object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:1}, source_port:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint32
}, id:2}, dest_object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:3}, dest_port:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint32
}, id:4}, unique:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint64
}, id:5}, payload:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:6}});
Sirikata.Protocol.Object.Noise = PROTO.Message("Sirikata.Protocol.Object.Noise", {payload:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.bytes
}, id:1}});
Sirikata.Protocol.Object.Ping = PROTO.Message("Sirikata.Protocol.Object.Ping", {ping:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.time
}, id:7}, distance:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.Double
}, id:8}, id:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:9}, payload:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:10}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
if(typeof Sirikata.Protocol.Prox == "undefined") {
  Sirikata.Protocol.Prox = {}
}
Sirikata.Protocol.Prox._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.Prox.QueryRequest = PROTO.Message("Sirikata.Protocol.Prox.QueryRequest", {query_angle:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.Float
}, id:1}, query_max_count:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:2}, query_parameters:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:3}});
Sirikata.Protocol.Prox.IndexProperties = PROTO.Message("Sirikata.Protocol.Prox.IndexProperties", {id:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint32
}, id:1}, index_id:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:2}, DynamicClassification:PROTO.Enum("Sirikata.Protocol.Prox.IndexProperties.DynamicClassification", {Static:1, Dynamic:2}), dynamic_classification:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Prox.IndexProperties.DynamicClassification
}, id:3}});
Sirikata.Protocol.Prox.ObjectAddition = PROTO.Message("Sirikata.Protocol.Prox.ObjectAddition", {object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:1}, location:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.TimedMotionVector
}, id:2}, orientation:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.TimedMotionQuaternion
}, id:3}, aggregate_bounds:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.AggregateBoundingInfo
}, id:10}, seqno:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint64
}, id:5}, mesh:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:6}, physics:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:7}, parent:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PBJ.uuid
}, id:8}, ObjectType:PROTO.Enum("Sirikata.Protocol.Prox.ObjectAddition.ObjectType", {Object:1, Aggregate:2}), type:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Prox.ObjectAddition.ObjectType
}, id:9}});
Sirikata.Protocol.Prox.ObjectRemoval = PROTO.Message("Sirikata.Protocol.Prox.ObjectRemoval", {RemovalType:PROTO.Enum("Sirikata.Protocol.Prox.ObjectRemoval.RemovalType", {Transient:1, Permanent:2}), object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:1}, seqno:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint64
}, id:2}, type:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Prox.ObjectRemoval.RemovalType
}, id:3}});
Sirikata.Protocol.Prox.ProximityUpdate = PROTO.Message("Sirikata.Protocol.Prox.ProximityUpdate", {addition:{options:{}, multiplicity:PROTO.repeated, type:function() {
  return Sirikata.Protocol.Prox.ObjectAddition
}, id:1}, removal:{options:{}, multiplicity:PROTO.repeated, type:function() {
  return Sirikata.Protocol.Prox.ObjectRemoval
}, id:2}, index_properties:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Prox.IndexProperties
}, id:3}});
Sirikata.Protocol.Prox.ProximityResults = PROTO.Message("Sirikata.Protocol.Prox.ProximityResults", {t:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.time
}, id:1}, update:{options:{}, multiplicity:PROTO.repeated, type:function() {
  return Sirikata.Protocol.Prox.ProximityUpdate
}, id:2}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
if(typeof Sirikata.Protocol.Session == "undefined") {
  Sirikata.Protocol.Session = {}
}
Sirikata.Protocol.Session._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.Session.VersionInfo = PROTO.Message("Sirikata.Protocol.Session.VersionInfo", {name:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:1}, version:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:2}, major:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:3}, minor:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:4}, revision:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:5}, vcs_version:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:6}});
Sirikata.Protocol.Session.Connect = PROTO.Message("Sirikata.Protocol.Session.Connect", {ConnectionType:PROTO.Enum("Sirikata.Protocol.Session.Connect.ConnectionType", {Fresh:1, Migration:2}), version:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.VersionInfo
}, id:11}, type:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.Session.Connect.ConnectionType
}, id:1}, object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:2}, auth:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:8}, loc:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionVector
}, id:3}, orientation:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionQuaternion
}, id:4}, bounds:{options:{packed:!0}, multiplicity:PROTO.optional, type:function() {
  return PBJ.boundingsphere3f
}, id:5}, query_angle:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.Float
}, id:6}, query_max_count:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:10}, query_parameters:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:12}, mesh:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:7}, physics:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:9}, oh_name:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:13}, zernike:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:14}});
Sirikata.Protocol.Session.ConnectResponse = PROTO.Message("Sirikata.Protocol.Session.ConnectResponse", {Response:PROTO.Enum("Sirikata.Protocol.Session.ConnectResponse.Response", {Success:1, Redirect:2, Error:3}), version:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.VersionInfo
}, id:8}, response:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.Session.ConnectResponse.Response
}, id:1}, redirect:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:2}, loc:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionVector
}, id:3}, orientation:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.TimedMotionQuaternion
}, id:4}, bounds:{options:{packed:!0}, multiplicity:PROTO.optional, type:function() {
  return PBJ.boundingsphere3f
}, id:5}, mesh:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:6}, physics:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:7}});
Sirikata.Protocol.Session.ConnectAck = PROTO.Message("Sirikata.Protocol.Session.ConnectAck", {});
Sirikata.Protocol.Session.InitiateMigration = PROTO.Message("Sirikata.Protocol.Session.InitiateMigration", {new_server:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint64
}, id:1}});
Sirikata.Protocol.Session.Disconnect = PROTO.Message("Sirikata.Protocol.Session.Disconnect", {object:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:1}, reason:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:2}});
Sirikata.Protocol.Session.Coordinate = PROTO.Message("Sirikata.Protocol.Session.Coordinate", {CoordinationType:PROTO.Enum("Sirikata.Protocol.Session.Coordinate.CoordinationType", {Add:1, Remove:2, MigrateTo:3, MigrateFrom:4, MigrateReq:5, Ready:6, Ack:7}), type:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.Session.Coordinate.CoordinationType
}, id:1}, object:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PBJ.uuid
}, id:2}, entity:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PBJ.uuid
}, id:3}, oh_name:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:4}, migrate_capacity:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:5}, migrate_threshold:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.int32
}, id:6}});
Sirikata.Protocol.Session.OHMigration = PROTO.Message("Sirikata.Protocol.Session.OHMigration", {MigrationType:PROTO.Enum("Sirikata.Protocol.Session.OHMigration.MigrationType", {Object:1, Entity:2, Ack:3}), type:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.Session.OHMigration.MigrationType
}, id:1}, id:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uuid
}, id:2}, oh_name:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:3}, password:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:4}, reason:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.string
}, id:5}, objects:{options:{}, multiplicity:PROTO.repeated, type:function() {
  return PBJ.uuid
}, id:6}});
Sirikata.Protocol.Session.Container = PROTO.Message("Sirikata.Protocol.Session.Container", {seqno:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:8}, connect:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.Connect
}, id:1}, connect_response:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.ConnectResponse
}, id:2}, connect_ack:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.ConnectAck
}, id:3}, init_migration:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.InitiateMigration
}, id:4}, disconnect:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.Disconnect
}, id:5}, coordinate:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.Coordinate
}, id:6}, oh_migration:{options:{}, multiplicity:PROTO.optional, type:function() {
  return Sirikata.Protocol.Session.OHMigration
}, id:7}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
if(typeof Sirikata.Protocol.SST == "undefined") {
  Sirikata.Protocol.SST = {}
}
Sirikata.Protocol.SST._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.SST.SSTChannelHeader = PROTO.Message("Sirikata.Protocol.SST.SSTChannelHeader", {channel_id:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uint8
}, id:1}, transmit_sequence_number:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint64
}, id:2}, ack_count:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uint8
}, id:3}, ack_sequence_number:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint64
}, id:4}, payload:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:5}});
Sirikata.Protocol.SST.SSTStreamHeader = PROTO.Message("Sirikata.Protocol.SST.SSTStreamHeader", {StreamPacketType:PROTO.Enum("Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType", {INIT:1, REPLY:2, DATA:3, ACK:4, DATAGRAM:5}), Flags:PROTO.Flags(123456, "Sirikata.Protocol.SST.SSTStreamHeader.Flags", {CONTINUES:1}), lsid:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint32
}, id:1}, type:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uint8
}, id:2}, flags:{options:{}, multiplicity:PROTO.required, type:function() {
  return Sirikata.Protocol.SST.SSTStreamHeader.Flags
}, id:3}, window:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.uint8
}, id:4}, src_port:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint32
}, id:5}, dest_port:{options:{}, multiplicity:PROTO.required, type:function() {
  return PROTO.uint32
}, id:6}, psid:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint32
}, id:7}, rsid:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint32
}, id:8}, bsn:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.uint64
}, id:9}, payload:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PROTO.bytes
}, id:10}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
Sirikata.Protocol._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.TimedMotionQuaternion = PROTO.Message("Sirikata.Protocol.TimedMotionQuaternion", {t:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.time
}, id:1}, position:{options:{packed:!0}, multiplicity:PROTO.required, type:function() {
  return PBJ.quaternion
}, id:2}, velocity:{options:{packed:!0}, multiplicity:PROTO.required, type:function() {
  return PBJ.quaternion
}, id:3}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
Sirikata.Protocol._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.TimedMotionVector = PROTO.Message("Sirikata.Protocol.TimedMotionVector", {t:{options:{}, multiplicity:PROTO.required, type:function() {
  return PBJ.time
}, id:1}, position:{options:{packed:!0}, multiplicity:PROTO.required, type:function() {
  return PBJ.vector3f
}, id:2}, velocity:{options:{packed:!0}, multiplicity:PROTO.required, type:function() {
  return PBJ.vector3f
}, id:3}});
typeof Sirikata == "undefined" && (Sirikata = {});
if(typeof Sirikata.Protocol == "undefined") {
  Sirikata.Protocol = {}
}
Sirikata.Protocol._PBJ_Internal = "pbj-0.0.3";
Sirikata.Protocol.TimeSync = PROTO.Message("Sirikata.Protocol.TimeSync", {seqno:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PBJ.uint8
}, id:1}, t:{options:{}, multiplicity:PROTO.optional, type:function() {
  return PBJ.time
}, id:2}});
Kata.require(["katajs/oh/SpaceConnection.js", "katajs/oh/SessionManager.js", "katajs/network/TCPSST.js", "katajs/core/Quaternion.js", ["externals/protojs/protobuf.js", "externals/protojs/pbj.js", "katajs/oh/plugins/sirikata/impl/AggregateBoundingInfo.pbj.js"], ["externals/protojs/protobuf.js", "externals/protojs/pbj.js", "katajs/oh/plugins/sirikata/impl/TimedMotionVector.pbj.js"], ["externals/protojs/protobuf.js", "externals/protojs/pbj.js", "katajs/oh/plugins/sirikata/impl/TimedMotionQuaternion.pbj.js"],
["externals/protojs/protobuf.js", "externals/protojs/pbj.js", "katajs/oh/plugins/sirikata/impl/Session.pbj.js"], ["externals/protojs/protobuf.js", "externals/protojs/pbj.js", "katajs/oh/plugins/sirikata/impl/ObjectMessage.pbj.js"], ["externals/protojs/protobuf.js", "externals/protojs/pbj.js", "katajs/oh/plugins/sirikata/impl/Prox.pbj.js"], ["externals/protojs/protobuf.js", "externals/protojs/pbj.js", "katajs/oh/plugins/sirikata/impl/Loc.pbj.js"], ["externals/protojs/protobuf.js", "externals/protojs/pbj.js",
"katajs/oh/plugins/sirikata/impl/Frame.pbj.js"], "katajs/oh/sst/SSTImpl.js", "katajs/oh/plugins/sirikata/Frame.js", "katajs/oh/plugins/sirikata/Sync.js", "katajs/core/FilterChannel.js", "katajs/core/MessageDispatcher.js", "katajs/oh/Presence.js", "katajs/core/URL.js", "katajs/oh/impl/ScriptProtocol.js"], function() {
  function e(e, f) {
    e != Kata.SST.SUCCESS && Kata.warn("location packet lost due to unsuccessful packet send");
    f != null ? f.close(!1) : Kata.warn("Failed to connect child stream to loc")
  }
  var f = Kata.SpaceConnection.prototype;
  Kata.SirikataSpaceConnection = function(e, h) {
    f.constructor.call(this, e);
    this.mSpaceURL = h;
    this.mObjectUUIDs = {};
    this.mLocalIDs = {};
    this.mOutstandingConnectRequests = {};
    this.mConnectedObjects = {};
    var j = 7777;
    Kata.URL.port(h) && (j = Kata.URL.port(h));
    this.mSocket = new Kata.TCPSST(Kata.URL.host(h), j);
    this.mPrimarySubstream = this.mSocket.clone();
    this.mPrimarySubstream.registerListener(Kata.bind(this._receivedData, this));
    this.mODPHandlers = {};
    this.mIncompleteLocationData = {};
    this.mSync = new Kata.Sirikata.SyncClient(this, new Kata.ODP.Endpoint(this.mSpaceURL, Kata.ObjectID.nil(), this.Ports.TimeSync), new Kata.ODP.Endpoint(this.mSpaceURL, Kata.ObjectID.nil(), this.Ports.TimeSync))
  };
  Kata.extend(Kata.SirikataSpaceConnection, Kata.SpaceConnection.prototype);
  Kata.SirikataSpaceConnection.prototype.Ports = {Session:1, Proximity:2, Location:3, TimeSync:4, Space:253};
  Kata.SirikataSpaceConnection.prototype.ObjectMessageRouter = function(e) {
    this.mParentSpaceConn = e
  };
  Kata.SirikataSpaceConnection.prototype.ObjectMessageRouter.prototype.route = function(e) {
    this.mParentSpaceConn._sendPreparedODPMessage(e)
  };
  Kata.SirikataSpaceConnection.prototype._getObjectID = function(e) {
    this.mObjectUUIDs[e] || (this.mObjectUUIDs[e] = Math.uuid(), this.mLocalIDs[this.mObjectUUIDs[e]] = e);
    return this.mObjectUUIDs[e]
  };
  Kata.SirikataSpaceConnection.prototype._getLocalID = function(e) {
    return this.mLocalIDs[e]
  };
  Kata.SirikataSpaceConnection.prototype._toLocalTime = function(e) {
    return e instanceof Date ? new Date(e.getTime() - this.mSync.offset()) : new Date(e - this.mSync.offset())
  };
  Kata.SirikataSpaceConnection.prototype._toSpaceTime = function(e) {
    return e instanceof Date ? new Date(e.getTime() + this.mSync.offset()) : new Date(e + this.mSync.offset())
  };
  Kata.SirikataSpaceConnection.prototype._serializeMessage = function(e) {
    var f = new PROTO.ByteArrayStream;
    e.SerializeToStream(f);
    return f
  };
  Kata.SirikataSpaceConnection.prototype._generateLocUpdateParts = function(e, f) {
    var j = f ? {loc:void 0, orient:void 0, bounds:[0, 0, 0, 1], visual:""} : {loc:void 0, orient:void 0, bounds:void 0, visual:void 0};
    if(e.pos || e.vel) {
      var m = new Sirikata.Protocol.TimedMotionVector;
      m.t = this._toSpaceTime(e.time);
      if(e.pos) {
        m.position = e.pos
      }
      if(e.vel) {
        m.velocity = e.vel
      }
      j.loc = m
    }
    if(e.orient || e.rotvel != void 0 && e.rotaxis != void 0) {
      m = new Sirikata.Protocol.TimedMotionQuaternion;
      m.t = this._toSpaceTime(e.time);
      if(e.orient) {
        m.position = e.orient
      }
      if(e.rotvel != void 0 && e.rotaxis != void 0) {
        m.velocity = Kata.Quaternion.fromAxisAngle(e.rotaxis, e.rotvel).array()
      }
      j.orient = m
    }
    if(e.scale) {
      if(e.scale.length === void 0) {
        j.bounds = [0, 0, 0, e.scale], console.log("IMPROPER BOUNDS: number")
      }else {
        if(e.scale.length == 3) {
          j.bounds = [0, 0, 0, e.scale[0]], Kata.warn("IMPROPER BOUNDS LENGTH")
        }else {
          if(e.scale.length == 4) {
            j.bounds = e.scale
          }
        }
      }
    }
    if(e.visual) {
      j.visual = e.visual
    }
    return j
  };
  Kata.SirikataSpaceConnection.prototype.connectObject = function(e, f, j, m, p) {
    var e = this._getObjectID(e), o = !1;
    if(j.posTime === void 0 && j.time === void 0) {
      j.time = Date.now(), o = !0
    }
    var r = Kata.LocationIdentity(j.posTime === void 0 ? j.time : j.posTime);
    Kata.LocationCopyUnifyTime(j, r);
    r.visual = j.visual;
    this.mOutstandingConnectRequests[e] = {loc_bounds:r, visual:m, reset_time:o, deferred_odp:[]};
    j = new Sirikata.Protocol.Session.Connect;
    j.type = Sirikata.Protocol.Session.Connect.ConnectionType.Fresh;
    j.object = e;
    if(f) {
      j.auth = typeof f == "string" ? PROTO.encodeUTF8(f) : f
    }
    f = this._generateLocUpdateParts(r, !0);
    if(f.loc) {
      j.loc = f.loc
    }
    if(f.orient) {
      j.orientation = f.orient
    }
    if(f.bounds) {
      j.bounds = f.bounds
    }
    if(f.visual) {
      j.mesh = f.visual
    }
    if(p > 0 && p != !0 && p) {
      j.query_angle = p
    }else {
      if(p) {
        j.query_angle = 1.0E-26
      }
    }
    p = new Sirikata.Protocol.Session.Container;
    p.connect = j;
    this._sendODPMessage(e, this.Ports.Session, Kata.ObjectID.nil(), this.Ports.Session, this._serializeMessage(p))
  };
  Kata.SirikataSpaceConnection.prototype.disconnectObject = function(e) {
    var f = new Sirikata.Protocol.Session.Disconnect;
    f.object = e;
    f.reason = "Quit";
    var j = new Sirikata.Protocol.Session.Container;
    j.disconnect = f;
    this._sendODPMessage(e, this.Ports.Session, Kata.ObjectID.nil(), this.Ports.Session, this._serializeMessage(j))
  };
  Kata.SirikataSpaceConnection.prototype.sendODPMessage = function(e, f, j, m, p) {
    this._sendODPMessage(e, f, j, m, p)
  };
  Kata.SirikataSpaceConnection.prototype._sendODPMessage = function(e, f, j, m, p) {
    var o = new Sirikata.Protocol.Object.ObjectMessage;
    o.source_object = e;
    o.source_port = f;
    o.dest_object = j;
    o.dest_port = m;
    o.unique = PROTO.I64.fromNumber(0);
    if(typeof p !== "undefined" && (typeof p.length === "undefined" || p.length > 0)) {
      o.payload = typeof p == "string" ? PROTO.encodeUTF8(p) : p
    }
    this._sendPreparedODPMessage(o)
  };
  Kata.SirikataSpaceConnection.prototype._sendPreparedODPMessage = function(e) {
    var f = new PROTO.ArrayBufferStream;
    e.SerializeToStream(f);
    this.mPrimarySubstream.sendMessage(f.getUint8Array())
  };
  Kata.SirikataSpaceConnection.prototype._handleDisconnected = function(e) {
    if(e === this.mPrimarySubstream) {
      for(var f in this.mConnectedObjects) {
        this.mParent.disconnected(f, this.mSpaceURL)
      }
      for(f in this.mOutstandingConnectRequests) {
        this.mParent.connectionResponse(this._getLocalID(f), !1, {space:this.mSpaceURL, object:f}, {msg:"Couldn't connect to space server."})
      }
      this.mParent.spaceConnectionDisconnected(this)
    }
  };
  Kata.SirikataSpaceConnection.prototype._receivedData = function(e, f) {
    if(f === void 0 || f === null) {
      this._handleDisconnected(e)
    }else {
      var j = new Sirikata.Protocol.Object.ObjectMessage;
      j.ParseFromStream(new PROTO.Uint8ArrayStream(f));
      if(j.source_object == Kata.ObjectID.nil() && j.dest_port == this.Ports.Session) {
        this._handleSessionMessage(j)
      }else {
        var m = this.mODPHandlers[j.dest_object + j.dest_port];
        m ? m(this.mSpaceURL, j.source_object, j.source_port, j.dest_object, j.dest_port, j.payload) : (m = this.mConnectedObjects[j.dest_object]) && (m.odpDispatcher.dispatchMessage(j) || this._tryDeliverODP(j))
      }
    }
  };
  Kata.SirikataSpaceConnection.prototype._receiveODPMessage = function(e, f, j) {
    this.mODPHandlers[e + f] = j
  };
  Kata.SirikataSpaceConnection.prototype._tryDeliverODP = function(e) {
    var f = this.mOutstandingConnectRequests[e.dest_object];
    f ? f.deferred_odp.push(e) : this._deliverODP(e)
  };
  Kata.SirikataSpaceConnection.prototype._deliverODP = function(e) {
    this.mParent.receiveODPMessage(this.mSpaceURL, e.source_object, e.source_port, e.dest_object, e.dest_port, e.payload)
  };
  Kata.SirikataSpaceConnection.prototype._handleSessionMessage = function(e) {
    var f = new Sirikata.Protocol.Session.Container;
    f.ParseFromStream(PROTO.CreateArrayStream(e.payload));
    e = e.dest_object;
    if(f.HasField("connect_response")) {
      var j = f.connect_response;
      if(j.response == Sirikata.Protocol.Session.ConnectResponse.Response.Success) {
        j = this._getLocalID(e);
        Kata.log("Successfully connected " + j);
        var m = new Sirikata.Protocol.Session.ConnectAck, p = new Sirikata.Protocol.Session.Container;
        p.connect_ack = m;
        this._sendODPMessage(e, this.Ports.Session, Kata.ObjectID.nil(), this.Ports.Session, this._serializeMessage(p));
        this.mConnectedObjects[e] = {};
        m = new this.ObjectMessageRouter(this);
        p = new Kata.SST.ObjectMessageDispatcher;
        this.mConnectedObjects[e].odpDispatcher = p;
        this.mConnectedObjects[e].odpBaseDatagramLayer = Kata.SST.createBaseDatagramLayer(new Kata.SST.EndPoint(e, 0), m, p);
        this.mConnectedObjects[e].proxdata = [];
        Kata.SST.connectStream(new Kata.SST.EndPoint(e, this.Ports.Space), new Kata.SST.EndPoint(Kata.SpaceID.nil(), this.Ports.Space), Kata.bind(this._spaceSSTConnectCallback, this, e));
        this.mParent.aliasIDs(j, {space:this.mSpaceURL, object:e})
      }else {
        j.response == Sirikata.Protocol.Session.ConnectResponse.Response.Redirect ? Kata.notImplemented("Server redirects for Sirikata are not implemented.") : j.response == Sirikata.Protocol.Session.ConnectResponse.Response.Error ? (Kata.warn("Connection Error."), j = this._getLocalID(e), this.mParent.connectionResponse(j, !1, {space:this.mSpaceURL, object:e}, {msg:"Authentication failure."})) : Kata.warn("Got unknown connection response.")
      }
    }
    f.HasField("init_migration") && Kata.notImplemented("Migrations not implemented.")
  };
  Kata.SirikataSpaceConnection.prototype._spaceSSTConnectCallback = function(e, f, j) {
    if(f == Kata.SST.FAILURE) {
      Kata.warn("Failed to get SST connection to space for " + e + ".")
    }else {
      Kata.log("Successful SST space connection for " + e + ". Setting up loc and prox listeners.");
      this.mConnectedObjects[e].spaceStream = j;
      j.listenSubstream(this.Ports.Location, Kata.bind(this._handleLocationSubstream, this, e));
      j.listenSubstream(this.Ports.Proximity, Kata.bind(this._handleProximitySubstream, this, e));
      f = this.mOutstandingConnectRequests[e];
      if(f.reset_time) {
        f.loc_bounds.time = Kata.now(this.mSpaceURL)
      }
      delete this.mOutstandingConnectRequests[e];
      this.mParent.connectionResponse(this._getLocalID(e), !0, {space:this.mSpaceURL, object:e}, {loc:f.loc_bounds, vis:f.visual});
      for(e = 0;e < f.deferred_odp.length;e++) {
        this._deliverODP(f.deferred_odp[e])
      }
    }
  };
  Kata.SirikataSpaceConnection.prototype.locUpdateRequest = function(f, h, j) {
    var m = new Sirikata.Protocol.Loc.LocationUpdateRequest, h = this._generateLocUpdateParts(h, !1);
    if(h.loc) {
      m.location = h.loc
    }
    if(h.orient) {
      m.orientation = h.orient
    }
    if(h.bounds) {
      m.bounds = h.bounds
    }
    if(typeof j == "string") {
      m.mesh = j
    }
    j = new Sirikata.Protocol.Loc.Container;
    j.update_request = m;
    (f = this.mConnectedObjects[f].spaceStream) ? f.createChildStream(e, this._serializeMessage(j).getArray(), this.Ports.Location, this.Ports.Location) : Kata.warn("Tried to send loc update before stream to server was ready.")
  };
  Kata.SirikataSpaceConnection.prototype.requestQueryRemoval = function(e) {
    this.requestQueryUpdate(e, 4 * Math.PI)
  };
  Kata.SirikataSpaceConnection.prototype.requestQueryUpdate = function(e, f) {
    var j = new Sirikata.Protocol.Prox.QueryRequest;
    j.query_angle = f;
    var m = this.mConnectedObjects[e].spaceStream;
    m ? m.datagram(this._serializeMessage(j).getArray(), this.Ports.Proximity, this.Ports.Proximity) : Kata.warn("Tried to send prox update before stream to server was ready.")
  };
  Kata.SirikataSpaceConnection.prototype.setPhysics = function(f, h) {
    var j = new Sirikata.Protocol.Loc.LocationUpdateRequest;
    j.physics = h;
    var m = new Sirikata.Protocol.Loc.Container;
    m.update_request = j;
    (j = this.mConnectedObjects[f].spaceStream) ? j.createChildStream(e, this._serializeMessage(m).getArray(), this.Ports.Location, this.Ports.Location) : Kata.warn("Tried to send loc update before stream to server was ready.")
  };
  Kata.SirikataSpaceConnection.prototype._handleLocationSubstream = function(e, f, j) {
    f != 0 && Kata.warn("Location substream (error " + f + ")");
    j.registerReadCallback(Kata.bind(this._handleLocationSubstreamRead, this, e, j))
  };
  Kata.SirikataSpaceConnection.prototype._handleProximitySubstream = function(e, f, j) {
    f != 0 && Kata.warn("Proximity substream (error " + f + ")");
    j.registerReadCallback(Kata.bind(this._handleProximitySubstreamRead, this, e, j))
  };
  Kata.SirikataSpaceConnection.prototype._handleLocationSubstreamRead = function(e, f, j) {
    this.mIncompleteLocationData[f.mUSID] && (j = this.mIncompleteLocationData[f.mUSID].concat(j));
    var m = new Sirikata.Protocol.Frame, p = PROTO.CreateArrayStream(j);
    if(m.ParseFromStream(p)) {
      this.mIncompleteLocationData[f.mUSID] && delete this.mIncompleteLocationData[f.mUSID];
      j = new Sirikata.Protocol.Loc.BulkLocationUpdate;
      j.ParseFromStream(PROTO.CreateArrayStream(m.payload));
      for(m = 0;m < j.update.length;m++) {
        var o = j.update[m], p = o.object, r = o.HasField("mesh") ? o.mesh : void 0, s = o.HasField("physics") ? o.physics : void 0;
        if(o.location) {
          var t = {};
          t.seqno = o.seqno;
          t.time = this._toLocalTime(o.location.t).getTime();
          t.pos = o.location.position;
          t.vel = o.location.velocity;
          this.mParent.presenceLocUpdate(this.mSpaceURL, p, e, t, r, s)
        }
        if(o.orientation) {
          t = {};
          t.seqno = o.seqno;
          t.time = this._toLocalTime(o.orientation.t).getTime();
          t.orient = o.orientation.position;
          var q = (new Kata.Quaternion(o.orientation.velocity)).toAngleAxis();
          t.rotaxis = q.axis;
          t.rotvel = q.angle;
          this.mParent.presenceLocUpdate(this.mSpaceURL, p, e, t, r, s)
        }
        if(o.aggregate_bounds) {
          t = {};
          t.seqno = o.seqno;
          q = o.aggregate_bounds.max_object_size;
          t.scale = [0, 0, 0, q ? q : 0];
          if(o.aggregate_bounds.center_offset) {
            o = o.aggregate_bounds.center_offset, t.scale[0] = o[0], t.scale[1] = o[1], t.scale[2] = o[2]
          }
          if(!t.time) {
            t.time = Kata.now(this.mSpaceURL)
          }
          this.mParent.presenceLocUpdate(this.mSpaceURL, p, e, t, r, s)
        }
      }
      f.close(!1)
    }else {
      this.mIncompleteLocationData[f.mUSID] = j
    }
  };
  Kata.SirikataSpaceConnection.prototype._handleProximitySubstreamRead = function(e, f, j) {
    f = this.mConnectedObjects[e];
    for(f.proxdata = f.proxdata.concat(j);;) {
      var m = Kata.Frame.parse(f.proxdata);
      if(m === null) {
        break
      }
      j = new Sirikata.Protocol.Prox.ProximityResults;
      j.ParseFromStream(PROTO.CreateArrayStream(m));
      for(m = 0;m < j.update.length;m++) {
        this._handleProximityUpdate(e, j.t, j.update[m])
      }
    }
  };
  Kata.SirikataSpaceConnection.prototype._handleProximityUpdate = function(e, f, j) {
    for(var m = 0;m < j.addition.length;m++) {
      if(f = j.addition[m].object, f != e) {
        var p = {};
        p.loc = Kata.LocationIdentity(0);
        p.loc.pos = j.addition[m].location.position;
        p.loc.vel = j.addition[m].location.velocity;
        p.loc.posTime = this._toLocalTime(j.addition[m].location.t).getTime();
        p.loc.orient = j.addition[m].orientation.position;
        var o = (new Kata.Quaternion(j.addition[m].orientation.velocity)).toAngleAxis();
        p.loc.rotaxis = o.axis;
        p.loc.rotvel = o.angle;
        p.loc.orientTime = this._toLocalTime(j.addition[m].orientation.t).getTime();
        if(j.addition[m].aggregate_bounds && (o = j.addition[m].aggregate_bounds.max_object_size, p.bounds = [0, 0, 0, o ? o : 0], j.addition[m].aggregate_bounds.center_offset)) {
          o = j.addition[m].aggregate_bounds.center_offset, p.bounds[0] = o[0], p.bounds[1] = o[1], p.bounds[2] = o[2]
        }
        p.loc.scale = p.bounds;
        p.loc.scaleTime = this._toLocalTime(j.addition[m].location.t).getTime();
        if(j.addition[m].HasField("mesh")) {
          p.visual = j.addition[m].mesh
        }
        this.mParent.proxEvent(this.mSpaceURL, e, f, !0, p)
      }
    }
    for(m = 0;m < j.removal.length;m++) {
      f = j.removal[m].object, f != e && this.mParent.proxEvent(this.mSpaceURL, e, f, !1)
    }
  };
  Kata.SessionManager.registerProtocolHandler("sirikata", Kata.SirikataSpaceConnection)
}, "katajs/oh/plugins/sirikata/SirikataSpaceConnection.js");
Kata.require([["externals/protojs/protobuf.js", "externals/protojs/pbj.js", "katajs/oh/plugins/sirikata/impl/TimeSync.pbj.js"]], function() {
  if(typeof Kata.Sirikata == "undefined") {
    Kata.Sirikata = {}
  }
  Kata.Sirikata.SyncClient = function(e, f, g, h) {
    this.mODP = e;
    this.mLocalEndpoint = f;
    this.mSyncEndpoint = g;
    this.mCB = h;
    this.mODP._receiveODPMessage(f.object(), f.port(), Kata.bind(this.handleMessage, this));
    this.mSeqNo = 0;
    this.mRequestTimes = Array(256);
    this.poll();
    this.mOffset = null
  };
  Kata.Sirikata.SyncClient.prototype.MaxRTT = 5E3;
  Kata.Sirikata.SyncClient.prototype.valid = function() {
    return this.mOffset == null
  };
  Kata.Sirikata.SyncClient.prototype.offset = function() {
    return this.mOffset
  };
  Kata.Sirikata.SyncClient.prototype.poll = function() {
    var e = new Sirikata.Protocol.TimeSync, f = this.mSeqNo;
    this.mSeqNo = (this.mSeqNo + 1) % 256;
    e.seqno = f;
    this.mRequestTimes[f] = Date.now();
    f = new PROTO.ByteArrayStream;
    e.SerializeToStream(f);
    this.mODP.sendODPMessage(this.mLocalEndpoint.object(), this.mLocalEndpoint.port(), this.mSyncEndpoint.object(), this.mSyncEndpoint.port(), f);
    setTimeout(Kata.bind(this.poll, this), 5E3)
  };
  Kata.Sirikata.SyncClient.prototype.handleMessage = function(e, f, g, h, j, m) {
    e = new Sirikata.Protocol.TimeSync;
    e.ParseFromStream(PROTO.CreateArrayStream(m));
    m = this.mRequestTimes[e.seqno];
    e = e.t;
    f = Date.now();
    g = f - m;
    if(!(f < m || g > this.MaxRTT)) {
      this.mOffset = e - (m + g / 2), this.mCB && this.mCB()
    }
  }
}, "katajs/oh/plugins/sirikata/Sync.js");
Kata.require(["katajs/oh/RemotePresence.js", "katajs/oh/sst/SSTImpl.js"], function() {
  var e = Kata.RemotePresence.prototype;
  Kata.Presence = function(f, g, h, j, m, p) {
    e.constructor.call(this, this, g, h, j, m, p);
    this.mScript = f;
    this.mQueryHander = this.mQuery = null;
    this.mRequestedLocation = this.mLocation;
    this.mOrphanLocUpdates = {};
    f = this.sstEndpoint(0);
    (g = Kata.SST.getBaseDatagramLayer(f)) ? (this.ODPRouter = g.mRouter, this.ODPDispatcher = g.mDispatcher, this.ODPBaseDatagramLayer = g) : (this.ODPRouter = new this.ObjectMessageRouter(this), this.ODPDispatcher = new Kata.SST.ObjectMessageDispatcher, this.ODPBaseDatagramLayer = Kata.SST.createBaseDatagramLayer(f, this.ODPRouter, this.ODPDispatcher))
  };
  Kata.extend(Kata.Presence, e);
  Kata.Presence.prototype.bindODPPort = function(e) {
    return this.mScript.bindODPPort(this.mSpace, this.mID, e)
  };
  Kata.Presence.prototype.ObjectMessageRouter = function(e) {
    this.mParent = e
  };
  Kata.Presence.prototype.ObjectMessageRouter.prototype.route = function(e) {
    this.mParent._sendPreparedODPMessage(e)
  };
  Kata.Presence.prototype._sendPreparedODPMessage = function(e) {
    return this.mScript._sendPreparedODPMessage(this.mSpace, e)
  };
  Kata.Presence.prototype._sendHostedObjectMessage = function(e) {
    return this.mScript._sendHostedObjectMessage(e)
  };
  Kata.Presence.prototype.disconnect = function() {
    this.mScript._disconnect(this)
  };
  Kata.Presence.prototype.query = function() {
    return this.mQuery
  };
  Kata.Presence.prototype.setQuery = function(e) {
    this.mQuery = e;
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.Query(this.mSpace, this.mID, e))
  };
  Kata.Presence.prototype.setQueryHandler = function(e) {
    this.mQueryHandler = e
  };
  Kata.Presence.prototype._requestedPosition = function(e) {
    return Kata.LocationExtrapolate(this.mRequestedLocation, e).pos.concat()
  };
  Kata.Presence.prototype._requestedVelocity = function() {
    return this.mRequestedLocation.vel.concat()
  };
  Kata.Presence.prototype._requestedOrientation = function(e) {
    return Kata.LocationExtrapolate(this.mRequestedLocation, e).orient.concat()
  };
  Kata.Presence.prototype._requestedAngularSpeed = function() {
    return this.mRequestedLocation.rotvel
  };
  Kata.Presence.prototype._requestedRotationalAxis = function() {
    return this.mRequestedLocation.rotaxis.concat()
  };
  Kata.Presence.prototype._requestedRotationalVelocity = function() {
    return Kata.Quaternion.fromLocationAngularVelocity(this.mRequestedLocation)
  };
  Kata.Presence.prototype._requestedScale = function() {
    return this.mRequestedLocation.scale.concat()
  };
  Kata.Presence.prototype._requestedLocation = function() {
    var e = {}, g;
    for(g in this.mRequestedLocation) {
      e[g] = this.mRequestedLocation[g]
    }
    return e
  };
  Kata.Presence.prototype.predictedPosition = function(e) {
    return this._requestedPosition(e)
  };
  Kata.Presence.prototype.predictedVelocity = function() {
    return this._requestedVelocity()
  };
  Kata.Presence.prototype.predictedOrientation = function(e) {
    return this._requestedOrientation(e)
  };
  Kata.Presence.prototype.predictedAngularSpeed = function() {
    return this._requestedAngularSpeed()
  };
  Kata.Presence.prototype.predictedRotationalAxis = function() {
    return this._requestesdRotationalAxis()
  };
  Kata.Presence.prototype.predictedRotationalVelocity = function() {
    return this._requestesdRotationalVelocity()
  };
  Kata.Presence.prototype.predictedScale = function() {
    return this._requestedScale()
  };
  Kata.Presence.prototype.predictedLocation = function() {
    return this._requestedLocation()
  };
  Kata.Presence.prototype.setPosition = function(e) {
    var g = Kata.now(this.mSpace), h = this._requestedPosition(g);
    if(!(h[0] == e[0] && h[1] == e[1] && h[2] == e[2])) {
      e = {pos:e.concat(), vel:this._requestedVelocity(), time:Kata.now(this.mSpace)}, h = new Kata.ScriptProtocol.FromScript.Location(this.mSpace, this.mID, e), this.mRequestedLocation = Kata.LocationUpdate(e, this.mRequestedLocation, null, g), this._sendHostedObjectMessage(h)
    }
  };
  Kata.Presence.prototype.setVelocity = function(e) {
    var g = Kata.now(this.mSpace), h = this._requestedVelocity();
    if(!(h[0] == e[0] && h[1] == e[1] && h[2] == e[2])) {
      e = {pos:this._requestedPosition(g), vel:e.concat(), time:g}, h = new Kata.ScriptProtocol.FromScript.Location(this.mSpace, this.mID, e), this.mRequestedLocation = Kata.LocationUpdate(e, this.mRequestedLocation, null, g), this._sendHostedObjectMessage(h)
    }
  };
  Kata.Presence.prototype.setOrientation = function(e) {
    var g = Kata.now(this.mSpace), h = this._requestedOrientation(g);
    if(!(h[0] == e[0] && h[1] == e[1] && h[2] == e[2] && h[3] == e[3])) {
      e = {orient:e.concat(), rotaxis:this._requestedRotationalAxis(), rotvel:this._requestedAngularSpeed(), time:Kata.now(this.mSpace)}, h = new Kata.ScriptProtocol.FromScript.Location(this.mSpace, this.mID, e), this.mRequestedLocation = Kata.LocationUpdate(e, this.mRequestedLocation, null, g), this._sendHostedObjectMessage(h)
    }
  };
  Kata.Presence.prototype.setAngularVelocity = function(e) {
    !1 in e && (e = new Kata.Quaternion(e));
    var e = e.toAngleAxis(), g = e.angle, h = e.axis, e = Kata.now(this.mSpace), j = this._requestedAngularSpeed(), m = this._requestedRotationalAxis();
    if(!(j == g && m[0] == h[0] && m[1] == h[1] && m[2] == h[2])) {
      g = {orient:this._requestedOrientation(e), rotaxis:h.concat(), rotvel:g, time:e}, h = new Kata.ScriptProtocol.FromScript.Location(this.mSpace, this.mID, g), this.mRequestedLocation = Kata.LocationUpdate(g, this.mRequestedLocation, null, e), this._sendHostedObjectMessage(h)
    }
  };
  Kata.Presence.prototype.setLocation = function(e) {
    var g = Kata.now(this.mSpace);
    if(e.time === void 0) {
      e.time = Kata.now(this.mSpace)
    }
    var h = new Kata.ScriptProtocol.FromScript.Location(this.mSpace, this.mID, e);
    this.mRequestedLocation = Kata.LocationUpdate(e, this.mRequestedLocation, null, g);
    this._sendHostedObjectMessage(h)
  };
  Kata.Presence.prototype.setBounds = function(e) {
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.Location(this.mSpace, this.mID, {bounds:e.concat(), time:Kata.now(this.mSpace)}))
  };
  Kata.Presence.prototype.setScale = function(e) {
    var g = Kata.now(this.mSpace), h = {scale:e.concat(), time:g}, e = new Kata.ScriptProtocol.FromScript.Location(this.mSpace, this.mID, {scale:e.concat(), time:g});
    this.mRequestedLocation = Kata.LocationUpdate(h, this.mRequestedLocation, null, g);
    this._sendHostedObjectMessage(e)
  };
  Kata.Presence.prototype.setVisual = function(e) {
    var g = new Kata.ScriptProtocol.FromScript.Location(this.mSpace, this.mID, e);
    g.visual = e;
    this._sendHostedObjectMessage(g)
  };
  Kata.Presence.prototype.setPhysics = function(e) {
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.Physics(this.mSpace, this.mID, e))
  };
  Kata.Presence.prototype.remotePresence = function(e, g) {
    this.mQueryHandler && this.mQueryHandler(e, g);
    var h = e.presenceID(), j = this.mOrphanLocUpdates[h];
    if(g && j !== void 0) {
      for(var m = 0;m < j.length;m++) {
        e._updateLoc(j[m].loc, j[m].visual)
      }
      this.mOrphanLocUpdates[h].timeout && clearTimeout(this.mOrphanLocUpdates[h].timeout);
      delete this.mOrphanLocUpdates[h]
    }
  };
  Kata.Presence.prototype.subscribe = function(e) {
    this.mParent._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.Subscription(this.mSpace, this.mID, e, !0))
  };
  Kata.Presence.prototype.unsubscribe = function(e) {
    this.mParent._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.Subscription(this.mSpace, this.mID, e, !1))
  };
  Kata.Presence.prototype.onDisconnected = function() {
    Kata.notImplemented("Presence.onDisconnected")
  };
  Kata.Presence.prototype.handleSpaceEvent = function() {
    Kata.notImplemented("Presence.handleSpaceEvent")
  };
  Kata.Presence.prototype._handleDisconnect = function() {
    Kata.notImplemented("Presence._handleDisconnect")
  };
  Kata.Presence.prototype._handleLocEvent = function(e, g) {
    Kata.now(this.mSpace);
    if(this.id() === e.observed) {
      return this._updateLoc(e.loc, e.visual, e.physics), this
    }else {
      var h = Kata.Script.remotePresenceKey(e.space, e.observed);
      if(h = g[h]) {
        h._updateLoc(e.loc, e.visual, e.physics)
      }else {
        var j = new Kata.PresenceID(e.space, e.observed);
        this.mOrphanLocUpdates[j] || (this.mOrphanLocUpdates[j] = []);
        this.mOrphanLocUpdates[j].push(e);
        if(!this.mOrphanLocUpdates[j].timeout) {
          this.mOrphanLocUpdates[j].timeout = setTimeout(Kata.bind(this._clearOrphanLocUpdates, this, j), 6E4)
        }
      }
      return h
    }
  };
  Kata.Presence.prototype._clearOrphanLocUpdates = function(e) {
    delete this.mOrphanLocUpdates[e]
  };
  Kata.Presence.prototype._handleVisualEvent = function() {
    Kata.notImplemented("Presence._handleVisualEvent")
  };
  Kata.Presence.prototype._handleQueryEvent = function() {
    Kata.notImplemented("Presence._handleQueryEvent")
  }
}, "katajs/oh/Presence.js");
Kata.require(["externals/protojs/protobuf.js", "katajs/core/Time.js", "katajs/oh/odp/Endpoint.js"], function() {
  Kata.RemotePresence = function(e, f, g, h, j, m) {
    this.mParent = e;
    this.mSpace = f;
    this.mID = g;
    this.mOrientSeqNo = this.mPosSeqNo = this.mScaleSeqNo = void 0;
    this.mLocation = h;
    if(j) {
      this.rMesh = j
    }
    if(m) {
      this.mPhysics = m
    }
    this.mTracking = !1
  };
  Kata.RemotePresence.prototype.id = function() {
    return this.mID
  };
  Kata.RemotePresence.prototype.object = function() {
    return this.mID
  };
  Kata.RemotePresence.prototype.space = function() {
    return this.mSpace
  };
  Kata.RemotePresence.prototype.presenceID = function() {
    return new Kata.PresenceID(this.mSpace, this.mID)
  };
  Kata.RemotePresence.prototype.endpoint = function(e) {
    return new Kata.ODP.Endpoint(this.mSpace, this.mID, e)
  };
  Kata.RemotePresence.prototype.sstEndpoint = function(e) {
    return new Kata.SST.EndPoint(this.object(), e)
  };
  Kata.RemotePresence.prototype.owner = function() {
    return this.mParent
  };
  Kata.RemotePresence.prototype.track = function() {
    if(!this.mTracking) {
      this.mParent.subscribe(this.mID), this.mTracking = !0
    }
  };
  Kata.RemotePresence.prototype.untrack = function() {
    if(this.mTracking) {
      this.mParent.unsubscribe(this.mID), this.mTracking = !1
    }
  };
  Kata.RemotePresence.prototype.position = function(e) {
    e === void 0 && console.log("inaccurate read of position");
    return Kata.LocationExtrapolate(this.mLocation, e).pos.concat()
  };
  Kata.RemotePresence.prototype.velocity = function() {
    return this.mLocation.vel.concat()
  };
  Kata.RemotePresence.prototype.orientation = function(e) {
    e === void 0 && console.log("inaccurate read of orientation");
    return Kata.LocationExtrapolate(this.mLocation, e).orient.concat()
  };
  Kata.RemotePresence.prototype.angularSpeed = function() {
    return this.mLocation.rotvel
  };
  Kata.RemotePresence.prototype.rotationalAxis = function() {
    return this.mLocation.rotaxis.concat()
  };
  Kata.RemotePresence.prototype.rotationalVelocity = function() {
    return Kata.Quaternion.fromLocationAngularVelocity(this.mLocation)
  };
  Kata.RemotePresence.prototype.scale = function() {
    return this.mLocation.scale.concat()
  };
  Kata.RemotePresence.prototype.location = function() {
    var e = {}, f;
    for(f in this.mLocation) {
      e[f] = this.mLocation[f]
    }
    return e
  };
  Kata.RemotePresence.prototype.predictedPosition = function(e) {
    return this.position(e)
  };
  Kata.RemotePresence.prototype.predictedVelocity = function() {
    return this.velocity()
  };
  Kata.RemotePresence.prototype.predictedOrientation = function(e) {
    return this.orientation(e)
  };
  Kata.RemotePresence.prototype.predictedAngularSpeed = function() {
    return this.angularSpeed()
  };
  Kata.RemotePresence.prototype.predictedRotationalAxis = function() {
    return this.rotationalAxis()
  };
  Kata.RemotePresence.prototype.predictedRotationalVelocity = function() {
    return this.rotationalVelocity()
  };
  Kata.RemotePresence.prototype.predictedScale = function() {
    return this.scale()
  };
  Kata.RemotePresence.prototype.predictedLocation = function() {
    return this.location()
  };
  Kata.RemotePresence.prototype.bounds = function() {
    return this.mLocation.scale.concat()
  };
  Kata.RemotePresence.prototype.visual = function() {
    return this.rMesh
  };
  Kata.RemotePresence.prototype.physics = function() {
    return this.mPhysics
  };
  Kata.RemotePresence.prototype._updateLoc = function(e, f, g) {
    if(e) {
      if(e.seqno) {
        if(this.mScaleSeqNo == void 0 || e.seqno == void 0 || !PROTO.I64.prototype.unsigned_less.call(e.seqno, this.mScaleSeqNo)) {
          if(e.seqno != void 0) {
            this.mScaleSeqNo = e.seqno
          }
        }else {
          delete e.scale
        }
        if(this.mPosSeqNo == void 0 || e.seqno == void 0 || !PROTO.I64.prototype.unsigned_less.call(e.seqno, this.mPosSeqNo)) {
          if(e.seqno != void 0) {
            this.mPosSeqNo = e.seqno
          }
        }else {
          delete e.pos, delete e.vel
        }
        if(this.mOrientSeqNo == void 0 || e.seqno == void 0 || !PROTO.I64.prototype.unsigned_less.call(e.seqno, this.mOrientSeqNo)) {
          if(e.seqno != void 0) {
            this.mOrientSeqNo = e.seqno
          }
        }else {
          delete e.orient, delete e.rotvel, delete e.rotaxis
        }
      }
      this.mLocation = Kata.LocationUpdate(e, this.mLocation, void 0, Kata.now(this.mSpace))
    }
    if(f != void 0) {
      this.rMesh = f
    }
    if(g != void 0) {
      this.mPhysics = g
    }
  }
}, "katajs/oh/RemotePresence.js");
Kata.require(["katajs/oh/impl/ScriptProtocol.js", "katajs/oh/Presence.js", "katajs/oh/RemotePresence.js", "katajs/oh/odp/Port.js", "katajs/oh/odp/Service.js"], function() {
  Kata.Script = function(e) {
    Kata.ODP.Service.prototype.constructor.call(this, Kata.bind(this._sendODPMessage, this));
    this.mChannel = e;
    this.mChannel.registerListener(Kata.bind(this._handleHostedObjectMessage, this));
    this.mPresences = {};
    this.mRemotePresences = {};
    this.mConnectRequests = {};
    var e = {}, f = Kata.ScriptProtocol.ToScript.Types;
    e[f.Connected] = Kata.bind(this._handleConnected, this);
    e[f.ConnectionFailed] = Kata.bind(this._handleConnectFailed, this);
    e[f.Disconnected] = Kata.bind(this._handleDisconnect, this);
    e[f.ReceiveODPMessage] = Kata.bind(this._handleReceiveODPMessage, this);
    e[f.QueryEvent] = Kata.bind(this._handleQueryEvent, this);
    e[f.PresenceLocUpdate] = Kata.bind(this._handlePresenceLocUpdate, this);
    this.mMessageDispatcher = new Kata.MessageDispatcher(e);
    this.mBehaviors = []
  };
  Kata.extend(Kata.Script, Kata.ODP.Service.prototype);
  Kata.Script.prototype.addBehavior = function(e) {
    this.mBehaviors.push(e)
  };
  Kata.Script.prototype._sendHostedObjectMessage = function(e) {
    return this.mChannel.sendMessage(e)
  };
  Kata.Script.prototype.connect = function(e, f, g, h) {
    f = new Kata.ScriptProtocol.FromScript.Connect(e.space, f, e.loc, e.visual, h);
    this.mConnectRequests[e.space] = g;
    this._sendHostedObjectMessage(f)
  };
  Kata.Script.prototype._disconnect = function(e) {
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.Disconnect(e.space(), e.id()))
  };
  Kata.Script.prototype._handleConnected = function(e, f) {
    var g = new Kata.Presence(this, Kata.URL(f.space), f.id, f.loc, f.visual, f.physics);
    this.mPresences[f.space] = g;
    var h = this.mConnectRequests[g.space()];
    h && (delete this.mConnectRequests[g.space()], h(g));
    this.mBehaviors.forEach(function(e) {
      e.newPresence && e.newPresence(g)
    })
  };
  Kata.Script.prototype._handleConnectFailed = function(e, f) {
    var g = this.mConnectRequests[f.space];
    g && (delete this.mConnectRequests[f.space], g(null, f.space, f.reason ? f.reason : "Disconnected"))
  };
  Kata.Script.prototype._handleDisconnect = function(e, f) {
    var g = this.mPresences[f.space];
    g && (delete this.mPresences[f.space], this.mBehaviors.forEach(function(e) {
      e.presenceInvalidated && e.presenceInvalidated(g)
    }))
  };
  Kata.Script.prototype.timer = function() {
    return null
  };
  Kata.Script.prototype.createObject = function(e, f, g) {
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.CreateObject(e, f, g))
  };
  Kata.Script.prototype.queryUpdate = function(e, f, g) {
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.QueryUpdate(e, f, g))
  };
  Kata.Script.prototype.queryRemoval = function(e, f) {
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.QueryRemoval(e, f))
  };
  Kata.Script.prototype.Persistence = {};
  Kata.Script.prototype.Persistence.read = function() {
    Kata.notImplemented("Script.read")
  };
  Kata.Script.prototype.Persistence.write = function() {
    Kata.notImplemented("Script.write")
  };
  Kata.Script.prototype._handleHostedObjectMessage = function(e, f) {
    f = Kata.ScriptProtocol.ToScript.reconstitute(f);
    this.mMessageDispatcher.dispatch(e, f)
  };
  Kata.Script.remotePresenceKey = function(e, f) {
    return e + f
  };
  Kata.Script.prototype.getRemotePresence = function(e) {
    return this.mRemotePresences[Kata.Script.remotePresenceKey(e.space(), e.object())]
  };
  Kata.Script.prototype._handleQueryEvent = function(e, f) {
    var g = this.mPresences[f.space], h = null, j = Kata.Script.remotePresenceKey(f.space, f.observed);
    if(f.entered) {
      (h = this.mRemotePresences[j]) ? h._killTimeout && (clearTimeout(h._killTimeout), delete h._killTimeout) : (h = new Kata.RemotePresence(g, f.space, f.observed, f.loc, f.visual), this.mRemotePresences[j] = h, g.remotePresence(h, !0), this.mBehaviors.forEach(function(e) {
        e.remotePresence && e.remotePresence(g, h, !0)
      }), this._handleQueryEventDelegate(h, f))
    }else {
      h = this.mRemotePresences[j];
      if(!h) {
        return Kata.warn("Got removal prox event for unknown object."), h
      }
      if(h._killTimeout) {
        return h
      }
      var m = this;
      h._killTimeout = setTimeout(function() {
        delete m.mRemotePresences[j];
        g.remotePresence(h, !1);
        m.mBehaviors.forEach(function(e) {
          e.remotePresence && e.remotePresence(g, h, !1)
        });
        m._handleQueryEventDelegate(h, f)
      }, 1E4)
    }
    return h
  };
  Kata.Script.prototype._handleQueryEventDelegate = function() {
  };
  Kata.Script.prototype._sendODPMessage = function(e, f, g) {
    if(!Kata.URL.equals(e.space(), f.space())) {
      throw"Mismatching spaces in ODP message.";
    }
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.SendODPMessage(e.space(), e.object(), e.port(), f.object(), f.port(), g))
  };
  Kata.Script.prototype._sendPreparedODPMessage = function(e, f) {
    this._sendHostedObjectMessage(new Kata.ScriptProtocol.FromScript.SendODPMessage(e, f.source_object, f.source_port, f.dest_object, f.dest_port, f.payload))
  };
  Kata.Script.prototype._handleReceiveODPMessage = function(e, f) {
    var g = this.mPresences[f.space], h = !1;
    g && g.ODPDispatcher.dispatchMessage(f) && (h = !0);
    h || this._deliverODPMessage(new Kata.ODP.Endpoint(f.space, f.source_object, f.source_port), new Kata.ODP.Endpoint(f.space, f.dest_object, f.dest_port), f.payload)
  };
  Kata.Script.prototype._handlePresenceLocUpdate = function(e, f) {
    var g = this.mPresences[f.space];
    return g ? g._handleLocEvent(f, this.mRemotePresences) : (Kata.warn("Got loc update destined for unknown object."), g)
  };
  Kata.Script.prototype._handleStorageEvent = function() {
  }
}, "katajs/oh/Script.js");
Kata.require(["katajs/core/URL.js"], function() {
  Kata.SessionManager = function() {
    this.mSpaceConnections = {};
    this.mObjects = {}
  };
  Kata.SessionManager.registerProtocolHandler = function(e, f) {
    if(!this._protocols) {
      this._protocols = {}
    }
    this._protocols[e] && Kata.warn("Overwriting protocol handler for " + e);
    this._protocols[e] = f
  };
  Kata.SessionManager._getProtocolHandler = function(e) {
    if(this._protocols) {
      return this._protocols[e]
    }
  };
  Kata.SessionManager.prototype.connect = function(e, f, g) {
    var h = f.space, j = Kata.URL.protocol(h), m = this.mSpaceConnections[h];
    m || ((m = Kata.SessionManager._getProtocolHandler(j)) || Kata.error("Unknown space protocol: " + j), m = new m(this, h), this.mSpaceConnections[h] = m);
    this.mObjects[e.getID()] = e;
    m.connectObject(e.getID(), g, f, f.visual, f.query)
  };
  Kata.SessionManager.prototype.aliasIDs = function(e, f) {
    var g = this.mObjects[e];
    g ? this.mObjects[f.object] = g : Kata.warn("Got ID aliasing for unknown object: " + e)
  };
  Kata.SessionManager.prototype.connectionResponse = function(e, f, g, h) {
    var j = this.mObjects[e];
    j ? (f && (delete this.mObjects[e], this.mObjects[g.object] = j), j.connectionResponse(f, g, h)) : Kata.warn("Got connection response for unknown object: " + e)
  };
  Kata.SessionManager.prototype.disconnect = function(e, f) {
    var g = this.mSpaceConnections[Kata.URL(f.space)];
    g && g.disconnectObject(f.id)
  };
  Kata.SessionManager.prototype.disconnected = function(e, f) {
    var g = this.mObjects[e];
    g ? g.disconnected(f) : Kata.warn("Got disconnection event for unknown object: " + e)
  };
  Kata.SessionManager.prototype.spaceConnectionDisconnected = function(e) {
    for(var f in this.mSpaceConnections) {
      e === this.mSpaceConnections[f] && delete this.mSpaceConnections[f]
    }
  };
  Kata.SessionManager.prototype.sendODPMessage = function(e, f, g, h, j, m) {
    this.mSpaceConnections[e].sendODPMessage(f, g, h, j, m)
  };
  Kata.SessionManager.prototype.receiveODPMessage = function(e, f, g, h, j, m) {
    this.mObjects[h].receiveODPMessage(e, f, g, h, j, m)
  };
  Kata.SessionManager.prototype.registerProxQuery = function(e, f, g) {
    this.mSpaceConnections[e].registerProxQuery(f, g)
  };
  Kata.SessionManager.prototype.proxEvent = function(e, f, g, h, j) {
    this.mObjects[f].proxEvent(e, g, h, j)
  };
  Kata.SessionManager.prototype.locUpdateRequest = function(e, f, g, h) {
    e = this.mSpaceConnections[e];
    e !== void 0 && e.locUpdateRequest(f, g, h)
  };
  Kata.SessionManager.prototype.requestQueryRemoval = function(e, f) {
    var g = this.mSpaceConnections[e];
    g !== void 0 && g.requestQueryRemoval(f)
  };
  Kata.SessionManager.prototype.requestQueryUpdate = function(e, f, g) {
    e = this.mSpaceConnections[e];
    e !== void 0 && e.requestQueryUpdate(f, g)
  };
  Kata.SessionManager.prototype.setPhysics = function(e, f, g) {
    e = this.mSpaceConnections[e];
    e !== void 0 && e.setPhysics(f, g)
  };
  Kata.SessionManager.prototype.presenceLocUpdate = function(e, f, g, h, j, m) {
    this.mObjects[g].presenceLocUpdate(e, f, h, j, m)
  };
  Kata.SessionManager.prototype.subscribe = function(e, f, g) {
    this.mSpaceConnections[e].subscribe(f, g)
  };
  Kata.SessionManager.prototype.unsubscribe = function(e, f, g) {
    this.mSpaceConnections[e].unsubscribe(f, g)
  }
}, "katajs/oh/SessionManager.js");
typeof Kata == "undefined" && (Kata = {});
Kata.require([], function() {
  Kata.Simulation = function(e) {
    this.mChannel = e;
    e.registerListener(Kata.bind(this.receivedMessage, this))
  };
  Kata.Simulation.prototype.receivedMessage = function() {
  }
}, "katajs/oh/Simulation.js");
Kata.require(["katajs/oh/ObjectHost.js"], function() {
  Kata.SpaceConnection = function(e) {
    this.mParent = e
  };
  Kata.SpaceConnection.prototype.connectObject = function() {
    Kata.notImplemented("SpaceConnection.connectObject")
  };
  Kata.SpaceConnection.prototype.disconnectObject = function() {
    Kata.notImplemented("SpaceConnection.disconnectObject")
  };
  Kata.SpaceConnection.prototype.sendODPMessage = function() {
    Kata.notImplemented("SpaceConnection.sendODPMessage")
  };
  Kata.SpaceConnection.prototype.registerProxQuery = function() {
    Kata.notImplemented("SpaceConnection.registerQuery")
  };
  Kata.SpaceConnection.prototype.locUpdateRequest = function() {
    Kata.notImplemented("SpaceConnection.locUpdateRequest")
  };
  Kata.SpaceConnection.prototype.requestQueryRemoval = function() {
    Kata.notImplemented("SpaceConnection.requestQueryRemoval")
  };
  Kata.SpaceConnection.prototype.requestQueryUpdate = function() {
    Kata.notImplemented("SpaceConnection.requestQueryUpdate")
  };
  Kata.SpaceConnection.prototype.setPhysics = function() {
    Kata.notImplemented("SpaceConnection.setPhysics")
  };
  Kata.SpaceConnection.prototype.subscribe = function() {
    Kata.notImplemented("SpaceConnection.subscribe")
  };
  Kata.SpaceConnection.prototype.unsubscribe = function() {
    Kata.notImplemented("SpaceConnection.unsubscribe")
  }
}, "katajs/oh/SpaceConnection.js");
Kata.require(["katajs/core/Deque.js", ["externals/protojs/protobuf.js", "externals/protojs/pbj.js", "katajs/oh/plugins/sirikata/impl/SSTHeader.pbj.js"], ["externals/protojs/protobuf.js", "externals/protojs/pbj.js", "katajs/oh/plugins/sirikata/impl/ObjectMessage.pbj.js"]], function() {
  function e() {
  }
  e.prototype.push = function() {
  };
  new e;
  var f = new e, g = new e, h = new e;
  new e;
  new e;
  new e;
  var j = new e, m = new e;
  new e;
  var p = new e;
  new e;
  if(typeof Kata.SST == "undefined") {
    Kata.SST = {}
  }
  if(typeof Kata.SST.Impl == "undefined") {
    Kata.SST.Impl = {}
  }
  Kata.SST.ObjectMessageDispatcher = function() {
    this.mObjectMessageRecipients = {}
  };
  Kata.SST.ObjectMessageDispatcher.prototype.registerObjectMessageRecipient = function(e, f) {
    this.mObjectMessageRecipients[e] = f
  };
  Kata.SST.ObjectMessageDispatcher.prototype.unregisterObjectMessageRecipient = function(e, f) {
    this.mObjectMessageRecipients[e] != f ? Kata.log("Unregistering wrong recipient for port " + e) : delete this.mObjectMessageRecipients[e]
  };
  Kata.SST.ObjectMessageDispatcher.prototype.dispatchMessage = function(e) {
    if(e.dest_port in this.mObjectMessageRecipients) {
      return this.mObjectMessageRecipients[e.dest_port].receiveMessage(e)
    }
    return!1
  };
  Kata.SST.EndPoint = function(e, f) {
    this.endPoint = e;
    this.port = f
  };
  Kata.SST.EndPoint.prototype.uid = function() {
    return"" + this.endPoint + ":" + this.port
  };
  Kata.SST.EndPoint.prototype.toString = Kata.SST.EndPoint.prototype.uid;
  Kata.SST.EndPoint.prototype.objectId = function() {
    return this.endPoint
  };
  Kata.SST.Impl.BaseDatagramLayer = function(e, f, g) {
    this.mRouter = e;
    this.mDispatcher = f;
    this.mContext = g;
    this.mMinAvailableChannels = 1;
    this.mMinAvailablePorts = 2049;
    this.mAvailableChannels = [];
    this.mAvailablePorts = []
  };
  var o = {}, r = {}, s = {}, t = function(e) {
    e = e.objectId();
    if(e in o) {
      return o[e]
    }
    return null
  };
  Kata.SST.createBaseDatagramLayer = function(e, f, g) {
    e = e.objectId();
    if(e in o) {
      return o[e]
    }
    return o[e] = new Kata.SST.Impl.BaseDatagramLayer(f, g)
  };
  Kata.SST.getBaseDatagramLayer = function(e) {
    e = e.objectId();
    if(e in o) {
      return o[e]
    }
  };
  Kata.SST.Impl.BaseDatagramLayer.prototype.context = function() {
    return this.mContext
  };
  Kata.SST.Impl.BaseDatagramLayer.prototype.send = function(e, f, g) {
    var h = new Sirikata.Protocol.Object.ObjectMessage;
    h.source_object = e.objectId();
    h.source_port = e.port;
    h.dest_object = f.objectId();
    h.dest_port = f.port;
    h.unique = PROTO.I64.fromNumber(0);
    h.payload = g;
    return this.mRouter.route(h)
  };
  Kata.SST.Impl.BaseDatagramLayer.prototype.receiveMessage = function(e) {
    var f;
    a: {
      var g = new Kata.SST.EndPoint(e.source_object, e.source_port);
      f = new Kata.SST.EndPoint(e.dest_object, e.dest_port);
      var h = e.payload, e = f.uid(), j = q[e], m = s[e];
      if(!j && !m) {
        Kata.log("whichLocal and listening are both null for " + e), f = !1
      }else {
        var o = new Sirikata.Protocol.SST.SSTChannelHeader, h = o.ParseFromArray(h), p = o.channel_id;
        if(j) {
          if(p == 0) {
            Kata.log("Someone's already connected at this port on object " + f.endPoint.uid());
            f = !0;
            break a
          }
          j.receiveParsedMessage(h)
        }else {
          if(p == 0) {
            m ? (e = o.payload, j = this.getAvailableChannel(), m = this.getAvailablePort(), o = new Kata.SST.EndPoint(f.endPoint, m), g = new Kata.SST.Connection(o, g), g.listenStream(o.port, s[f]), q[o.uid()] = g, g.setLocalChannelID(j), g.setRemoteChannelID(e[0] * 16777216 + 65536 * e[1] + 256 * e[2] + e[3]), g.setState(3), g.sendData([j >> 24 & 255, j >> 16 & 255, j >> 8 & 255, j & 255, m >> 24 & 255, m >> 16 & 255, m >> 8 & 255, m & 255], !1)) : Kata.log("Got non-init message on port we're listening on: " +
            e)
          }
        }
        f = !0
      }
    }
    return f
  };
  Kata.SST.Impl.BaseDatagramLayer.prototype.dispatcher = function() {
    return this.mDispatcher
  };
  Kata.SST.Impl.BaseDatagramLayer.prototype.getAvailablePort = function() {
    var e = this.mAvailablePorts.length;
    if(e) {
      this.mAvailabePorts.length = e - 1
    }
    return this.mMinAvailablePorts++
  };
  Kata.SST.Impl.BaseDatagramLayer.prototype.releasePort = function(e) {
    e <= 2048 || (e + 1 == this.mMinAvailablePorts ? --this.mMinAvailablePorts : this.mAvailablePorts[this.mAvailablePorts.length] = e)
  };
  Kata.SST.Impl.BaseDatagramLayer.prototype.getAvailableChannel = function() {
    var e = this.mAvailableChannels.length;
    if(e) {
      this.mAvailabeChannels.length = e - 1
    }
    return this.mMinAvailableChannels++
  };
  Kata.SST.Impl.BaseDatagramLayer.prototype.releaseChannel = function(e) {
    e + 1 == this.mMinAvailableChannels ? --this.mMinAvailableChannels : this.mAvailableChannels[this.mAvailableChannels.length] = e
  };
  Kata.SST.SUCCESS = 0;
  Kata.SST.FAILURE = -1;
  Kata.SST.Impl.ChannelSegment = function(e, f, g) {
    this.mBuffer = e;
    this.mChannelSequenceNumber = f;
    this.mAckSequenceNumber = g;
    this.mAckTime = this.mTransmitTime = null
  };
  Kata.SST.Impl.ChannelSegment.prototype.setAckTime = function(e) {
    this.mAckTime = e
  };
  Kata.SST.Connection = function(e, f) {
    this.mLocalEndPoint = e;
    this.mRemoteEndPoint = f;
    this.mState = u;
    this.mRemoteChannelID = 0;
    this.mLocalChannelID = 1;
    this.mLastReceivedSequenceNumber = this.mTransmitSequenceNumber = PROTO.I64.ONE;
    this.mPartialReadDatagrams = {};
    this.mNumStreams = 0;
    this.mCwnd = 1;
    this.mRTOMilliseconds = 5E3;
    this.mFirstRTO = !0;
    this.mLastTransmitTime = new Date;
    this.inSendingMode = !0;
    this.numSegmentsSent = 0;
    this.mDatagramLayer = t(e);
    this.mDatagramLayer.dispatcher().registerObjectMessageRecipient(e.port, this);
    this.mOutgoingSubstreamMap = {};
    this.mIncomingSubstreamMap = {};
    this.mListeningStreamsCallbackMap = {};
    this.mReadDatagramCallbacks = {};
    this.mQueuedSegments = new Kata.Deque;
    this.mOutstandingSegments = new Kata.Deque
  };
  Kata.SST.Connection.prototype.localEndPoint = function() {
    return this.mLocalEndPoint
  };
  Kata.SST.Connection.prototype.remoteEndPoint = function() {
    return this.mRemoteEndPoint
  };
  Kata.SST.Connection.prototype.getContext = function() {
    return this.mDatagramLayer.context()
  };
  Kata.SST.Connection.prototype.sendSSTChannelPacket = function(e) {
    if(this.mState == u) {
      return!1
    }
    return this.mDatagramLayer.send(this.mLocalEndPoint, this.mRemoteEndPoint, e.SerializeToArray())
  };
  Kata.SST.Connection.prototype.serviceConnection = function() {
    var e = new Date;
    if(this.mState == u) {
      return setTimeout(Kata.bind(this.cleanup, this), 0), !1
    }else {
      if(this.mState == v) {
        if(this.mQueuedSegments.empty()) {
          return setTimeout(Kata.bind(this.cleanup, this), 0), this.mState = u, !1
        }else {
          this.inSendingMode || Kata.warn("Empty deque but not in sending mode for disconnected stream")
        }
      }
    }
    if(this.inSendingMode) {
      for(var f = this.numSegmentsSent = 0;!this.mQueuedSegments.empty() && this.mOutstandingSegments.size() <= this.mCwnd;++f) {
        var g = this.mQueuedSegments.front(), h = new Sirikata.Protocol.SST.SSTChannelHeader;
        h.channel_id = this.mRemoteChannelID;
        h.transmit_sequence_number = g.mChannelSequenceNumber;
        h.ack_count = 1;
        h.ack_sequence_number = g.mAckSequenceNumber;
        h.payload = g.mBuffer;
        this.sendSSTChannelPacket(h);
        g.mTransmitTime = e;
        this.mOutstandingSegments.push_back(g);
        this.mQueuedSegments.pop_front();
        this.numSegmentsSent++;
        this.mLastTransmitTime = e;
        this.inSendingMode = !1
      }
      this.inSendingMode || setTimeout(Kata.bind(this.serviceConnection, this), this.mRTOMilliseconds)
    }else {
      if(!this.mOutstandingSegments.empty()) {
        this.mCwnd /= 2;
        if(this.mCwnd < 1) {
          this.mCwnd = 1
        }
        this.mOutstandingSegments.clear()
      }
      this.inSendingMode = !0;
      setTimeout(Kata.bind(this.serviceConnection, this), 0)
    }
    return!0
  };
  var q = {}, u = 1, v = 5;
  Kata.SST.Connection.prototype.getNewLSID = function() {
    return++this.mNumStreams
  };
  Kata.SST.Connection.prototype.releaseLSID = function() {
  };
  Kata.SST.Connection.prototype.listenStream = function(e, f) {
    this.mListeningStreamsCallbackMap[e] = f
  };
  Kata.SST.Connection.prototype.stream = function(e, f, g, h, j) {
    j === void 0 && (j = 0);
    var m = Math.uuid(), o = this.getNewLSID(), e = new Kata.SST.Stream(j, this, g, h, m, o, f, !1, 0, e);
    return this.mOutgoingSubstreamMap[o] = e
  };
  Kata.SST.Connection.prototype.sendData = function(e, f) {
    e.length > 1300 && Kata.log("Data longer than MAX_PAYLOAD_SIZE OF 1300");
    f === void 0 && Kata.log("sendData not setting whether it is an ack");
    var g = this.mTransmitSequenceNumber;
    if(f) {
      var h = new Sirikata.Protocol.SST.SSTChannelHeader;
      h.channel_id = this.mRemoteChannelID;
      h.transmit_sequence_number = this.mTransmitSequenceNumber;
      h.ack_count = 1;
      h.ack_sequence_number = this.mLastReceivedSequenceNumber;
      h.payload = e;
      this.sendSSTChannelPacket(h)
    }else {
      this.mQueuedSegments.size() < 300 && (this.mQueuedSegments.push_back(new Kata.SST.Impl.ChannelSegment(e, this.mTransmitSequenceNumber, this.mLastReceivedSequenceNumber)), this.inSendingMode && setTimeout(Kata.bind(this.serviceConnection, this)))
    }
    this.mTransmitSequenceNumber = this.mTransmitSequenceNumber.unsigned_add(PROTO.I64.ONE);
    return g
  };
  Kata.SST.Connection.prototype.setState = function(e) {
    this.mState = e
  };
  Kata.SST.Connection.prototype.setLocalChannelID = function(e) {
    this.mLocalChannelID = e
  };
  Kata.SST.Connection.prototype.setRemoteChannelID = function(e) {
    this.mRemoteChannelID = e
  };
  Kata.SST.Connection.prototype.markAcknowledgedPacket = function(e) {
    for(var f = this.mOutstandingSegments.size(), g = 0;g < f;g++) {
      var h = this.mOutstandingSegments.index(g);
      if(h.mChannelSequenceNumber.equals(e)) {
        h.mAckTime = new Date;
        this.mFirstRTO ? (this.mRTOMilliseconds = h.mAckTime - h.mTransmitTime, this.mFirstRTO = !1) : this.mRTOMilliseconds = 0.8 * this.mRTOMilliseconds + (1 - 0.8) * (h.mAckTime - h.mTransmitTime);
        this.inSendingMode = !0;
        Math.random() * this.mCwnd < 1 && (this.mCwnd += 1);
        this.mOutstandingSegments.erase(g);
        break
      }
    }
  };
  Kata.SST.Connection.prototype.parsePacket = function(e) {
    var f = new Sirikata.Protocol.SST.SSTStreamHeader;
    f.ParseFromArray(e.payload);
    f.type == Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType.INIT ? this.handleInitPacket(f) : f.type == Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType.REPLY ? this.handleReplyPacket(f) : f.type == Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType.DATA ? this.handleDataPacket(f) : f.type == Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType.ACK ? this.handleAckPacket(e, f) : f.type == Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType.DATAGRAM && this.handleDatagram(f)
  };
  Kata.SST.Connection.prototype.headerToStringDebug = function(e) {
    return this.mLocalEndPoint + "-> " + this.mRemoteEndPoint + " LSID:" + e.lsid
  };
  Kata.SST.Connection.prototype.handleInitPacket = function(e) {
    var f = e.lsid;
    if(f in this.mIncomingSubstreamMap) {
      Kata.log("Init message for connected stream" + this.headerToStringDebug(e)), this.mIncomingSubstreamMap[f].sendReplyPacket(void 0, f)
    }else {
      var g = this.mListeningStreamsCallbackMap[e.dest_port];
      if(g) {
        var h = Math.uuid(), j = this.getNewLSID(), h = new Kata.SST.Stream(e.psid, this, e.dest_port, e.src_port, h, j, [], !0, f, null);
        this.mOutgoingSubstreamMap[j] = h;
        this.mIncomingSubstreamMap[f] = h;
        g(0, h);
        h.receiveData(e, e.payload, e.bsn)
      }else {
        Kata.log("Not listening to streams at: " + this.headerToStringDebug(e))
      }
    }
  };
  Kata.SST.Connection.prototype.handleReplyPacket = function(e) {
    var f = e.lsid;
    if(this.mIncomingSubstreamMap[f]) {
      Kata.log("Received reply packet for already connected stream\n" + this.headerToStringDebug(e))
    }else {
      var g = this.mOutgoingSubstreamMap[e.rsid];
      g ? (this.mIncomingSubstreamMap[g.mRemoteLSID = f] = g, g.mStreamReturnCallback && (g.mStreamReturnCallback(Kata.SST.SUCCESS, g), g.receiveData(e, e.payload, e.bsn))) : Kata.log("Received reply packet for unknown stream\n" + this.headerToStringDebug(e))
    }
  };
  Kata.SST.Connection.prototype.handleDataPacket = function(e) {
    var f = this.mIncomingSubstreamMap[e.lsid];
    f && f.receiveData(e, e.payload, e.bsn)
  };
  Kata.SST.Connection.prototype.handleAckPacket = function(e, f) {
    var g = this.mIncomingSubstreamMap[f.lsid];
    g && g.receiveData(f, f.payload, e.ack_sequence_number)
  };
  Kata.SST.Connection.prototype.handleDatagram = function(e) {
    if(e.flags & Sirikata.Protocol.SST.SSTStreamHeader.CONTINUES) {
      e.lsid in this.mPartialReadDatagrams || (this.mPartialReadDatagrams[e.lsid] = []), this.mPartialReadDatagrams[e.lsid].push(e.payload)
    }else {
      var f = e.dest_port, g = [];
      f in this.mReadDatagramCallbacks && (g = this.mReadDatagramCallbacks[f]);
      var f = g.length, h = this.mPartialReadDatagrams[e.lsid];
      if(h) {
        for(var j = [], m = h.length, o = 0;o < m;++o) {
          j = Array.concat(j, h[o])
        }
        j += e.payload;
        delete this.mPartialReadDatagrams[h];
        for(h = 0;h < f;h++) {
          g[h](j)
        }
      }else {
        for(h = 0;h < f;h++) {
          g[h](e.payload)
        }
      }
    }
    e = new Sirikata.Protocol.SST.SSTChannelHeader;
    e.channel_id = this.mRemoteChannelID;
    e.transmit_sequence_number = this.mTransmitSequenceNumber;
    e.ack_count = 1;
    e.ack_sequence_number = this.mLastReceivedSequenceNumber;
    this.sendSSTChannelPacket(e);
    this.mTransmitSequenceNumber = this.mTransmitSequenceNumber.unsigned_add(PROTO.I64.ONE)
  };
  Kata.SST.Connection.prototype.receiveMessage = function(e) {
    var e = e.payload, f = new Sirikata.Protocol.SST.SSTChannelHeader;
    f.ParseFromArray(e);
    this.mLastReceivedSequenceNumber = f.transmit_sequence_number;
    this.markAcknowledgedPacket(f.ack_sequence_number);
    if(this.mState == 2) {
      if(this.mState = 4, new Kata.SST.EndPoint(this.mRemoteEndPoint.endPoint, this.mRemoteEndPoint.port), this.setRemoteChannelID(f.payload[0] * 16777216 + f.payload[1] * 65536 + f.payload[2] * 256 + f.payload[3]), this.mRemoteEndPoint.port = f.payload[4] * 16777216 + f.payload[5] * 65536 + f.payload[6] * 256 + f.payload[7], this.sendData([], !1), e = this.mLocalEndPoint.uid(), f = r[e]) {
        delete r[e], f(Kata.SST.SUCCESS, this)
      }
    }else {
      this.mState == 3 ? this.mState = 4 : this.mState == 4 && f.payload && f.payload.length > 0 && this.parsePacket(f)
    }
    return!0
  };
  Kata.SST.Connection.prototype.eraseDisconnectedStream = function(e) {
    e.mLSID in this.mOutgoingSubstreamMap ? delete this.mOutgoingSubstreamMap[e.mLSID] : Kata.warn("Unable to remove stream from outgoing map " + e.mRemoteLSID + "/" + e.mLSID);
    e.mRemoteLSID in this.mIncomingSubstreamMap ? delete this.mIncomingSubstreamMap[e.mRemoteLSID] : Kata.warn("Unable to remove stream from incoming map " + e.mRemoteLSID + "/" + e.mLSID)
  };
  Kata.SST.Connection.prototype.finalize = function() {
    this.mDatagramLayer.dispatcher().unregisterObjectMessageRecipient(this.mLocalEndPoint.port, this);
    if(this.mState != u) {
      this.mState = u, this.close(!0)
    }
  };
  Kata.SST.Connection.prototype.cleanup = function() {
    var e = this.mState;
    if(e == 2 || e == u) {
      var f = null, g = this.mLocalEndPoint.uid(), f = r[g];
      delete r[g];
      delete q[g];
      e == 2 && f && f(Kata.SST.FAILURE, this)
    }
  };
  Kata.SST.Connection.prototype.datagram = function(e, f, g, h) {
    var j = 0;
    if(this.mState == u || this.mState == v) {
      return h && h(Kata.SST.FAILURE, e), !1
    }
    for(var m = this.getNewLSID(), o = e.length;j < o;) {
      for(var p = 28;;) {
        var q, r = !0;
        o - j > 1300 - p ? (q = 1300 - p, r = !0) : (q = o - j, r = !1);
        var s = new Sirikata.Protocol.SST.SSTStreamHeader;
        s.lsid = m;
        s.type = Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType.DATAGRAM;
        var t = 0;
        r && (t |= Sirikata.Protocol.SST.SSTStreamHeader.CONTINUES);
        s.flags = t;
        s.window = 10;
        s.src_port = f;
        s.dest_port = g;
        s.payload = e.slice(j, j + q);
        r = s.SerializeToArray();
        if(r.length > 1300) {
          p += 10
        }else {
          this.sendData(r, !1);
          j += q;
          break
        }
      }
    }
    h && h(Kata.SST.SUCCESS, e);
    return!0
  };
  Kata.SST.Connection.prototype.registerReadDatagramCallback = function(e, f) {
    e in this.mReadDatagramCallbacks || (this.mReadDatagramCallbacks[e] = []);
    this.mReadDatagramCallbacks[e].push(f);
    return!0
  };
  Kata.SST.Connection.prototype.registerReadOrderedDatagramCallback = function() {
    throw"UNIMPLEMENTED";
  };
  Kata.SST.Connection.prototype.close = function(e) {
    e && this.mState != u && delete q[this.mLocalEndPoint.uid()];
    this.mState = e ? u : v
  };
  var w = function(e, f) {
    this.mAckTime = this.mTransmitTime = null;
    this.mBuffer = e;
    this.mOffset = f
  }, B = 1 - 0.8, A = {};
  Kata.SST.connectStream = function(e, f, g) {
    var h = e.uid();
    if(A[h]) {
      return!1
    }
    A[h] = g;
    g = D;
    h = e.uid();
    h in q ? (Kata.log("mConnectionMap.find failed for " + e.uid()), e = !1) : (f = new Kata.SST.Connection(e, f), q[h] = f, r[h] = g, f.setState(2), e = t(e).getAvailableChannel(), g = [e >> 24 & 255, e >> 16 & 255, e >> 8 & 255, e & 255], f.setLocalChannelID(e), f.sendData(g, !1), e = !0);
    return e
  };
  Kata.SST.listenStream = function(e, f) {
    var g;
    g = f.objectId();
    (g = o[g]) ? (g.mDispatcher.registerObjectMessageRecipient(f.port, g), g = !0) : g = !1;
    g ? (g = f.uid(), g in s ? g = !1 : (s[g] = e, g = !0)) : g = !1;
    return g
  };
  Kata.SST.Stream = function(e, f, g, j, m, o, p, q, r, s) {
    this.mState = 4;
    this.mLocalPort = g;
    this.mRemotePort = j;
    this.mParentLSID = e;
    this.mConnection = f;
    this.mUSID = m;
    this.mLSID = o;
    this.mRemoteLSID = r;
    this.mStreamRTOMilliseconds = 5E3;
    this.mReceiveWindowSize = this.mTransmitWindowSize = 1E4;
    this.mNumOutstandingBytes = 0;
    this.mNextByteExpected = PROTO.I64.ZERO;
    this.mLastContiguousByteReceived = PROTO.I64.fromNumber(-1);
    this.mLastSendTime = null;
    this.mStreamReturnCallback = s;
    this.mConnected = !1;
    if(q) {
      this.mConnected = !0, this.mState = 2, h.push(this)
    }
    this.mInitialData = p ? p.length <= 1E3 ? p : p.slice(0, 1E3) : [];
    this.mReceiveBuffer = [];
    this.mQueuedBuffers = new Kata.Deque;
    this.mChannelToBufferMap = {};
    this.mChannelToStreamOffsetMap = {};
    this.mCurrentQueueLength = 0;
    q ? this.sendReplyPacket(this.mInitialData, r) : this.sendInitPacket(this.mInitialData);
    this.mNumInitRetransmissions = 1;
    this.mNumBytesSent = PROTO.I64.fromNumber(this.mInitialDataLength || 0);
    p.length > this.mInitialData.length && this.write(p.slice(this.mInitialData.length, p.length))
  };
  Kata.SST.Stream.prototype.finalize = function() {
    this.close(!0)
  };
  Kata.SST.Stream.prototype.datagram = function(e, f, g, h) {
    return this.mConnection.datagram(e, f, g, h)
  };
  Kata.SST.Stream.prototype.listenSubstream = function(e, f) {
    this.mConnection.listenStream(e, f)
  };
  Kata.SST.Stream.prototype.write = function(e) {
    if(this.mState == 1 || this.mState == 3) {
      return-1
    }
    var f = 0, g = e.length;
    if(g <= 1E3) {
      if(this.mCurrentQueueLength + g > 4E6) {
        return 0
      }
      this.mQueuedBuffers.push_back(new w(e, this.mNumBytesSent));
      this.mCurrentQueueLength += g;
      this.mNumBytesSent = this.mNumBytesSent.unsigned_add(PROTO.I64.fromNumber(g));
      setTimeout(Kata.bind(this.serviceStream, this), 0);
      return g
    }else {
      for(var h = 0;h < g;) {
        var j = g - h > 1E3 ? 1E3 : g - h;
        if(this.mCurrentQueueLength + j > 4E6) {
          break
        }
        this.mQueuedBuffers.push_back.push_back(new w(e.slice(h, h + j), this.mNumBytesSent));
        h += j;
        this.mCurrentQueueLength += j;
        this.mNumBytesSent = this.mNumBytesSent.unsigned_add(PROTO.I64.fromNumber(j));
        f++
      }
      setTimeout(Kata.bind(this.serviceStream, this), 0);
      return h
    }
  };
  Kata.SST.Stream.prototype.registerReadCallback = function(e) {
    this.mReadCallback = e;
    this.sendToApp(0);
    return!0
  };
  Kata.SST.Stream.prototype.close = function(e) {
    return e ? (this.mConnected = !1, this.mConnection && this.mConnection.eraseDisconnectedStream(this), this.mState = 1, j.push(this), !0) : this.mState != 1 ? (p.push(this), this.mState = 3, setTimeout(Kata.bind(this.serviceStream, this), 0), !0) : !1
  };
  Kata.SST.Stream.prototype.setPriority = function() {
  };
  Kata.SST.Stream.prototype.priority = function() {
    return 0
  };
  Kata.SST.Stream.prototype.connection = function() {
    return this.mConnection
  };
  Kata.SST.Stream.prototype.createChildStream = function(e, f, g, h) {
    this.mConnection.stream(e, f, g, h, this.mParentLSID)
  };
  Kata.SST.Stream.prototype.localEndPoint = function() {
    return new Kata.SST.EndPoint(this.mConnection.localEndPoint().endPoint, this.mLocalPort)
  };
  Kata.SST.Stream.prototype.remoteEndPoint = function() {
    return new Kata.SST.EndPoint(this.mConnection.remoteEndPoint().endPoint, this.mRemotePort)
  };
  var D = function(e, f) {
    var g = f.mLocalEndPoint, h = g.uid(), j = A[h];
    delete A[h];
    j || Kata.error("Callback not defined for connectionCreatedStreamSST, " + h);
    e != Kata.SST.SUCCESS ? j(Kata.SST.FAILURE, null) : f.stream(j, [], g.port, f.mRemoteEndPoint.port)
  };
  Kata.SST.Stream.prototype.serviceStream = function() {
    function e(f) {
      for(var g in f) {
        return!1
      }
      return!0
    }
    var h = null;
    this.conn = this.mConnection;
    var j = new Date;
    if(this.mState != 2 && this.mState != 3 && this.mState != 1) {
      if(!this.mConnected && this.mNumInitRetransmissions < 5) {
        return this.sendInitPacket(this.mInitialData), this.mLastSendTime = j, this.mNumInitRetransmissions++, !0
      }
      this.mInitialDataLength = 0;
      if(this.mConnected) {
        g.push(this), this.mState = 2
      }else {
        return j = !0, this.mParentLSID == 0 && (j = this.mConnection.mLocalEndPoint.uid(), h = A[j], delete A[j], this.mConnection.close(!0), j = !1), this.mStreamReturnCallback && this.mStreamReturnCallback(Kata.SST.FAILURE, null), this.mStreamReturnCallback = null, this.mState = 1, m.push(this), h && h(Kata.SST.FAILURE, null), j || setTimeout(Kata.bind(this.mConnection.cleanup, this.mConnection), 0), !1
      }
    }else {
      if(this.mState != 1) {
        if(this.mLastSendTime && j.getTime() - this.mLastSendTime.getTime() > 2 * this.mStreamRTOMilliseconds) {
          this.resendUnackedPackets(), this.mLastSendTime = j
        }
        if(this.mState == 3 && this.mQueuedBuffers.empty() && e(this.mChannelToBufferMap)) {
          return this.mState = 1, f.push(this), this.mConnection.eraseDisconnectedStream(this), !0
        }
        for(h = !1;!this.mQueuedBuffers.empty();) {
          var o = this.mQueuedBuffers.front();
          if(this.mTransmitWindowSize < o.mBuffer.length) {
            break
          }
          var p = this.sendDataPacket(o.mBuffer, o.mOffset);
          o.mTransmitTime = j;
          h = !0;
          p = p.hash();
          if(!this.mChannelToBufferMap[p]) {
            this.mChannelToBufferMap[p] = o, this.mChannelToStreamOffsetMap[p] = o.mOffset
          }
          this.mQueuedBuffers.pop_front();
          this.mCurrentQueueLength -= o.mBuffer.length;
          this.mLastSendTime = j;
          o.mBuffer.length > this.mTransmitWindowSize && Kata.log("Failure: buffer length " + o.mBuffer.length + "is greater than trasmitwindow size" + this.mTransmitWindowSize);
          this.mTransmitWindowSize -= o.mBuffer.length;
          this.mNumOutstandingBytes += o.mBuffer.length
        }
        h && setTimeout(Kata.bind(this.serviceStream, this), this.mStreamRTOMilliseconds * 2)
      }
    }
    return!0
  };
  Kata.SST.Stream.prototype.resendUnackedPackets = function() {
    for(var e in this.mChannelToBufferMap) {
      var f = this.mChannelToBufferMap[e], g = f.mBuffer.length;
      this.mQueuedBuffers.push_front(f);
      this.mCurrentQueueLength += g;
      if(this.mTransmitWindowSize < g) {
        g <= 0 && Kata.log("Assertion failed: channelbuffer must have size >0"), this.mTransmitWindowSize = g
      }
    }
    setTimeout(Kata.bind(this.serviceStream, this), 0);
    if((e = function(e) {
      for(var f in e) {
        return!1
      }
      return!0
    }(this.mChannelToBufferMap)) && !this.mQueuedBuffers.empty()) {
      if(f = this.mQueuedBuffers.front(), g = f.mBuffer.length, g <= 0 && Kata.log("Assertion failed: channelbuffer must have size >0"), this.mTransmitWindowSize < g) {
        this.mTransmitWindowSize = g
      }
    }
    this.mNumOutstandingBytes = 0;
    if(!e) {
      this.mStreamRTOMilliseconds < 2E3 && (this.mStreamRTOMilliseconds *= 2), this.mChannelToBufferMap = {}
    }
  };
  Kata.SST.Stream.prototype.sendToApp = function(e) {
    for(var f = e;e < 1E4;e++) {
      if(this.mReceiveBuffer[e] !== void 0) {
        f++
      }else {
        break
      }
    }
    if(this.mReadCallback && f > 0) {
      this.mReadCallback(this.mReceiveBuffer.slice(0, f));
      this.mLastContiguousByteReceived = this.mLastContiguousByteReceived.add(PROTO.I64.fromNumber(f));
      this.mNextByteExpected = this.mLastContiguousByteReceived.unsigned_add(PROTO.I64.ONE);
      for(var g = 1E4 - f, e = 0;e < g;e++) {
        this.mReceiveBuffer[e] = this.mReceiveBuffer[e + f]
      }
      for(;e < 1E4;++e) {
        this.mReceiveBuffer[e] = void 0
      }
      this.mReceiveBuffer.length = g;
      this.mReceiveWindowSize += f
    }
  };
  Kata.SST.Stream.prototype.receiveData = function(e, f, g) {
    if(e.type == Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType.REPLY) {
      this.mConnected = !0
    }else {
      if(e.type == Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType.DATA || e.type == Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType.INIT) {
        Math.pow(2, e.window) - this.mNumOutstandingBytes < 0.5 && Kata.log("Assertion failed: 2^" + e.window + " <= " + this.mNumOutstandingBytes);
        this.mTransmitWindowSize = Math.round(Math.pow(2, e.window) - this.mNumOutstandingBytes);
        this.mTransmitWindowSize > 0 && !this.mQueuedBuffers.empty() && setTimeout(Kata.bind(this.serviceStream, this), 0);
        var h = g.sub(this.mLastContiguousByteReceived).lsw - 1;
        if(g.lsw == this.mNextByteExpected.lsw) {
          if(h + f.length <= 1E4) {
            var j = f.length;
            this.mReceiveWindowSize -= j;
            for(var m = 0;m < j;++m) {
              var o = h + m;
              this.mReceiveBuffer[o] = f[m]
            }
            this.sendToApp(j);
            this.sendAckPacket()
          }else {
            this.sendToApp(0)
          }
        }else {
          if(j = f.length, m = g.lsw + j - 1 - this.mLastContiguousByteReceived.lsw, Math.abs(m) > 2147483647 && (m = -m), m <= 0) {
            this.sendAckPacket()
          }else {
            if(h + j <= 1E4) {
              h + j <= 0 && Kata.log("Assertion failed: Offset in Buffer " + h + "+" + j + "<=0");
              this.mReceiveWindowSize -= j;
              for(m = 0;m < j;++m) {
                o = h + m, this.mReceiveBuffer[o] = f[m]
              }
              this.sendAckPacket()
            }else {
              this.sendToApp(0)
            }
          }
        }
      }
    }
    f = g.hash();
    if(f in this.mChannelToBufferMap) {
      g = this.mChannelToBufferMap[f];
      j = g.mOffset;
      this.mNumOutstandingBytes -= g.mBuffer.length;
      g.mAckTime = new Date;
      this.updateRTO(g.mTransmitTime, g.mAckTime);
      Math.pow(2, e.window) - this.mNumOutstandingBytes >= 0.5 ? (this.mTransmitWindowSize = Math.round(Math.pow(2, e.window) - this.mNumOutstandingBytes), this.mTransmitWindowSize > 0 && !this.mQueuedBuffers.empty() && setTimeout(Kata.bind(this.serviceStream, this), 0)) : this.mTransmitWindowSize = 0;
      delete this.mChannelToBufferMap[f];
      var e = [], p;
      for(p in this.mChannelToBufferMap) {
        this.mChannelToBufferMap[p].mOffset.equals(j) && e.push(p)
      }
      for(m = 0;m < e.length;m++) {
        delete this.mChannelToBufferMap[e[m]]
      }
    }else {
      if(f in this.mChannelToStreamOffsetMap) {
        j = this.mChannelToStreamOffsetMap[f];
        delete this.mChannelToStreamOffsetMap[f];
        e = [];
        for(p in this.mChannelToBufferMap) {
          this.mChannelToBufferMap[p].mOffset.equals(j) && e.push(p)
        }
        j = e.length;
        for(m = 0;m < j;m++) {
          delete this.mChannelToBufferMap[e[m]]
        }
      }
    }
  };
  Kata.SST.Stream.prototype.updateRTO = function() {
    var e = !0;
    return function(f, g) {
      var h = f.getTime(), j = g.getTime();
      h > j ? Kata.log("Bad sample\n") : e ? (this.mStreamRTOMilliseconds = j - h, e = !1) : this.mStreamRTOMilliseconds = 0.8 * this.mStreamRTOMilliseconds + B * (j - h)
    }
  }();
  Kata.SST.Stream.prototype.sendInitPacket = function(e) {
    var f = new Sirikata.Protocol.SST.SSTStreamHeader;
    f.lsid = this.mLSID;
    f.type = Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType.INIT;
    f.flags = 0;
    f.window = Math.log(this.mReceiveWindowSize) / Math.log(2);
    f.src_port = this.mLocalPort;
    f.dest_port = this.mRemotePort;
    f.psid = this.mParentLSID;
    f.bsn = PROTO.I64.fromNumber(0);
    f.payload = e;
    this.mConnection.sendData(f.SerializeToArray(), !1);
    setTimeout(Kata.bind(this.serviceStream, this), 2 * this.mStreamRTOMilliseconds)
  };
  Kata.SST.Stream.prototype.sendAckPacket = function() {
    var e = new Sirikata.Protocol.SST.SSTStreamHeader;
    e.lsid = this.mLSID;
    e.type = Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType.ACK;
    e.flags = 0;
    e.window = Math.log(this.mReceiveWindowSize) / Math.log(2);
    e.src_port = this.mLocalPort;
    e.dest_port = this.mRemotePort;
    this.mConnection.sendData(e.SerializeToArray(), !0)
  };
  Kata.SST.Stream.prototype.sendDataPacket = function(e, f) {
    var g = new Sirikata.Protocol.SST.SSTStreamHeader;
    g.lsid = this.mLSID;
    g.type = Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType.DATA;
    g.flags = 0;
    g.window = Math.log(this.mReceiveWindowSize) / Math.log(2);
    g.src_port = this.mLocalPort;
    g.dest_port = this.mRemotePort;
    g.bsn = PROTO.I64.fromNumber(f);
    g.payload = e;
    return this.mConnection.sendData(g.SerializeToArray(), !1)
  };
  Kata.SST.Stream.prototype.sendReplyPacket = function(e, f) {
    var g = new Sirikata.Protocol.SST.SSTStreamHeader;
    g.lsid = this.mLSID;
    g.type = Sirikata.Protocol.SST.SSTStreamHeader.StreamPacketType.REPLY;
    g.flags = 0;
    g.window = Math.log(this.mReceiveWindowSize) / Math.log(2);
    g.src_port = this.mLocalPort;
    g.dest_port = this.mRemotePort;
    g.rsid = f;
    g.bsn = PROTO.I64.fromNumber(0);
    g.payload = e;
    this.mConnection.sendData(g.SerializeToArray(), !1)
  }
}, "katajs/oh/sst/SSTImpl.js");
Kata.require([], function() {
  if(typeof Kata.Loopback == "undefined") {
    Kata.Loopback = {}
  }
  Kata.Loopback.EveryoneProx = function(e) {
    this.mSpace = e;
    this.mObjects = {};
    this.mQueriers = {}
  };
  Kata.Loopback.EveryoneProx.prototype.addObject = function(e) {
    if(!this.mObjects[e]) {
      for(var f in this.mObjects[e] = e, this.mQueriers) {
        f != e && this.mSpace.proxResult(f, e, !0)
      }
    }
  };
  Kata.Loopback.EveryoneProx.prototype.removeObject = function(e) {
    if(this.mObjects[e]) {
      for(var f in delete this.mObjects[e], this.mQueriers) {
        f != e && this.mSpace.proxResult(f, e, !1)
      }
    }
  };
  Kata.Loopback.EveryoneProx.prototype.addQuery = function(e) {
    if(!this.mQueriers[e]) {
      for(var f in this.mQueriers[e] = e, this.mObjects) {
        e != f && this.mSpace.proxResult(e, f, !0)
      }
    }
  };
  Kata.Loopback.EveryoneProx.prototype.removeQuery = function(e) {
    this.mQueriers[e] && delete this.mQueriers[e]
  }
}, "katajs/space/loop/EveryoneProx.js");
Kata.require([], function() {
  if(typeof Kata.Loopback == "undefined") {
    Kata.Loopback = {}
  }
  Kata.Loopback.Loc = function() {
    this.mObjects = {};
    this.mListeners = []
  };
  Kata.Loopback.Loc.prototype.addListener = function(e) {
    this.mListeners.append(e)
  };
  Kata.Loopback.Loc.prototype._notify = function() {
    for(var e in this.mListeners) {
      e.apply(void 0, arguments)
    }
  };
  Kata.Loopback.Loc.prototype.add = function(e, f, g) {
    this.mObjects[e] && Kata.warn("Loopback.Loc trying to add an existing object." + e);
    this.mObjects[e] = {loc:f, visual:g}
  };
  Kata.Loopback.Loc.prototype._checkExists = function(e) {
    if(!this.mObjects[e]) {
      return!1
    }
    return!0
  };
  Kata.Loopback.Loc.prototype.remove = function(e) {
    this._checkExists(e) ? delete this.mObjects[e] : Kata.warn("Loopback.Loc trying to remove unknown object." + e)
  };
  Kata.Loopback.Loc.prototype.update = function(e, f, g) {
    if(this._checkExists(e)) {
      f && Kata.LocationReset(f, this.mObjects[e].loc);
      if(g) {
        this.mObjects[e].visual = g
      }
      this._notify(e, f, g)
    }else {
      Kata.warn("Trying to update location for non-existant object: " + e)
    }
  };
  Kata.Loopback.Loc.prototype.updatePosition = function(e, f, g) {
    this.update(e, {pos:f, time:g})
  };
  Kata.Loopback.Loc.prototype.updateVelocity = function(e, f) {
    this.update(e, {vel:f})
  };
  Kata.Loopback.Loc.prototype.updateOrientation = function(e, f, g) {
    this.update(e, {orient:f, time:g})
  };
  Kata.Loopback.Loc.prototype.updateAngularVelocity = function(e, f, g) {
    this.update(e, {angvel:f, angaxis:g})
  };
  Kata.Loopback.Loc.prototype.updateBounds = function(e, f, g) {
    this.update(e, {scale:f, time:g})
  };
  Kata.Loopback.Loc.prototype.updateVisual = function(e, f) {
    this.update(e, {}, f)
  };
  Kata.Loopback.Loc.prototype.lookup = function(e) {
    return this.mObjects[e]
  }
}, "katajs/space/loop/Loc.js");
Kata.require(["katajs/oh/SpaceConnection.js", "katajs/core/Time.js", "katajs/core/Math.uuid.js", "katajs/space/loop/Loc.js", "katajs/space/loop/EveryoneProx.js", "katajs/space/loop/Subscription.js", "katajs/core/Location.js"], function() {
  Kata.LoopbackSpace = function(e) {
    var f = Kata.URL.host(e);
    Kata.LoopbackSpace.spaces[f] && Kata.warn("Overwriting static LoopbackSpace map entry for " + e);
    Kata.LoopbackSpace.spaces[f] = this;
    this.mID = e;
    this.netdelay = 10;
    this.mObjects = {};
    this.mLoc = new Kata.Loopback.Loc;
    this.mProx = new Kata.Loopback.EveryoneProx(this);
    this.mSubscription = new Kata.Loopback.Subscription(this)
  };
  Kata.LoopbackSpace.spaces = {};
  Kata.LoopbackSpace.prototype.connectObject = function(e, f, g) {
    var h = this;
    setTimeout(function() {
      h._connectObject(e, f, g)
    }, this.netdelay)
  };
  Kata.LoopbackSpace._fakeUUIDs = 100;
  Kata.LoopbackSpace.prototype._connectObject = function(e, f, g) {
    var h;
    h = Kata.DEBUG_FAKE_UUID ? "fake-uuid-" + Kata.LoopbackSpace._fakeUUIDs++ : Math.uuid();
    this.mLoc.add(h, g, f.visual);
    this.mProx.addObject(h);
    this.mSubscription.addObject(h);
    this.mObjects[h] = f;
    f.connected(e, h, g, f.visual)
  };
  Kata.LoopbackSpace.prototype.disconnectObject = function(e) {
    var f = this;
    setTimeout(function() {
      f._disconnectObject(e)
    }, this.netdelay)
  };
  Kata.LoopbackSpace.prototype._disconnectObject = function(e) {
    this.mSubscription.removeObject(e);
    this.mProx.removeQuery(e);
    this.mProx.removeObject(e);
    this.mLoc.remove(e);
    delete this.mObjects[e]
  };
  Kata.LoopbackSpace.prototype.sendODPMessage = function(e, f, g, h, j) {
    var m = this;
    setTimeout(function() {
      m._sendODPMessage(e, f, g, h, j)
    }, this.netdelay)
  };
  Kata.LoopbackSpace.prototype._sendODPMessage = function(e, f, g, h, j) {
    if(this.mObjects[e]) {
      var m = this.mObjects[g];
      m ? m.message(e, f, g, h, j) : Kata.warn("LoopbackSpace got message to non-existant object: " + g)
    }else {
      Kata.warn("LoopbackSpace got message from non-existant object: " + e)
    }
  };
  Kata.LoopbackSpace.prototype.registerProxQuery = function(e, f) {
    var g = this;
    setTimeout(function() {
      g._registerProxQuery(e, f)
    }, this.netdelay)
  };
  Kata.LoopbackSpace.prototype._registerProxQuery = function(e) {
    this.mProx.addQuery(e)
  };
  Kata.LoopbackSpace.prototype.proxResult = function(e, f, g) {
    var h = this.mObjects[e];
    if(h) {
      var j = this.mLoc.lookup(f), m = {loc:j.loc, visual:j.visual};
      Kata.LocationCopyUnifyTime(m.loc, j.loc);
      h.prox(e, f, g, m)
    }else {
      Kata.warn("LoopbackSpace got query result for non-existant object: " + e)
    }
  };
  Kata.LoopbackSpace.prototype.requestQueryRemoval = function() {
    Kata.notImplemented("Loopback space does not handle query angles")
  };
  Kata.LoopbackSpace.prototype.requestQueryUpdate = function() {
    Kata.notImplemented("Loopback space does not handle query angles")
  };
  Kata.LoopbackSpace.prototype.locUpdateRequest = function(e, f, g) {
    this._locUpdateRequest(e, f, g)
  };
  Kata.LoopbackSpace.prototype._locUpdateRequest = function(e, f, g) {
    this.mLoc.update(e, f, g);
    var h = this;
    this.mSubscription.notify(e, function(j) {
      h.mObjects[j].presenceLocUpdate(e, j, f, g)
    }, !0)
  };
  Kata.LoopbackSpace.prototype.subscriptionRequest = function(e, f, g) {
    var h = this;
    setTimeout(function() {
      h._subscriptionRequest(e, f, g)
    }, this.netdelay)
  };
  Kata.LoopbackSpace.prototype._subscriptionRequest = function(e, f, g) {
    g ? this.mSubscription.subscribe(e, f) : this.mSubscription.unsubscribe(e, f)
  };
  Kata.LoopbackSpace.prototype.sendMessage = function() {
  }
}, "katajs/space/loop/Space.js");
Kata.require([], function() {
  if(typeof Kata.Loopback == "undefined") {
    Kata.Loopback = {}
  }
  Kata.Loopback.Subscription = function(e) {
    this.mSpace = e;
    this.mSubscribers = {}
  };
  Kata.Loopback.Subscription.prototype.addObject = function(e) {
    this.mSubscribers[e] = {}
  };
  Kata.Loopback.Subscription.prototype.removeObject = function(e) {
    delete this.mSubscribers[e];
    for(var f in this.mSubscribers) {
      delete this.mSubscribers[f][e]
    }
  };
  Kata.Loopback.Subscription.prototype.subscribe = function(e, f) {
    this.mSubscribers[f] && (this.mSubscribers[f][e] = e)
  };
  Kata.Loopback.Subscription.prototype.unsubscribe = function(e, f) {
    this.mSubscribers[f] && delete this.mSubscribers[f][e]
  };
  Kata.Loopback.Subscription.prototype.notify = function(e, f, g) {
    var h = this.mSubscribers[e], j;
    for(j in h) {
      f(j)
    }
    g && f(e)
  }
}, "katajs/space/loop/Subscription.js");
(function() {
  for(var e in Kata.closureIncluded) {
    Kata.setIncluded(e)
  }
})();

